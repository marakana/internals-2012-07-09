<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.6" />
<title>Marakana Android Internals </title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Marakana Android Internals </h1>
<span id="author">Aleksandar (Saša) Gargenta, Ken Jones, Marko Gargenta</span><br />
<span id="revdate">April 18th, 2012</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph" id="Android_Internals"><p>Aleksandar (Saša) Gargenta, Ken Jones, Marko Gargenta</p></div>
<div class="paragraph"><p>Marakana.com</p></div>
<div class="paragraph"><p>April 18th, 2012</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">1. Overview</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Android Overview
</p>
</li>
<li>
<p>
Android Stack
</p>
</li>
<li>
<p>
JNI/NDK on Android
</p>
</li>
<li>
<p>
IPC/Binder on Android
</p>
</li>
<li>
<p>
Android Security
</p>
</li>
<li>
<p>
Building Android from Source
</p>
</li>
<li>
<p>
Android Startup
</p>
</li>
<li>
<p>
Android Services
</p>
</li>
<li>
<p>
Android Customization
</p>
</li>
<li>
<p>
Appendix: USB on Android
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_android_stack">2. Android Stack</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/AndroidStack.svg" alt="images/AndroidStack.svg" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Exploring the anatomy of Android. A walk through the Android stack, starting from the bottom and moving up.
</p>
<div class="ulist"><ul>
<li>
<p>
Linux Kernel Layer
</p>
</li>
<li>
<p>
Native Layer
</p>
</li>
<li>
<p>
Application Framework Layer
</p>
</li>
<li>
<p>
Applications Layer
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="sect2">
<h3 id="Android_Linux_Kernel_Layer">2.1. Android Linux Kernel Layer</h3>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="images/AndroidStack-Linux.svg" alt="images/AndroidStack-Linux.svg" />
</div>
<div class="title">Figure 1. Android Linux Kernel Layer</div>
</div>
<div class="sect3">
<h4 id="_overview_2">2.1.1. Overview</h4>
<div class="ulist"><ul>
<li>
<p>
Android runs on a modified Linux kernel
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Android Version - Linux Kernel Version</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Android Version</th>
<th align="left" valign="top">Kernel Version</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">1.0</p></td>
<td align="left" valign="top"><p class="table">2.6.25</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">1.5</p></td>
<td align="left" valign="top"><p class="table">2.6.27</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">1.6</p></td>
<td align="left" valign="top"><p class="table">2.6.29</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">2.2</p></td>
<td align="left" valign="top"><p class="table">2.6.32</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">2.3</p></td>
<td align="left" valign="top"><p class="table">2.6.35</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3.0</p></td>
<td align="left" valign="top"><p class="table">2.6.36</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">4.0.1</p></td>
<td align="left" valign="top"><p class="table">3.0.1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">4.0.3</p></td>
<td align="left" valign="top"><p class="table">3.0.8</p></td>
</tr>
</tbody>
</table>
</div>
</li>
<li>
<p>
Android is <strong>not</strong> "Linux"
</p>
<div class="ulist"><ul>
<li>
<p>
no glibc
</p>
</li>
<li>
<p>
no X11
</p>
</li>
<li>
<p>
many standard configuration files are missing: no <tt>/etc/passwd</tt>, no <tt>/etc/fstab</tt>, etc.
</p>
</li>
<li>
<p>
many standard Linux utilities are missing: no <tt>/bin/cp</tt>, no <tt>/bin/su</tt>, etc.
</p>
</li>
</ul></div>
</li>
<li>
<p>
In the <em>Android Stack</em> Linux kernel provides
</p>
<div class="ulist"><ul>
<li>
<p>
Hardware abstraction layer (low level)
</p>
<div class="ulist"><ul>
<li>
<p>
Well-understood driver model
</p>
</li>
<li>
<p>
Many drivers for common devices
</p>
</li>
<li>
<p>
"Free" drivers for future devices
</p>
</li>
</ul></div>
</li>
<li>
<p>
Process and memory management
</p>
</li>
<li>
<p>
Simple, but secure, per-process sandboxing (permissions-based security model)
</p>
</li>
<li>
<p>
Support for shared libraries
</p>
</li>
<li>
<p>
Network stack
</p>
</li>
</ul></div>
</li>
<li>
<p>
Application developers and users never "see" the Linux kernel
</p>
</li>
<li>
<p>
The <tt>adb shell</tt> command opens Linux shell (remember, limited standard utils)
</p>
</li>
<li>
<p>
Maintains a separate "forked" git tree (<a href="https://android.googlesource.com/">https://android.googlesource.com/</a>)
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. Android Linux Kernel GIT Repositories</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Android Version</th>
<th align="left" valign="top">Kernel Version</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">kernel/common.git</p></td>
<td align="left" valign="top"><p class="table">The "official" Android Kernel branch (used as the basis for others)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/goldfish.git</p></td>
<td align="left" valign="top"><p class="table">Kernel tree for the "goldfish" emulator</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/experimental.git</p></td>
<td align="left" valign="top"><p class="table">The experimental extensions</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/linux-2.6.git</p></td>
<td align="left" valign="top"><p class="table">The mirror of Linus' kernel tree</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/lk.git</p></td>
<td align="left" valign="top"><p class="table">(L)ittle (K)ernel bootloader</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/msm.git</p></td>
<td align="left" valign="top"><p class="table">Kernel tree for MSM7XXX family and Android on MSM7XXX (Qualcomm)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/omap.git</p></td>
<td align="left" valign="top"><p class="table">Kernel tree for TI&#8217;s OMAP family SOCs on Android</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/samsung.git</p></td>
<td align="left" valign="top"><p class="table">Kernel tree for Samsung SOCs systems on Android</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">kernel/tegra.git</p></td>
<td align="left" valign="top"><p class="table">Kernel tree for NVIDIA Tegra family SOCs on Android</p></td>
</tr>
</tbody>
</table>
</div>
</li>
<li>
<p>
Android introduces <strong>many extensions</strong>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The following are some of the changes/additions Android makes to the Linux kernel.</p></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Binder">2.1.2. Binder IPC</h4>
<div class="ulist"><ul>
<li>
<p>
OpenBinder-based IPC driver enables "object-oriented operating system environment"
</p>
<div class="ulist"><ul>
<li>
<p>
Exposed via <tt>/dev/binder</tt>
</p>
</li>
<li>
<p>
Runtime info at <tt>/proc/misc/binder</tt>
</p>
</li>
<li>
<p>
Like CORBA, but much simpler
</p>
</li>
<li>
<p>
Initially developed for BeOS later used by Palm (which acquired BeOS)
</p>
</li>
</ul></div>
</li>
<li>
<p>
By default, apps and services (including system services) run in separate processes, but often need to share data
</p>
</li>
<li>
<p>
Traditional IPC leads to security challenges and adds overhead, which is amplified on a mobile device
</p>
</li>
<li>
<p>
Most of Android infrastructure (services) is supported by Binder
</p>
</li>
<li>
<p>
Binder is lightweight and high-performance
</p>
<div class="ulist"><ul>
<li>
<p>
Bound services are automatically reference-counted and "garbage collected" when no longer in use
</p>
</li>
<li>
<p>
Provides automatic per-process thread pooling for services (with remote clients)
</p>
</li>
<li>
<p>
Remote (service) method calls are synchronous (feels like just a function call, even though it&#8217;s IPC)
</p>
<div class="ulist"><ul>
<li>
<p>
Supports <tt>oneway</tt> (asynchronous) execution model as well
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Services defined/exposed via AIDL
</p>
</li>
<li>
<p>
Implementation is at <tt>drivers/misc/binder.c</tt> with include at <tt>include/linux/binder.h</tt>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Ashmem">2.1.3. Ashmem (Anonymous SHared MEMory)</h4>
<div class="ulist"><ul>
<li>
<p>
A reference-counted, virtually mapped, named memory block that is shared between processes that the kernel is allowed to free
</p>
</li>
<li>
<p>
Similar to POSIX SHM but with different behavior and a simpler file-based API (POSIX SHM does not allow the kernel to free shared memory)
</p>
</li>
<li>
<p>
Programs open <tt>/dev/ashmem</tt>, use <tt>mmap()</tt> on it, and then share file handles via binder
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">int</span> size <span style="color: #990000">=</span> <span style="color: #993399">4096</span><span style="color: #990000">;</span>
<span style="color: #009900">int</span> fd <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ashmem_create_region</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"MySharedRegionName"</span><span style="color: #990000">,</span> size<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>fd <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  data <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mmap</span></span><span style="color: #990000">(</span>NULL<span style="color: #990000">,</span> size<span style="color: #990000">,</span> PROT_READ <span style="color: #990000">|</span> PROT_WRITE<span style="color: #990000">,</span> MAP_SHARED<span style="color: #990000">,</span> fd<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>data <span style="color: #990000">!=</span> MAP_FAILED<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">/* for security reasons, no other process can ashmem_create_region() with the same name */</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">/* instead, to share this memory, we send fd via Binder IPC to another process */</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">/* that process then mmap()'s it the same way in order to access the shared memory */</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
When all processes <tt>close(fd)</tt> to the shared memory region, the kernel automatically reclaims that memory (because it is reference-counted)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Supports a number of <tt>ioctl()</tt>-s: <tt>ASHMEM_SET_NAME</tt>, <tt>ASHMEM_GET_NAME</tt>, <tt>ASHMEM_SET_SIZE</tt>, <tt>ASHMEM_GET_SIZE</tt>, <tt>ASHMEM_SET_PROT_MASK</tt>, <tt>ASHMEM_GET_PROT_MASK</tt>, <tt>ASHMEM_PIN</tt>, <tt>ASHMEM_UNPIN</tt>, <tt>ASHMEM_GET_PIN_STATUS</tt>, <tt>ASHMEM_PURGE_ALL_CACHES</tt>
</p>
</li>
<li>
<p>
Android uses ashmem to share resources to minimize redundancy across processes
</p>
</li>
<li>
<p>
Kernel can discard unused shared blocks of memory when under pressure
</p>
</li>
<li>
<p>
Implementation at <tt>mm/ashmem.c</tt> with include at <tt>include/linux/ashmem.h</tt>
</p>
</li>
<li>
<p>
Represented in the Java layer as <tt>android.os.MemoryFile</tt>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Pmem">2.1.4. Pmem</h4>
<div class="ulist"><ul>
<li>
<p>
Physical memory allocator
</p>
</li>
<li>
<p>
Used to manage large (1-16+ MB) physically contiguous regions of memory shared between userspace and kernel drivers (DSP, GPU, etc.)
</p>
<div class="ulist"><ul>
<li>
<p>
Unlike ashmem, pmem is not reference-counted: the process that allocates a pmem heap is required to hold the file descriptor until all the other references are closed, so that it can free it explicitly
</p>
</li>
</ul></div>
</li>
<li>
<p>
Originally developed for MSM7201A
</p>
</li>
<li>
<p>
Implementation at <tt>drivers/misc/pmem.c</tt> with include at <tt>include/linux/android_pmem.h</tt>
</p>
</li>
<li>
<p>
Supports a number of <tt>ioctl()</tt>-s: <tt>PMEM_GET_PHYS</tt>, <tt>PMEM_MAP</tt>, <tt>PMEM_GET_SIZE</tt>, <tt>PMEM_UNMAP</tt>, <tt>PMEM_ALLOCATE</tt>, <tt>PMEM_CONNECT</tt>, <tt>PMEM_GET_TOTAL_SIZE</tt>, <tt>PMEM_CACHE_FLUSH</tt>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Wakelocks">2.1.5. Wakelocks</h4>
<div class="ulist"><ul>
<li>
<p>
Extended power management
</p>
</li>
<li>
<p>
More aggressive power-manager policy than standard Linux PM
</p>
<div class="ulist"><ul>
<li>
<p>
"CPU shouldn&#8217;t consume power if no applications or services require power" - i.e. the CPU shuts down eagerly
</p>
</li>
<li>
<p>
Applications and services that wish to continue running (after a short timeout following a user activity) are required to request "wake locks" via the app framework or native libs
</p>
</li>
</ul></div>
</li>
<li>
<p>
Wake locks are used by applications and services to request CPU resources
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>WAKE_LOCK_SUSPEND</tt>: prevents a full system suspend
</p>
</li>
<li>
<p>
<tt>WAKE_LOCK_IDLE</tt>: prevents entering low-power states from idle to avoid large interrupt latencies (disabled interrupts) - so the system is more responsive
</p>
</li>
</ul></div>
</li>
<li>
<p>
Exposed to kernel as
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;linux/wakelock.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000000">wake_lock_init</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">wakelock</span> <span style="color: #990000">*</span>lock<span style="color: #990000">,</span> <span style="color: #009900">int</span> type<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">wake_lock</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">wake_lock</span> <span style="color: #990000">*</span>lock<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">wake_unlock</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">wake_lock</span> <span style="color: #990000">*</span>lock<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">wake_lock_timeout</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">wake_lock</span> <span style="color: #990000">*</span>lock<span style="color: #990000">,</span> <span style="color: #009900">long</span> timeout<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">wake_lock_destroy</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">wake_lock</span> <span style="color: #990000">*</span>lock<span style="color: #990000">);</span>
<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">wake_lock_active</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">wake_lock</span> <span style="color: #990000">*</span>lock<span style="color: #990000">);</span>
<span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">has_wake_lock</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> type<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Exposed to user-space as
</p>
<div class="listingblock">
<div class="content">
<pre><tt>echo "MyLock" &gt; /sys/power/wake_lock
echo "MyLock" &gt; /sys/power/wake_unlock</tt></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Also supports auto-release: <tt>/sys/power/wake_lock &lt;lock-name&gt; &lt;timeout-in-ns&gt;</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Support for different types of wake locks
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
<thead>
<tr>
<th align="left" valign="top">Flag</th>
<th align="left" valign="top">CPU</th>
<th align="left" valign="top">Screen</th>
<th align="left" valign="top">Keybaord</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">PARTIAL_WAKE_LOCK</p></td>
<td align="left" valign="top"><p class="table">On</p></td>
<td align="left" valign="top"><p class="table">Off</p></td>
<td align="left" valign="top"><p class="table">Off</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SCREEN_DIM_WAKE_LOCK</p></td>
<td align="left" valign="top"><p class="table">On</p></td>
<td align="left" valign="top"><p class="table">Dim</p></td>
<td align="left" valign="top"><p class="table">Off</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SCREEN_BRIGHT_WAKE_LOCK</p></td>
<td align="left" valign="top"><p class="table">On</p></td>
<td align="left" valign="top"><p class="table">Bright</p></td>
<td align="left" valign="top"><p class="table">Off</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FULL_WAKE_LOCK</p></td>
<td align="left" valign="top"><p class="table">On</p></td>
<td align="left" valign="top"><p class="table">Bright</p></td>
<td align="left" valign="top"><p class="table">On</p></td>
</tr>
</tbody>
</table>
</div>
<div class="ulist"><ul>
<li>
<p>
Also, there are two more flags that affect the screen behavior (not applicable with <tt>PARTIAL_WAKE_LOCK</tt>):
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Flag</th>
<th align="left" valign="top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">ACQUIRE_CAUSES_WAKEUP</p></td>
<td align="left" valign="top"><p class="table">Force screen to turn on as soon as the wake-lock is acquired (i.e. don&#8217;t wait for user activity)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ON_AFTER_RELEASE</p></td>
<td align="left" valign="top"><p class="table">When set, the user activity timer will be reset when the wake-lock is released, causing the screen/keyboard illumination to remain on a bit longer (reduces flicker if code is cycling between wake-locks)</p></td>
</tr>
</tbody>
</table>
</div>
</li>
</ul></div>
</li>
<li>
<p>
Alls user-space wake-lock management must go through Java-based <tt>PowerManagerService</tt>  (even from user-space native libraries)
</p>
</li>
<li>
<p>
Baseband processor normally does not shut down, so network traffic still raises interrupts allowing CPU to wake up
</p>
</li>
<li>
<p>
Stats exposed via <tt>/proc/wakelocks</tt>
</p>
</li>
<li>
<p>
Implementation at <tt>drivers/android/power.c</tt> with include at <tt>include/linux/wakelock.h</tt>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_EarlySuspend">2.1.6. Early Suspend</h4>
<div class="ulist"><ul>
<li>
<p>
An extension to the standard Linux power management stages
</p>
</li>
<li>
<p>
Not meant for suspending the device
</p>
</li>
<li>
<p>
Allows the system to power-down some of its components (like the screen, sensors, etc.)
</p>
</li>
<li>
<p>
When user requested sleep state changes, kernel notifies drivers of early suspend
</p>
</li>
<li>
<p>
User-space changes the sleep state by writing to <tt>/sys/power/request_state</tt>: <tt>EARLY_SUSPEND_LEVEL_BLANK_SCREEN</tt>, <tt>EARLY_SUSPEND_LEVEL_STOP_DRAWING</tt>, <tt>EARLY_SUSPEND_LEVEL_DISABLE_FB</tt>, <tt>EARLY_SUSPEND_LEVEL_STOP_INPUT</tt>
</p>
</li>
<li>
<p>
The opposite of early suspend is "late resume" - the stage that resumes these devices
</p>
</li>
<li>
<p>
Enabled by <tt>EARLYSUSPEND</tt>
</p>
</li>
<li>
<p>
Configured in one of three modes:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>NO_USER_SPACE_SCREEN_ACCESS_CONTROL</tt> - no user-space control
</p>
</li>
<li>
<p>
<tt>CONSOLE_EARLYSUSPEND</tt> - user-space control via the console
</p>
</li>
<li>
<p>
<tt>FB_EARLYSUSPEND</tt> -  user-space control via the sysfs
</p>
</li>
</ul></div>
</li>
<li>
<p>
Implementation at <tt>kernel/power/fbearlysuspend.c</tt> (or <tt>kernel/power/consoleearlysuspend.c</tt>) with include at <tt>include/linux/earlysuspend.h</tt>
</p>
</li>
<li>
<p>
See <a href="http://lwn.net/Articles/416690/">http://lwn.net/Articles/416690/</a>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Alarm">2.1.7. Alarm</h4>
<div class="ulist"><ul>
<li>
<p>
Kernel support for Android&#8217;s <tt>AlarmManager</tt>
</p>
</li>
<li>
<p>
User-space tells kernel when it would like to wake up
</p>
</li>
<li>
<p>
Kernel schedules a time-based call-back (while holding a WakeLock) regardless of the sleep-state of the CPU
</p>
<div class="ulist"><ul>
<li>
<p>
Apps can then run (need to hold their own WakeLocks)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Implementation at <tt>drivers/rtc/alarm.c</tt> with include at <tt>include/linux/android_alarm.h</tt>
</p>
</li>
<li>
<p>
Exposed via <tt>/dev/alarm</tt>
</p>
</li>
<li>
<p>
Supports a number of <tt>ioctl()</tt>-s: <tt>ANDROID_ALARM_CLEAR</tt>, <tt>ANDROID_ALARM_WAIT</tt>, <tt>ANDROID_ALARM_SET</tt>, <tt>ANDROID_ALARM_SET_AND_WAIT</tt>, <tt>ANDROID_ALARM_GET_TIME</tt>, <tt>ANDROID_ALARM_GET_TIME</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
See <a href="https://lwn.net/Articles/429925/">https://lwn.net/Articles/429925/</a>
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Alarm_Memory_Killer">2.1.8. Low Memory Killer (a.k.a. Viking Killer)</h4>
<div class="ulist"><ul>
<li>
<p>
Automatically SIGKILLs eligible least-recently-used processes when running low on memory
</p>
</li>
<li>
<p>
More aggressive than standard OOM handling
</p>
</li>
<li>
<p>
Implementation at <tt>drivers/staging/android/lowmemorykiller.c</tt> and <tt>security/lowmem.c</tt>
</p>
</li>
<li>
<p>
System sets up 6 priority slots via <tt>init.rc</tt> (writes to <tt>/sys/module/lowmemorykiller/parameters/</tt>) and user-space <tt>ActivityManager</tt> then sets each app&#8217;s <tt>/proc/&lt;pid&gt;/oom_adj</tt> (from -16 to 15)
</p>
<div class="listingblock">
<div class="content">
<pre><tt># Define the oom_adj values for the classes of processes that can be
# killed by the kernel.  These are used in ActivityManagerService.
    setprop ro.FOREGROUND_APP_ADJ 0
    setprop ro.VISIBLE_APP_ADJ 1
    setprop ro.PERCEPTIBLE_APP_ADJ 2
    setprop ro.HEAVY_WEIGHT_APP_ADJ 3
    setprop ro.SECONDARY_SERVER_ADJ 4
    setprop ro.BACKUP_APP_ADJ 5
    setprop ro.HOME_APP_ADJ 6
    setprop ro.HIDDEN_APP_MIN_ADJ 7
    setprop ro.EMPTY_APP_ADJ 15

# Define the memory thresholds at which the above process classes will
# be killed.  These numbers are in pages (4k).
    setprop ro.FOREGROUND_APP_MEM 2048
    setprop ro.VISIBLE_APP_MEM 3072
    setprop ro.PERCEPTIBLE_APP_MEM 4096
    setprop ro.HEAVY_WEIGHT_APP_MEM 4096
    setprop ro.SECONDARY_SERVER_MEM 6144
    setprop ro.BACKUP_APP_MEM 6144
    setprop ro.HOME_APP_MEM 6144
    setprop ro.HIDDEN_APP_MEM 7168
    setprop ro.EMPTY_APP_MEM 8192

# Write value must be consistent with the above properties.
# Note that the driver only supports 6 slots, so we have combined some of
# the classes into the same memory level; the associated processes of higher
# classes will still be killed first.
    write /sys/module/lowmemorykiller/parameters/adj 0,1,2,4,7,15

    write /proc/sys/vm/overcommit_memory 1
    write /proc/sys/vm/min_free_order_shift 4
    write /sys/module/lowmemorykiller/parameters/minfree 2048,3072,4096,6144,7168,8192

    # Set init its forked children's oom_adj.
    write /proc/1/oom_adj -16</tt></pre>
</div></div>
</li>
<li>
<p>
To application developers this means that low memory killer stacks processes based on the following order:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Foreground processes - with an <tt>Activity</tt> that just ran <tt>onResume()</tt>, or a <tt>Service</tt> bound to it or started as foreground, or executing its callback methods, or a <tt>BroadcastReceiver</tt> executing <tt>onReceive()</tt>
</p>
</li>
<li>
<p>
Visible processes - with an <tt>Activity</tt> that just ran <tt>onPause()</tt> but is still visible or a <tt>Service</tt> bound to a component from a visible process
</p>
</li>
<li>
<p>
Service processes - with a <tt>Service</tt> that has been started with <tt>Context.startService()</tt>
</p>
</li>
<li>
<p>
Background processes - with an <tt>Activity</tt> that just ran <tt>onStop()</tt>
</p>
</li>
<li>
<p>
Empty processes - with no components (kept around just for caching purposes)
</p>
</li>
</ol></div>
</li>
<li>
<p>
See <a href="http://developer.android.com/guide/topics/fundamentals/processes-and-threads.html">http://developer.android.com/guide/topics/fundamentals/processes-and-threads.html</a>
</p>
</li>
<li>
<p>
Everything directly started from <tt>init.rc</tt> (including the <tt>system_server</tt>) has its <tt>oom_adj</tt> set to <tt>-16</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
If we get to killing those, the system is toast anyway
</p>
</li>
</ul></div>
</li>
<li>
<p>
Applications can request that they be kept persistent (in memory) by setting <tt>&lt;application android:persistent="true" ...&gt;</tt> in their <tt>AndroidManifest.xml</tt> file
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>ActivityManager</tt> then starts persistent apps and initializes their <tt>oom_adj</tt> to <tt>-12</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Logger">2.1.9. Logger</h4>
<div class="ulist"><ul>
<li>
<p>
System-wide logging facility (from Kernel all the way to apps)
</p>
</li>
<li>
<p>
This is what <tt>logcat</tt> command reads from
</p>
</li>
<li>
<p>
Supports four auto-rotating log buffers managed by the kernel
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/dev/log/main</tt> (64KB)
</p>
<div class="ulist"><ul>
<li>
<p>
Destination for Android apps
</p>
</li>
<li>
<p>
Most logging happens via <tt>android.util.Log</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/dev/log/system</tt> (64KB)
</p>
<div class="ulist"><ul>
<li>
<p>
Destination for Android framework&#8217;s system services and libraries
</p>
</li>
<li>
<p>
Most logging happens via hidden <tt>android.util.Slog</tt> or directly via <tt>liblog</tt> library
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/dev/log/events</tt> (256KB)
</p>
<div class="ulist"><ul>
<li>
<p>
Destination for Android system diagnostic events - e.g. garbage collections, activity manager state, system watchdogs, and other low level activity
</p>
</li>
<li>
<p>
Logging via <tt>android.util.EventLog</tt> or directly via <tt>liblog</tt> library
</p>
</li>
<li>
<p>
Binary-encoded - can be decoded via <tt>/system/etc/event-log-tags</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/dev/log/radio</tt> (64KB)
</p>
<div class="ulist"><ul>
<li>
<p>
Destination for radio and phone-related information
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Log reading and writing is done via normal Linux file I/O
</p>
<div class="ulist"><ul>
<li>
<p>
Calls to <tt>open()</tt>, <tt>write()</tt>, and <tt>close()</tt> are extremely low-overhead on these devices
</p>
</li>
<li>
<p>
Each <tt>read()</tt> returns exactly one log entry (up to 4KB) and can be both blocking and non-blocking
</p>
</li>
</ul></div>
</li>
<li>
<p>
Implementation at <tt>drivers/misc/logger.c</tt> (with a <tt>logger.h</tt> in the same directory)
</p>
</li>
<li>
<p>
Supports a number of <tt>ioctl()</tt>-s: <tt>LOGGER_GET_LOG_BUF_SIZE</tt>, <tt>LOGGER_GET_LOG_LEN</tt>, <tt>LOGGER_GET_NEXT_ENTRY_LEN</tt>, <tt>LOGGER_FLUSH_LOG</tt>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Paranoid_Network_Security">2.1.10. Paranoid Network Security</h4>
<div class="ulist"><ul>
<li>
<p>
Restricts access to some networking features depending on the group of the calling process
</p>
</li>
<li>
<p>
Enabled via <tt>CONFIG_ANDROID_PARANOID_NETWORK</tt> kernel build option, which defines process group IDs that have special network access:
</p>
<div class="listingblock">
<div class="title"><tt>include/linux/android_aid.h</tt> (kernel source-tree):</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> AID_NET_BT_ADMIN <span style="color: #993399">3001</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> AID_NET_BT       <span style="color: #993399">3002</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> AID_INET         <span style="color: #993399">3003</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>net/ipv4/af_inet.c</tt> (kernel source-tree):</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;linux/android_aid.h&gt;</span>

<span style="font-weight: bold"><span style="color: #0000FF">static</span></span> inline <span style="color: #008080">int</span> <span style="font-weight: bold"><span style="color: #000000">current_has_network</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">in_egroup_p</span></span><span style="color: #990000">(</span>AID_INET<span style="color: #990000">)</span> <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #000000">capable</span></span><span style="color: #990000">(</span>CAP_NET_RAW<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>
<span style="color: #990000">...</span>
<span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">inet_create</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">net</span> <span style="color: #990000">*</span>net<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">socket</span> <span style="color: #990000">*</span>sock<span style="color: #990000">,</span> <span style="color: #009900">int</span> protocol<span style="color: #990000">)</span>
<span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(!</span><span style="font-weight: bold"><span style="color: #000000">current_has_network</span></span><span style="color: #990000">())</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span>EACCES<span style="color: #990000">;</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Also in <tt>net/ipv6/af_inet6.c</tt> and <tt>net/bluetooth/af_bluetooth.c</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
These are re-defined for Android user-space and assigned logical group-names
</p>
<div class="listingblock">
<div class="title"><tt>system/core/include/private/android_filesystem_config.h</tt> (Android source-tree)</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">...</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> AID_NET_BT_ADMIN  <span style="color: #993399">3001</span>  <span style="font-style: italic"><span style="color: #9A1900">/* bluetooth: create any socket */</span></span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> AID_NET_BT        <span style="color: #993399">3002</span>  <span style="font-style: italic"><span style="color: #9A1900">/* bluetooth: create sco, rfcomm or l2cap sockets */</span></span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> AID_INET          <span style="color: #993399">3003</span>  <span style="font-style: italic"><span style="color: #9A1900">/* can create AF_INET and AF_INET6 sockets */</span></span>
<span style="color: #990000">...</span>
<span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #008080">android_id_info</span> android_ids<span style="color: #990000">[]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
    <span style="color: #990000">...</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"net_bt_admin"</span><span style="color: #990000">,</span>     AID_NET_BT_ADMIN<span style="color: #990000">,</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"net_bt"</span><span style="color: #990000">,</span>           AID_NET_BT<span style="color: #990000">,</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
    <span style="color: #FF0000">{</span> <span style="color: #FF0000">"inet"</span><span style="color: #990000">,</span>             AID_INET<span style="color: #990000">,</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #990000">...</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #990000">...</span></tt></pre></div></div>
</li>
<li>
<p>
Android app permissions are then mapped to group names
</p>
<div class="listingblock">
<div class="title"><tt>/system/etc/permissions/platform.xml</tt> (system image)</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;permissions&gt;</span></span>
  ...
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.BLUETOOTH_ADMIN"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;group</span></span> <span style="color: #009900">gid</span><span style="color: #990000">=</span><span style="color: #FF0000">"net_bt_admin"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/permission&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.BLUETOOTH"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;group</span></span> <span style="color: #009900">gid</span><span style="color: #990000">=</span><span style="color: #FF0000">"net_bt"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/permission&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.INTERNET"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;group</span></span> <span style="color: #009900">gid</span><span style="color: #990000">=</span><span style="color: #FF0000">"inet"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/permission&gt;</span></span>
  ...
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/permissions&gt;</span></span></tt></pre></div></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Linux_Kernel_Other_Changes">2.1.11. Other Kernel Changes</h4>
<div class="ulist"><ul>
<li>
<p>
Timed output / Timed GPIO
</p>
<div class="ulist"><ul>
<li>
<p>
Generic GPIO allows user space to access and manipulate GPIO registers
</p>
</li>
<li>
<p>
Timed GPIO allows changing a GPIO pin and having it restored automatically after a specified timeout
</p>
</li>
<li>
<p>
Implementation at <tt>drivers/android/timed_output.c</tt> and <tt>drivers/android/timed_gpio.c</tt>
</p>
</li>
<li>
<p>
Used by the vibrator by default
</p>
</li>
</ul></div>
</li>
<li>
<p>
Linux Scheduler
</p>
<div class="ulist"><ul>
<li>
<p>
Not a custom scheduler, just Android-specific configuration in <tt>init.rc</tt>
</p>
<div class="listingblock">
<div class="content">
<pre><tt>write /proc/sys/kernel/panic_on_oops 1
write /proc/sys/kernel/hung_task_timeout_secs 0
write /proc/cpu/alignment 4
write /proc/sys/kernel/sched_latency_ns 10000000
write /proc/sys/kernel/sched_wakeup_granularity_ns 2000000
write /proc/sys/kernel/sched_compat_yield 1
write /proc/sys/kernel/sched_child_runs_first 0</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Switch events - userspace support for monitoring GPIO used by <tt>vold</tt> to detect USB
</p>
</li>
<li>
<p>
USB gadget driver for ADB (<tt>drivers/usb/gadget/android.c</tt>)
</p>
</li>
<li>
<p>
yaffs2 flash filesystem, though this is switching to ext4
</p>
</li>
<li>
<p>
RAM console
</p>
<div class="ulist"><ul>
<li>
<p>
Kernel&#8217;s <tt>printk</tt> goes to a RAM buffer
</p>
</li>
<li>
<p>
A kernel panic can be viewed in the next kernel invocation via <tt>/proc/last_kmsg</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Support in FAT filesystem for <tt>FVAT_IOCTL_GET_VOLUME_ID</tt>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="Android_Native_Layer">2.2. Android User-Space Native Layer</h3>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="images/AndroidStack-NativeLayer.svg" alt="images/AndroidStack-NativeLayer.svg" />
</div>
<div class="title">Figure 2. Android User-Space Native Layer</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Android user-space native layer is divided into multiple "logical" categories
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="Android_Native_Layer_Bionic">2.2.1. Bionic Library</h4>
<div class="ulist"><ul>
<li>
<p>
Custom standard C library (libc) derived from BSD optimized for Android
</p>
</li>
<li>
<p>
Why Bionic?
</p>
<div class="ulist"><ul>
<li>
<p>
BSD licensed (business-friendly - i.e. keeps GPL out of user-space)
</p>
<div class="ulist"><ul>
<li>
<p>
Proprietary code linked to bionic can remain proprietary
</p>
</li>
</ul></div>
</li>
<li>
<p>
Lean (~200KB, or about half the size of glibc)
</p>
<div class="ulist"><ul>
<li>
<p>
It is loaded into every process, so it needs to be small
</p>
</li>
</ul></div>
</li>
<li>
<p>
Fast (custom pthread impl) - perfect for embedded use
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_changes_from_bsd_libc">2.2.2. Changes From BSD libc</h4>
<div class="ulist"><ul>
<li>
<p>
Support for arbitrary Android system-properties via <tt>&lt;sys/system_properties.h&gt;</tt>
</p>
</li>
<li>
<p>
Support for Android Kernel Logger Driver (via <tt>liblog</tt>)
</p>
</li>
<li>
<p>
Support for Android-specific user/group management
</p>
<div class="ulist"><ul>
<li>
<p>
Enabled via <tt>getpwnam()</tt>, <tt>getgrouplist()</tt>, and, <tt>getgrgid()</tt>, which are aware of generated UIDs of the applications (&gt;10000) and their corresponding synthetic user/group-names (e.g. app_123)
</p>
</li>
<li>
<p>
Basic UID/GIDs defined in <tt>/system/core/include/private/android_filesystem_config.h</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Support for Android-specific <tt>getservent()</tt>, <tt>getservbyport()</tt>, and <tt>getservbyname()</tt> in place of <tt>/etc/services</tt>
</p>
</li>
<li>
<p>
No support for <tt>/etc/protocol</tt>
</p>
</li>
<li>
<p>
"Clean" kernel headers that allow user-space to use kernel-specific declarations (e.g. ioctl&#8217;s, structure declarations, constants, etc.)
</p>
</li>
<li>
<p>
Custom pthread implementation based on Linux futexes
</p>
<div class="ulist"><ul>
<li>
<p>
Bundled-in (i.e. <tt>-lpthread</tt> not required)
</p>
</li>
<li>
<p>
Optimized for embedded use - strives to provide <strong>very</strong> short code paths for common operations
</p>
<div class="ulist"><ul>
<li>
<p>
Normal, recursive and error-check mutexes are supported
</p>
</li>
<li>
<p>
No support for process-shared mutexes and condition variables (use Android&#8217;s own Binder-IPC instead) as well as read/write locks, priority-ceiling in mutexes, <tt>pthread_cancel()</tt>, and other more advanced features (not a priority for embedded use)
</p>
</li>
<li>
<p>
Provides only 64 as opposed to 128 thread-specific storage slots required by POSIX
</p>
</li>
<li>
<p>
No support for read/write memory barriers (restricts SMP/multi-core on certain architectures)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Does not support all the relocations generated by other GCC ARM toolchains
</p>
</li>
</ul></div>
</li>
<li>
<p>
No support for System V IPCs - to avoid denial-of-service
</p>
<div class="ulist"><ul>
<li>
<p>
SysV has no way to automatically release a semaphore allocated in the kernel when
</p>
<div class="ulist"><ul>
<li>
<p>
a buggy or malicious process exits
</p>
</li>
<li>
<p>
a non-buggy and non-malicious process crashes or is explicitly killed (e.g. via low-memory-killer)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Again, we use Android&#8217;s own Binder-IPC instead
</p>
</li>
</ul></div>
</li>
<li>
<p>
No support for locales (I18N done at the application/Dalvik layer via well-defined resource mechanism)
</p>
<div class="ulist"><ul>
<li>
<p>
No support for wide chars (i.e. multi-byte characters)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>time_t</tt> is 32-bit on 32-bit hardware
</p>
</li>
<li>
<p>
Timezones are defined via <tt>TZ</tt> env-vars or via <tt>persist.sys.timezone</tt> system property
</p>
</li>
<li>
<p>
NetBSD-derived DNS resolver library
</p>
<div class="ulist"><ul>
<li>
<p>
Reads from <tt>/system/etc/resolv.conf</tt>
</p>
</li>
<li>
<p>
Uses name servers defined in <tt>net.dns1</tt>, <tt>net.dns2</tt> system properties
</p>
<div class="ulist"><ul>
<li>
<p>
Can be process specific: <tt>net.dns1.&lt;pid&gt;</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Built-in linker
</p>
<div class="ulist"><ul>
<li>
<p>
Support pre-linked mapping files
</p>
</li>
</ul></div>
</li>
<li>
<p>
Support for x86, ARM and ARM thumb CPU instruction sets and kernel interfaces
</p>
</li>
<li>
<p>
<strong>Not binary compatible</strong> with any other known Linux C library (glibc, ucLibc, etc.)
</p>
<div class="ulist"><ul>
<li>
<p>
Not event fully POSIX-compliant
</p>
</li>
<li>
<p>
No support for C++ exceptions
</p>
</li>
<li>
<p>
<strong>Requires recompile</strong> of existing legacy code against bionic
</p>
</li>
</ul></div>
</li>
<li>
<p>
See <tt>ndk/docs/system/libc/OVERVIEW.html</tt> for more info (in the Android source tree)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Native_Layer_HAL">2.2.3. User-space Hardware Abstraction Layer (HAL)</h4>
<div class="ulist"><ul>
<li>
<p>
User-space C/C++ hardware abstraction layer - as shared libraries
</p>
</li>
<li>
<p>
Communicate with Linux drivers via <tt>/dev/</tt>, <tt>/sys/</tt>, or <tt>/proc/</tt>
</p>
</li>
<li>
<p>
Why not just use Linux drivers directly?
</p>
<div class="ulist"><ul>
<li>
<p>
Separates Android platform logic from specific hardware interfaces
</p>
</li>
<li>
<p>
Linux does not have common definitions of hardware that upper layers depend on
</p>
</li>
<li>
<p>
User-space HAL offer <em>standard</em> "driver" definitions for graphics, audio, camera, bluetooth, GPS, radio (RIL), WiFi, etc.
</p>
</li>
<li>
<p>
Makes porting easier
</p>
</li>
</ul></div>
</li>
<li>
<p>
OEMs implement "drivers" for specific hardware as shared libraries
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>libhardware</tt>
</p>
</li>
<li>
<p>
<tt>libhardware_legacy</tt>
</p>
</li>
<li>
<p>
The code can remain proprietary since the user-space drivers link against bionic, not the kernel (i.e. no GPL)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Platform loads these HAL libs at runtime via pre-determined naming strategies
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>libhardware</tt> is a simple shared library that can load device-specific shared libraries via <tt>hw_get_module(const char *id, const struct hw_module_t **module)</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
First checks under <tt>/vendor/lib/hw/</tt> and then <tt>/system/lib/hw/</tt> as follows:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>&lt;*_HARDWARE_MODULE_ID&gt;.&lt;ro.product.board&gt;.so</tt>
</p>
</li>
<li>
<p>
<tt>&lt;*_HARDWARE_MODULE_ID&gt;.&lt;ro.board.platform&gt;.so</tt>
</p>
</li>
<li>
<p>
<tt>&lt;*_HARDWARE_MODULE_ID&gt;.&lt;ro.arch&gt;.so</tt>
</p>
</li>
<li>
<p>
<tt>&lt;*_HARDWARE_MODULE_ID&gt;.default.so</tt>
</p>
</li>
</ol></div>
</li>
<li>
<p>
For example, on a Nexus S (where <tt>TARGET_BOARD_PLATFORM=s5pc110</tt>, <tt>board=herring</tt>, and <tt>/vendor/</tt> &#8594; <tt>/system/vendor</tt>)
</p>
<div class="ulist"><ul>
<li>
<p>
The GPS "driver" is loaded from <tt>/system/vendor/lib/hw/gps.s5pc110.so</tt> (where <tt>GPS_HARDWARE_MODULE_ID="gps"</tt>)
</p>
</li>
<li>
<p>
The Sensors "driver" is loaded from <tt>/system/lib/hw/sensors.herring.so</tt> (where <tt>SENSORS_HARDWARE_MODULE_ID="sensors"</tt>)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
<tt>libhardware_legacy</tt> is a shared library for  vibrator, wifi-module-loader, power, uevent, audio, camera, etc.
</p>
<div class="ulist"><ul>
<li>
<p>
Some board-independent hardware (like vibrator, power, wifi, etc.) is directly supported by <tt>/system/lib/libhardware_legacy.so</tt> via well-defined paths on the file system (mostly via <tt>/proc</tt> or <tt>/sys</tt>) or well-defined system properties
</p>
</li>
<li>
<p>
Board-specific devices (like audio, camera, etc.) are supported by separate shared libraries loaded by well-defined names (e.g. <tt>/system/lib/libaudio.so</tt>, <tt>/system/lib/libcamera.so</tt>, etc.)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Radio is a bit special, as its <tt>rild</tt> (Radio Interface Link Daemon) loads "libril" as defined by <tt>rild.libpath</tt> system property
</p>
<div class="ulist"><ul>
<li>
<p>
On Nexus S, this is <tt>/vendor/lib/libsec-ril.so</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Native_Layer_Daemons">2.2.4. Native Daemons</h4>
<div class="ulist"><ul>
<li>
<p>
<tt>/system/bin/servicemanager</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<em>The naming service</em> for all other <tt>systemserver</tt>'s (i.e. framework) services
</p>
</li>
<li>
<p>
Registers as <tt>BINDER_SET_CONTEXT_MGR</tt> on <tt>/dev/binder</tt> and starts reading from it (in a loop)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/vold</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Volume Daemon used for mounting/unmounting removable media (like <tt>/mnt/sdcard</tt>) on demand
</p>
</li>
<li>
<p>
Configured via <tt>/system/etc/vold.fstab</tt>
</p>
</li>
<li>
<p>
For example, Nexus One&#8217;s SD Card is automatically re/mounted:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>dev_mount sdcard /mnt/sdcard auto /devices/platform/goldfish_mmc.0 /devices/platform/msm_sdcc.2/mmc_host/mmc1</tt></pre>
</div></div>
</li>
<li>
<p>
While Nexus S, has a "virtual" but fixed SDCard:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>dev_mount sdcard /mnt/sdcard 3 /devices/platform/s3c-sdhci.0/mmc_host/mmc0/mmc0:0001/block/mmcblk0</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/rild</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Acts as a bridge between platform framework services (<tt>TelephonyManager</tt>) and <tt>libril</tt>, which is OEM-specific interface to the baseband modem
</p>
</li>
<li>
<p>
Stateful - helps handle incoming calls/messages (unsolicited requests)
</p>
</li>
<li>
<p>
Interfaces with upper layers via a Unix socket connection
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/netd</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Manages network connections, routing, PPP, etc.
</p>
</li>
<li>
<p>
Enables tethering, connections over USB/Bluetooth, etc.
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/mediaserver</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Home of <tt>AudioFlinger</tt>, <tt>MediaPlayerService</tt>, <tt>CameraService</tt>, <tt>AudioPolicyService</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/installd</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Listens on a unix socket and performs installation/uninstallation of packages (i.e. apps)
</p>
</li>
<li>
<p>
Used by the <tt>PackageManager</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/keystore</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Listens on a unix socket and provides secured storage for key-value pairs
</p>
</li>
<li>
<p>
Keys are encoded in file names, and values are encrypted with checksums
</p>
</li>
<li>
<p>
The encryption key is protected by a user-defined password
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/debuggerd</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Catches crashes of native processes and dumps their stack trace to <tt>/data/tombtones/</tt>
</p>
</li>
<li>
<p>
When native processes initialize, they implicitly connect (through a unix socket) to <tt>debuggerd</tt> through a separate thread spawned by bionic
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/wpa_supplicant</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Handles WPA authentication for WiFi networks
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/dhcpd</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Requests (leases) IPs from DHCP servers
</p>
</li>
<li>
<p>
Handles network changes (e.g. 3G to Wifi)
</p>
</li>
</ul></div>
</li>
<li>
<p>
BlueZ (Bluetooth support daemons)
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/system/bin/dbus-daemon</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
A simple IPC (bus) framework
</p>
</li>
<li>
<p>
Provides <tt>systemserver</tt> with a way to access <tt>hcid</tt> (Bluetooth Host Controller Interface Daemon)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/bluetoothd</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Manages device pairings and the rest of the stack
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/sdptool</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Used to manage individual Bluetooth profile as services
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>hfag</tt> - Hands-Free Profile
</p>
</li>
<li>
<p>
<tt>hsag</tt> - Headset Profile
</p>
</li>
<li>
<p>
<tt>opush</tt> - Object Push Profile
</p>
</li>
<li>
<p>
<tt>pbap</tt> - Phonebook-Access Profile
</p>
</li>
<li>
<p>
etc.
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/racoon</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Assists with ipsec key negotiations (IKE)
</p>
</li>
<li>
<p>
Used for VPN connections
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/ueventd</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Handles uevents from the Kernel and sets up correct ownership/permissions on the device file descriptors
</p>
</li>
<li>
<p>
Applies configuration from <tt>/ueventd.rc</tt>
</p>
<div class="listingblock">
<div class="content">
<pre><tt>...
/dev/urandom              0666   root       root
/dev/ashmem               0666   root       root
/dev/binder               0666   root       root
...
/dev/log/*                0662   root       log
...
/dev/ttyMSM0              0600   bluetooth  bluetooth
...
/dev/alarm                0664   system     radio
...
/dev/cam                  0660   root       camera
...
/dev/akm8976_pffd         0640   compass    system
/dev/lightsensor          0640   system     system
...
/dev/bus/usb/*            0660   root       usb
/sys/devices/virtual/input/input*   enable      0660  root   input
...</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/sbin/adbd</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
End-point of Android Debug Bridge
</p>
</li>
<li>
<p>
Accepts ADB connections over USB
</p>
</li>
<li>
<p>
Possible to accept network connections as well
</p>
</li>
</ul></div>
</li>
<li>
<p>
Vendor-specific daemons which fasciliate interaction with the hardware
</p>
<div class="ulist"><ul>
<li>
<p>
For example <tt>/system/vendor/bin/gpsd</tt> on Nexus S
</p>
</li>
</ul></div>
</li>
<li>
<p>
Other daemons, like <tt>zygote</tt> and <tt>systemserver</tt> will be discussed separately
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Native_Layer_Flingers">2.2.5. Flingers</h4>
<div class="sect4">
<h5 id="Android_Native_Layer_Surface_Flinger">Surface Flinger</h5>
<div class="ulist"><ul>
<li>
<p>
<tt>SurfaceFlinger</tt> is Android&#8217;s system-wide screen composer that draws into standard Linux frame-buffer (<tt>/dev/fb0</tt>)
</p>
</li>
<li>
<p>
Apps draw (in 2D or 3D) into "windows", which are implemented as double-buffered <tt>Surface</tt> objects backed by the surface flinger
</p>
<div class="ulist"><ul>
<li>
<p>
Front-buffer used for composition, back-buffer for drawing
</p>
</li>
<li>
<p>
Buffers are flipped after drawing
</p>
<div class="ulist"><ul>
<li>
<p>
Minimal buffer copying
</p>
</li>
<li>
<p>
Avoids flickers and artifacts as the front-buffer is always available for composition
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Surface flinger expects the video driver to offer:
</p>
<div class="ulist"><ul>
<li>
<p>
A linear address space of mappable memory
</p>
<div class="ulist"><ul>
<li>
<p>
Video memory is <tt>mmap()</tt>'ed to process address-space for direct writing
</p>
</li>
<li>
<p>
Enough video memory for twice the physical screen area
</p>
<div class="ulist"><ul>
<li>
<p>
Otherwise, regular system memory has to be used for buffering, and is copied on flips (slow!)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Support for RGB 565 pixel format
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="Android_Native_Layer_Audio_Flinger">Audio Flinger</h5>
<div class="ulist"><ul>
<li>
<p>
<tt>AudioFlinger</tt> is Android&#8217;s system-wide audio stream routing engine/mixer and audio input capture facility
</p>
<div class="ulist"><ul>
<li>
<p>
Sits on top of device-specific <tt>libaudio.so</tt> implementation, which usually simply bridges to ALSA
</p>
</li>
</ul></div>
</li>
<li>
<p>
To play audio, apps send uncompressed mono/stereo PCM streams to audio flinger (usually via <tt>MediaPlayer</tt>)
</p>
<div class="ulist"><ul>
<li>
<p>
Streams include ringtones, notifications, voice calls, touch tones, key tones, music
</p>
</li>
<li>
<p>
Audio flinger routes these streams to various outputs (earpiece, speakers, Bluetooth)
</p>
</li>
</ul></div>
</li>
<li>
<p>
To capture audio, apps request access to uncompressed input path managed by the audio flinger (usually via <tt>MediaRecorder</tt>)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect3">
<h4 id="Android_Native_Layer_Function_Libraries">2.2.6. Function Libraries</h4>
<div class="ulist"><ul>
<li>
<p>
Provide computation-intensive services to the rest of the platform
</p>
<div class="ulist"><ul>
<li>
<p>
This is in addition to bionic
</p>
</li>
</ul></div>
</li>
<li>
<p>
Many pieces borrowed from other open source projects
</p>
<div class="ulist"><ul>
<li>
<p>
LibWebCore/WebKit, V8, SQLite, OpenSSL, FreeType, etc.
</p>
</li>
<li>
<p>
Usually abstracted by Java counterparts
</p>
</li>
</ul></div>
</li>
<li>
<p>
Media Framework Libraries
</p>
<div class="ulist"><ul>
<li>
<p>
Originally based on PacketVideo&#8217;s OpenCORE platform
</p>
</li>
<li>
<p>
Switched to Stagefright with Gingerbread
</p>
</li>
<li>
<p>
Support for playback and recording of many popular audio and video formats, as well as static image files
</p>
<div class="ulist"><ul>
<li>
<p>
MPEG4, H.264, VP8/WebM, MP3, AAC, AMR, JPG, and PNG
</p>
</li>
</ul></div>
</li>
<li>
<p>
Pluggable via Khronos' OpenMAX IL (supports for codecs in both software and hardware)
</p>
</li>
</ul></div>
</li>
<li>
<p>
3D libraries
</p>
<div class="ulist"><ul>
<li>
<p>
Support for OpenGL ES 1.0 and 2.0 APIs
</p>
</li>
<li>
<p>
Comes with highly optimized 3D software rasterizer - when hardware does not offer native OpenGL support
</p>
</li>
</ul></div>
</li>
<li>
<p>
2D libraries
</p>
<div class="ulist"><ul>
<li>
<p>
SGL (Skia) - the underlying 2D graphics engine
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Native_Layer_Dalvik">2.2.7. Dalvik</h4>
<div class="imageblock">
<div class="content">
<img src="images/Stack-Dalvik-Dan.png" alt="images/Stack-Dalvik-Dan.png" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Dalvik is a custom clean-room implementation of a virtual machine, semantically similar to a JVM but <strong>not</strong> a JVM
</p>
<div class="ulist"><ul>
<li>
<p>
Licensed under Apache 2.0 open-source license
</p>
</li>
</ul></div>
</li>
<li>
<p>
Provides Android app portability and consistency across various hardware (like a JVM)
</p>
</li>
<li>
<p>
Runs Dalvik byte-code, stored in <tt>.dex</tt> files (<strong>not</strong> Java byte code)
</p>
<div class="ulist"><ul>
<li>
<p>
Developers program in the Java language (i.e. <tt>.java</tt> files), which get compiled into Java byte-code (i.e. <tt>.class</tt> files)
</p>
</li>
<li>
<p>
Build-tools compile Java&#8217;s <tt>.class</tt> files into a <tt>.dex</tt> file before packaging (into <tt>.apk</tt> files)
</p>
<div class="ulist"><ul>
<li>
<p>
3rd party libraries are also re-compiled into dex code
</p>
</li>
</ul></div>
</li>
<li>
<p>
Dalvik never sees any Java byte-code
</p>
</li>
</ul></div>
</li>
<li>
<p>
Why not Java SE?
</p>
<div class="ulist"><ul>
<li>
<p>
Java SE is too bloated for mobile environment
</p>
</li>
<li>
<p>
Would require too much redundancy (at the library level)
</p>
</li>
<li>
<p>
Not well-optimized for mobile (at the bytecode and interpreter level)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Why not Java ME?
</p>
<div class="ulist"><ul>
<li>
<p>
Costs $$$ - hinders adoption
</p>
</li>
<li>
<p>
Designed by a committee - hard to imagine iOS-like developer appeal
</p>
</li>
<li>
<p>
Apps share a single VM - not great for security sandboxing
</p>
</li>
<li>
<p>
Apps are second-rate citizens - don&#8217;t get access to all the hardware
</p>
</li>
</ul></div>
</li>
<li>
<p>
Dalvik is optimized for embedded environment:
</p>
<div class="ulist"><ul>
<li>
<p>
Minimal-memory footprint while providing a secure sandboxing model
</p>
<div class="ulist"><ul>
<li>
<p>
Uncompressed <tt>.dex</tt> files are smaller than compressed <tt>.jar</tt> files due to more efficient bytecode
</p>
<div class="ulist"><ul>
<li>
<p>
On average Dalvik byte code is 30% smaller than JVM byte code
</p>
</li>
<li>
<p>
Multiple classes in one <tt>.dex</tt> file
</p>
</li>
<li>
<p>
Shared constant pool (assumes 32-bit indexes)
</p>
</li>
<li>
<p>
Simpler class-loading
</p>
</li>
<li>
<p>
Because it is uncompressed, dex code can be memory-mapped and shared (i.e. <tt>mmap()</tt>-ed)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Each app runs in a separate instance of Dalvik
</p>
<div class="ulist"><ul>
<li>
<p>
At startup, system launches <tt>zygote</tt>, a half-baked Dalvik process, which is forked any time a new VM is needed
</p>
</li>
<li>
<p>
Due to copy-on-write support, large sections of the heap are shared (including 1800+ preloaded classes)
</p>
</li>
<li>
<p>
Since each VM runs in a separate process, we get great security isolation
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Register-based fixed-width CPU-optimized byte-code interpreter
</p>
<div class="ulist"><ul>
<li>
<p>
Standard JVM bytecode executes 8-bit stack instructions - local variables must be copied to or from the operand stack by separate instructions
</p>
<div class="ulist"><ul>
<li>
<p>
Memory speed to CPU speed is amplified on mobile CPUs - we want to minimize access to the main memory
</p>
</li>
</ul></div>
</li>
<li>
<p>
Dalvik uses 16-bit instruction set that works directly on local variables (managed via a 4-bit virtual register field)
</p>
</li>
</ul></div>
</li>
<li>
<p>
With JIT support, as of Froyo (2-5x performance improvement in CPU-bound code)
</p>
<div class="ulist"><ul>
<li>
<p>
Trace-level granularity (more optimal than whole method-level compilations)
</p>
</li>
<li>
<p>
Fast context-switching (interpreted mode to native mode and back)
</p>
</li>
<li>
<p>
Well-balanced from performance vs. memory overhead perspective (~ 100-200KB overhead per app)
</p>
</li>
<li>
<p>
~ 1:8 ratio of Dalvik to native code (mostly due to optimizations, like inlining)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Includes support for instrumentation to allow tracing and profiling of running code
</p>
</li>
<li>
<p>
Core libraries based on Java SE 5 (mostly from Apache Harmony), with many differences
</p>
<div class="ulist"><ul>
<li>
<p>
No support for <tt>java.applet</tt>, <tt>java.awt</tt>, <tt>java.lang.management</tt> and <tt>javax.management</tt> (JMX), <tt>java.rmi</tt> and <tt>javax.rmi</tt>, <tt>javax.accessibiliy</tt>, <tt>javax.activity</tt>, <tt>javax.imageio</tt>, <tt>javax.naming</tt> (JNDI), <tt>javax.print</tt>, <tt>javax.security.auth.kerberos</tt>, <tt>javax.security.auth.spi</tt>, <tt>javax.security.spi</tt>, <tt>javax.security.sasl</tt>, <tt>javax.sound</tt>, <tt>javax.swing</tt>, <tt>javax.transaction</tt>, <tt>javax.xml</tt> (except for javax.xml.parsers), <tt>org.ietf</tt>, <tt>org.omg</tt>, <tt>org.w3c.dom.*</tt> (subpackages)
</p>
</li>
<li>
<p>
But support for Android APIs (including wrappers for OpenGL, SQLite, etc.), Apache HTTP Client (<tt>org.apache.http</tt>), JSON parser (<tt>org.json</tt>), XML SAX parser (<tt>org.xml.sax</tt>), XML Pull Parser (<tt>org.xmlpull</tt>), etc.
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="imageblock">
<div class="content">
<img src="images/Dalvik-LicensePlate.png" alt="images/Dalvik-LicensePlate.png" />
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="Android_Application_Framework_Layer">2.3. Android Application Framework Layer</h3>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="images/AndroidStack-ApplicationFramework.svg" alt="images/AndroidStack-ApplicationFramework.svg" />
</div>
<div class="title">Figure 3. Android Application Framework Layer</div>
</div>
<div class="sect3">
<h4 id="_overview_3">2.3.1. Overview</h4>
<div class="ulist"><ul>
<li>
<p>
The rich set of system services wrapped in intuitive Java APIs
</p>
<div class="ulist"><ul>
<li>
<p>
Most managed by the <tt>systemserver</tt> process and accessible via Binder/AIDL
</p>
</li>
</ul></div>
</li>
<li>
<p>
Abstraction of hardware services
</p>
<div class="ulist"><ul>
<li>
<p>
Location, telephony, WiFi, Bluetooth, sensors, camera, etc.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Java-language bindings for the native libraries (e.g. OpenGL, SQLite)
</p>
</li>
<li>
<p>
Core platform services (like life-cycle management)
</p>
<div class="ulist"><ul>
<li>
<p>
Essential to the apps, even if most are not used directly
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="imageblock">
<div class="content">
<img src="images/AndroidFooService.svg" alt="images/AndroidFooService.svg" />
</div>
</div>
</div>
<div class="sect3">
<h4 id="Android_Activity_Manager_Service">2.3.2. Activity Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Manages lifecycle of applications and their components
</p>
<div class="ulist"><ul>
<li>
<p>
Sets up <tt>oom_ajd</tt> setting read by Low Memory Killer (<a href="#Android_Linux_Kernel_Low_Memory_Killer">[Android_Linux_Kernel_Low_Memory_Killer]</a>) Android extension to the Linux kernel
</p>
</li>
</ul></div>
</li>
<li>
<p>
Handles application requests to <tt>startActivity()</tt>, <tt>sendBroadcast()</tt>, <tt>startService()</tt>, <tt>bindService()</tt>, etc.
</p>
<div class="ulist"><ul>
<li>
<p>
Enforces security permissions on those requests
</p>
</li>
</ul></div>
</li>
<li>
<p>
Maintains user task state - i.e. the back-stack
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Package_Manager_Service">2.3.3. Package Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Along with <tt>installd</tt> responsible for installation of <tt>.apk</tt>-s on the Android system
</p>
</li>
<li>
<p>
Maintains internal data structures representing installed packages as well as their individual components
</p>
<div class="ulist"><ul>
<li>
<p>
Used by Activity Manager when handling intents (i.e. intent resolution is handled here)
</p>
</li>
<li>
<p>
Provides this info on demand to other services and apps
</p>
</li>
</ul></div>
</li>
<li>
<p>
Very central to the platform&#8217;s security
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Power_Manager_Service">2.3.4. Power Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Controls power management
</p>
</li>
<li>
<p>
Provides access to wake locks
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Alarm_Manager_Service">2.3.5. Alarm Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Manages wake-up alarms for applications
</p>
</li>
<li>
<p>
Supports inexact wakeup frequencies - helps consolidate wake-ups into fewer slots
</p>
</li>
<li>
<p>
Uses power manager for wake locks
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Notification_Manager_Service">2.3.6. Notification Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Used by apps and other services to notify the user of events that may be of interest
</p>
<div class="ulist"><ul>
<li>
<p>
This is how background events "bubble up" as notifications
</p>
</li>
</ul></div>
</li>
<li>
<p>
Supports persistent notification, as well as notifications that use LEDs, screen backlight, sound, and/or vibration to notify the user
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Keyguard_Manager_Service">2.3.7. Keyguard Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Manages locking/unlocking of the keyguard
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Location_Manager_Service">2.3.8. Location Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Handles geographic location updates (e.g. GPS) and distributes them to the listening applications
</p>
</li>
<li>
<p>
Support proximity alerts (via Intents)
</p>
</li>
<li>
<p>
Supports providers of different granularity (GPS, Network, WiFi)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Sensor_Manager_Service">2.3.9. Sensor Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Provides a uniform access to the device&#8217;s sensors
</p>
</li>
<li>
<p>
Apps request sensor notifications via this manager
</p>
<div class="ulist"><ul>
<li>
<p>
Sensor manager delivers sensor updates via a generic (timestamped) array of values (which are sensor-dependent)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Supported sensor types: accelerometer, linear acceleration, gravity, gyroscope, light, magnetic field, orientation, pressure, proximity, rotation vector, temperature
</p>
<div class="ulist"><ul>
<li>
<p>
Actual sensor support is (obviously) hardware-dependent
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Search_Manager_Service">2.3.10. Search Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Provides a framework for device-wide (global) or app-specific search
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Vibrator_Manager_Service">2.3.11. Vibrator Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Provides simplistic access to the vibrator hardware
</p>
</li>
<li>
<p>
Can be used for simple haptic feedback (using patterns)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Connectivity_Manager_Service">2.3.12. Connectivity Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Monitors network connections (Wi-Fi, GPRS, UMTS, etc.) and
</p>
<div class="ulist"><ul>
<li>
<p>
Send broadcast intents when network connectivity changes
</p>
</li>
<li>
<p>
Attempts to "fail over" to another network when connectivity to a network is lost
</p>
</li>
</ul></div>
</li>
<li>
<p>
Provides an API that allows applications to query the coarse-grained or fine-grained state of the available networks
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Wifi_Manager_Service">2.3.13. Wifi Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Unlike the connectivity manager, the Wifi Manager supports Wifi-specific operations
</p>
</li>
<li>
<p>
Provides a list and allows management of configured networks
</p>
</li>
<li>
<p>
Provides access to and management of the state of the currently active Wi-Fi network connection, if any
</p>
</li>
<li>
<p>
Enables access point scans
</p>
</li>
<li>
<p>
Broadcasts Intents on Wifi-connectivity state change events
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Telephony_Manager_Service">2.3.14. Telephony Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Provides access to information about the telephony services on the device
</p>
</li>
<li>
<p>
Apps query Telephony Manager to determine telephony services and states, as well as to access some types of subscriber information (e.g. device id)
</p>
</li>
<li>
<p>
Apps can also register a listener to receive notification of telephony state changes
</p>
</li>
<li>
<p>
Handles tethering requests
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Input_Method_Manager_Service">2.3.15. Input Method Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Central system to the overall input method framework (IMF) architecture
</p>
<div class="ulist"><ul>
<li>
<p>
Arbitrates interaction between applications (each has a separate client) and the current input method
</p>
</li>
</ul></div>
</li>
<li>
<p>
Responsible for creating and running an input method (IME) to capture the actual input and translate it into text
</p>
<div class="ulist"><ul>
<li>
<p>
Allows multiple apps to requests input focus and control over the state of IME
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_UI_Mode_Manager_Service">2.3.16. UI Mode Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Provides access to the system UI mode
</p>
<div class="ulist"><ul>
<li>
<p>
Enable/disable car-mode
</p>
</li>
<li>
<p>
Enable/disable night-mode
</p>
</li>
</ul></div>
</li>
<li>
<p>
System uses it to implement automatic UI mode changes
</p>
</li>
<li>
<p>
Apps use it to manually control UI modes of the device
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Download_Manager_Service">2.3.17. Download Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Handles long-running HTTP downloads
</p>
</li>
<li>
<p>
Clients request that a URI be downloaded to a particular destination file
</p>
</li>
<li>
<p>
The download manager handles the download in the background, taking care of HTTP interactions and retrying downloads after failures or across connectivity changes and system reboots
</p>
</li>
<li>
<p>
New as of Gingerbread (2.3, API 9)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Storage_Manager_Service">2.3.18. Storage Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Handles storage-related items such as Opaque Binary Blobs (OBBs)
</p>
</li>
<li>
<p>
"OBBs contain a filesystem that maybe be encrypted on disk and mounted on-demand from an application. OBBs are a good way of providing large amounts of binary assets without packaging them into APKs as they may be multiple gigabytes in size. However, due to their size, they&#8217;re most likely stored in a shared storage pool accessible from all programs. The system does not guarantee the security of the OBB file itself&#8230;"
</p>
<div class="ulist"><ul>
<li>
<p>
E.g. great for GPS/Mapping applications that need support for off-line maps
</p>
</li>
</ul></div>
</li>
<li>
<p>
New as of Gingerbread (2.3, API 9)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Audio_Manager_Service">2.3.19. Audio Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Provides access to volume and ringer mode control
</p>
</li>
<li>
<p>
Allows management/querying for the state of the audio system
</p>
<div class="ulist"><ul>
<li>
<p>
Set/Get the current mode: normal, ringtone, in-call, in-communications
</p>
</li>
<li>
<p>
Set/Get the current ringer mode: normal, silent, vibrate
</p>
</li>
<li>
<p>
Set/Get the state of audio channels: speaker, bluetooth headset, wired headset, speakerphone
</p>
</li>
<li>
<p>
Set/Get the volume
</p>
</li>
<li>
<p>
Get audio focus requests
</p>
</li>
</ul></div>
</li>
<li>
<p>
Allows playing of sound effects: clicks, key-presses, navigation, etc.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Window_Manager_Service">2.3.20. Window Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Manages windows (z-order) composed in a surface
</p>
</li>
<li>
<p>
Allows us to place custom views (windows)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Layout_Inflater_Manager_Service">2.3.21. Layout Inflater Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Used to instantiate layout XML files into its corresponding <tt>View</tt> object trees
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Resource_Manager_Service">2.3.22. Resource Manager Service</h4>
<div class="ulist"><ul>
<li>
<p>
Provides access to non-code resources such as localized strings, graphics, and layout files
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Additional_Manager_Services">2.3.23. Additional Manager Services</h4>
<div class="ulist"><ul>
<li>
<p>
Lights Service: handles status lights on the device
</p>
</li>
<li>
<p>
Throttle Service: answers queries about data transfer amounts and throttling
</p>
</li>
<li>
<p>
Mount Service: mount/unmount removable storage
</p>
</li>
<li>
<p>
Battery Service: reports on battery health/status
</p>
</li>
<li>
<p>
Wallpaper Service: manages changes to the wallpaper
</p>
</li>
<li>
<p>
Backup Agent: provides remote backup/restore capabilities
</p>
</li>
<li>
<p>
Bluetooth Service: manages bluetooth pairings
</p>
</li>
<li>
<p>
Headset, Dock, USB Observers: observe specific device connections
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="Android_Applications_Layer">2.4. Android Applications Layer</h3>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="images/AndroidStack-Applications.svg" alt="images/AndroidStack-Applications.svg" />
</div>
<div class="title">Figure 4. Android Applications Layer</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Android ships with a number of built-in "applications"
</p>
<div class="ulist"><ul>
<li>
<p>
These are stored on the read-only <tt>/system/</tt> partition under <tt>/system/app</tt>
</p>
</li>
<li>
<p>
Cannot be uninstalled without re-flashing the ROM
</p>
</li>
</ul></div>
</li>
<li>
<p>
An Android application is a loose set of components, which may be used as
</p>
<div class="ulist"><ul>
<li>
<p>
A single independent cohesive unit (a "traditional" application)
</p>
</li>
<li>
<p>
A set to re-usable modules used by other applications via binder and/or Intents (in form of an API)
</p>
</li>
<li>
<p>
A combination of the two
</p>
</li>
</ul></div>
</li>
<li>
<p>
Applications are distributed as APKs (ZIP-compressed <tt>.apk</tt> files) consisting of
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>AndroidManifest.xml</tt> configuration file
</p>
</li>
<li>
<p>
Dalvik byte-code (<tt>classes.dex</tt>)
</p>
</li>
<li>
<p>
Optional native code as shared libraries (typically compiled for ARM)
</p>
</li>
<li>
<p>
Optional resources including layout/menu/preference definitions, drawables, text, audio, styles, etc.
</p>
</li>
<li>
<p>
Optional assets
</p>
</li>
<li>
<p>
Signature/public key (used for signing)
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="Android_Build_In_Applications">2.4.1. Android Built-in Applications</h4>
<div class="ulist"><ul>
<li>
<p>
AccountsAndSyncSettings
</p>
</li>
<li>
<p>
Bluetooth
</p>
</li>
<li>
<p>
Browser
</p>
</li>
<li>
<p>
Calculator
</p>
</li>
<li>
<p>
Calendar
</p>
</li>
<li>
<p>
Camera
</p>
</li>
<li>
<p>
CertInstaller
</p>
</li>
<li>
<p>
Contacts
</p>
</li>
<li>
<p>
DeskClock
</p>
</li>
<li>
<p>
Email
</p>
</li>
<li>
<p>
Gallery
</p>
</li>
<li>
<p>
Gallery3D
</p>
</li>
<li>
<p>
HTMLViewer
</p>
</li>
<li>
<p>
Launcher2
</p>
</li>
<li>
<p>
Mms
</p>
</li>
<li>
<p>
Music
</p>
</li>
<li>
<p>
Nfc
</p>
</li>
<li>
<p>
PackageInstaller
</p>
</li>
<li>
<p>
Phone
</p>
</li>
<li>
<p>
Protips
</p>
</li>
<li>
<p>
Provision
</p>
</li>
<li>
<p>
QuickSearchBox
</p>
</li>
<li>
<p>
Settings
</p>
</li>
<li>
<p>
SoundRecorder
</p>
</li>
<li>
<p>
SpeechRecorder
</p>
</li>
<li>
<p>
Stk
</p>
</li>
<li>
<p>
Tag
</p>
</li>
<li>
<p>
VoiceDialer
</p>
</li>
<li>
<p>
<em>OEM-specific application packages</em>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Build_In_Content_Providers">2.4.2. Android Built-in Content Providers</h4>
<div class="ulist"><ul>
<li>
<p>
ApplicationsProvider
</p>
</li>
<li>
<p>
CalendarProvider
</p>
</li>
<li>
<p>
ContactsProvider
</p>
</li>
<li>
<p>
DownloadProvider
</p>
</li>
<li>
<p>
DrmProvider
</p>
</li>
<li>
<p>
MediaProvider
</p>
</li>
<li>
<p>
TelephonyProvider
</p>
</li>
<li>
<p>
UserDictionaryProvider
</p>
</li>
<li>
<p>
<em>OEM-specific content providers</em>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Build_In_Input_Methods">2.4.3. Android Built-in Input Methods</h4>
<div class="ulist"><ul>
<li>
<p>
LatinIME
</p>
</li>
<li>
<p>
OpenWnn
</p>
</li>
<li>
<p>
PinyinIME
</p>
</li>
<li>
<p>
<em>OEM-specific input methods (like Swype)</em>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="Android_Build_In_Wallpapers">2.4.4. Android Built-in Wallpapers</h4>
<div class="ulist"><ul>
<li>
<p>
Basic
</p>
</li>
<li>
<p>
LivePicker
</p>
</li>
<li>
<p>
MagicSmoke
</p>
</li>
<li>
<p>
MusicVisualization
</p>
</li>
<li>
<p>
<em>OEM-specific wallpapers</em>
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Android_NDK">3. Android Native Development Kit (NDK)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_in_ndk">3.1. What is in NDK?</h3>
<div class="ulist"><ul>
<li>
<p>
Android&#8217;s Dalvik VM allows our applications written in Java to call methods implemented in native code through the Java Native Interface (JNI)
</p>
<div class="ulist"><ul>
<li>
<p>
For example:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fetchurl<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FetchUrl</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="color: #009900">byte</span><span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">fetch</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> url<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #FF0000">{</span>
        System<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">loadLibrary</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fetchurl"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
NDK is a tool-chain to build and cross-compile our native code for the device-specific architecture
</p>
<div class="ulist"><ul>
<li>
<p>
At the moment, NDK supports ARMv5TE, ARMv7-A, and as of NDK r6 (July 2011) x86 ABIs
</p>
</li>
<li>
<p>
For example, we would implement native <tt>fetch</tt> method in C and compile it into a library <tt>libfetchurl.so</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
NDK offers a way to package our native code library (as <tt>lib&lt;something&gt;.so</tt>) into the APK file so we can distribute it with our application easily
</p>
<div class="ulist"><ul>
<li>
<p>
For example, our library would be packaged as <tt>libs/armeabi/libfetchurl.so</tt> in the APK
</p>
</li>
</ul></div>
</li>
<li>
<p>
NDK provides a set of native system headers that will be supported for the future releases of Android platform (<tt>libc</tt>, <tt>libm</tt>, <tt>libz</tt>, <tt>liblog</tt>, <tt>libjnigrahics</tt>, OpenGL/OpenSL ES, JNI headers, minimal C++ support headers, and Android native app APIs)
</p>
</li>
<li>
<p>
Finally, NDK comes with extensive documentation, sample code and examples
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_why_ndk">3.2. Why NDK?</h3>
<div class="ulist"><ul>
<li>
<p>
NDK allows us to develop parts of our Android application in C/C++
</p>
</li>
<li>
<p>
Generally, we do not develop native-only apps via NDK
</p>
<div class="ulist"><ul>
<li>
<p>
Android&#8217;s  Gingerbread (2.3) release supports <tt>NativeActivity</tt>, which allows handling lifecycle callbacks in native code, so we can now develop native-only apps,
</p>
<div class="ulist"><ul>
<li>
<p>
No support for native services, broadcast receivers, content providers, etc.
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
NDK code still subject to security sandboxing - we don&#8217;t get extra permissions for running natively
</p>
</li>
<li>
<p>
Main motivation for native code is performance (CPU-intensive, self-contained, low-memory footprint code) and the re-use of legacy code
</p>
<div class="ulist"><ul>
<li>
<p>
For system integrators, NDK offers access to low-level libraries (e.g. access to user-space HAL)
</p>
</li>
<li>
<p>
<strong>Using NDK always increases complexity</strong> of applications, so it should only be used when it&#8217;s essential to the application
</p>
</li>
<li>
<p>
Programming in Java offers richer APIs, memory protection and management, higher-level language constructs (OOP), all of which generally results in higher productivity
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_java_native_interface_jni">3.3. Java Native Interface (JNI)</h3>
<div class="sect3">
<h4 id="_jni_overview">3.3.1. JNI Overview</h4>
<div class="ulist"><ul>
<li>
<p>
An interface that allows Java to interact with code written in another language
</p>
</li>
<li>
<p>
Motivation for JNI
</p>
<div class="ulist"><ul>
<li>
<p>
Code reusability
</p>
<div class="ulist"><ul>
<li>
<p>
Reuse existing/legacy code with Java (mostly C/C++)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Performance
</p>
<div class="ulist"><ul>
<li>
<p>
Native code used to be up to 20 times faster than Java, when running in interpreted mode
</p>
</li>
<li>
<p>
Modern JIT compilers (HotSpot, Dalvik) make this a moot point
</p>
</li>
</ul></div>
</li>
<li>
<p>
Allow Java to tap into low level O/S, H/W routines
</p>
</li>
</ul></div>
</li>
<li>
<p>
JNI code is not portable!
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>JNI can also be used to invoke Java code from within natively-written applications - such as those written in C/C++.</p></div>
<div class="paragraph"><p>In fact, the <tt>java</tt> command-line utility is an example of one such application, that launches Java code in a Java Virtual Machine.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_jni_components">3.3.2. JNI Components</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://docs.oracle.com/javase/1.5.0/docs/tooldocs/windows/javah.html"><tt>javah</tt></a> - JDK tool that builds C-style header files from a given Java class that includes <tt>native</tt> methods
</p>
<div class="ulist"><ul>
<li>
<p>
Adapts Java method signatures to native function prototypes
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>jni.h</tt> - C/C++ header file included with the JDK that maps Java types to their native counterparts
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>javah</tt> automatically includes this file in the application header files
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_jni_by_example">3.3.3. JNI By Example</h4>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
We start by creating a Java class with one or more <tt>native</tt> methods
</p>
<div class="listingblock">
<div class="title"><tt>src/com/marakana/jniexamples/Hello.java</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>jniexamples<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Hello</span> <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">sayHi</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> who<span style="color: #990000">,</span> <span style="color: #009900">int</span> times<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/1.png" alt="1" /></span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #FF0000">{</span>
        System<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">loadLibrary</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"hello"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/2.png" alt="2" /></span></span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">(</span>String<span style="color: #990000">[]</span> args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">sayHi</span></span><span style="color: #990000">(</span>args<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">],</span> Integer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseInt</span></span><span style="color: #990000">(</span>args<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]));</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/3.png" alt="3" /></span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
The method <tt>sayHi(String, int)</tt> will be implemented in C/C++ in separate files, which will be compiled into a shared library.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Load the shared library by its <em>logical</em> name. The actual name is system-dependent:  <tt>libhello.so</tt> (on Linux/Unix), <tt>hello.dll</tt> (on Windows), and <tt>libhello.jnilib</tt> (Mac OSX).
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Here we call our <tt>native</tt> method as a regular Java method.
</td></tr>
</table></div>
</li>
<li>
<p>
Compile the Java code
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ mkdir -p bin
$ javac -d bin<span style="color: #990000">/</span> src/com/marakana/jniexamples/Hello<span style="color: #990000">.</span>java</tt></pre></div></div>
</li>
<li>
<p>
Using the <tt>javah</tt> tool, we generate the C header file from the compiled
<tt>com.marakana.jniexamples.Hello</tt> class:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ mkdir -p jni
$ javah -jni -classpath bin -d jni com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>jniexamples<span style="color: #990000">.</span>Hello</tt></pre></div></div>
</li>
<li>
<p>
Observe the generated C header file:
</p>
<div class="listingblock">
<div class="title"><tt>jni/com_marakana_jniexamples_Hello.h</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;jni.h&gt;</span>
<span style="font-style: italic"><span style="color: #9A1900">/* Header for class com_marakana_jniexamples_Hello */</span></span>

<span style="font-weight: bold"><span style="color: #000080">#ifndef</span></span> _Included_com_marakana_jniexamples_Hello
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> _Included_com_marakana_jniexamples_Hello
<span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> __cplusplus
<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #FF0000">"C"</span> <span style="color: #FF0000">{</span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Class:     com_marakana_jniexamples_Hello</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Method:    sayHi</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Signature: (Ljava/lang/String;I)V</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> Java_com_marakana_jniexamples_Hello_sayHi
  <span style="color: #990000">(</span>JNIEnv <span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jstring<span style="color: #990000">,</span> jint<span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> __cplusplus
<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Method names resolve to C functions based on a pre-defined naming strategy:
the prefix <tt>Java_</tt>, followed by a mangled fully-qualified class name, followed by an underscore ("<tt>_</tt>") separator, followed by a mangled method name. For overloaded native methods, two underscores ("<tt>__</tt>") followed by the mangled argument signature.</td>
</tr></table>
</div>
</li>
<li>
<p>
Provide the C implementation:
</p>
<div class="listingblock">
<div class="title"><tt>jni/com_marakana_jniexamples_Hello.c</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"com_marakana_jniexamples_Hello.h"</span>

JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> Java_com_marakana_jniexamples_Hello_sayHi
  <span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> who<span style="color: #990000">,</span> <span style="color: #008080">jint</span> times<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> who<span style="color: #990000">,</span> NULL<span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>name <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">jint</span> i<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> times<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello %s</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> name<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ReleaseStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> who<span style="color: #990000">,</span> name<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Most of the time, we cannot just use Java data types directly in C. For example, we have to convert <tt>java.lang.String</tt> to <tt>char *</tt> before we can effectively use it in C.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This code assumes: <tt>#define NULL ((void *) 0)</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
Compile the shared library
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ mkdir -p libs
$ gcc -o libs/libhello<span style="color: #990000">.</span>jnilib -lc -shared <span style="color: #990000">\</span>
    -I/System/Library/Frameworks/JavaVM<span style="color: #990000">.</span>framework/Headers <span style="color: #990000">\</span>
    jni/com_marakana_jniexamples_Hello<span style="color: #990000">.</span>c
$ file libs/libhello<span style="color: #990000">.</span>jnilib
libs/libhello<span style="color: #990000">.</span>jnilib<span style="color: #990000">:</span> Mach-O <span style="color: #993399">64</span>-bit dynamically linked shared library x86_64</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">On Unix/Linux, compile as:<br />
<tt>gcc -o libs/libhello.so -lc -shared -I$JAVA_HOME/include jni/com_marakana_jniexamples_Hello.c</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
Run our code
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ java -Djava<span style="color: #990000">.</span>library<span style="color: #990000">.</span><span style="color: #009900">path</span><span style="color: #990000">=</span>libs -classpath bin com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>jniexamples<span style="color: #990000">.</span>Hello Student <span style="color: #993399">5</span>
Hello Student
Hello Student
Hello Student
Hello Student
Hello Student</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Instead of specifying <tt>-Djava.library.path=libs</tt>, we could have preceded our <tt>java</tt> command with <tt>export LD_LIBRARY_PATH=libs</tt>.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Common mistakes resulting in <tt>java.lang.UnsatisfiedLinkError</tt> usually come from incorrect naming of the shared library (O/S-dependent), the library not being in the search path, or wrong library being loaded by Java code.</td>
</tr></table>
</div>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_native_method_arguments">3.3.4. Native Method Arguments</h4>
<div class="ulist"><ul>
<li>
<p>
A C/C++ implementation of a <tt>native</tt> Java method accepts the following function arguments:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>JNIEnv *env</tt>, an interface pointer (pointer to a pointer) to a <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/functions.html">function table</a>, where each entry in the table is a pointer to a function that enables Java-to-C/C++ integration (e.g. type conversion)
</p>
</li>
<li>
<p>
The second argument varies depending on whether the native method is a <tt>static</tt> method or an instance (i.e. non-<tt>static</tt>) method:
</p>
<div class="ulist"><ul>
<li>
<p>
In case of instance methods, the second argument is a <tt>jobject obj</tt>, which is a reference to the object on which the method is invoked
</p>
</li>
<li>
<p>
In case of <tt>static</tt> methods, the second is a <tt>jclass clazz</tt>, which is a reference to the class in which the method is defined
</p>
</li>
</ul></div>
</li>
<li>
<p>
The remaining arguments correspond to regular Java method arguments (subject to the mapping described below)
</p>
</li>
</ul></div>
</li>
<li>
<p>
The native function can pass its result back to Java via the return value (or return <tt>void</tt>)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_primitive_type_mapping">3.3.5. Primitive Type Mapping</h4>
<div class="ulist"><ul>
<li>
<p>
Java primitives have well-known size and are signed by default
</p>
</li>
<li>
<p>
C/C++ primitives vary in size, depending on the platform (e.g. the size of the <tt>long</tt> depends on the size of the word)
</p>
</li>
<li>
<p>
To provide inter-operability with C/C++, <tt>jni.h</tt> defines the following mappings:
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<thead>
<tr>
<th align="left" valign="top">Java Language Type </th>
<th align="left" valign="top"> Native Type </th>
<th align="left" valign="top"> Description </th>
<th align="left" valign="top"> <tt>typedef</tt> (C99) </th>
<th align="left" valign="top"> <tt>typedef</tt> (otherwise)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><tt>boolean</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jboolean</tt></p></td>
<td align="left" valign="top"><p class="table">unsigned 8 bits</p></td>
<td align="left" valign="top"><p class="table"><tt>uint8_t</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>unsigned char</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>byte</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jbyte</tt></p></td>
<td align="left" valign="top"><p class="table">signed 8 bits</p></td>
<td align="left" valign="top"><p class="table"><tt>int8_t</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>signed char</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>char</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jchar</tt></p></td>
<td align="left" valign="top"><p class="table">unsigned 16 bits</p></td>
<td align="left" valign="top"><p class="table"><tt>uint16_t</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>unsigned short</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>short</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jshort</tt></p></td>
<td align="left" valign="top"><p class="table">signed 16 bits</p></td>
<td align="left" valign="top"><p class="table"><tt>int16_t</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>short</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>int</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jint</tt></p></td>
<td align="left" valign="top"><p class="table">signed 32 bits</p></td>
<td align="left" valign="top"><p class="table"><tt>int32_t</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>int</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>long</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jlong</tt></p></td>
<td align="left" valign="top"><p class="table">signed 64 bits</p></td>
<td align="left" valign="top"><p class="table"><tt>int64_t</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>long long</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>float</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jfloat</tt></p></td>
<td align="left" valign="top"><p class="table">32-bit IEEE 754</p></td>
<td align="left" valign="top"><p class="table"><tt>float</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>float</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>double</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jdouble</tt></p></td>
<td align="left" valign="top"><p class="table">64-bit IEEE 754</p></td>
<td align="left" valign="top"><p class="table"><tt>double</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>double</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>void</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>void</tt></p></td>
<td align="left" valign="top"><p class="table">N/A</p></td>
<td align="left" valign="top"><p class="table">N/A</p></td>
<td align="left" valign="top"><p class="table">N/A</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">N/A</p></td>
<td align="left" valign="top"><p class="table"><tt>jsize</tt></p></td>
<td align="left" valign="top"><p class="table">used to describe cardinal indices and sizes</p></td>
<td align="left" valign="top"><p class="table"><tt>jint</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jint</tt></p></td>
</tr>
</tbody>
</table>
</div>
</li>
<li>
<p>
Because <tt>boolean</tt>s are treated as unsigned bytes, the following definitions are also useful
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top">Java Boolean Value </th>
<th align="left" valign="top"> Native Boolean Type </th>
<th align="left" valign="top"> Definition</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><tt>false</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>JNI_FALSE</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>#define JNI_FALSE  0</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>true</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>JNI_TRUE</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>#define JNI_TRUE  1</tt></p></td>
</tr>
</tbody>
</table>
</div>
</li>
<li>
<p>
Primitive data types are always <em>copied</em> between Java and native code
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_reference_type_mapping">3.3.6. Reference Type Mapping</h4>
<div class="ulist"><ul>
<li>
<p>
The JNI includes a number of pre-defined reference types (passed as opaque references in C) that correspond to different kinds of Java object types:
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top">Java Language Type </th>
<th align="left" valign="top"> Native Type </th>
<th align="left" valign="top"> <tt>typedef</tt> in C</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><tt>java.lang.Object</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jobject</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>void*</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>java.lang.Class</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jclass</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jobject</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>java.lang.Throwable</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jthrowable</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jobject</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>java.lang.String</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jstring</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jobject</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>java.lang.ref.WeakReference</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jweak</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jobject</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">N/A</p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jobject</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>java.lang.Object[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jobjectArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>boolean[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jbooleanArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>byte[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jbyteArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>char[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jcharArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>short[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jshortArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>int[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jintArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>long[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jlongArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>float[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jfloatArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>double[]</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jdoubleArray</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>jarray</tt></p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about reference types in C++</div>
<div class="paragraph"><p>These reference types in C++ are defined as proper classes:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>class _jobject <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jclass <span style="color: #990000">:</span> public _jobject <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jstring <span style="color: #990000">:</span> public _jobject <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jarray <span style="color: #990000">:</span> public _jobject <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jobjectArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jbooleanArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jbyteArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jcharArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jshortArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jintArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jlongArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jfloatArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jdoubleArray <span style="color: #990000">:</span> public _jarray <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>
class _jthrowable <span style="color: #990000">:</span> public _jobject <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jobject<span style="color: #990000">*</span>       jobject<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jclass<span style="color: #990000">*</span>        jclass<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jstring<span style="color: #990000">*</span>       jstring<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jarray<span style="color: #990000">*</span>        jarray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jobjectArray<span style="color: #990000">*</span>  jobjectArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jbooleanArray<span style="color: #990000">*</span> jbooleanArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jbyteArray<span style="color: #990000">*</span>    jbyteArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jcharArray<span style="color: #990000">*</span>    jcharArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jshortArray<span style="color: #990000">*</span>   jshortArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jintArray<span style="color: #990000">*</span>     jintArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jlongArray<span style="color: #990000">*</span>    jlongArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jfloatArray<span style="color: #990000">*</span>   jfloatArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jdoubleArray<span style="color: #990000">*</span>  jdoubleArray<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jthrowable<span style="color: #990000">*</span>    jthrowable<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> _jobject<span style="color: #990000">*</span>       jweak<span style="color: #990000">;</span></tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="title">A tip about <tt>NULL</tt> in Android NDK</div>
<div class="paragraph"><p>Android&#8217;s native development kit (NDK) does not define <tt>NULL</tt> in its <tt>jni.h</tt>, so the following definition can be useful when working with pointers and reference types:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">NULL</span></span> <span style="color: #990000">((</span><span style="color: #009900">void</span> <span style="color: #990000">*)</span> <span style="color: #993399">0</span><span style="color: #990000">)</span></tt></pre></div></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">Opaque references are C pointer types that refer to <em>internal</em> data structures in the JVM. It is an error to try to dereference opaque references and try to use them directly.</td>
</tr></table>
</div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_global_and_local_references">3.3.7. Global and Local References</h4>
<div class="ulist"><ul>
<li>
<p>
Unlike primitives, arbitrary Java objects are always passed by <em>reference</em>
</p>
</li>
<li>
<p>
The VM must keep track of all objects that have been passed to the native code, so that these objects are not freed by the GC (i.e. these references are considered object <em>roots</em> while in use)
</p>
<div class="ulist"><ul>
<li>
<p>
Consequently, the native code must have a way to tell the VM that it no longer needs references to objects
</p>
</li>
<li>
<p>
Additionally, the GC must be able to relocate an object referred to by native code (in the case of a copying GC), which means that these references must not be <em>dereferenced</em> by the native code
</p>
</li>
<li>
<p>
We will access the fields/methods on these references via JNI accessor functions
</p>
</li>
</ul></div>
</li>
<li>
<p>
All objects passed to native code and returned from <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/functions.html">JNI functions</a> are considered <em>local references</em>
</p>
<div class="ulist"><ul>
<li>
<p>
Automatically "freed" after the native function call returns
</p>
<div class="ulist"><ul>
<li>
<p>
The VM creates a table of references before every function call, and frees it when the call completes
</p>
</li>
<li>
<p>
Consequently, the native function calls are more expensive than regular method calls
</p>
</li>
</ul></div>
</li>
<li>
<p>
Also possible to explicitly free using:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">DeleteLocalRef</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> localRef<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Only valid in the thread in which they are created
</p>
</li>
<li>
<p>
If we end up using more than 16 local references (default) within a native function scope, we can ask the VM for more:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jint</span> <span style="font-weight: bold"><span style="color: #000000">EnsureLocalCapacity</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jint</span> capacity<span style="color: #990000">);</span>
<span style="color: #008080">jint</span> <span style="font-weight: bold"><span style="color: #000000">PushLocalFrame</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jint</span> capacity<span style="color: #990000">);</span>
<span style="color: #008080">jobject</span> <span style="font-weight: bold"><span style="color: #000000">PopLocalFrame</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> result<span style="color: #990000">);</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
To hold on to an object beyond a single native function call, we can convert a local reference to a <em>global reference</em>
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jobject</span> <span style="font-weight: bold"><span style="color: #000000">NewGlobalRef</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> obj<span style="color: #990000">);</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Becomes our responsibility to explicitly delete the reference when no longer in use:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">DeleteGlobalRef</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> globalRef<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Also supported are the weak global references
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jweak</span> <span style="font-weight: bold"><span style="color: #000000">NewWeakGlobalRef</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> obj<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">DeleteWeakGlobalRef</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jweak</span> obj<span style="color: #990000">);</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
JNI accessor functions do not make a distinction between the different reference types
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_using_strings">3.3.8. Using Strings</h4>
<div class="ulist"><ul>
<li>
<p>
In C, a string is a pointer to a <tt>\0</tt>-terminated character array where each character is one byte
</p>
</li>
<li>
<p>
In Java, an instance of <tt>java.lang.String</tt> is an immutable object which wraps a character array, which itself is an object (i.e. it knows its length so it is not <tt>\0</tt>-terminated), and each character is represented in UTF16 as <em>two bytes</em>
</p>
</li>
<li>
<p>
<a href="http://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/functions.html#string_operations">String Operations</a> are provided by <tt>JNIEnv</tt>:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* On Unicode (UTF-16) Characters */</span></span>
<span style="color: #008080">jstring</span> <span style="font-weight: bold"><span style="color: #000000">NewString</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #008080">jchar</span> <span style="color: #990000">*</span>unicodeChars<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">);</span>
<span style="color: #008080">jsize</span> <span style="font-weight: bold"><span style="color: #000000">GetStringLength</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> string<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">const</span></span> jchar <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">GetStringChars</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> string<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">ReleaseStringChars</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> string<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #008080">jchar</span> <span style="color: #990000">*</span>chars<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetStringRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> str<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jchar</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">/* On (modified) UTF-8 Characters */</span></span>
<span style="color: #008080">jstring</span> <span style="font-weight: bold"><span style="color: #000000">NewStringUTF</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>bytes<span style="color: #990000">);</span>
<span style="color: #008080">jsize</span> <span style="font-weight: bold"><span style="color: #000000">GetStringUTFLength</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> string<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">GetStringUTFChars</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> string<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">ReleaseStringUTFChars</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> string<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>utf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetStringUTFRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> str<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about <tt>GetString[UTF]Chars</tt>(…) functions</div>
<div class="paragraph"><p>The pointer resulting from <tt>GetString[UTF]Chars</tt>(…) is valid until <tt>ReleaseString[UTF]Chars(…)</tt> is called.</p></div>
<div class="paragraph"><p>If <tt>isCopy</tt> is not <tt>NULL</tt>, then <tt>*isCopy</tt> is set to <tt>JNI_TRUE</tt> if a copy is made. When <tt>*isCopy == JNI_FALSE</tt>, the returned string is a <em>direct pointer</em> to the characters in the original <tt>java.lang.String</tt> instance, which is then pinned in memory. The native code must ensure <strong>not to modify</strong> the contents of the returned string, otherwise, it would be modifying the private data of the <em>immutable</em> <tt>java.lang.String</tt> object!</p></div>
<div class="paragraph"><p>Regardless of <tt>isCopy</tt>, we have to call <tt>ReleaseString[UTF]Chars(…)</tt> when we are done using the character array, either to free the memory (when <tt>*isCopy == JNI_TRUE</tt>) or to un-pin the original string in memory (when <tt>*isCopy == JNI_FALSE</tt>).</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about modified UTF-8 strings:</div>
<div class="paragraph"><p>JNI&#8217;s <em>UTF</em> string functions (that work with <tt>char *</tt>) return/assume <tt>\0</tt>-terminated character arrays that are encoded as UTF-8 character sequences, except that if the string <em>contains</em> a <tt>\u0000</tt> character, it is represented by a pair of bytes 0xc0 0x80 (1100000010000000) instead of 0x00. When working with regular ASCII characters, each character is represented by exactly one byte.</p></div>
</td>
</tr></table>
</div>
</li>
<li>
<p>
Examples:
</p>
<div class="ulist"><ul>
<li>
<p>
What <strong>NOT</strong> to do:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"com_marakana_jniexamples_HelloName.h"</span>

JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_HelloName_sayHelloName</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> name<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello %s"</span><span style="color: #990000">,</span> name<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">/* <img src="./images/icons/callouts/1.png" alt="1" />  */</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
This example would not work (would likely crash the VM) since the <tt>jstring</tt> type represents strings in the Java virtual machine. This is different from the C string type (<tt>char *</tt>).
</td></tr>
</table></div>
</li>
<li>
<p>
Convert Java string to C string:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"com_marakana_jniexamples_HelloName.h"</span>

JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_HelloName_sayHelloName</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> name<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>cName <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> name<span style="color: #990000">,</span> NULL<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">/* <img src="./images/icons/callouts/1.png" alt="1" /> */</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cName <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* OutOfMemoryError already thrown */</span></span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello %s</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> cName<span style="color: #990000">);</span>
        <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ReleaseStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> name<span style="color: #990000">,</span> cName<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">/* <img src="./images/icons/callouts/2.png" alt="2" /> */</span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
This returns a pointer to an array of bytes representing the string in modified UTF-8 encoding; or NULL if we ran out of memory, in which case <tt>java.lang.OutOfMemoryError</tt> would also be thrown (upon returning back to the Java runtime).
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Calling <tt>ReleaseStringUTFChars</tt> indicates that the native method no longer needs the UTF-8 string returned by <tt>GetStringUTFChars</tt>, thus the memory taken by the UTF-8 string can be freed. Failure to do this would result in a memory leak, which could ultimately lead to memory exhaustion.
</td></tr>
</table></div>
</li>
<li>
<p>
Convert C string to Java string:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"com_marakana_jniexamples_GetName.h"</span>

JNIEXPORT jstring <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_ReturnName_GetName</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> class<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">char</span> buf<span style="color: #990000">[</span><span style="color: #993399">20</span><span style="color: #990000">];</span>
    <span style="font-weight: bold"><span style="color: #000000">fgets</span></span><span style="color: #990000">(</span>buf<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>buf<span style="color: #990000">),</span> stdin<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">NewStringUTF</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> buf<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Print each character of a Java string
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"com_marakana_jniexamples_HelloName.h"</span>

JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_HelloName_sayHelloName</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jstring</span> name<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">char</span> buf<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">];</span>
    <span style="color: #008080">jint</span> i<span style="color: #990000">;</span>
    <span style="color: #008080">jsize</span> len <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetStringUTFLength</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> name<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #000000">fputs</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello "</span><span style="color: #990000">,</span> stdout<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> len<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
       <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetStringUTFRegion</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> name<span style="color: #990000">,</span> i<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> buf<span style="color: #990000">);</span>
       <span style="font-weight: bold"><span style="color: #000000">putc</span></span><span style="color: #990000">(</span>buf<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">],</span> stdout<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">/* assumes ASCII */</span></span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #000000">putc</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">'</span><span style="color: #990000">,</span> stdout<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_arrays">3.3.9. Arrays</h4>
<div class="ulist"><ul>
<li>
<p>
As with Strings, Java arrays are different than C arrays; the former are objects (which <em>know</em> their <tt>length</tt>) whereas the latter are just pointers to memory addresses
</p>
<div class="ulist"><ul>
<li>
<p>
So, <tt>int[]</tt> in Java is not the same as <tt>jint[]</tt> in C/C++
</p>
</li>
<li>
<p>
Instead, <tt>int[]</tt> in Java, becomes <tt>jintArray</tt> in C/C++
</p>
</li>
</ul></div>
</li>
<li>
<p>
JNI provides <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/jni/spec/functions.html#wp17314">functions</a> for
</p>
<div class="ulist"><ul>
<li>
<p>
Creating arrays:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jobjectArray</span>  <span style="font-weight: bold"><span style="color: #000000">NewObjectArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> elementClass<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> initialElement<span style="color: #990000">);</span>
<span style="color: #008080">jbooleanArray</span> <span style="font-weight: bold"><span style="color: #000000">NewBooleanArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span>
<span style="color: #008080">jbyteArray</span>    <span style="font-weight: bold"><span style="color: #000000">NewByteArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span>
<span style="color: #008080">jcharArray</span>    <span style="font-weight: bold"><span style="color: #000000">NewCharArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span>
<span style="color: #008080">jshortArray</span>   <span style="font-weight: bold"><span style="color: #000000">NewShortArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span>
<span style="color: #008080">jintArray</span>     <span style="font-weight: bold"><span style="color: #000000">NewIntArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span>
<span style="color: #008080">jlongArray</span>    <span style="font-weight: bold"><span style="color: #000000">NewLongArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span>
<span style="color: #008080">jfloatArray</span>   <span style="font-weight: bold"><span style="color: #000000">NewFloatArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span>
<span style="color: #008080">jdoubleArray</span>  <span style="font-weight: bold"><span style="color: #000000">NewDoubleArray</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> length<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Getting the length of an array
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jsize</span> <span style="font-weight: bold"><span style="color: #000000">GetArrayLength</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jarray</span> array<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Getting/Setting individual elements of object arrays
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jobject</span> <span style="font-weight: bold"><span style="color: #000000">GetObjectArrayElement</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobjectArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> index<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetObjectArrayElement</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobjectArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> index<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> value<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Converting Java arrays of primitives to C/C++ arrays:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>jboolean<span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">GetBooleanArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbooleanArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
jbyte<span style="color: #990000">*</span>    <span style="font-weight: bold"><span style="color: #000000">GetByteArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbyteArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
jchar<span style="color: #990000">*</span>    <span style="font-weight: bold"><span style="color: #000000">GetCharArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jcharArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
jshort<span style="color: #990000">*</span>   <span style="font-weight: bold"><span style="color: #000000">GetShortArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jshortArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
jint<span style="color: #990000">*</span>     <span style="font-weight: bold"><span style="color: #000000">GetIntArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jintArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
jlong<span style="color: #990000">*</span>    <span style="font-weight: bold"><span style="color: #000000">GetLongArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jlongArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
jfloat<span style="color: #990000">*</span>   <span style="font-weight: bold"><span style="color: #000000">GetFloatArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jfloatArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
jdouble<span style="color: #990000">*</span>  <span style="font-weight: bold"><span style="color: #000000">GetDoubleArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jdoubleArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>

<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseBooleanArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbooleanArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span>
<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseByteArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbyteArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jbyte</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span>
<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseCharArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jcharArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jchar</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span>
<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseShortArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jshortArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jshort</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span>
<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseIntArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jintArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jint</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span>
<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseLongArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jlongArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span>
<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseFloatArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jfloatArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jfloat</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span>
<span style="color: #009900">void</span>      <span style="font-weight: bold"><span style="color: #000000">ReleaseDoubleArrayElements</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jdoubleArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jdouble</span> <span style="color: #990000">*</span>elems<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about memory</div>
<div class="paragraph"><p>The pointer resulting from <tt>Get</tt><em>Type</em><tt>ArrayElements(…)</tt> is valid until <tt>Release</tt><em>Type</em><tt>ArrayElements(…)</tt> is called (unless <tt>mode == JNI_COMMIT</tt>).</p></div>
<div class="paragraph"><p>If <tt>isCopy</tt> is not <tt>NULL</tt>, then <tt>*isCopy</tt> is set to <tt>JNI_TRUE</tt> if a copy is made. When <tt>*isCopy == JNI_FALSE</tt>, the returned array is a <em>direct pointer</em> to the elements of the Java array, which is then pinned in memory.</p></div>
<div class="paragraph"><p>Regardless of <tt>isCopy</tt>, we have to call <tt>Release</tt><em>Type</em><tt>ArrayElements(…, int mode)</tt> when we are done using the native array, either to un-pin the Java array in memory when <tt>*isCopy == JNI_FALSE</tt>, or, when <tt>*isCopy == JNI_TRUE</tt>, to:</p></div>
<div class="ulist"><ul>
<li>
<p>
copy the native array over the Java array and free it (when <tt>mode == 0</tt>)
</p>
</li>
<li>
<p>
copy the native array over the Java array but <strong>not</strong> free it (when <tt>mode == JNI_COMMIT</tt>)<br />
    This option assumes that we will call <tt>Release</tt><em>Type</em><tt>ArrayElements(…, JNI_ABORT)</tt> at some later point
</p>
</li>
<li>
<p>
leave the Java array intact and free the native array (when <tt>mode == JNI_ABORT</tt>)
</p>
</li>
</ul></div>
<div class="paragraph"><p>JNI also supports a <em>critical</em> version of these functions:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">void</span> <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">GetPrimitiveArrayCritical</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jarray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>isCopy<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">ReleasePrimitiveArrayCritical</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jarray</span> array<span style="color: #990000">,</span> <span style="color: #009900">void</span> <span style="color: #990000">*</span>carray<span style="color: #990000">,</span> <span style="color: #008080">jint</span> mode<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The function <tt>GetPrimitiveArrayCritical(…)</tt> is similar to <tt>Get</tt><em>Type</em><tt>ArrayElements(…)</tt>, except that the VM is more likely to return the pointer to the primitive array (i.e. <tt>*isCopy == JNI_FALSE</tt> is more likely). However, this comes with some caveats. The native code between <tt>GetPrimitiveArrayCritical(…)</tt> and <tt>ReleasePrimitiveArrayCritical(…)</tt> must not call other JNI functions, or make any system calls that may cause the current thread to block and wait for another Java thread. This is because the VM may temporarily suspend the garbage collection - in case it does not support memory pinning.</p></div>
</td>
</tr></table>
</div>
</li>
</ul></div>
</li>
<li>
<p>
Copying Java primitive arrays to and from C/C++ arrays:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetBooleanArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbooleanArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetByteArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbyteArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jbyte</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetCharArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jcharArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jchar</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetShortArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jshortArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jshort</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetIntArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jintArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jint</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetLongArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jlongArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetFloatArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jfloatArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jfloat</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">GetDoubleArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jdoubleArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jdouble</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>

<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetBooleanArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbooleanArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jboolean</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetByteArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jbyteArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jbyte</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetCharArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jcharArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jchar</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetShortArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jshortArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jshort</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetIntArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jintArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jint</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetLongArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jlongArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetFloatArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jfloatArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jfloat</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">SetDoubleArrayRegion</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jdoubleArray</span> array<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> start<span style="color: #990000">,</span> <span style="color: #008080">jsize</span> len<span style="color: #990000">,</span> <span style="color: #008080">jdouble</span> <span style="color: #990000">*</span>buf<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
For example, to sum the contents of a Java <tt>int</tt> array in C, we could:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JNIEXPORT jint <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_Math_sum</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jintArray</span> array<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">jinit</span> <span style="color: #990000">*</span>cArray <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetIntArrayElements</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> array<span style="color: #990000">,</span> NULL<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cArray <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">jini</span> len <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetArrayLength</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> array<span style="color: #990000">);</span>
        <span style="color: #008080">jint</span> i<span style="color: #990000">;</span>
        <span style="color: #008080">jint</span> result <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> len<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
            result <span style="color: #990000">+=</span> cArray<span style="color: #990000">[</span>i<span style="color: #990000">];</span>
        <span style="color: #FF0000">}</span>
        <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ReleaseIntArrayElements</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> array<span style="color: #990000">,</span> cArray<span style="color: #990000">,</span> JNI_ABORT<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Alternatively, we could also extract the individual elements:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JNIEXPORT jint <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_Math_sum</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jintArray</span> array<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">jint</span> buf<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">];</span>
    <span style="color: #008080">jini</span> len <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetArrayLength</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> array<span style="color: #990000">);</span>
    <span style="color: #008080">jint</span> i<span style="color: #990000">;</span>
    <span style="color: #008080">jint</span> result <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> len<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
        <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetIntArrayRegion</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> array<span style="color: #990000">,</span> i<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> buf<span style="color: #990000">);</span>
        result <span style="color: #990000">+=</span> buf<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">];</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
To do the opposite, copy a C array to Java array, we would do:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JNIEXPORT jintArray <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_Foo_getData</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> class<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">jint</span> cArray<span style="color: #990000">[</span><span style="color: #993399">10</span><span style="color: #990000">];</span>
    <span style="color: #008080">jsize</span> len <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>cArray<span style="color: #990000">);</span>
    <span style="color: #008080">jintArray</span> jArray <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">NewIntArray</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> len<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>jArray <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">jint</span> i<span style="color: #990000">;</span>
        <span style="font-style: italic"><span style="color: #9A1900">/* "get" the data */</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> len<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
            cArray<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> i<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">SetIntArrayRegion</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> jArray<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> len<span style="color: #990000">,</span> cArray<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> jArray<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
To avoid any chance of memory copying, we could also use direct memory buffers (<tt>java.nio.ByteBuffer</tt>):
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jobject</span> <span style="font-weight: bold"><span style="color: #000000">NewDirectByteBuffer</span></span><span style="color: #990000">(</span>JNIEnv<span style="color: #990000">*</span> env<span style="color: #990000">,</span> <span style="color: #009900">void</span><span style="color: #990000">*</span> address<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> capacity<span style="color: #990000">);</span>
<span style="color: #009900">void</span><span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">GetDirectBufferAddress</span></span><span style="color: #990000">(</span>JNIEnv<span style="color: #990000">*</span> env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> buf<span style="color: #990000">);</span>
<span style="color: #008080">jlong</span> <span style="font-weight: bold"><span style="color: #000000">GetDirectBufferCapacity</span></span><span style="color: #990000">(</span>JNIEnv<span style="color: #990000">*</span> env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> buf<span style="color: #990000">);</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
For example
</p>
<div class="listingblock">
<div class="title">In Java</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Foo</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">(</span>String<span style="color: #990000">[]</span> args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        …
        <span style="color: #008080">ByteBuffer</span> buf <span style="color: #990000">=</span> ByteBuffer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">allocateDirect</span></span><span style="color: #990000">(</span><span style="color: #993399">1024</span><span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// populate buf</span></span>
        <span style="font-weight: bold"><span style="color: #000000">processData</span></span><span style="color: #990000">(</span>buf<span style="color: #990000">);</span>
        …
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">processData</span></span><span style="color: #990000">(</span><span style="color: #008080">ByteBuffer</span> buf<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">In C</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_Foo_processData</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> buf<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">char</span> <span style="color: #990000">*</span>cBuf <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetDirectBufferAddress</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> buf<span style="color: #990000">);</span>
    <span style="font-style: italic"><span style="color: #9A1900">/* process cBuf from 0 to (*env)-&gt;GetDirectBufferCapacity(env, buf) */</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_reflection">3.3.10. Reflection</h4>
<div class="ulist"><ul>
<li>
<p>
JNI supports getting a reference to a Java class in native code:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jclass</span> <span style="font-weight: bold"><span style="color: #000000">FindClass</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">);</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
The <tt>name</tt> argument is a fully-qualified classname (with <tt>/</tt> as the package separators)
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* load the java.lang.String class */</span></span>
<span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">FindClass</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"java/lang/String"</span><span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
For arrays, we use <tt>[L</tt><em>classname</em><tt>;</tt> format
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* load the java.lang.String[] class */</span></span>
<span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">FindClass</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"[Ljava/lang/String;"</span><span style="color: #990000">);</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
Given a reference to a class, we can find out its super class, as well as whether it is assignable from another class:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jclass</span> <span style="font-weight: bold"><span style="color: #000000">GetSuperclass</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">);</span>
<span style="color: #008080">jboolean</span> <span style="font-weight: bold"><span style="color: #000000">IsAssignableFrom</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz1<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz2<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Given a reference to an object, we can find out its class, as well as whether it is an instance of another class:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jclass</span> <span style="font-weight: bold"><span style="color: #000000">GetObjectClass</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> obj<span style="color: #990000">);</span>
<span style="color: #008080">jboolean</span> <span style="font-weight: bold"><span style="color: #000000">IsInstanceOf</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> obj<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Once we have a class, JNI offers functions to lookup, get/set fields and invoke methods of that class - based on the following field and method signatures:
</p>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">Type Signature </th>
<th align="left" valign="top"> Java Type</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><tt>Z</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>boolean</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>B</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>byte</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>C</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>char</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>S</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>short</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>I</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>int</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>J</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>long</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>F</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>float</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>D</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>double</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>L</tt><em>fully-qualified-class</em><tt>;</tt></p></td>
<td align="left" valign="top"><p class="table"><em>fully-qualified-class</em></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>[<em>type</em></tt></p></td>
<td align="left" valign="top"><p class="table"><tt><em>type</em>[]</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>(<em>arg-types</em>)<em>ret-type</em></tt></p></td>
<td align="left" valign="top"><p class="table">method type</p></td>
</tr>
</tbody>
</table>
</div>
</li>
<li>
<p>
For fields, JNI offers functions to:
</p>
<div class="ulist"><ul>
<li>
<p>
Lookup a field ID based on its name/signature:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jfieldID</span> <span style="font-weight: bold"><span style="color: #000000">GetStaticFieldID</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>sig<span style="color: #990000">);</span>
<span style="color: #008080">jfieldID</span> <span style="font-weight: bold"><span style="color: #000000">GetFieldID</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>sig<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Get/set the value of a field based on the field ID:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">jobject</span></span>     <span style="color: #990000">(*</span>GetStaticObjectField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jboolean</span></span>    <span style="color: #990000">(*</span>GetStaticBooleanField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jbyte</span></span>       <span style="color: #990000">(*</span>GetStaticByteField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jchar</span></span>       <span style="color: #990000">(*</span>GetStaticCharField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jshort</span></span>      <span style="color: #990000">(*</span>GetStaticShortField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jint</span></span>        <span style="color: #990000">(*</span>GetStaticIntField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jlong</span></span>       <span style="color: #990000">(*</span>GetStaticLongField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jfloat</span></span>      <span style="color: #990000">(*</span>GetStaticFloatField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jdouble</span></span>     <span style="color: #990000">(*</span>GetStaticDoubleField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>

<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticObjectField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jobject<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticBooleanField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jboolean<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticByteField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jbyte<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticCharField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jchar<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticShortField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jshort<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticIntField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jint<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticLongField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jlong<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticFloatField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jfloat<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetStaticDoubleField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jdouble<span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">jobject</span></span>     <span style="color: #990000">(*</span>GetObjectField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jboolean</span></span>    <span style="color: #990000">(*</span>GetBooleanField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jbyte</span></span>       <span style="color: #990000">(*</span>GetByteField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jchar</span></span>       <span style="color: #990000">(*</span>GetCharField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jshort</span></span>      <span style="color: #990000">(*</span>GetShortField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jint</span></span>        <span style="color: #990000">(*</span>GetIntField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jlong</span></span>       <span style="color: #990000">(*</span>GetLongField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jfloat</span></span>      <span style="color: #990000">(*</span>GetFloatField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">jdouble</span></span>     <span style="color: #990000">(*</span>GetDoubleField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">);</span>

<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetObjectField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jobject<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetBooleanField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jboolean<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetByteField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jbyte<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetCharField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jchar<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetShortField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jshort<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetIntField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jint<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetLongField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jlong<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetFloatField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jfloat<span style="color: #990000">);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>SetDoubleField<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jfieldID<span style="color: #990000">,</span> jdouble<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
For example:
</p>
<div class="listingblock">
<div class="title">In Java</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Foo</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">String</span> bar<span style="color: #990000">;</span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">processBar</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">In C</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_Foo_processBar</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> object<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">/* Same as object.getClass() */</span></span>
    <span style="color: #008080">jclass</span> clazz <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetObjectClass</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> object<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>clazz <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* cannot be null in this case */</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">/* Same as clazz.getField("bar") */</span></span>
        <span style="color: #008080">jfieldID</span> field <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetFieldID</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> clazz<span style="color: #990000">,</span> <span style="color: #FF0000">"bar"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Ljava/lang/String;"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>field <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* make sure we got the field */</span></span>
            <span style="font-style: italic"><span style="color: #9A1900">/* Same as field.get(object) */</span></span>
            <span style="color: #008080">jstring</span> jString <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetObjectField</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> object<span style="color: #990000">,</span> field<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>jString <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">/* Convert the value to a C (UTF-8) string */</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>cString <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> jString<span style="color: #990000">,</span> NULL<span style="color: #990000">);</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cString <span style="color: #990000">==</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* Out of memory */</span></span>
                <span style="color: #FF0000">}</span>
                <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Value of </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">bar</span><span style="color: #CC33CC">\"</span><span style="color: #FF0000"> before the change: </span><span style="color: #CC33CC">\"</span><span style="color: #FF0000">%s</span><span style="color: #CC33CC">\"\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> cString<span style="color: #990000">);</span>
                <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ReleaseStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> jString<span style="color: #990000">,</span> cString<span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span>
            <span style="font-style: italic"><span style="color: #9A1900">/* Create a new String */</span></span>
            jString <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">NewStringUTF</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"Bar2"</span><span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>jString <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* make sure we are not out of memory */</span></span>
                <span style="font-style: italic"><span style="color: #9A1900">/* Same as field.set(object, jString) */</span></span>
                <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">SetObjectField</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> object<span style="color: #990000">,</span> field<span style="color: #990000">,</span> jString<span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
For methods, JNI offers functions to:
</p>
<div class="ulist"><ul>
<li>
<p>
Lookup a method ID based on its name and signature:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jmethodID</span> <span style="font-weight: bold"><span style="color: #000000">GetStaticMethodID</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>sig<span style="color: #990000">);</span>
<span style="color: #008080">jmethodID</span> <span style="font-weight: bold"><span style="color: #000000">GetMethodID</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>sig<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Invoke a method based on the method ID:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">jobject</span></span>     <span style="color: #990000">(*</span>CallStaticObjectMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jboolean</span></span>    <span style="color: #990000">(*</span>CallStaticBooleanMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jbyte</span></span>       <span style="color: #990000">(*</span>CallStaticByteMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jchar</span></span>       <span style="color: #990000">(*</span>CallStaticCharMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jshort</span></span>      <span style="color: #990000">(*</span>CallStaticShortMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jint</span></span>        <span style="color: #990000">(*</span>CallStaticIntMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jlong</span></span>       <span style="color: #990000">(*</span>CallStaticLongMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jfloat</span></span>      <span style="color: #990000">(*</span>CallStaticFloatMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jdouble</span></span>     <span style="color: #990000">(*</span>CallStaticDoubleMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>CallStaticVoidMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>

<span style="font-weight: bold"><span style="color: #000000">jobject</span></span>     <span style="color: #990000">(*</span>CallObjectMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jboolean</span></span>    <span style="color: #990000">(*</span>CallBooleanMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jbyte</span></span>       <span style="color: #990000">(*</span>CallByteMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jchar</span></span>       <span style="color: #990000">(*</span>CallCharMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jshort</span></span>      <span style="color: #990000">(*</span>CallShortMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jint</span></span>        <span style="color: #990000">(*</span>CallIntMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jlong</span></span>       <span style="color: #990000">(*</span>CallLongMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jfloat</span></span>      <span style="color: #990000">(*</span>CallFloatMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="font-weight: bold"><span style="color: #000000">jdouble</span></span>     <span style="color: #990000">(*</span>CallDoubleMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span>
<span style="color: #009900">void</span>        <span style="color: #990000">(*</span>CallVoidMethod<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> <span style="color: #990000">...);</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>JNI also offers <tt>Call…(…)</tt> functions that take args in a form of <tt>va_list</tt> as well as an array of <tt>jvalue</tt>-s:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>     <span style="color: #990000">(*</span>Call<span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>MethodV<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> va_list<span style="color: #990000">);</span>
<span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>     <span style="color: #990000">(*</span>CallStatic<span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>MethodV<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> va_list<span style="color: #990000">);</span>
<span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>     <span style="color: #990000">(*</span>Call<span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>MethodA<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> jvalue<span style="color: #990000">*);</span>
<span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>     <span style="color: #990000">(*</span>CallStatic<span style="color: #990000">&lt;</span>Type<span style="color: #990000">&gt;</span>MethodA<span style="color: #990000">)(</span>JNIEnv<span style="color: #990000">*,</span> jobject<span style="color: #990000">,</span> jmethodID<span style="color: #990000">,</span> jvalue<span style="color: #990000">*);</span></tt></pre></div></div>
</td>
</tr></table>
</div>
</li>
<li>
<p>
For example:
</p>
<div class="listingblock">
<div class="title">In Java</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Foo</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">String</span> bar<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">setBar</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> bar<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>bar <span style="color: #990000">=</span> bar<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">processBar</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">In C</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> <span style="font-weight: bold"><span style="color: #000000">Java_com_marakana_jniexamples_Foo_processBar</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jobject</span> object<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">/* Same as object.getClass() */</span></span>
    <span style="color: #008080">jclass</span> clazz <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetObjectClass</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> object<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>clazz <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">/* Same as clazz.getMethod("setBar", String.class) - assuming non-static */</span></span>
        <span style="color: #008080">jmethodID</span> method <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetMethodID</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> clazz<span style="color: #990000">,</span> <span style="color: #FF0000">"setBar"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"(Ljava/lang/String;)V"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>method <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* make sure we found the method */</span></span>
            <span style="font-style: italic"><span style="color: #9A1900">/* Create a new Java String */</span></span>
            <span style="color: #008080">jstring</span> jString <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">NewStringUTF</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"Bar2"</span><span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>jString <span style="color: #990000">!=</span> null<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">/* Same as method.invoke(object, jString) */</span></span>
                <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">CallVoidMethod</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> object<span style="color: #990000">,</span> method<span style="color: #990000">,</span> jString<span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_exceptions">3.3.11. Exceptions</h4>
<div class="ulist"><ul>
<li>
<p>
JNI permits us to throw exceptions from native code
</p>
<div class="ulist"><ul>
<li>
<p>
Assuming we have a <tt>Throwable</tt> <em>object</em>:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jint</span> <span style="font-weight: bold"><span style="color: #000000">Throw</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jthrowable</span> obj<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Assuming we have a <tt>Throwable</tt> <em>class</em>, and that it has a constructor that takes a string message:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jint</span> <span style="font-weight: bold"><span style="color: #000000">ThrowNew</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>message<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
For example:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">ThrowExceptionByClassName</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">jclass</span> clazz <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">FindClass</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> name<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>clazz <span style="color: #990000">!=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ThrowNew</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> clazz<span style="color: #990000">,</span> message<span style="color: #990000">);</span>
        <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">DeleteLocalRef</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> clazz<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
…
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>invalidArgument <span style="color: #990000">==</span> TRUE<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">ThrowExceptionByClassName</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"java/lang/IllegalArgumentException"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"This argument is not valid!"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
Throwing an exception from native code just registers the throwable (as an exception pointer) with the current thread - it <em>does not interrupt</em> the current flow of the code!
</p>
<div class="ulist"><ul>
<li>
<p>
The pending exception gets "thrown" upon returning to the Java code
</p>
</li>
<li>
<p>
While an exception is pending, we can only call the following JNI functions:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>DeleteGlobalRef</tt>
</p>
</li>
<li>
<p>
<tt>DeleteLocalRef</tt>
</p>
</li>
<li>
<p>
<tt>DeleteWeakGlobalRef</tt>
</p>
</li>
<li>
<p>
<tt>ExceptionCheck</tt>
</p>
</li>
<li>
<p>
<tt>ExceptionClear</tt>
</p>
</li>
<li>
<p>
<tt>ExceptionDescribe</tt>
</p>
</li>
<li>
<p>
<tt>ExceptionOccurred</tt>
</p>
</li>
<li>
<p>
<tt>MonitorExit</tt>
</p>
</li>
<li>
<p>
<tt>PopLocalFrame</tt>
</p>
</li>
<li>
<p>
<tt>PushLocalFrame</tt>
</p>
</li>
<li>
<p>
<tt>Release&lt;PrimitiveType&gt;ArrayElements</tt>
</p>
</li>
<li>
<p>
<tt>ReleasePrimitiveArrayCritical</tt>
</p>
</li>
<li>
<p>
<tt>ReleaseStringChars</tt>
</p>
</li>
<li>
<p>
<tt>ReleaseStringCritical</tt>
</p>
</li>
<li>
<p>
<tt>ReleaseStringUTFChars</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Calling methods on Java objects (e.g. via <tt>CallObjectMethod</tt>) can fail with an exception, but since exceptions don&#8217;t automatically abort our function calls, we must explicitly check for existence of pending exceptions (e.g. with <tt>ExceptionCheck</tt>)
</p>
</li>
<li>
<p>
Native code can "catch" an exception by calling <tt>ExceptionCheck(…)</tt> or <tt>ExceptionOccurred(…)</tt>, print its stack trace (to stderr) with <tt>ExceptionDescribe(…)</tt>, and "handle" it (i.e. clear it) with <tt>ExceptionClear(…)</tt>
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">jthrowable</span> <span style="font-weight: bold"><span style="color: #000000">ExceptionOccurred</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">/* NULL if no exception is currently being thrown */</span></span>
<span style="color: #008080">jboolean</span> <span style="font-weight: bold"><span style="color: #000000">ExceptionCheck</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">ExceptionDescribe</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">);</span>
<span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">ExceptionClear</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">);</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
To get to the message of a throwable object we would do something like:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">CallObjectMethod</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> …<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">/* this can throw an exception */</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ExceptionCheck</span></span><span style="color: #990000">(</span>env<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">jthrowable</span> throwable <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ExceptionOccurred</span></span><span style="color: #990000">(</span>env<span style="color: #990000">);</span>
    <span style="color: #008080">jclazz</span> clazz <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetObjectClass</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> throwable<span style="color: #990000">);</span>
    <span style="color: #008080">jmethodID</span> getMessageMethod <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetMethodID</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> clazz<span style="color: #990000">,</span> <span style="color: #FF0000">"getMessage"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"()Ljava/lang/String;"</span><span style="color: #990000">);</span>
    <span style="color: #008080">jstring</span> message <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">CallObjectMethod</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> throwable<span style="color: #990000">,</span> getMessageMethod<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>cMessage <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> message<span style="color: #990000">,</span> NULL<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cMessage<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ERROR: %s</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> cMessage<span style="color: #990000">);</span>
        <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ReleaseStringUTFChars</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> message<span style="color: #990000">,</span> cMessage<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">DeleteLocalRef</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> clazz<span style="color: #990000">);</span>
    <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ExceptionDescribe</span></span><span style="color: #990000">(</span>env<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">/* optionally dump the stack trace */</span></span>
    <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ExceptionClear</span></span><span style="color: #990000">(</span>env<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">/* mark the exception as "handled" */</span></span>
<span style="color: #FF0000">}</span>
…</tt></pre></div></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_ndk">3.4. Using NDK</h3>
<div class="imageblock">
<div class="content">
<img src="images/NDK.svg" alt="images/NDK.svg" />
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fibonacci_example">3.5. Fibonacci Example</h3>
<div class="ulist"><ul>
<li>
<p>
NDK is best explained via an example (based on Fibonacci)
</p>
</li>
<li>
<p>
The code is available
</p>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/FibonacciNative/zipball/master">https://github.com/marakana/FibonacciNative/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/FibonacciNative">Git</a>: <tt>git clone <a href="https://github.com/marakana/FibonacciNative.git">https://github.com/marakana/FibonacciNative.git</a></tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Start by creating a new Android Project
</p>
<div class="ulist"><ul>
<li>
<p>
Project Name: FibonacciNative
</p>
</li>
<li>
<p>
Build Target: Android 2.2 (API 8) or later
</p>
</li>
<li>
<p>
Application Name: Fibonacci Native
</p>
</li>
<li>
<p>
Package: <tt>com.marakana.android.fibonaccinative</tt>
</p>
</li>
<li>
<p>
Create Activity: <tt>FibonacciActivity</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_fibonacci_java_native_function_prototypes">3.5.1. Fibonacci - Java Native Function Prototypes</h4>
<div class="paragraph"><p>We start off by defining C function prototypes as <tt>native</tt> Java methods (wrapped in some class):</p></div>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/src/com/marakana/android/fibonaccinative/FibLib.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccinative<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibLib</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"FibLib"</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> n <span style="color: #990000">&lt;=</span> <span style="color: #993399">0</span> <span style="color: #990000">?</span> <span style="color: #993399">0</span> <span style="color: #990000">:</span> n <span style="color: #990000">==</span> <span style="color: #993399">1</span> <span style="color: #990000">?</span> <span style="color: #993399">1</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n <span style="color: #990000">-</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n <span style="color: #990000">-</span> <span style="color: #993399">2</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Recursive Java implementation of the Fibonacci algorithm</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// (included for comparison only)</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"fibJR("</span> <span style="color: #990000">+</span> n <span style="color: #990000">+</span> <span style="color: #FF0000">")"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Function prototype for future native recursive implementation</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// of the Fibonacci algorithm</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">);</span>


    <span style="font-style: italic"><span style="color: #9A1900">// Iterative Java implementation of the Fibonacci algorithm</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// (included for comparison only)</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"fibJI("</span> <span style="color: #990000">+</span> n <span style="color: #990000">+</span> <span style="color: #FF0000">")"</span><span style="color: #990000">);</span>
        <span style="color: #009900">long</span> previous <span style="color: #990000">=</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
        <span style="color: #009900">long</span> result <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #009900">long</span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;=</span> n<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
            <span style="color: #009900">long</span> sum <span style="color: #990000">=</span> result <span style="color: #990000">+</span> previous<span style="color: #990000">;</span>
            previous <span style="color: #990000">=</span> result<span style="color: #990000">;</span>
            result <span style="color: #990000">=</span> sum<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Function prototype for future iterative recursive implementation</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// of the Fibonacci algorithm</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// as defined by LOCAL_MODULE in Android.mk</span></span>
        System<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">loadLibrary</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com_marakana_android_fibonaccinative_FibLib"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_fibonacci_function_prototypes_in_a_c_header_file">3.5.2. Fibonacci - Function Prototypes in a C Header File</h4>
<div class="paragraph"><p>We then extract our C header file with our function prototypes:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
On the command line, change to your project&#8217;s root directory
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cd /path/to/workspace/FibonacciNative</tt></pre>
</div></div>
</li>
<li>
<p>
Create <tt>jni</tt> sub-directory
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir jni</tt></pre>
</div></div>
</li>
<li>
<p>
Extract the C header file from <tt>com.marakana.android.fibonaccinative.FibLib</tt> class:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ javah -jni -classpath bin/classes -d jni com.marakana.android.fibonaccinative.FibLib</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Prior to ADT r14, compiled class files were kept directly in the <tt>bin/</tt> directory, so in our <tt>javah</tt> command we would&#8217;ve used <tt>-classpath bin</tt> instead.</td>
</tr></table>
</div>
</li>
<li>
<p>
Check out the resulting file:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/jni/com_marakana_android_fibonaccinative_FibLib.h</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;jni.h&gt;</span>
<span style="font-style: italic"><span style="color: #9A1900">/* Header for class com_marakana_android_fibonaccinative_FibLib */</span></span>

<span style="font-weight: bold"><span style="color: #000080">#ifndef</span></span> _Included_com_marakana_android_fibonaccinative_FibLib
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> _Included_com_marakana_android_fibonaccinative_FibLib
<span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> __cplusplus
<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #FF0000">"C"</span> <span style="color: #FF0000">{</span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Class:     com_marakana_android_fibonaccinative_FibLib</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Method:    fibNR</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Signature: (J)J</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
JNIEXPORT jlong <span style="color: #008080">JNICALL</span> Java_com_marakana_android_fibonaccinative_FibLib_fibNR
  <span style="color: #990000">(</span>JNIEnv <span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jlong<span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Class:     com_marakana_android_fibonaccinative_FibLib</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Method:    fibNI</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * Signature: (J)J</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
JNIEXPORT jlong <span style="color: #008080">JNICALL</span> Java_com_marakana_android_fibonaccinative_FibLib_fibNI
  <span style="color: #990000">(</span>JNIEnv <span style="color: #990000">*,</span> jclass<span style="color: #990000">,</span> jlong<span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> __cplusplus
<span style="color: #FF0000">}</span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The function prototype names are name-spaced to the classname they are found in.</td>
</tr></table>
</div>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_fibonacci_provide_c_implementation">3.5.3. Fibonacci - Provide C Implementation</h4>
<div class="paragraph"><p>We provide the C implementation of <tt>com_marakana_android_fibonacci_FibLib.h</tt> header file:</p></div>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/jni/com_marakana_android_fibonaccinative_FibLib.c</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* Include the header file that was created via "javah -jni" command */</span></span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"com_marakana_android_fibonaccinative_FibLib.h"</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;android/log.h&gt;</span>

<span style="font-style: italic"><span style="color: #9A1900">/* Recursive implementation of the fibonacci algorithm (in a helper function) */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">jlong</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span><span style="color: #008080">jlong</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> n <span style="color: #990000">&lt;=</span> <span style="color: #993399">0</span> <span style="color: #990000">?</span> <span style="color: #993399">0</span> <span style="color: #990000">:</span> n <span style="color: #990000">==</span> <span style="color: #993399">1</span> <span style="color: #990000">?</span> <span style="color: #993399">1</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n <span style="color: #990000">-</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n <span style="color: #990000">-</span> <span style="color: #993399">2</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">/* Actual implementation of JNI-defined `fibNR` (recursive) function */</span></span>
JNIEXPORT jlong <span style="color: #008080">JNICALL</span> Java_com_marakana_android_fibonaccinative_FibLib_fibNR
  <span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">__android_log_print</span></span><span style="color: #990000">(</span>ANDROID_LOG_DEBUG<span style="color: #990000">,</span> <span style="color: #FF0000">"FibLib.c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"fibNR(%lld)"</span><span style="color: #990000">,</span> n<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">/* Actual implementation of JNI-defined `fibNI` (iterative) function */</span></span>
JNIEXPORT jlong <span style="color: #008080">JNICALL</span> Java_com_marakana_android_fibonaccinative_FibLib_fibNI
  <span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">jlong</span> previous <span style="color: #990000">=</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="color: #008080">jlong</span> result <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="color: #008080">jlong</span> i<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #000000">__android_log_print</span></span><span style="color: #990000">(</span>ANDROID_LOG_DEBUG<span style="color: #990000">,</span> <span style="color: #FF0000">"FibLib.c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"fibNI(%lld)"</span><span style="color: #990000">,</span> n<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;=</span> n<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">jlong</span> sum <span style="color: #990000">=</span> result <span style="color: #990000">+</span> previous<span style="color: #990000">;</span>
        previous <span style="color: #990000">=</span> result<span style="color: #990000">;</span>
        result <span style="color: #990000">=</span> sum<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_fibonacci_an_alternative_implementation_c">3.5.4. Fibonacci - An Alternative Implementation (C++)</h4>
<div class="paragraph"><p>We could also use an alternative mechanism of linking native-code to managed code by pre-registering our functions. This leads to earlier detection of method-function mismatch issues, a slight performance improvement, and spares us the redundancy of the header file and the use of the <tt>javah</tt> command.</p></div>
<div class="ulist"><ul>
<li>
<p>
See <a href="http://java.sun.com/docs/books/jni/html/other.html#29535">http://java.sun.com/docs/books/jni/html/other.html#29535</a>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/jni/com_marakana_android_fibonaccinative_FibLib.cpp</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;jni.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;android/log.h&gt;</span>

<span style="font-weight: bold"><span style="color: #0000FF">namespace</span></span> com_marakana_android_fibonaccinative <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">jlong</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span><span style="color: #008080">jlong</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> n <span style="color: #990000">&lt;=</span> <span style="color: #993399">0</span> <span style="color: #990000">?</span> <span style="color: #993399">0</span> <span style="color: #990000">:</span> n <span style="color: #990000">==</span> <span style="color: #993399">1</span> <span style="color: #990000">?</span> <span style="color: #993399">1</span> <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n <span style="color: #990000">-</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n <span style="color: #990000">-</span> <span style="color: #993399">2</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">jlong</span> <span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">__android_log_print</span></span><span style="color: #990000">(</span>ANDROID_LOG_DEBUG<span style="color: #990000">,</span> <span style="color: #FF0000">"FibLib.c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"fibNR(%lld)"</span><span style="color: #990000">,</span> n<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">jlong</span> <span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">,</span> <span style="color: #008080">jlong</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">jlong</span> previous <span style="color: #990000">=</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
        <span style="color: #008080">jlong</span> result <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
        <span style="color: #008080">jlong</span> i<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #000000">__android_log_print</span></span><span style="color: #990000">(</span>ANDROID_LOG_DEBUG<span style="color: #990000">,</span> <span style="color: #FF0000">"FibLib.c"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"fibNI(%lld)"</span><span style="color: #990000">,</span> n<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;=</span> n<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
            <span style="color: #008080">jlong</span> sum <span style="color: #990000">=</span> result <span style="color: #990000">+</span> previous<span style="color: #990000">;</span>
            previous <span style="color: #990000">=</span> result<span style="color: #990000">;</span>
            result <span style="color: #990000">=</span> sum<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">JNINativeMethod</span> method_table<span style="color: #990000">[]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"fibNR"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"(J)J"</span><span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">void</span> <span style="color: #990000">*)</span> fibNR <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">{</span> <span style="color: #FF0000">"fibNI"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"(J)J"</span><span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">void</span> <span style="color: #990000">*)</span> fibNI <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">using</span></span> <span style="font-weight: bold"><span style="color: #0000FF">namespace</span></span> com_marakana_android_fibonaccinative<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #FF0000">"C"</span> <span style="color: #008080">jint</span> <span style="font-weight: bold"><span style="color: #000000">JNI_OnLoad</span></span><span style="color: #990000">(</span>JavaVM<span style="color: #990000">*</span> vm<span style="color: #990000">,</span> <span style="color: #009900">void</span><span style="color: #990000">*</span> reserved<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    JNIEnv<span style="color: #990000">*</span> env<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>vm<span style="color: #990000">-&gt;</span><span style="font-weight: bold"><span style="color: #000000">GetEnv</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">reinterpret_cast</span></span><span style="color: #990000">&lt;</span><span style="color: #009900">void</span><span style="color: #990000">**&gt;(&amp;</span>env<span style="color: #990000">),</span> JNI_VERSION_1_6<span style="color: #990000">)</span> <span style="color: #990000">!=</span> JNI_OK<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JNI_ERR<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">jclass</span> clazz <span style="color: #990000">=</span> env<span style="color: #990000">-&gt;</span><span style="font-weight: bold"><span style="color: #000000">FindClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com/marakana/android/fibonaccinative/FibLib"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>clazz<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="color: #008080">jint</span> ret <span style="color: #990000">=</span> env<span style="color: #990000">-&gt;</span><span style="font-weight: bold"><span style="color: #000000">RegisterNatives</span></span><span style="color: #990000">(</span>clazz<span style="color: #990000">,</span> method_table<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>method_table<span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>method_table<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]));</span>
            env<span style="color: #990000">-&gt;</span><span style="font-weight: bold"><span style="color: #000000">DeleteLocalRef</span></span><span style="color: #990000">(</span>clazz<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> ret <span style="color: #990000">==</span> <span style="color: #993399">0</span> <span style="color: #990000">?</span> JNI_VERSION_1_6 <span style="color: #990000">:</span> JNI_ERR<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JNI_ERR<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Most of the Android&#8217;s JNI-based shared libraries are built using this, "alternative", approach where the functions are pre-registered.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_fibonacci_makefile">3.5.5. Fibonacci - Makefile</h4>
<div class="paragraph"><p>We need a <tt>Android.mk</tt> makefile, which will be used by NDK to compile our JNI code into a shared library:</p></div>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/jni/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Defines the root to all other relative paths</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># The macro function my-dir, provided by the build system,</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># specifies the path of the current directory (i.e. the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># directory containing the Android.mk file itself)</span></span>
LOCAL_PATH <span style="color: #990000">:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Clear all LOCAL_XXX variables with the exception of</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># LOCAL_PATH (this is needed because all variables are global)</span></span>
include <span style="color: #009900">$(CLEAR_VARS)</span>

<span style="font-style: italic"><span style="color: #9A1900"># List all of our C files to be compiled (header file</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># dependencies are automatically computed)</span></span>
LOCAL_SRC_FILES <span style="color: #990000">:=</span> com_marakana_android_fibonaccinative_FibLib<span style="color: #990000">.</span>c

<span style="font-style: italic"><span style="color: #9A1900"># The name of our shared module (this name will be prepended</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># by lib and postfixed by .so)</span></span>
LOCAL_MODULE <span style="color: #990000">:=</span> com_marakana_android_fibonaccinative_FibLib

<span style="font-style: italic"><span style="color: #9A1900"># We need to tell the linker about our use of the liblog.so</span></span>
LOCAL_LDLIBS <span style="color: #990000">+=</span> -llog

<span style="font-style: italic"><span style="color: #9A1900"># Collects all LOCAL_XXX variables since "include $(CLEAR_VARS)"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#  and determines what to build (in this case a shared library)</span></span>
include <span style="color: #009900">$(BUILD_SHARED_LIBRARY)</span>
</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">It&#8217;s easiest to copy the <tt>Android.mk</tt> file from another (sample) project and adjust <tt>LOCAL_SRC_FILES</tt> and <tt>LOCAL_MODULE</tt> as necessary</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">See <tt>/path/to/ndk-installation-dir/docs/ANDROID-MK.html</tt> for the complete reference of Android make files (build system)</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_fibonacci_compile_our_shared_module">3.5.6. Fibonacci - Compile Our Shared Module</h4>
<div class="paragraph"><p>Finally, from the root of our project (i.e. <tt>FibonacciNative/</tt>), we run <tt>ndk-build</tt> to build our code into a shared library (<tt>FibonacciNative/libs/armeabi/libcom_marakana_android_fibonacci_FibLib.so</tt>):</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ ndk-build
Compile thumb  : com_marakana_android_fibonaccinative_FibLib &lt;= com_marakana_android_fibonaccinative_FibLib.c
SharedLibrary  : libcom_marakana_android_fibonaccinative_FibLib.so
Install        : libcom_marakana_android_fibonaccinative_FibLib.so =&gt; libs/armeabi/libcom_marakana_android_fibonaccinative_FibLib.so</tt></pre>
</div></div>
<div class="paragraph"><p>Running <tt>ndk-build clean</tt> will clean all generated binaries.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The command <tt>ndk-build</tt> comes from the NDK&#8217;s installation directory (e.g. <tt>/path/to/android-ndk-r5b</tt>), so it&#8217;s easiest if we add this directory to our <tt>PATH</tt>.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The current version of NDK (at least up to r5b) on Windows depends on Cygwin (a Unix-like environment and command-line interface for Microsoft Windows), or specifically "shell" (bash) and "make" (gmake) programs available through Cygwin. To run <tt>ndk-build</tt> on Windows, we first need to run <tt>bash</tt> and then execute <tt>ndk-build</tt>. It is important that both <tt>c:\path\to\cygwin\bin</tt> and <tt>c:\path\to\ndk</tt> be defined in our <tt>Path</tt>.</td>
</tr></table>
</div>
<div class="sect4">
<h5 id="_controlling_cpu_application_binary_interface_abi">Controlling CPU Application Binary Interface (ABI)</h5>
<div class="ulist"><ul>
<li>
<p>
By default, the NDK will generate machine code for the <em>armeabi</em> (i.e. ARMv5TE with support for Thumb-1) ABI
</p>
<div class="ulist"><ul>
<li>
<p>
The target application library is packaged as <tt>lib/armeabi/lib&lt;name&gt;.so</tt>
</p>
</li>
<li>
<p>
Upon installation, it is copied to <tt>/data/data/&lt;package&gt;/lib/lib&lt;name&gt;.so</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
We could add support for ARMv7-A (including hardware FPU/VFPv3-D16, Thumb-2, VFPv3-D32/ThumbEE, and SIMD/NEON) via <tt>APP_ABI</tt> in a separate <tt>Application.mk</tt> file
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>APP_ABI := armeabi-v7a</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
ARMv7-a only
</p>
</li>
<li>
<p>
Packaged as <tt>lib/armeabi-v7a/lib&lt;name&gt;.so</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>APP_ABI := armeabi armeabi-v7a x86</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Builds <strong>three</strong> versions of the library, for ARMv5TE, ARMv7-a, and x86 in a single "fat binary"
</p>
</li>
<li>
<p>
Packaged as
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>lib/armeabi/lib&lt;name&gt;.so</tt>
</p>
</li>
<li>
<p>
<tt>lib/armeabi-v7a/lib&lt;name&gt;.so</tt>
</p>
</li>
<li>
<p>
<tt>lib/x86/lib&lt;name&gt;.so</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
The Android system knows at runtime which ABI(s) it supports
</p>
<div class="ulist"><ul>
<li>
<p>
<em>primary</em> ABI for the device corresponds to the machine code of the system image
</p>
</li>
<li>
<p>
<em>secondary</em> ABI (optional) corresponds to to another ABI that is also supported by the system image
</p>
</li>
<li>
<p>
Upon installation, Android first scans <tt>lib/&lt;primary-abi&gt;/lib&lt;name&gt;.so</tt> then <tt>lib/&lt;secondary-abi&gt;/lib&lt;name&gt;.so</tt> and installs the first that it finds to <tt>/data/data/&lt;package&gt;/lib/lib&lt;name&gt;.so</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
As an alternative to <tt>Application.mk</tt> file, we could also specify <tt>APP_ABI</tt> on the command-line:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>ndk-build "APP_ABI=armeabi armeabi-v7a x86"</tt></pre>
</div></div>
</li>
<li>
<p>
Support for <tt>x86</tt> ABI (i.e. IA-32 instruction set) was added in NDK r6 (July 2011)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect3">
<h4 id="_fibonacci_client">3.5.7. Fibonacci - Client</h4>
<div class="paragraph"><p>We can now build the "client" of our library (in this case a simple activity) to use our <tt>FibLib</tt> library.</p></div>
<div class="sect4">
<h5 id="_fibonacci_string_resources">Fibonacci - String Resources</h5>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/res/values/strings.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"hello"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Get Your Fibonacci Numbers Here!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"fibJR"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibJR<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"fibJI"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibJI<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"fibNR"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibNR<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"fibNI"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibNI<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>FibonacciNative<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Get Fibonacci Result<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_fibonacci_user_interface_layout">Fibonacci - User Interface (Layout)</h5>
<div class="imageblock">
<div class="content">
<img src="screens/FibonacciNativeMainLayout.png" alt="screens/FibonacciNativeMainLayout.png" />
</div>
</div>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/res/layout/main.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;LinearLayout</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
    <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span>
    <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span>
    <span style="color: #009900">android:orientation</span><span style="color: #990000">=</span><span style="color: #FF0000">"vertical"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This is just a simple title ("Get Your Fibonacci Here!")  --&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;TextView</span></span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span>
        <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
        <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"center"</span>
        <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/hello"</span>
        <span style="color: #009900">android:textSize</span><span style="color: #990000">=</span><span style="color: #FF0000">"25sp"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This is the entry box for our number "n"  --&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;EditText</span></span>
        <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/input"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
        <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
        <span style="color: #009900">android:ems</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span>
        <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"right"</span>
        <span style="color: #009900">android:inputType</span><span style="color: #990000">=</span><span style="color: #FF0000">"number"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;requestFocus</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/EditText&gt;</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This radio group allows the user to select the fibonacci implementation type  --&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioGroup</span></span>
        <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
        <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
        <span style="color: #009900">android:orientation</span><span style="color: #990000">=</span><span style="color: #FF0000">"horizontal"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span>
            <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_jr"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
            <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
            <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/fibJR"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span>
            <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_ji"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
            <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
            <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/fibJI"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span>
            <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_nr"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
            <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
            <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/fibNR"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span>
            <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_ni"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
            <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
            <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/fibNI"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/RadioGroup&gt;</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This button allows the user to trigger fibonacci calculation  --&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;Button</span></span>
        <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/button"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
        <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
        <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/button"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This is the output area for the fibonacci result  --&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;TextView</span></span>
        <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/output"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
        <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
        <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"center"</span>
        <span style="color: #009900">android:textSize</span><span style="color: #990000">=</span><span style="color: #FF0000">"20sp"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/LinearLayout&gt;</span></span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_fibonacci_tt_fibonacciactivity_tt">Fibonacci - <tt>FibonacciActivity</tt></h5>
<div class="listingblock">
<div class="title"><tt>FibonacciNative/src/com/marakana/android/fibonaccinative/FibonacciActivity.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccinative<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Activity<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>ProgressDialog<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>AsyncTask<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Bundle<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>SystemClock<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>text<span style="color: #990000">.</span>TextUtils<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">.</span>OnClickListener<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Button<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>EditText<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>RadioGroup<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>TextView<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibonacciActivity</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Activity <span style="color: #008080">implements</span> OnClickListener <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">EditText</span> input<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">RadioGroup</span> type<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">TextView</span> output<span style="color: #990000">;</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span><span style="color: #008080">Bundle</span> savedInstanceState<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span>savedInstanceState<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #000000">setContentView</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>layout<span style="color: #990000">.</span>main<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input <span style="color: #990000">=</span> <span style="color: #990000">(</span>EditText<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>input<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type <span style="color: #990000">=</span> <span style="color: #990000">(</span>RadioGroup<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output <span style="color: #990000">=</span> <span style="color: #990000">(</span>TextView<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>output<span style="color: #990000">);</span>
        <span style="color: #008080">Button</span> button <span style="color: #990000">=</span> <span style="color: #990000">(</span>Button<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>button<span style="color: #990000">);</span>
        button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setOnClickListener</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onClick</span></span><span style="color: #990000">(</span><span style="color: #008080">View</span> view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">String</span> s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getText</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">toString</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>TextUtils<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isEmpty</span></span><span style="color: #990000">(</span>s<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">ProgressDialog</span> dialog <span style="color: #990000">=</span> ProgressDialog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"Calculating..."</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">long</span> n <span style="color: #990000">=</span> Long<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseLong</span></span><span style="color: #990000">(</span>s<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> AsyncTask<span style="color: #990000">&lt;</span>Void<span style="color: #990000">,</span> Void<span style="color: #990000">,</span> String<span style="color: #990000">&gt;()</span> <span style="color: #FF0000">{</span>

            @Override
            <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #008080">String</span> <span style="font-weight: bold"><span style="color: #000000">doInBackground</span></span><span style="color: #990000">(</span>Void<span style="color: #990000">...</span> params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="color: #009900">long</span> result <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
                <span style="color: #009900">long</span> t <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">();</span>
                <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getCheckedRadioButtonId</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_jr<span style="color: #990000">:</span>
                    result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_ji<span style="color: #990000">:</span>
                    result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_nr<span style="color: #990000">:</span>
                    result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_ni<span style="color: #990000">:</span>
                    result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                <span style="color: #FF0000">}</span>
                t <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">()</span> <span style="color: #990000">-</span> t<span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fib(%d)=%d in %d ms"</span><span style="color: #990000">,</span> n<span style="color: #990000">,</span> result<span style="color: #990000">,</span> t<span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span>

            @Override
            <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPostExecute</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> result<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                dialog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dismiss</span></span><span style="color: #990000">();</span>
                FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setText</span></span><span style="color: #990000">(</span>result<span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">execute</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_fibonacci_result">3.5.8. Fibonacci - Result</h4>
<div class="imageblock">
<div class="content">
<img src="screens/FibonacciNativeResult.png" alt="screens/FibonacciNativeResult.png" />
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ndk_8217_s_stable_apis">3.6. NDK&#8217;s Stable APIs</h3>
<div class="paragraph"><p>The header files for NDK stable APIs are available at <tt>/path/to/ndk/platforms/&lt;android-platform&gt;/&lt;arch-name&gt;/usr/include</tt>.</p></div>
<div class="sect3">
<h4 id="_android_specific_log_support">3.6.1. Android-specific Log Support</h4>
<div class="ulist"><ul>
<li>
<p>
Include <tt>&lt;android/log.h&gt;</tt> to access various functionality that can be used to send log messages to the kernel (i.e. logcat buffers) from our native code
</p>
</li>
<li>
<p>
Requires that our code be linked to <tt>/system/lib/liblog.so</tt> with <tt>LOCAL_LDLIBS += -llog</tt> in our <tt>Android.mk</tt> file
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_zlib_compression_library">3.6.2. ZLib Compression Library</h4>
<div class="ulist"><ul>
<li>
<p>
Include <tt>&lt;zlib.h&gt;</tt> and <tt>&lt;zconf.h&gt;</tt> to access ZLib compression library
</p>
<div class="ulist"><ul>
<li>
<p>
See <tt>http://www.zlib.net/manual.html</tt> for more info on ZLib
</p>
</li>
</ul></div>
</li>
<li>
<p>
Requires that our code be linked to <tt>/system/lib/libz.so</tt> with <tt>LOCAL_LDLIBS += -lz</tt> in our <tt>Android.mk</tt> file
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_the_opengl_es_1_x_library">3.6.3. The OpenGL ES 1.x Library</h4>
<div class="ulist"><ul>
<li>
<p>
Include <tt>&lt;GLES/gl.h&gt;</tt> and <tt>&lt;GLES/glext.h&gt;</tt> to access OpenGL ES 1.x rendering calls from native
code
</p>
<div class="ulist"><ul>
<li>
<p>
The "1.x" here refers to both versions 1.0 and 1.1
</p>
<div class="ulist"><ul>
<li>
<p>
Using 1.1 requires OpenGL-capable GPU
</p>
</li>
<li>
<p>
Using 1.0 is universally supported since Android includes software renderer for GPU-less devices
</p>
</li>
<li>
<p>
Requires that we include <tt>&lt;uses-feature&gt;</tt> tag in our manifest file to indicate the actual OpenGL version that we expect
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Requires that our code be linked to <tt>/system/lib/libGLESv1_CM.so</tt> with <tt>LOCAL_LDLIBS += -lGLESv1_CM.so</tt> in our <tt>Android.mk</tt> file
</p>
</li>
<li>
<p>
Since API 4 (Android 1.6)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_the_opengl_es_2_0_library">3.6.4. The OpenGL ES 2.0 Library</h4>
<div class="ulist"><ul>
<li>
<p>
Include <tt>&lt;GLES2/gl2.h&gt;</tt> and <tt>&lt;GLES2/gl2ext.h&gt;</tt> to access OpenGL ES 2.0 rendering calls from native
code
</p>
<div class="ulist"><ul>
<li>
<p>
Enables the use of vertex and fragment shaders via the GLSL language
</p>
</li>
<li>
<p>
Since not all devices support OpenGL 2.0, we should include <tt>&lt;uses-feature&gt;</tt> tag in our manifest file to indicate this requirement
</p>
</li>
</ul></div>
</li>
<li>
<p>
Requires that our code be linked to <tt>/system/lib/libGLESv2.so</tt> with <tt>LOCAL_LDLIBS += -lGLESv2.so</tt> in our <tt>Android.mk</tt> file
</p>
</li>
<li>
<p>
Since API 4 (Android 2.0)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_the_tt_jnigraphics_tt_library">3.6.5. The <tt>jnigraphics</tt> Library</h4>
<div class="ulist"><ul>
<li>
<p>
Include <tt>&lt;android/bitmap.h&gt;</tt> to reliably access the pixel buffers of Java bitmap objects from native
code
</p>
</li>
<li>
<p>
Requires that our code be linked to <tt>/system/lib/libjnigraphics.so</tt> with <tt>LOCAL_LDLIBS += -ljnigraphics</tt> in our <tt>Android.mk</tt> file
</p>
</li>
<li>
<p>
Since API 8 (Android 2.2)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_the_opensl_es_native_audio_library">3.6.6. The OpenSL ES native audio Library</h4>
<div class="ulist"><ul>
<li>
<p>
Include <tt>&lt;SLES/OpenSLES.h&gt;</tt> and <tt>&lt;SLES/OpenSLES_Platform.h&gt;</tt> to perform audio input and output from native code
</p>
<div class="ulist"><ul>
<li>
<p>
Based on Khronos Group OpenSL ES™ 1.0.1
</p>
</li>
</ul></div>
</li>
<li>
<p>
Requires that our code be linked to <tt>/system/lib/libOpenSLES.so</tt> with <tt>LOCAL_LDLIBS += -lOpenSLES</tt> in our <tt>Android.mk</tt> file
</p>
</li>
<li>
<p>
Since API 9 (Android 2.3)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_the_android_native_application_apis">3.6.7. The Android native application APIs</h4>
<div class="ulist"><ul>
<li>
<p>
Makes it possible to write our entire application in native code
</p>
<div class="ulist"><ul>
<li>
<p>
Mainly added for gaming
</p>
</li>
<li>
<p>
Our code still depends on the Dalvik VM since most of the platform features are managed in the VM and accessed via JNI (Native &#8594; Java)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Include <tt>&lt;android/native_activity.h&gt;</tt> to write an Android activity (with its life-cycle callbacks) in native code
</p>
<div class="ulist"><ul>
<li>
<p>
A native activity would serve as the main entry point into our native application
</p>
</li>
</ul></div>
</li>
<li>
<p>
Include <tt>&lt;android/looper.h&gt;</tt>, <tt>&lt;android/input.h&gt;</tt>, <tt>&lt;android/keycodes.h&gt;</tt>, and <tt>&lt;android/sensor.h&gt;</tt> to listen to input events and sensors directly from native code
</p>
</li>
<li>
<p>
Include <tt>&lt;android/rect.h&gt;</tt>, <tt>&lt;android/window.h&gt;</tt>, <tt>&lt;android/native_window.h&gt;</tt>, and <tt>&lt;android/native_window_jni.h&gt;</tt> for window management from native code
</p>
<div class="ulist"><ul>
<li>
<p>
Includes ability to lock/unlock the pixel buffer to draw directly into it
</p>
</li>
</ul></div>
</li>
<li>
<p>
Include <tt>&lt;android/configuration.h&gt;</tt>, <tt>&lt;android/asset_manager.h&gt;</tt>, <tt>&lt;android/storage_manager.h&gt;</tt>, and <tt>&lt;android/obb.h&gt;</tt> for direct access to the assets embedded in our <tt>.apk</tt> files Opaque Binary Blob (OBB) files
</p>
<div class="ulist"><ul>
<li>
<p>
All access is read-only
</p>
</li>
</ul></div>
</li>
<li>
<p>
Requires that our code be linked to <tt>libandroid.so</tt> with <tt>LOCAL_LDLIBS += -landroid</tt> in our <tt>Android.mk</tt> file
</p>
</li>
<li>
<p>
Since API 9 (Android 2.3)
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">With the exception of the libraries listed above, the native system libraries in the Android platform are not considered "stable" and may change in future platform versions. Unless our library is being built for a specific Android ROM, we should only make use of the stable libraries provided by the NDK.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">All the header files are available under: <tt>/path/to/ndk-installation-dir/platforms/android-9/arch-arm/usr/include/</tt></td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">See <tt>/path/to/ndk-installation-dir/docs/STABLE-APIS.html</tt> for the complete reference of NDK&#8217;s stable APIs.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lab_ndk">3.7. Lab: NDK</h3>
<div class="paragraph"><p>Create a simple Android application that allows the end-user to log to Android&#8217;s logcat via functionality provided by <tt>/system/lib/liblog.so</tt> (i.e. you cannot use <tt>android.util.Log</tt>).</p></div>
<div class="paragraph"><p>For example, this could be your <tt>LogLib</tt>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>loglib<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LogLib</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> priority<span style="color: #990000">,</span> <span style="color: #008080">String</span> tag<span style="color: #990000">,</span> <span style="color: #008080">String</span> msg<span style="color: #990000">);</span>
    <span style="font-style: italic"><span style="color: #9A1900">/* You'll need to load your library here */</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The basic scaffolding for your application, along with the UI is already provided:</p></div>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/LogNative/zipball/master">https://github.com/marakana/LogNative/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/LogNative">Git</a>: <tt>git clone <a href="https://github.com/marakana/LogNative.git">https://github.com/marakana/LogNative.git</a></tt>
</p>
</li>
</ul></div>
<div class="paragraph"><p>As a bonus:</p></div>
<div class="ulist"><ul>
<li>
<p>
Throw <tt>java.lang.IllegalArgumentException</tt> if <tt>priority</tt> is not one of the allowed types
</p>
</li>
<li>
<p>
Throw <tt>java.lang.NullPointerException</tt> if <tt>tag</tt> or <tt>msg</tt> are null
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Don&#8217;t forget to convert <tt>tag</tt> and <tt>msg</tt> strings from the Java format (<tt>jstring</tt>) to native format (<tt>char *</tt>) before trying to use them in <tt>int __android_log_write(int prio, const char *tag, const char *text)</tt>. Also, don&#8217;t forget to <em>free</em> the native strings before returning from the native method. Finally, don&#8217;t forget to tell the linker about your use of the <em>log</em> library.</td>
</tr></table>
</div>
<div class="paragraph"><p>The solution is provided:</p></div>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/LogNative/zipball/solution">https://github.com/marakana/LogNative/zipball/solution</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/LogNative/tree/solution">Git</a>: <tt>git clone <a href="https://github.com/marakana/LogNative.git">https://github.com/marakana/LogNative.git</a> -b solution</tt>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Android_Binder_IPC">4. Android Binder Inter Process Communication (IPC) with AIDL</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_why_ipc">4.1. Why IPC?</h3>
<div class="ulist"><ul>
<li>
<p>
Each Android application runs in a separate process
</p>
<div class="ulist"><ul>
<li>
<p>
Android application-framework services also run in a separate process called <tt>systemserver</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Often we wish to make use of services offered by other applications, or we simply wish to expose our applications' capabilities to 3rd party apps
</p>
<div class="ulist"><ul>
<li>
<p>
Even Android&#8217;s <tt>Intent</tt>-based IPC-like mechanism (used for starting activities and services, as well as delivering events), is internally based on Binder
</p>
</li>
</ul></div>
</li>
<li>
<p>
By design (for security reasons), processes cannot directly access each other&#8217;s data
</p>
</li>
<li>
<p>
To cross the process boundaries, we need support of a inter-process communication transport mechanism, which handles passing of data from one process (caller) to another (callee)
</p>
<div class="ulist"><ul>
<li>
<p>
Caller&#8217;s data is <em>marshaled</em> into tokens that IPC understands, copied to callee&#8217;s process, and finally <em>unmarshaled</em> into what callee expects
</p>
</li>
<li>
<p>
Callee&#8217;s response is also <em>marshaled</em>, copied to caller&#8217;s process where it is <em>unmarshaled</em> into what caller expects
</p>
</li>
<li>
<p>
Marshaling/unmarshaling is automatically provided by the IPC mechanism
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_what_is_binder">4.2. What is Binder?</h3>
<div class="imageblock">
<div class="content">
<img src="images/BinderIPC.png" alt="images/BinderIPC.png" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Binder provides a lightweight remote procedure call (RPC) mechanism designed for high performance when performing in-process and cross-process calls (IPC)
</p>
</li>
<li>
<p>
Binder-capable services are described in Android Interface Definition Language (AIDL), not unlike other IDL languages
</p>
</li>
<li>
<p>
Since Binder is provided as a Linux driver, the services can be written in both C/C++ as well as Java
</p>
<div class="ulist"><ul>
<li>
<p>
Most Android services are written in Java
</p>
</li>
</ul></div>
</li>
<li>
<p>
All caller calls go through Binder&#8217;s <tt>transact()</tt> method, which automatically marshals the arguments and return values via <tt>Parcel</tt> objects
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>Parcel</tt> is a generic buffer of data (decomposed into primitives) that also maintains some meta-data about its contents - such as object references to ensure object identity across processes
</p>
</li>
<li>
<p>
Caller calls to <tt>transact()</tt> are by default synchronous - i.e. provide the same semantics as a local method call
</p>
<div class="ulist"><ul>
<li>
<p>
On callee side, the Binder framework maintains a pool of transaction threads, which are used to handle the incoming IPC requests (unless the call is local, in which case the same thread is used)
</p>
</li>
<li>
<p>
Callee methods can be marked as <tt>oneway</tt>, in which case caller calls do not block (i.e. calls return immediately)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Callee' mutable state needs to be thread-safe - since callee&#8217;s can accept concurrent requests from multiple callers
</p>
</li>
<li>
<p>
The Binder system also supports recursion across processes - i.e. behaves the same as recursion semantics when calling methods on local objects
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_what_is_aidl">4.3. What is AIDL?</h3>
<div class="ulist"><ul>
<li>
<p>
Android Interface Definition Language is a Android-specific language for defining Binder-based service interafaces
</p>
</li>
<li>
<p>
AIDL follows Java-like interface syntax and allows us to declare our "business" methods
</p>
</li>
<li>
<p>
Each Binder-based service is defined in a separate <tt>.aidl</tt> file, typically named <tt>I</tt><em><tt>Foo</tt></em><tt>Service.aidl</tt>, and saved in the <tt>src/</tt> directory
</p>
<div class="listingblock">
<div class="title"><tt>src/com/example/app/IFooService.aidl</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Bar<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IFooService</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span>inout <span style="color: #008080">Bar</span> bar<span style="color: #990000">);</span>
    <span style="color: #008080">Bar</span> <span style="font-weight: bold"><span style="color: #000000">getById</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> id<span style="color: #990000">);</span>
    <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">delete</span></span><span style="color: #990000">(</span>in <span style="color: #008080">Bar</span> bar<span style="color: #990000">);</span>
    <span style="color: #008080">List&lt;Bar&gt;</span> <span style="font-weight: bold"><span style="color: #000000">getAll</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
The <tt>aidl</tt> build tool (part of Android SDK) is used to extract a real Java interface (along with a <tt>Stub</tt> providing Android&#8217;s <tt>android.os.IBinder</tt>) from each <tt>.aidl</tt> file and place it into our <tt>gen/</tt> directory
</p>
<div class="listingblock">
<div class="title"><tt>gen/com/example/app/IFooService.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IFooService</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>IInterface
<span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">abstract</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Stub</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Binder
        <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">.</span>IFooService <span style="color: #FF0000">{</span>
        …
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">.</span><span style="color: #008080">IFooService</span> <span style="font-weight: bold"><span style="color: #000000">asInterface</span></span><span style="color: #990000">(</span>
            android<span style="color: #990000">.</span>os<span style="color: #990000">.</span><span style="color: #008080">IBinder</span> obj<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            …
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span><span style="color: #008080">IBinder</span> <span style="font-weight: bold"><span style="color: #000000">asBinder</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        …
    <span style="color: #FF0000">}</span>
    <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">(</span>com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">.</span><span style="color: #008080">Bar</span> bar<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
    com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">.</span><span style="color: #008080">Bar</span> <span style="font-weight: bold"><span style="color: #000000">getById</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> id<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
    <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">delete</span></span><span style="color: #990000">(</span>com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">.</span><span style="color: #008080">Bar</span> bar<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
    java<span style="color: #990000">.</span>util<span style="color: #990000">.</span><span style="color: #008080">List&lt;Bar&gt;</span> <span style="font-weight: bold"><span style="color: #000000">getAll</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Eclipse ADT automatically calls <tt>aidl</tt> for each <tt>.aidl</tt> file that it finds in our <tt>src/</tt> directory</td>
</tr></table>
</div>
</li>
<li>
<p>
AIDL supports the following types:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>null</tt>
</p>
</li>
<li>
<p>
<tt>boolean</tt>, <tt>boolean[]</tt>, <tt>byte</tt>, <tt>byte[]</tt>, <tt>char[]</tt>, <tt>int</tt>, <tt>int[]</tt>, <tt>long</tt>, <tt>long[]</tt>, <tt>float</tt>, <tt>float[]</tt>, <tt>double</tt>, <tt>double[]</tt>
</p>
</li>
<li>
<p>
<tt>java.lang.CharSequence</tt>, <tt>java.lang.String</tt>
</p>
</li>
<li>
<p>
<tt>java.io.FileDescriptor</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Gets transferred as a dup of the original file descriptor - while the fd is different, it points to the same underlying stream and position
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>java.io.Serializable</tt> (not efficient)
</p>
</li>
<li>
<p>
<tt>java.util.List</tt> (of supported types, including generic definitions)
</p>
<div class="ulist"><ul>
<li>
<p>
Internally, Binder always uses <tt>java.util.ArrayList</tt> as the concrete implementation
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>java.util.Map</tt> (of supported types)
</p>
<div class="ulist"><ul>
<li>
<p>
Internally, Binder always uses <tt>java.util.HashMap</tt> as the concrete implementation
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>java.lang.Object[]</tt> (supporting objects of the same type defined here, but also primitive wrappers)
</p>
</li>
<li>
<p>
<tt>android.util.SparseArray</tt>, <tt>android.util.SparseBooleanArray</tt>
</p>
</li>
<li>
<p>
<tt>android.os.Bundle</tt>
</p>
</li>
<li>
<p>
<tt>android.os.IBinder</tt>, <tt>android.os.IInterface</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
The contents of these objects are not actually transferred - instead a special token serving as a self-reference is written
</p>
</li>
<li>
<p>
Reading these objects from a parcel returns a handle to the original object that was written
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>android.os.Parcelable</tt> (allowing for custom types):
</p>
<div class="listingblock">
<div class="title">src/com/example/app/Bar.java</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcel<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcelable<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Bar</span> <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> Parcelable <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">int</span> id<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">String</span> data<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #000000">Bar</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> id<span style="color: #990000">,</span> <span style="color: #008080">String</span> data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>id <span style="color: #990000">=</span> id<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>data <span style="color: #990000">=</span> data<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// getters and setters omitted</span></span>
    …

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">writeToParcel</span></span><span style="color: #990000">(</span><span style="color: #008080">Parcel</span> parcel<span style="color: #990000">,</span> <span style="color: #009900">int</span> flags<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writeInt</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>id<span style="color: #990000">);</span>
        parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writeString</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>data<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> Parcelable<span style="color: #990000">.</span><span style="color: #008080">Creator&lt;Bar&gt;</span> CREATOR <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Parcelable<span style="color: #990000">.</span>Creator<span style="color: #990000">&lt;</span>Bar<span style="color: #990000">&gt;()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">Bar</span> <span style="font-weight: bold"><span style="color: #000000">createFromParcel</span></span><span style="color: #990000">(</span><span style="color: #008080">Parcel</span> parcel<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Bar</span></span><span style="color: #990000">(</span>parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">readInt</span></span><span style="color: #990000">(),</span> parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">readString</span></span><span style="color: #990000">());</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> Bar<span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">newArray</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> size<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Bar<span style="color: #990000">[</span>size<span style="color: #990000">];</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
These custom classes have to be declared in their own (simplified) <tt>.aidl</tt> files
</p>
<div class="listingblock">
<div class="title">src/com/example/app/Bar.aidl</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>example<span style="color: #990000">.</span>app<span style="color: #990000">;</span>
<span style="color: #008080">parcelable</span> Bar<span style="color: #990000">;</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">AIDL-interfaces have to <tt>import</tt> parcelable custom classes even if they are in the same package. In the case of the previous example, <tt>src/com/example/app/IFooService.aidl</tt> would have to <tt>import com.example.app.Bar;</tt> if it makes any references to <tt>com.example.app.Bar</tt> even though they are in the same package.</td>
</tr></table>
</div>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
AIDL-defined methods can take zero or more parameters, and must return a value or <tt>void</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
All non-primitive parameters require a <em>directional tag</em> indicating which way the data goes: one of: <tt>in</tt>, <tt>out</tt>, or <tt>inout</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Direction for primitives is always <tt>in</tt> (can be omitted)
</p>
</li>
<li>
<p>
The direction tag tells binder when to marshal the data, so its use has direct consequences on performance
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
All <tt>.aidl</tt> comments are copied over to the generated Java interface (except for comments before the import and package statements).
</p>
</li>
<li>
<p>
Static fields are not supported in <tt>.aidl</tt> files
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_fibonacci_example_building_a_binder_based_service_and_client">4.4. Fibonacci Example: Building a Binder-based Service and Client</h3>
<div class="imageblock">
<div class="content">
<img src="images/FibonacciClientServiceArchitecture.svg" alt="images/FibonacciClientServiceArchitecture.svg" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
To demonstrate an Binder-based service and client, we&#8217;ll create three separate projects:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>FibonacciCommon</tt> library project - to define our AIDL interface as well as custom types for parameters and return values
</p>
</li>
<li>
<p>
<tt>FibonacciService</tt> project - where we implement our AIDL interface and expose it to the clients
</p>
</li>
<li>
<p>
<tt>FibonacciClient</tt> project - where we connect to our AIDL-defined service and use it
</p>
</li>
</ol></div>
</li>
<li>
<p>
The code is available
</p>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/FibonacciBinderDemo/zipball/master">https://github.com/marakana/FibonacciBinderDemo/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/FibonacciBinderDemo">Git</a>: <tt>git clone <a href="https://github.com/marakana/FibonacciBinderDemo.git">https://github.com/marakana/FibonacciBinderDemo.git</a></tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_fibonaccicommon_define_aidl_interface_and_custom_types">4.5. FibonacciCommon - Define AIDL Interface and Custom Types</h3>
<div class="ulist"><ul>
<li>
<p>
We start by creating a new Android (library) project, which will host the common API files (an AIDL interface as well as custom types for parameters and return values) shared by the service and its clients
</p>
<div class="ulist"><ul>
<li>
<p>
Project Name: <tt>FibonacciCommon</tt>
</p>
</li>
<li>
<p>
Build Target: Android 2.2 (API 8) or later
</p>
</li>
<li>
<p>
Package Name: <tt>com.marakana.android.fibonaccicommon</tt>
</p>
</li>
<li>
<p>
Min SDK Version: 8
</p>
</li>
<li>
<p>
No need to specify Application name or an activity
</p>
</li>
</ul></div>
</li>
<li>
<p>
To turn this into a <em>library project</em> we need to access project properties  &#8594; <tt>Android</tt> &#8594; <tt>Library</tt> and check <tt>Is Library</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
We could also manually add <tt>android.library=true</tt> to <tt>FibonacciCommon/default.properties</tt> and refresh the project
</p>
</li>
</ul></div>
</li>
<li>
<p>
Since library projects are never turned into actual applications (APKs)
</p>
<div class="ulist"><ul>
<li>
<p>
We can simplify our manifest file:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
    <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonaccicommon"</span> <span style="color: #009900">android:versionCode</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
    <span style="color: #009900">android:versionName</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
And we can remove everything from <tt>FibonacciCommon/res/</tt> directory (e.g. <tt>rm -fr FibonacciCommon/res/*</tt>)
</p>
</li>
</ul></div>
</li>
<li>
<p>
We are now ready to create our AIDL interface
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/src/com/marakana/android/fibonaccicommon/IFibonacciService.aidl</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciRequest<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciResponse<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IFibonacciService</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span>in <span style="color: #008080">long</span> n<span style="color: #990000">);</span>
    <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span>in <span style="color: #008080">long</span> n<span style="color: #990000">);</span>
    <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span>in <span style="color: #008080">long</span> n<span style="color: #990000">);</span>
    <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span>in <span style="color: #008080">long</span> n<span style="color: #990000">);</span>
    <span style="color: #008080">FibonacciResponse</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>in <span style="color: #008080">FibonacciRequest</span> request<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Our interface clearly depends on two custom Java types, which we have to not only implement in Java, but define in their own <tt>.aidl</tt> files
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/src/com/marakana/android/fibonaccicommon/FibonacciRequest.aidl</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>

<span style="color: #008080">parcelable</span> FibonacciRequest<span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/src/com/marakana/android/fibonaccicommon/FibonacciRequest.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcel<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcelable<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibonacciRequest</span> <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> Parcelable <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">enum</span> Type <span style="color: #FF0000">{</span>
        RECURSIVE_JAVA<span style="color: #990000">,</span> ITERATIVE_JAVA<span style="color: #990000">,</span> RECURSIVE_NATIVE<span style="color: #990000">,</span> ITERATIVE_NATIVE
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">long</span> n<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">Type</span> type<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciRequest</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">,</span> <span style="color: #008080">Type</span> type<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>n <span style="color: #990000">=</span> n<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>type <span style="color: #990000">==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">NullPointerException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Type must not be null"</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type <span style="color: #990000">=</span> type<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">getN</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> n<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">Type</span> <span style="font-weight: bold"><span style="color: #000000">getType</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> type<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">describeContents</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">writeToParcel</span></span><span style="color: #990000">(</span><span style="color: #008080">Parcel</span> parcel<span style="color: #990000">,</span> <span style="color: #009900">int</span> flags<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writeLong</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>n<span style="color: #990000">);</span>
        parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writeInt</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ordinal</span></span><span style="color: #990000">());</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> Parcelable<span style="color: #990000">.</span><span style="color: #008080">Creator&lt;FibonacciRequest&gt;</span> CREATOR <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Parcelable<span style="color: #990000">.</span>Creator<span style="color: #990000">&lt;</span>FibonacciRequest<span style="color: #990000">&gt;()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">FibonacciRequest</span> <span style="font-weight: bold"><span style="color: #000000">createFromParcel</span></span><span style="color: #990000">(</span><span style="color: #008080">Parcel</span> in<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="color: #009900">long</span> n <span style="color: #990000">=</span> in<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">readLong</span></span><span style="color: #990000">();</span>
            <span style="color: #008080">Type</span> type <span style="color: #990000">=</span> Type<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">values</span></span><span style="color: #990000">()[</span>in<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">readInt</span></span><span style="color: #990000">()];</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciRequest</span></span><span style="color: #990000">(</span>n<span style="color: #990000">,</span> type<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> FibonacciRequest<span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">newArray</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> size<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> FibonacciRequest<span style="color: #990000">[</span>size<span style="color: #990000">];</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/src/com/marakana/android/fibonaccicommon/FibonacciResponse.aidl</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>

<span style="color: #008080">parcelable</span> FibonacciResponse<span style="color: #990000">;</span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/src/com/marakana/android/fibonaccicommon/FibonacciResponse.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcel<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcelable<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibonacciResponse</span> <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> Parcelable <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">long</span> result<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">long</span> timeInMillis<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciResponse</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> result<span style="color: #990000">,</span> <span style="color: #009900">long</span> timeInMillis<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>result <span style="color: #990000">=</span> result<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>timeInMillis <span style="color: #990000">=</span> timeInMillis<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">getResult</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">getTimeInMillis</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> timeInMillis<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">describeContents</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">writeToParcel</span></span><span style="color: #990000">(</span><span style="color: #008080">Parcel</span> parcel<span style="color: #990000">,</span> <span style="color: #009900">int</span> flags<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writeLong</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>result<span style="color: #990000">);</span>
        parcel<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">writeLong</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>timeInMillis<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> Parcelable<span style="color: #990000">.</span><span style="color: #008080">Creator&lt;FibonacciResponse&gt;</span> CREATOR <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> Parcelable<span style="color: #990000">.</span>Creator<span style="color: #990000">&lt;</span>FibonacciResponse<span style="color: #990000">&gt;()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">FibonacciResponse</span> <span style="font-weight: bold"><span style="color: #000000">createFromParcel</span></span><span style="color: #990000">(</span><span style="color: #008080">Parcel</span> in<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciResponse</span></span><span style="color: #990000">(</span>in<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">readLong</span></span><span style="color: #990000">(),</span> in<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">readLong</span></span><span style="color: #990000">());</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> FibonacciResponse<span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">newArray</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> size<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> FibonacciResponse<span style="color: #990000">[</span>size<span style="color: #990000">];</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Finally we are now ready to take a look at our generated Java interface
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/gen/com/marakana/android/fibonaccicommon/IFibonacciService.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IFibonacciService</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>IInterface
<span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">abstract</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Stub</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Binder
        <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacci<span style="color: #990000">.</span>IFibonacciService <span style="color: #FF0000">{</span>
        …
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacci<span style="color: #990000">.</span><span style="color: #008080">IFibonacciService</span> <span style="font-weight: bold"><span style="color: #000000">asInterface</span></span><span style="color: #990000">(</span>
            android<span style="color: #990000">.</span>os<span style="color: #990000">.</span><span style="color: #008080">IBinder</span> obj<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            …
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span><span style="color: #008080">IBinder</span> <span style="font-weight: bold"><span style="color: #000000">asBinder</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        …
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span><span style="color: #008080">FibonacciResponse</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>
        com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span><span style="color: #008080">FibonacciRequest</span> request<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_fibonacciservice_implement_aidl_interface_and_expose_it_to_our_clients">4.6. FibonacciService - Implement AIDL Interface and Expose It To Our Clients</h3>
<div class="ulist"><ul>
<li>
<p>
We start by creating a new Android project, which will host the our AIDL Service implementation as well as provide a mechanism to access (i.e. bind to) our service implementation
</p>
<div class="ulist"><ul>
<li>
<p>
Project Name: <tt>FibonacciService</tt>
</p>
</li>
<li>
<p>
Build Target: Android 2.2 (API 8) or later
</p>
</li>
<li>
<p>
Package Name: <tt>com.marakana.android.fibonacciservice</tt>
</p>
</li>
<li>
<p>
Application name: Fibonacci Service
</p>
</li>
<li>
<p>
Min SDK Version: 8
</p>
</li>
<li>
<p>
No need to specify an Android activity
</p>
</li>
</ul></div>
</li>
<li>
<p>
We need to link this project to the <tt>FibonacciCommon</tt> in order to be able to access the common APIs: project properties &#8594; <tt>Android</tt> &#8594; <tt>Library</tt> &#8594; <tt>Add…</tt> &#8594; <tt>FibonacciCommon</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
As the result, <tt>FibonacciService/default.properties</tt> now has <tt>android.library.reference.1=../FibonacciCommon</tt> and <tt>FibonacciService/.classpath</tt> and <tt>FibonacciService/.project</tt> also link to <tt>FibonacciCommon</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Our service will make use of the <tt>com.marakana.android.fibonaccinative.FibLib</tt>, which provides the actual implementation of the Fibonacci algorithms
</p>
</li>
<li>
<p>
We copy (or move) this Java class (as well as the <tt>jni/</tt> implementation) from the <tt>FibonacciNative</tt> project
</p>
<div class="ulist"><ul>
<li>
<p>
Don&#8217;t forget to run <tt>ndk-build</tt> under <tt>FibonacciService/</tt> in order to generate the required native library
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_implement_aidl_interface">4.7. Implement AIDL Interface</h3>
<div class="ulist"><ul>
<li>
<p>
We are now ready to implement our AIDL-defined interface by extending from the auto-generated <tt>com.marakana.android.fibonaccicommon.IFibonacciService.Stub</tt> (which in turn extends from <tt>android.os.Binder</tt>)
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/src/com/marakana/android/fibonacciservice/IFibonacciServiceImpl.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacciservice<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>SystemClock<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciRequest<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciResponse<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>IFibonacciService<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccinative<span style="color: #990000">.</span>FibLib<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">IFibonacciServiceImpl</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> IFibonacciService<span style="color: #990000">.</span>Stub <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"IFibonacciServiceImpl"</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fibJI(%d)"</span><span style="color: #990000">,</span> n<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fibJR(%d)"</span><span style="color: #990000">,</span> n<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fibNI(%d)"</span><span style="color: #990000">,</span> n<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fibNR(%d)"</span><span style="color: #990000">,</span> n<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">FibonacciResponse</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span><span style="color: #008080">FibonacciRequest</span> request<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span>
                String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fib(%d, %s)"</span><span style="color: #990000">,</span> request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getN</span></span><span style="color: #990000">(),</span> request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getType</span></span><span style="color: #990000">()));</span>
        <span style="color: #009900">long</span> timeInMillis <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">();</span>
        <span style="color: #009900">long</span> result<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getType</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ITERATIVE_JAVA<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span>request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getN</span></span><span style="color: #990000">());</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> RECURSIVE_JAVA<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span>request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getN</span></span><span style="color: #990000">());</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ITERATIVE_NATIVE<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span>request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getN</span></span><span style="color: #990000">());</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> RECURSIVE_NATIVE<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span>request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getN</span></span><span style="color: #990000">());</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        timeInMillis <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">()</span> <span style="color: #990000">-</span> timeInMillis<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciResponse</span></span><span style="color: #990000">(</span>result<span style="color: #990000">,</span> timeInMillis<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_expose_our_aidl_defined_service_implementation_to_clients">4.8. Expose our AIDL-defined Service Implementation to Clients</h3>
<div class="ulist"><ul>
<li>
<p>
In order for clients (callers) to use our service, they first need to bind to it.
</p>
</li>
<li>
<p>
But in order for them to <em>bind</em> to it, we first need to expose it via our own <tt>android.app.Service</tt>'s <tt>onBind(Intent)</tt> implementation
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/src/com/marakana/android/fibonacciservice/FibonacciService.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacciservice<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Service<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Intent<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>IBinder<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibonacciService</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Service <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/1.png" alt="1" /></span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"FibonacciService"</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">IFibonacciServiceImpl</span> service<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/2.png" alt="2" /></span></span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">IFibonacciServiceImpl</span></span><span style="color: #990000">();</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/3.png" alt="3" /></span></span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onCreate()'ed"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/5.png" alt="5" /></span></span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">IBinder</span> <span style="font-weight: bold"><span style="color: #000000">onBind</span></span><span style="color: #990000">(</span><span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onBind()'ed"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/5.png" alt="5" /></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/4.png" alt="4" /></span></span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">boolean</span> <span style="font-weight: bold"><span style="color: #000000">onUnbind</span></span><span style="color: #990000">(</span><span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onUnbind()'ed"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="./images/icons/callouts/5.png" alt="5" /></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onUnbind</span></span><span style="color: #990000">(</span>intent<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onDestroy</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onDestroy()'ed"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onDestroy</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
We create yet another "service" object by extending from <tt>android.app.Service</tt>. The purpose of <tt>FibonacciService</tt> object is to provide access to our Binder-based <tt>IFibonacciServiceImpl</tt> object.
</td></tr>
<tr><td><img src="./images/icons/callouts/2.png" alt="2" /></td><td>
Here we simply declare a local reference to <tt>IFibonacciServiceImpl</tt>, which will act as a singleton (i.e. all clients will share a single instance). Since our <tt>IFibonacciServiceImpl</tt> does not require any special initialization, we could instantiate it at this point, but we choose to delay this until the <tt>onCreate()</tt> method.
</td></tr>
<tr><td><img src="./images/icons/callouts/3.png" alt="3" /></td><td>
Now we instantiate our <tt>IFibonacciServiceImpl</tt> that we&#8217;ll be providing to our clients (in the <tt>onBind(Intent)</tt> method). If our <tt>IFibonacciServiceImpl</tt> required access to the <tt>Context</tt> (which it doesn&#8217;t) we could pass a reference to <tt>this</tt> (i.e. <tt>android.app.Service</tt>, which implements <tt>android.content.Context</tt>) at this point. Many Binder-based services use <tt>Context</tt> in order to access other platform functionality.
</td></tr>
<tr><td><img src="./images/icons/callouts/4.png" alt="4" /></td><td>
This is where we provide access to our <tt>IFibonacciServiceImpl</tt> object to our clients. By design, we chose to have only one instance of <tt>IFibonacciServiceImpl</tt> (so all clients share it) but we could also provide each client with their own instance of <tt>IFibonacciServiceImpl</tt>.
</td></tr>
<tr><td><img src="./images/icons/callouts/5.png" alt="5" /></td><td>
We just add some logging calls to make it easy to track the life-cycle of our service.
</td></tr>
</table></div>
</li>
<li>
<p>
Finally, we register our <tt>FibonacciService</tt> in our <tt>AndroidManifest.xml</tt>, so that clients can find it
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
    <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice"</span> <span style="color: #009900">android:versionCode</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
    <span style="color: #009900">android:versionName</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-sdk</span></span> <span style="color: #009900">android:minSdkVersion</span><span style="color: #990000">=</span><span style="color: #FF0000">"8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> <span style="color: #009900">android:icon</span><span style="color: #990000">=</span><span style="color: #FF0000">"@drawable/icon"</span> <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;service</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".FibonacciService"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonaccicommon.IFibonacciService"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span> <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- <img src="./images/icons/callouts/1.png" alt="1" /> --&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/service&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./images/icons/callouts/1.png" alt="1" /></td><td>
The name of this action is arbitrary, but it is a common convention to use the fully-qualified name of our AIDL-derived interface.
</td></tr>
</table></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_fibonacciclient_using_aidl_defined_binder_based_services">4.9. FibonacciClient - Using AIDL-defined Binder-based Services</h3>
<div class="ulist"><ul>
<li>
<p>
We start by creating a new Android project, which will server as the client of the AIDL Service we previously implemented
</p>
<div class="ulist"><ul>
<li>
<p>
Project Name: <tt>FibonacciClient</tt>
</p>
</li>
<li>
<p>
Build Target: Android 2.2 (API 8) or later
</p>
</li>
<li>
<p>
Package Name: <tt>com.marakana.android.fibonacciclient</tt>
</p>
</li>
<li>
<p>
Application name: Fibonacci Client
</p>
</li>
<li>
<p>
Create activity: <tt>FibonacciActivity</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
We&#8217;ll repurpose most of this activity&#8217;s code from <tt>FibonacciNative</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Min SDK Version: 8
</p>
</li>
</ul></div>
</li>
<li>
<p>
We need to link this project to the <tt>FibonacciCommon</tt> in order to be able to access the common APIs: project properties &#8594; <tt>Android</tt> &#8594; <tt>Library</tt> &#8594; <tt>Add…</tt> &#8594; <tt>FibonacciCommon</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
As the result, <tt>FibonacciClient/default.properties</tt> now has <tt>android.library.reference.1=../FibonacciCommon</tt> and <tt>FibonacciClient/.classpath</tt> and <tt>FibonacciClient/.project</tt> also link to <tt>FibonacciCommon</tt>
</p>
</li>
<li>
<p>
As an alternative, we could&#8217;ve avoided creating <tt>FibonacciCommon</tt> in the first place
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>FibonacciService</tt> and <tt>FibonacciClient</tt> could have each had a copy of: <tt>IFibonacciService.aidl, </tt>FibonacciRequest.aidl<tt>, </tt>FibonacciResponse.aidl<tt>, </tt>FibonacciResult.java<tt>, and </tt>FibonacciResponse.java++
</p>
</li>
<li>
<p>
But we don&#8217;t like duplicating source code (even though the binaries do get duplicated at runtime)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Our client will make use of the string resources and layout definition from <tt>FibonacciNative</tt> application
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciClient/res/values/strings.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"hello"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Get Your Fibonacci Here!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Fibonacci Client<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"input_hint"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Enter N<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"input_error"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Numbers only!<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"button_text"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Get Fib Result<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"progress_text"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Calculating...<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"fib_error"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Failed to get Fibonacci result<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"type_fib_jr"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibJR<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"type_fib_ji"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibJI<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"type_fib_nr"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibNR<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"type_fib_ni"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>fibNI<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>FibonacciClient/res/layout/main.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;LinearLayout</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
    <span style="color: #009900">android:orientation</span><span style="color: #990000">=</span><span style="color: #FF0000">"vertical"</span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span>
    <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;TextView</span></span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/hello"</span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span> <span style="color: #009900">android:textSize</span><span style="color: #990000">=</span><span style="color: #FF0000">"25sp"</span> <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"center"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;EditText</span></span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/input"</span>
        <span style="color: #009900">android:hint</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/input_hint"</span> <span style="color: #009900">android:inputType</span><span style="color: #990000">=</span><span style="color: #FF0000">"number"</span>
        <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"right"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioGroup</span></span> <span style="color: #009900">android:orientation</span><span style="color: #990000">=</span><span style="color: #FF0000">"horizontal"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type"</span>
        <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:checked</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_jr"</span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/type_fib_jr"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_ji"</span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/type_fib_ji"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_nr"</span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/type_fib_nr"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;RadioButton</span></span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
            <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/type_fib_ni"</span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/type_fib_ni"</span>
            <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:layout_weight</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/RadioGroup&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;Button</span></span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/button_text"</span> <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/button"</span>
        <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;TextView</span></span> <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/output"</span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span>
        <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"match_parent"</span> <span style="color: #009900">android:textSize</span><span style="color: #990000">=</span><span style="color: #FF0000">"20sp"</span> <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"center|top"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/LinearLayout&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
We are now ready to implement our client
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciClient/src/com/marakana/android/fibonacciclient/FibonacciActivity.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacciclient<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Activity<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>ProgressDialog<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>ComponentName<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Intent<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>ServiceConnection<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>AsyncTask<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Bundle<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>IBinder<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>SystemClock<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>text<span style="color: #990000">.</span>TextUtils<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">.</span>OnClickListener<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Button<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>EditText<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>RadioGroup<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>TextView<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Toast<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciRequest<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciResponse<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>IFibonacciService<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibonacciActivity</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Activity <span style="color: #008080">implements</span> OnClickListener<span style="color: #990000">,</span>
        ServiceConnection <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"FibonacciActivity"</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">EditText</span> input<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// our input n</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">Button</span> button<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// trigger for fibonacci calcualtion</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">RadioGroup</span> type<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// fibonacci implementation type</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">TextView</span> output<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// destination for fibonacci result</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">IFibonacciService</span> service<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// reference to our service</span></span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span><span style="color: #008080">Bundle</span> savedInstanceState<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span>savedInstanceState<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setContentView</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>layout<span style="color: #990000">.</span>main<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// connect to our UI elements</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input <span style="color: #990000">=</span> <span style="color: #990000">(</span>EditText<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>input<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button <span style="color: #990000">=</span> <span style="color: #990000">(</span>Button<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>button<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type <span style="color: #990000">=</span> <span style="color: #990000">(</span>RadioGroup<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output <span style="color: #990000">=</span> <span style="color: #990000">(</span>TextView<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>output<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// request button click call-backs via onClick(View) method</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setOnClickListener</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// the button will be enabled once we connect to the service</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setEnabled</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onResume</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onResume()'ed"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onResume</span></span><span style="color: #990000">();</span>
        <span style="font-style: italic"><span style="color: #9A1900">// Bind to our FibonacciService service, by looking it up by its name</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// and passing ourselves as the ServiceConnection object</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// We'll get the actual IFibonacciService via a callback to</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// onServiceConnected() below</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(!</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindService</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>IFibonacciService<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getName</span></span><span style="color: #990000">()),</span>
                <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> BIND_AUTO_CREATE<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">w</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to bind to service"</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPause</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onPause()'ed"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onPause</span></span><span style="color: #990000">();</span>
        <span style="font-style: italic"><span style="color: #9A1900">// No need to keep the service bound (and alive) any longer than</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// necessary</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbindService</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onServiceConnected</span></span><span style="color: #990000">(</span><span style="color: #008080">ComponentName</span> name<span style="color: #990000">,</span> <span style="color: #008080">IBinder</span> service<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onServiceConnected()'ed to "</span> <span style="color: #990000">+</span> name<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// finally we can get to our IFibonacciService</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> IFibonacciService<span style="color: #990000">.</span>Stub<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">asInterface</span></span><span style="color: #990000">(</span>service<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// enable the button, because the IFibonacciService is initialized</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setEnabled</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onServiceDisconnected</span></span><span style="color: #990000">(</span><span style="color: #008080">ComponentName</span> name<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onServiceDisconnected()'ed to "</span> <span style="color: #990000">+</span> name<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// our IFibonacciService service is no longer connected</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
        <span style="font-style: italic"><span style="color: #9A1900">// disabled the button, since we cannot use IFibonacciService</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setEnabled</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// handle button clicks</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onClick</span></span><span style="color: #990000">(</span><span style="color: #008080">View</span> view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// parse n from input (or report errors)</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">long</span> n<span style="color: #990000">;</span>
        <span style="color: #008080">String</span> s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getText</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">toString</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>TextUtils<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isEmpty</span></span><span style="color: #990000">(</span>s<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
            n <span style="color: #990000">=</span> Long<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseLong</span></span><span style="color: #990000">(</span>s<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">NumberFormatException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setError</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getText</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>input_error<span style="color: #990000">));</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-style: italic"><span style="color: #9A1900">// build the request object</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> FibonacciRequest<span style="color: #990000">.</span><span style="color: #008080">Type</span> type<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getCheckedRadioButtonId</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_jr<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>RECURSIVE_JAVA<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_ji<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>ITERATIVE_JAVA<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_nr<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>RECURSIVE_NATIVE<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_ni<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>ITERATIVE_NATIVE<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">FibonacciRequest</span> request <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciRequest</span></span><span style="color: #990000">(</span>n<span style="color: #990000">,</span> type<span style="color: #990000">);</span>

        <span style="font-style: italic"><span style="color: #9A1900">// showing the user that the calculation is in progress</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">ProgressDialog</span> dialog <span style="color: #990000">=</span> ProgressDialog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">""</span><span style="color: #990000">,</span>
                <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getText</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>progress_text<span style="color: #990000">),</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// since the calculation can take a long time, we do it in a separate</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// thread to avoid blocking the UI</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> AsyncTask<span style="color: #990000">&lt;</span>Void<span style="color: #990000">,</span> Void<span style="color: #990000">,</span> String<span style="color: #990000">&gt;()</span> <span style="color: #FF0000">{</span>
            @Override
            <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #008080">String</span> <span style="font-weight: bold"><span style="color: #000000">doInBackground</span></span><span style="color: #990000">(</span>Void<span style="color: #990000">...</span> params<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">// this method runs in a background thread</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
                    <span style="color: #009900">long</span> totalTime <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">();</span>
                    <span style="color: #008080">FibonacciResponse</span> response <span style="color: #990000">=</span> FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service
                            <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>request<span style="color: #990000">);</span>
                    totalTime <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">()</span> <span style="color: #990000">-</span> totalTime<span style="color: #990000">;</span>
                    <span style="font-style: italic"><span style="color: #9A1900">// generate the result</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>
                            <span style="color: #FF0000">"fibonacci(%d)=%d</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">in %d ms</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">(+ %d ms)"</span><span style="color: #990000">,</span> n<span style="color: #990000">,</span>
                            response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getResult</span></span><span style="color: #990000">(),</span> response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTimeInMillis</span></span><span style="color: #990000">(),</span>
                            totalTime <span style="color: #990000">-</span> response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTimeInMillis</span></span><span style="color: #990000">());</span>
                <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">RemoteException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">wtf</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to communicate with the service"</span><span style="color: #990000">,</span> e<span style="color: #990000">);</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>

            @Override
            <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPostExecute</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> result<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">// get rid of the dialog</span></span>
                dialog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dismiss</span></span><span style="color: #990000">();</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>result <span style="color: #990000">==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                    <span style="font-style: italic"><span style="color: #9A1900">// handle error</span></span>
                    Toast<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">makeText</span></span><span style="color: #990000">(</span>FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>fib_error<span style="color: #990000">,</span>
                            Toast<span style="color: #990000">.</span>LENGTH_SHORT<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">();</span>
                <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                    <span style="font-style: italic"><span style="color: #9A1900">// show the result to the user</span></span>
                    FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setText</span></span><span style="color: #990000">(</span>result<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">execute</span></span><span style="color: #990000">();</span> <span style="font-style: italic"><span style="color: #9A1900">// run our AsyncTask</span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Our activity should already be registered in our <tt>AndroidManifest.xml</tt> file
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciClient/AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
    <span style="color: #009900">android:versionCode</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span> <span style="color: #009900">android:versionName</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span>
    <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciclient"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-sdk</span></span> <span style="color: #009900">android:minSdkVersion</span><span style="color: #990000">=</span><span style="color: #FF0000">"8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> <span style="color: #009900">android:icon</span><span style="color: #990000">=</span><span style="color: #FF0000">"@drawable/icon"</span> <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciclient.FibonacciActivity"</span>
            <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.action.MAIN"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;category</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.category.LAUNCHER"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
And the result should look like
</p>
<div class="imageblock">
<div class="content">
<img src="screens/FibonacciClientResult.png" alt="screens/FibonacciClientResult.png" />
</div>
</div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_async_ipc_via_binder">4.10. Async-IPC via Binder</h3>
<div class="ulist"><ul>
<li>
<p>
Binder allows for the asynchronous communication between the client and its service via the <tt>oneway</tt> declaration on the AIDL interface
</p>
</li>
<li>
<p>
Of course, we still care about the result, so generally async calls are used with call-backs - typically through listeners
</p>
</li>
<li>
<p>
When clients provide a reference to themselves as call-back listeners, then the roles reverse at the time the listeners are called: clients' listeners become the services, and services become the clients to those listeners
</p>
</li>
<li>
<p>
This is best explained via an example (based on Fibonacci)
</p>
</li>
<li>
<p>
The code is available
</p>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/FibonacciAsyncBinderDemo/zipball/master">https://github.com/marakana/FibonacciAsyncBinderDemo/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/FibonacciAsyncBinderDemo">Git</a>: <tt>git clone <a href="https://github.com/marakana/FibonacciAsyncBinderDemo.git">https://github.com/marakana/FibonacciAsyncBinderDemo.git</a></tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_fibonaccicommon_defining_a_tt_oneway_tt_aidl_service">4.10.1. FibonacciCommon - Defining a <tt>oneway</tt> AIDL Service</h4>
<div class="ulist"><ul>
<li>
<p>
First, we need a listener, which itself is a <tt>oneway</tt> AIDL-defined "service":
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/src/com/marakana/android/fibonaccicommon/IFibonacciServiceResponseListener.aidl</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciRequest<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciResponse<span style="color: #990000">;</span>

oneway <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IFibonacciServiceResponseListener</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onResponse</span></span><span style="color: #990000">(</span>in <span style="color: #008080">FibonacciResponse</span> response<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Now we can create a our <tt>oneway</tt> (i.e. asynchronous) interface:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciCommon/src/com/marakana/android/fibonaccicommon/IFibonacciService.aidl</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciRequest<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciResponse<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>IFibonacciServiceResponseListener<span style="color: #990000">;</span>

oneway <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">IFibonacciService</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>in <span style="color: #008080">FibonacciRequest</span> request<span style="color: #990000">,</span> in <span style="color: #008080">IFibonacciServiceResponseListener</span> listener<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_fibonacciservice_implementing_our_async_aidl_service">4.10.2. FibonacciService - Implementing our async AIDL service</h4>
<div class="ulist"><ul>
<li>
<p>
The implementation of our service invokes the listener, as opposed to returning a result:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/src/com/marakana/android/fibonacciservice/IFibonacciServiceImpl.java</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacciservice<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>SystemClock<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciRequest<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciResponse<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>IFibonacciService<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>IFibonacciServiceResponseListener<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccinative<span style="color: #990000">.</span>FibLib<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">IFibonacciServiceImpl</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> IFibonacciService<span style="color: #990000">.</span>Stub <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"IFibonacciServiceImpl"</span><span style="color: #990000">;</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span><span style="color: #008080">FibonacciRequest</span> request<span style="color: #990000">,</span>
            <span style="color: #008080">IFibonacciServiceResponseListener</span> listener<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> RemoteException <span style="color: #FF0000">{</span>
        <span style="color: #009900">long</span> n <span style="color: #990000">=</span> request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getN</span></span><span style="color: #990000">();</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"fib("</span> <span style="color: #990000">+</span> n <span style="color: #990000">+</span> <span style="color: #FF0000">")"</span><span style="color: #990000">);</span>
        <span style="color: #009900">long</span> timeInMillis <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">();</span>
        <span style="color: #009900">long</span> result<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>request<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getType</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ITERATIVE_JAVA<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJI</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> RECURSIVE_JAVA<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ITERATIVE_NATIVE<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNI</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> RECURSIVE_NATIVE<span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span>n<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
            result <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        timeInMillis <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">()</span> <span style="color: #990000">-</span> timeInMillis<span style="color: #990000">;</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Got fib(%d) = %d in %d ms"</span><span style="color: #990000">,</span> n<span style="color: #990000">,</span> result<span style="color: #990000">,</span>
                timeInMillis<span style="color: #990000">));</span>
        listener<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onResponse</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciResponse</span></span><span style="color: #990000">(</span>result<span style="color: #990000">,</span> timeInMillis<span style="color: #990000">));</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The service will not block waiting for the listener to return, because the listener itself is also <tt>oneway</tt>.</td>
</tr></table>
</div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_fibonacciclient_implementing_our_async_aidl_client">4.10.3. FibonacciClient - Implementing our async AIDL client</h4>
<div class="ulist"><ul>
<li>
<p>
Finally, we implement our client, which itself has to also implement a listener as a Binder service:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciClient/src/com/marakana/android/fibonacciclient/FibonacciActivity.java</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacciclient<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Activity<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Dialog<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>ProgressDialog<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>ComponentName<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Intent<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>ServiceConnection<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Bundle<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Handler<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>IBinder<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Message<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>SystemClock<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>text<span style="color: #990000">.</span>TextUtils<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">.</span>OnClickListener<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Button<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>EditText<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>RadioGroup<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>TextView<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciRequest<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>FibonacciResponse<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>IFibonacciService<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonaccicommon<span style="color: #990000">.</span>IFibonacciServiceResponseListener<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibonacciActivity</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Activity <span style="color: #008080">implements</span> OnClickListener<span style="color: #990000">,</span>
        ServiceConnection <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"FibonacciActivity"</span><span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">// the id of a message to our response handler</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">int</span> RESPONSE_MESSAGE_ID <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">// the id of a progress dialog that we'll be creating</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">int</span> PROGRESS_DIALOG_ID <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">EditText</span> input<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// our input n</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">Button</span> button<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// trigger for fibonacci calcualtion</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">RadioGroup</span> type<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// fibonacci implementation type</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">TextView</span> output<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// destination for fibonacci result</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">IFibonacciService</span> service<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// reference to our service</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">// the responsibility of the responseHandler is to take messages</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// from the responseListener (defined below) and display their content</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// in the UI thread</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">Handler</span> responseHandler <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Handler</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        @Override
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">handleMessage</span></span><span style="color: #990000">(</span><span style="color: #008080">Message</span> message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>message<span style="color: #990000">.</span>what<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> RESPONSE_MESSAGE_ID<span style="color: #990000">:</span>
                Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Handling response"</span><span style="color: #990000">);</span>
                FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setText</span></span><span style="color: #990000">((</span>String<span style="color: #990000">)</span> message<span style="color: #990000">.</span>obj<span style="color: #990000">);</span>
                FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">removeDialog</span></span><span style="color: #990000">(</span>PROGRESS_DIALOG_ID<span style="color: #990000">);</span>
                <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">// the responsibility of the responseListener is to receive call-backs</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// from the service when our FibonacciResponse is available</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">IFibonacciServiceResponseListener</span> responseListener <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> IFibonacciServiceResponseListener<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Stub</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

        <span style="font-style: italic"><span style="color: #9A1900">// this method is executed on one of the pooled binder threads</span></span>
        @Override
        <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onResponse</span></span><span style="color: #990000">(</span><span style="color: #008080">FibonacciResponse</span> response<span style="color: #990000">)</span>
                <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> RemoteException <span style="color: #FF0000">{</span>
            <span style="color: #008080">String</span> result <span style="color: #990000">=</span> String<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"%d in %d ms"</span><span style="color: #990000">,</span> response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getResult</span></span><span style="color: #990000">(),</span>
                    response<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTimeInMillis</span></span><span style="color: #990000">());</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Got response: "</span> <span style="color: #990000">+</span> result<span style="color: #990000">);</span>
            <span style="font-style: italic"><span style="color: #9A1900">// since we cannot update the UI from a non-UI thread,</span></span>
            <span style="font-style: italic"><span style="color: #9A1900">// we'll send the result to the responseHandler (defined above)</span></span>
            <span style="color: #008080">Message</span> message <span style="color: #990000">=</span> FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>responseHandler
                    <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">obtainMessage</span></span><span style="color: #990000">(</span>RESPONSE_MESSAGE_ID<span style="color: #990000">,</span> result<span style="color: #990000">);</span>
            FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>responseHandler<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sendMessage</span></span><span style="color: #990000">(</span>message<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span><span style="color: #008080">Bundle</span> savedInstanceState<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span>savedInstanceState<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setContentView</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>layout<span style="color: #990000">.</span>main<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// connect to our UI elements</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input <span style="color: #990000">=</span> <span style="color: #990000">(</span>EditText<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>input<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button <span style="color: #990000">=</span> <span style="color: #990000">(</span>Button<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>button<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type <span style="color: #990000">=</span> <span style="color: #990000">(</span>RadioGroup<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output <span style="color: #990000">=</span> <span style="color: #990000">(</span>TextView<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>output<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// request button click call-backs via onClick(View) method</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setOnClickListener</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// the button will be enabled once we connect to the service</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setEnabled</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onStart</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onStart()'ed"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onStart</span></span><span style="color: #990000">();</span>
        <span style="font-style: italic"><span style="color: #9A1900">// Bind to our FibonacciService service, by looking it up by its name</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// and passing ourselves as the ServiceConnection object</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// We'll get the actual IFibonacciService via a callback to</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// onServiceConnected() below</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(!</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bindService</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>IFibonacciService<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getName</span></span><span style="color: #990000">()),</span>
                <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> BIND_AUTO_CREATE<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">w</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to bind to service"</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onStop</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onStop()'ed"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onStop</span></span><span style="color: #990000">();</span>
        <span style="font-style: italic"><span style="color: #9A1900">// No need to keep the service bound (and alive) any longer than</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// necessary</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">unbindService</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onServiceConnected</span></span><span style="color: #990000">(</span><span style="color: #008080">ComponentName</span> name<span style="color: #990000">,</span> <span style="color: #008080">IBinder</span> service<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onServiceConnected()'ed to "</span> <span style="color: #990000">+</span> name<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// finally we can get to our IFibonacciService</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> IFibonacciService<span style="color: #990000">.</span>Stub<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">asInterface</span></span><span style="color: #990000">(</span>service<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// enable the button, because the IFibonacciService is initialized</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setEnabled</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onServiceDisconnected</span></span><span style="color: #990000">(</span><span style="color: #008080">ComponentName</span> name<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onServiceDisconnected()'ed to "</span> <span style="color: #990000">+</span> name<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">// our IFibonacciService service is no longer connected</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>
        <span style="font-style: italic"><span style="color: #9A1900">// disabled the button, since we cannot use IFibonacciService</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setEnabled</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #008080">Dialog</span> <span style="font-weight: bold"><span style="color: #000000">onCreateDialog</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> id<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>id<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> PROGRESS_DIALOG_ID<span style="color: #990000">:</span>
            <span style="font-style: italic"><span style="color: #9A1900">// this dialog will be opened in onClick(...) and</span></span>
            <span style="font-style: italic"><span style="color: #9A1900">// dismissed/removed by responseHandler.handleMessage(...)</span></span>
            <span style="color: #008080">ProgressDialog</span> dialog <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ProgressDialog</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
            dialog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setMessage</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getText</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>progress_text<span style="color: #990000">));</span>
            dialog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setIndeterminate</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> dialog<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreateDialog</span></span><span style="color: #990000">(</span>id<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// handle button clicks</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onClick</span></span><span style="color: #990000">(</span><span style="color: #008080">View</span> view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// parse n from input (or report errors)</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">long</span> n<span style="color: #990000">;</span>
        <span style="color: #008080">String</span> s <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getText</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">toString</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>TextUtils<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isEmpty</span></span><span style="color: #990000">(</span>s<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
            n <span style="color: #990000">=</span> Long<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parseLong</span></span><span style="color: #990000">(</span>s<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">NumberFormatException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>input<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setError</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getText</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>input_error<span style="color: #990000">));</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-style: italic"><span style="color: #9A1900">// build the request object</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> FibonacciRequest<span style="color: #990000">.</span><span style="color: #008080">Type</span> type<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>FibonacciActivity<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>type<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getCheckedRadioButtonId</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_jr<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>RECURSIVE_JAVA<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_ji<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>ITERATIVE_JAVA<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_nr<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>RECURSIVE_NATIVE<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>type_fib_ni<span style="color: #990000">:</span>
            type <span style="color: #990000">=</span> FibonacciRequest<span style="color: #990000">.</span>Type<span style="color: #990000">.</span>ITERATIVE_NATIVE<span style="color: #990000">;</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">FibonacciRequest</span> request <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FibonacciRequest</span></span><span style="color: #990000">(</span>n<span style="color: #990000">,</span> type<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Submitting request..."</span><span style="color: #990000">);</span>
            <span style="color: #009900">long</span> time <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">();</span>
            <span style="font-style: italic"><span style="color: #9A1900">// submit the request; the response will come to responseListener</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fib</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>responseListener<span style="color: #990000">);</span>
            time <span style="color: #990000">=</span> SystemClock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">uptimeMillis</span></span><span style="color: #990000">()</span> <span style="color: #990000">-</span> time<span style="color: #990000">;</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Submited request in "</span> <span style="color: #990000">+</span> time <span style="color: #990000">+</span> <span style="color: #FF0000">" ms"</span><span style="color: #990000">);</span>
            <span style="font-style: italic"><span style="color: #9A1900">// this dialog will be dismissed/removed by responseHandler</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">showDialog</span></span><span style="color: #990000">(</span>PROGRESS_DIALOG_ID<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">RemoteException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">wtf</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to communicate with the service"</span><span style="color: #990000">,</span> e<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_lab_binder_based_service_with_aidl">4.11. Lab: Binder-based Service with AIDL</h3>
<div class="paragraph"><p>Create an AIDL-described <tt>ILogService</tt> that provides the following functionality:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logservice<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">ILogService</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #008080">LogMessage</span> logMessage<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>where <tt>LogMessage</tt> is defined as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logservice<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LogMessage</span> … <span style="color: #FF0000">{</span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #000000">LogMessage</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> priority<span style="color: #990000">,</span> <span style="color: #008080">String</span> tag<span style="color: #990000">,</span> <span style="color: #008080">String</span> msg<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        …
    <span style="color: #FF0000">}</span>
    …
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Create a simple Android client that allows the user to submit a <tt>LogMessage</tt> request to the remote <tt>ILogService</tt> running in a separate process.</p></div>
<div class="paragraph"><p>You can borrow code (UI) from the basic <tt>LogNative</tt> application, which you can get:</p></div>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/LogNative/zipball/master">https://github.com/marakana/LogNative/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/LogNative">Git</a>: <tt>git clone <a href="https://github.com/marakana/LogNative.git">https://github.com/marakana/LogNative.git</a></tt>
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Your implementation could simply use <tt>android.util.Log.println(int priority, String tag, String msg)</tt> to do the logging.</td>
</tr></table>
</div>
<div class="paragraph"><p>The solution is provided:</p></div>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/LogBinderDemo/zipball/master">https://github.com/marakana/LogBinderDemo/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/LogBinderDemo">Git</a>: <tt>git clone <a href="https://github.com/marakana/LogBinderDemo.git">https://github.com/marakana/LogBinderDemo.git</a></tt>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Android_Security">5. Android Security</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_4">5.1. Overview</h3>
<div class="ulist"><ul>
<li>
<p>
Android Security Architecture
</p>
</li>
<li>
<p>
Android Application Signing
</p>
</li>
<li>
<p>
Understanding Android User IDs
</p>
</li>
<li>
<p>
File Access Permissions on Android
</p>
</li>
<li>
<p>
Using Permissions in Android Applications
</p>
</li>
<li>
<p>
Android Permission Enforcement
</p>
<div class="ulist"><ul>
<li>
<p>
Permissions enforced by the Linux kernel
</p>
</li>
<li>
<p>
Permissions enforced by the Application Framework Services
</p>
</li>
</ul></div>
</li>
<li>
<p>
Custom Android Permissions
</p>
<div class="ulist"><ul>
<li>
<p>
Declaring Custom Permissions
</p>
</li>
<li>
<p>
Requiring Custom Permissions
</p>
</li>
<li>
<p>
Enforcing Permissions Dynamically
</p>
</li>
</ul></div>
</li>
<li>
<p>
ContentProvider URI Permissions
</p>
</li>
<li>
<p>
Developer DOs and DON&#8217;Ts
</p>
<div class="ulist"><ul>
<li>
<p>
Public vs. Private Components
</p>
</li>
<li>
<p>
Intent Broadcast Permissions
</p>
</li>
<li>
<p>
Pending Intents
</p>
</li>
</ul></div>
</li>
<li>
<p>
Encryption on Android
</p>
<div class="ulist"><ul>
<li>
<p>
Application Data Encryption: OpenSSL, JCE/BouncyCastle
</p>
</li>
<li>
<p>
Whole Disk Encryption via dm-crypt
</p>
</li>
</ul></div>
</li>
<li>
<p>
Rooting Android Devices
</p>
<div class="ulist"><ul>
<li>
<p>
Controlling access to <tt>/system/bin/sh</tt>
</p>
</li>
<li>
<p>
Understanding Android Exploits
</p>
<div class="ulist"><ul>
<li>
<p>
UDEV exploit (exploid)
</p>
</li>
<li>
<p>
ADB setuid exhaustion attack (rageagainstthecage)
</p>
</li>
<li>
<p>
Buffer-overrun of vold (softbreak/gingerbreak)
</p>
</li>
<li>
<p>
Webkit exploits
</p>
</li>
<li>
<p>
Others
</p>
</li>
</ul></div>
</li>
<li>
<p>
To root or not to root
</p>
</li>
<li>
<p>
Malware rootkits
</p>
</li>
</ul></div>
</li>
<li>
<p>
Memory protection on Android (ASLR, etc.)
</p>
</li>
<li>
<p>
Tap-Jacking on Android
</p>
</li>
<li>
<p>
Device Administration (management) on Android
</p>
</li>
<li>
<p>
Building Anti-malware Applications for Android
</p>
</li>
<li>
<p>
Other Security Concerns
</p>
<div class="ulist"><ul>
<li>
<p>
Bootloaders
</p>
</li>
<li>
<p>
Security of GMail accounts affecting security of Android devices
</p>
</li>
<li>
<p>
Social-engineering vectors of attack
</p>
</li>
<li>
<p>
Encryption of communication
</p>
</li>
<li>
<p>
Firewall
</p>
</li>
<li>
<p>
SE-Linux
</p>
</li>
<li>
<p>
Recovery mode
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_android_security_architecture">5.2. Android Security Architecture</h3>
<div class="imageblock">
<div class="content">
<img src="images/AndroidProcessSnapshot-NoPermissions.svg" alt="images/AndroidProcessSnapshot-NoPermissions.svg" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Android is privilege-separated operating system
</p>
<div class="ulist"><ul>
<li>
<p>
Each app runs with a separate process with a distinct system identity (user/group ID), as do parts of the system
</p>
</li>
<li>
<p>
OS (Linux) provides app isolation (sandboxing)
</p>
</li>
</ul></div>
</li>
<li>
<p>
By default, no app can do anything to adversely affect other apps, the system, or the user
</p>
<div class="ulist"><ul>
<li>
<p>
E.g. reading/writing user data, modifying other apps'/system' files and settings, accessing network, keeping the device awake, etc.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Android provides fine-grained permission system that restricts what apps can do if they want to play outside the sandbox
</p>
<div class="ulist"><ul>
<li>
<p>
Apps statically declare permissions they need (use)
</p>
</li>
<li>
<p>
The Android system prompts the user for consent at app installation-time (and on update if changed)
</p>
</li>
<li>
<p>
No support for dynamic (run-time) granting of permissions (complicates user experience)
</p>
</li>
<li>
<p>
The responsibility lies with the user to make educated decisions as to which apps to install based on the list of requested permissions
</p>
</li>
<li>
<p>
Prone <a href="http://en.wikipedia.org/wiki/Confused_deputy_problem">confused deputy attacks</a> where a non-privileged malicious app exploits a vulnerable interface of another privileged (but "confused") application
</p>
</li>
</ul></div>
</li>
<li>
<p>
Apps can explicitly share resources/data, via ContentProviders, Intents, Binder/IPC, local sockets, or the file system
</p>
<div class="ulist"><ul>
<li>
<p>
This sharing goes un-checked by Android
</p>
</li>
<li>
<p>
The entire system prone to <a href="http://www.informatik.tu-darmstadt.de/fileadmin/user_upload/Group_TRUST/PubsPDF/NDSS_2012_Towards_Taming_Privilege-Escalation_Attacks_on_Android.pdf">collusion attacks</a> where malicious applications can collude to combine their permissions, allowing them to perform actions beyond their individual privileges
</p>
</li>
</ul></div>
</li>
<li>
<p>
Linux kernel is the sole mechanism of application (i.e. process) sandboxing
</p>
<div class="ulist"><ul>
<li>
<p>
Dalvik VM is not a security boundary
</p>
</li>
<li>
<p>
Native code (via NDK) is subject to the same restrictions (i.e. no extra privileges)
</p>
</li>
</ul></div>
</li>
<li>
<p>
All apps are created equal
</p>
<div class="ulist"><ul>
<li>
<p>
Sandboxed in the same way
</p>
</li>
<li>
<p>
Same level of security from each other
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_application_signing">5.3. Application Signing</h3>
<div class="ulist"><ul>
<li>
<p>
All apps (<tt>.apk</tt> files) <em>must be</em> digitally signed prior to installation on a device with a certificate whose private key is kept confidential by the developer of the application
</p>
</li>
<li>
<p>
Android uses the certificate as a means of:
</p>
<div class="ulist"><ul>
<li>
<p>
Identifying the author of an application
</p>
<div class="ulist"><ul>
<li>
<p>
Used to ensure the authenticity of future application updates
</p>
</li>
</ul></div>
</li>
<li>
<p>
Establishing trust relationships between applications
</p>
<div class="ulist"><ul>
<li>
<p>
Applications signed with the same certificate can share signature-level permissions, runtime process, user-id, and data
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
The signing process is based on public-key cryptography, as defined by Java&#8217;s JAR specification
</p>
<div class="ulist"><ul>
<li>
<p>
The private/signing key is kept confidential by the developer of the application
</p>
</li>
<li>
<p>
The certificate (including the public key) is embedded in the application itself (<tt>META-INF/CERT.RSA</tt>), along with the signature generated with the private key (<tt>META-INF/CERT.SF</tt>)
</p>
<div class="ulist"><ul>
<li>
<p>
The certificate can be self-signed - <strong>no trusted 3rd party (i.e. certification authority) is required</strong>
</p>
</li>
<li>
<p>
The certificate&#8217;s validity period should be 25 years or longer
</p>
<div class="ulist"><ul>
<li>
<p>
The certificate validity is only verified during the installation/update process (not at startup) - so apps with expired certificates would continue to function normally, but could not be updated
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Key/certificate management, app signing, and key verification can be accomplished using a number of tools:
</p>
<div class="ulist"><ul>
<li>
<p>
Java's <tt>keytool</tt> - used to create/manage keys (in keystores)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ keytool -genkey -v -keystore marakana.keystore -alias android -keyalg RSA -keysize 2048 -validity 10000 \
  -dname "CN=Android Application Signer, OU=Android, O=Marakana Inc., L=San Francisco, ST=California, C=US"</tt></pre>
</div></div>
</li>
<li>
<p>
Java&#8217;s <tt>jarsigner</tt> - used to sign/verify <tt>.apk</tt> files (signing is done in-place, replacing any existing signatures)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ jarsigner -keystore marakana.keystore MyApp.apk android
$ jarsigner -verify MyApp.apk
jar verified.</tt></pre>
</div></div>
</li>
<li>
<p>
Android's ADT Export Wizard for Eclipse - offers a wizard UI over the whole signing process (wraps <tt>keytool</tt>/<tt>jarsigner</tt> functionality)
</p>
</li>
</ul></div>
</li>
<li>
<p>
During the development, Android allows the use of the debug key (<tt>~/.android/debug.keystore</tt>), but applications <em>must be</em> signed using a real key prior to publishing
</p>
</li>
<li>
<p>
To print the information about the certificate embedded in an APK, we can do the following:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ jar -xvf MyApp.apk META-INF/CERT.RSA
$ keytool -printcert -file META-INF/CERT.RSA
Owner: CN=Android Application Signer, OU=Android, O=Marakana Inc., L=San Francisco, ST=California, C=US
Issuer: CN=Android Application Signer, OU=Android, O=Marakana Inc., L=San Francisco, ST=California, C=US
Serial number: 4f4e6461
Valid from: Wed Feb 29 11:46:09 CST 2012 until: Sun Feb 22 11:46:09 CST 2037
Certificate fingerprints:
     MD5:  57:B8:23:06:09:CD:2A:C9:9C:02:6C:B4:5D:1C:34:BD
     SHA1: 2E:49:E4:20:81:9E:A3:E9:91:5D:99:57:2A:A6:88:0E:23:14:63:AA
     Signature algorithm name: SHA1withRSA
     Version: 3
$ rm META-INF/CERT.RSA &amp;&amp; rmdir META-INF</tt></pre>
</div></div>
</li>
<li>
<p>
An APK could be signed using multiple keys (each with a different alias), though this is an uncommon use-case
</p>
</li>
</ul></div>
</li>
<li>
<p>
Since signatures are applied to the individual files, not the <tt>.apk</tt> itself, developers <strong>should</strong> use Android&#8217;s <tt>zipalign</tt> tool to optimize the final <tt>.apk</tt> package
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ zipalign -v 4 UnalignedApp.apk AlignedApp.apk</tt></pre>
</div></div>
</li>
<li>
<p>
See <a href="http://developer.android.com/guide/publishing/app-signing.html">http://developer.android.com/guide/publishing/app-signing.html</a>
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="Platform_Keys">5.3.1. Platform Keys</h4>
<div class="ulist"><ul>
<li>
<p>
AOSP comes with four platform keys in <tt>build/target/product/security/</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>platform</tt> - used to sign core parts of the system (configured with <tt>LOCAL_CERTIFICATE := platform</tt>): framework core, BackupRestoreConfirmation, DefaultContainerService, SettingsProvider, SharedStorageBackup, SystemUI, VpnDialogs, Bluetooth, CertInstaller, KeyChain, Nfc, PackageInstaller, Phone, Provision, Settings, Stk, TelephonyProvider, etc.
</p>
</li>
<li>
<p>
<tt>shared</tt> - used to sign home/contacts part of AOSP (configured with <tt>LOCAL_CERTIFICATE := shared</tt>): Contacts, Launcher2, QuickSearchBox, LatinIME, PinyinIME, ApplicationsProvider, ContactsProvider, UserDictionaryProvider, and built-in live wall papers
</p>
</li>
<li>
<p>
<tt>media</tt> - used to sign media/download framework parts of AOSP (configured with <tt>LOCAL_CERTIFICATE := media</tt>): Gallery, DownloadProvider, DrmProvider, MediaProvider
</p>
</li>
<li>
<p>
<tt>testkey</tt> - used to sign everything else - i.e. this is the default key for packages that don&#8217;t specify one of the keys above
</p>
</li>
</ul></div>
</li>
<li>
<p>
The keys provided by default cannot be used to ship an actual product (enforced by CTS)
</p>
</li>
<li>
<p>
For example, to generate our own keys, we can use the supplied <tt>development/tools/make_key</tt> command for each <tt>platform</tt>, <tt>media</tt>, <tt>shared</tt>, and <tt>testkey</tt>:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
<tt>$ rm build/target/product/security/platform.p*</tt>
</p>
</li>
<li>
<p>
<tt>$ SIGNER="/C=US/ST=California/L=San Francisco/O=Marakana Inc./OU=Android/CN=Android Platform Signer/emailAddress=<a href="mailto:android@marakana">android@marakana</a>.com"</tt>
</p>
</li>
<li>
<p>
<tt>$ echo | development/tools/make_key build/target/product/security/platform "$SIGNER"</tt>
</p>
</li>
<li>
<p>
Repeat for <tt>media</tt>, <tt>shared</tt>, and <tt>testkey</tt>
</p>
</li>
</ol></div>
</li>
<li>
<p>
To sign our own app using the platform key:
</p>
<div class="ulist"><ul>
<li>
<p>
If we are building it as part of the ROM, we can just add <tt>LOCAL_CERTIFICATE := platform</tt> to our app&#8217;s <tt>Android.mk</tt> file
</p>
</li>
<li>
<p>
To sign our app outside the build process, assuming we have access to platform sources and keys, we could use the <tt>signapk.jar</tt> tool:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ java -jar /path/to/aosp/out/host/linux-x86/framework/signapk.jar \
    /path/to/aosp/build/target/product/security/platform.x509.pem \
    /path/to/aosp/build/target/product/security/platform.pk8 \
    MyApp.apk MySignedApp.apk</tt></pre>
</div></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_user_ids">5.4. User IDs</h3>
<div class="ulist"><ul>
<li>
<p>
Each app (package) is assigned an arbitrary, but distinct, OS user ID at installation time
</p>
<div class="ulist"><ul>
<li>
<p>
Typically something like <tt>app_XX</tt> (e.g. <tt>app_79</tt>), where the actual UID is offset from <tt>10000</tt>
</p>
</li>
<li>
<p>
Does not change during app&#8217;s life on a device
</p>
</li>
<li>
<p>
For example, the Browser app is assigned UID <tt>10001</tt> (though it could be different), which translates to <tt>app_1</tt>:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb -e shell cat /data/system/packages.list |grep com.android.browser
com.android.browser 10001 0 /data/data/com.android.browser</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Each app process runs under its own UID:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb -e shell ps |grep com.android.browser
app_1     682   37    192592 53144 ffffffff 40011384 S com.android.browser</tt></pre>
</div></div>
</li>
<li>
<p>
All app resources are owned by its UID
</p>
<div class="listingblock">
<div class="content">
<pre><tt>adb -e shell ls -l /data/data/com.android.browser
drwxrwx--x app_1    app_1             2012-02-06 12:47 app_appcache
drwxrwx--x app_1    app_1             2012-02-06 12:47 app_databases
drwxrwx--x app_1    app_1             2012-02-06 12:47 app_geolocation
drwxrwx--x app_1    app_1             2012-02-06 12:47 app_icons
drwxrwx--x app_1    app_1             2012-02-06 12:47 cache
drwxrwx--x app_1    app_1             2012-02-06 12:48 databases
drwxr-xr-x system   system            2012-01-17 15:42 lib
drwxrwx--x app_1    app_1             2012-02-06 12:47 shared_prefs</tt></pre>
</div></div>
</li>
<li>
<p>
Apps that are signed with the same certificate can share data, user ID, as well as run in a single process
</p>
<div class="ulist"><ul>
<li>
<p>
They just need to specify the same <tt>sharedUserId</tt> and <tt>process</tt>
</p>
<div class="listingblock">
<div class="title"><tt>AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.myapp"</span>
          <span style="color: #009900">android:sharedUserId</span><span style="color: #990000">=</span><span style="color: #FF0000">"myapp"</span>
          <span style="color: #009900">android:sharedUserLabel</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/myapp_uid"</span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> <span style="color: #009900">android:process</span><span style="color: #990000">=</span><span style="color: #FF0000">"myapp"</span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">From the security standpoint, packages with the same <tt>sharedUserId</tt> are treated as being parts of the same application, with the same UID and file permissions.</td>
</tr></table>
</div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_file_access">5.5. File Access</h3>
<div class="ulist"><ul>
<li>
<p>
Android has a number of different partitions:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell mount
rootfs / rootfs ro 0 0
tmpfs /dev tmpfs rw,nosuid,mode=755 0 0
devpts /dev/pts devpts rw,mode=600 0 0
proc /proc proc rw 0 0
sysfs /sys sysfs rw 0 0
none /acct cgroup rw,cpuacct 0 0
tmpfs /mnt/asec tmpfs rw,mode=755,gid=1000 0 0
tmpfs /mnt/obb tmpfs rw,mode=755,gid=1000 0 0
none /dev/cpuctl cgroup rw,cpu 0 0
/dev/block/mtdblock0 /system yaffs2 ro 0 0
/dev/block/mtdblock1 /data yaffs2 rw,nosuid,nodev 0 0
/dev/block/mtdblock2 /cache yaffs2 rw,nosuid,nodev 0 0
/dev/block/vold/179:0 /mnt/sdcard vfat rw,dirsync,nosuid,nodev,noexec,uid=1000,gid=1015,fmask=0702,dmask=0702,allow_utime=0020,codepage=cp437,iocharset=iso8859-1,shortname=mixed,utf8,errors=remount-ro 0 0
/dev/block/vold/179:0 /mnt/secure/asec vfat rw,dirsync,nosuid,nodev,noexec,uid=1000,gid=1015,fmask=0702,dmask=0702,allow_utime=0020,codepage=cp437,iocharset=iso8859-1,shortname=mixed,utf8,errors=remount-ro 0 0
tmpfs /mnt/sdcard/.android_secure tmpfs ro,size=0k,mode=000 0 0</tt></pre>
</div></div>
</li>
<li>
<p>
The notable ones include:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/</tt> - the read-only root file system, containing the <tt>init</tt> process plus some bootstrapping configuration files
</p>
</li>
<li>
<p>
<tt>/system</tt> - the read-only home of the Android OS, containing the system libraries (including HAL and application framework), executables (daemons), fonts, media, and system apps
</p>
</li>
<li>
<p>
<tt>/data</tt> - the read-write file system containing user apps as well as application data (e.g. settings, preferences, etc) and system state information
</p>
</li>
<li>
<p>
<tt>/cache</tt> - the read-write file system containing transient user state (e.g. browser cache)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Apps could be stored in several locations:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/system/app/&lt;App-Name&gt;.apk</tt> (for system apps)
</p>
<div class="ulist"><ul>
<li>
<p>
The optimized dex code for this app would be stored as <tt>/system/app/&lt;App-Name&gt;.odex</tt>
</p>
</li>
<li>
<p>
When booted into safe-mode (by holding pre-configured keys pressed on power-on), Android will only make system apps available to the user
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/data/app/&lt;App-Name&gt;.apk</tt> (for pre-loaded user apps)
</p>
<div class="ulist"><ul>
<li>
<p>
The optimized dex code for this app would be stored as <tt>/data/dalvik-cache/&lt;App-Name&gt;.odex</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/data/app/&lt;app-package-name&gt;-1.apk</tt> (for downloaded user apps)
</p>
<div class="ulist"><ul>
<li>
<p>
The optimized dex code for this app would be stored as <tt>/data/dalvik-cache/data@app@&lt;app-package-name&gt;-1.apk@classes.dex</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/mnt/secure/asec/&lt;app-package-name&gt;-1.asec</tt> (for apps moved to SD Card)
</p>
<div class="ulist"><ul>
<li>
<p>
The optimized dex code for this app would be stored as <tt>/data/dalvik-cache/mnt@asec@&lt;app-package-name&gt;-1@<a href="mailto:pkg.apk@classes">pkg.apk@classes</a>.dex</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
To find out where a particular application is stored, we can ask the package manager:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell pm path com.android.browser
package:/system/app/Browser.apk</tt></pre>
</div></div>
</li>
<li>
<p>
Files created by apps are owned by apps' distinct user/group ID and are not world-accessible
</p>
<div class="ulist"><ul>
<li>
<p>
Stored under <tt>/data/data/&lt;app-package-name&gt;/</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Native libraries (generated by NDK) are copied to <tt>/data/data/&lt;app-package-name&gt;/lib/lib&lt;library-name&gt;.so</tt>
</p>
</li>
<li>
<p>
Exceptions
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/mnt/sdcard</tt> is FAT32, so free-for-all (though it requires <tt>android.permission.WRITE_TO_EXTERNAL_STORAGE</tt> permission)
</p>
</li>
<li>
<p>
Apps can create files, preferences, database with <tt>MODE_WORLD_READABLE</tt> and/or <tt>MODE_WORLD_WRITABLE</tt>, which affect world access, but not file ownership
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_using_permissions">5.6. Using Permissions</h3>
<div class="ulist"><ul>
<li>
<p>
By default, apps cannot do much outside their sandbox
</p>
</li>
<li>
<p>
Attempts to access restricted resources without holding the appropriate permission
</p>
<div class="ulist"><ul>
<li>
<p>
Fail with <tt>SecurityException</tt> (explicit failures)
</p>
<div class="ulist"><ul>
<li>
<p>
For example, dialing a number (i.e. starting an activity with action <tt>android.intent.action.CALL</tt> for some data URI/phone-number) is restricted
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell run-as com.example.helloworld am start -a android.intent.action.CALL -d tel:4155551234
Starting: Intent { act=android.intent.action.CALL dat=tel:xxxxxxxxxx }
java.lang.SecurityException: Permission Denial: starting Intent { act=android.intent.action.CALL dat=tel:xxxxxxxxxx flg=0x10000000 cmp=com.android.phone/.OutgoingCallBroadcaster } from null (pid=1533, uid=10045) requires android.permission.CALL_PHONE
    at android.os.Parcel.readException(Parcel.java:1327)
    at android.os.Parcel.readException(Parcel.java:1281)
    at android.app.ActivityManagerProxy.startActivity(ActivityManagerNative.java:1631)
    at com.android.commands.am.Am.runStart(Am.java:433)
    at com.android.commands.am.Am.run(Am.java:107)
    at com.android.commands.am.Am.main(Am.java:80)
    at com.android.internal.os.RuntimeInit.finishInit(Native Method)
    at com.android.internal.os.RuntimeInit.main(RuntimeInit.java:238)
    at dalvik.system.NativeStart.main(Native Method)</tt></pre>
</div></div>
</li>
<li>
<p>
For example, trying to read a private system directory is restricted:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell run-as com.example.helloworld ls /data/misc/keystore
opendir failed, Permission denied</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Ignored but logged by the system (implicit failures) - e.g. <tt>BroadcastReceiver</tt> listening on a protected intent
</p>
</li>
</ul></div>
</li>
<li>
<p>
To access restricted features of the system or other apps, apps developers are are required to <em>use</em> permissions via explicit <tt>&lt;uses-permission&gt;</tt>-s in <tt>AndroidManifest.xml</tt>
</p>
</li>
<li>
<p>
Subject to one-time user-approval, permissions are granted at install time with no support for run-time per-use user approval
</p>
</li>
<li>
<p>
For example, an app that wishes to track user by GPS and report location via network/SMS would require three permissions: access (fine) location, access the internet, and send SMS
</p>
</li>
<li>
<p>
Its <tt>AndroidManifest.xml</tt> would look like this:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span> <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.trackapp"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.ACCESS_FINE_LOCATION"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.INTERNET"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.SEND_SMS"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
For the list of built-in permissions:
</p>
<div class="ulist"><ul>
<li>
<p>
See <a href="http://developer.android.com/reference/android/Manifest.permission.html">http://developer.android.com/reference/android/Manifest.permission.html</a>
</p>
</li>
<li>
<p>
Or run:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>adb shell pm list permissions
All Permissions:

permission:android.permission.CLEAR_APP_USER_DATA
permission:android.permission.SHUTDOWN
permission:android.permission.BIND_INPUT_METHOD
permission:android.permission.ACCESS_DRM
permission:android.permission.DOWNLOAD_CACHE_NON_PURGEABLE
permission:android.permission.INTERNAL_SYSTEM_WINDOW
permission:android.permission.SEND_DOWNLOAD_COMPLETED_INTENTS
permission:android.permission.MOVE_PACKAGE
permission:android.permission.ACCESS_CHECKIN_PROPERTIES
permission:android.permission.CRYPT_KEEPER
permission:android.permission.READ_INPUT_STATE
permission:android.permission.DEVICE_POWER
permission:android.permission.DELETE_PACKAGES
permission:android.permission.ACCESS_CACHE_FILESYSTEM
permission:android.permission.REBOOT
permission:android.permission.STATUS_BAR
permission:android.permission.ACCESS_DOWNLOAD_MANAGER_ADVANCED
permission:android.permission.ACCESS_ALL_DOWNLOADS
permission:android.permission.STOP_APP_SWITCHES
permission:android.permission.BIND_VPN_SERVICE
permission:android.permission.CONTROL_LOCATION_UPDATES
permission:android.permission.ACCESS_DOWNLOAD_MANAGER
permission:android.permission.MANAGE_APP_TOKENS
permission:android.permission.BIND_PACKAGE_VERIFIER
permission:android.permission.DELETE_CACHE_FILES
permission:android.permission.BATTERY_STATS
permission:android.permission.COPY_PROTECTED_DATA
permission:com.android.email.permission.ACCESS_PROVIDER
permission:android.permission.INSTALL_DRM
permission:android.permission.MASTER_CLEAR
permission:android.permission.SET_ACTIVITY_WATCHER
permission:android.permission.BRICK
permission:android.permission.MODIFY_NETWORK_ACCOUNTING
permission:android.permission.READ_NETWORK_USAGE_HISTORY
permission:android.permission.BACKUP
permission:android.permission.SET_TIME
permission:android.permission.STATUS_BAR_SERVICE
permission:android.permission.INSTALL_PACKAGES
permission:android.permission.PERFORM_CDMA_PROVISIONING
permission:android.permission.INJECT_EVENTS
permission:android.permission.SET_POINTER_SPEED
permission:com.android.browser.permission.PRELOAD
permission:android.permission.WRITE_SECURE_SETTINGS
permission:android.permission.INSTALL_LOCATION_PROVIDER
permission:android.permission.CONFIRM_FULL_BACKUP
permission:android.permission.PACKAGE_USAGE_STATS
permission:android.permission.ACCESS_SURFACE_FLINGER
permission:android.permission.CALL_PRIVILEGED
permission:android.permission.PACKAGE_VERIFICATION_AGENT
permission:android.permission.CHANGE_COMPONENT_ENABLED_STATE
permission:android.intent.category.MASTER_CLEAR.permission.C2D_MESSAGE
permission:android.permission.WRITE_GSERVICES
permission:android.permission.MANAGE_NETWORK_POLICY
permission:android.permission.ALLOW_ANY_CODEC_FOR_PLAYBACK
permission:android.permission.BIND_TEXT_SERVICE
permission:android.permission.READ_FRAME_BUFFER
permission:android.permission.FORCE_BACK
permission:android.permission.UPDATE_DEVICE_STATS
permission:android.permission.BIND_WALLPAPER
permission:android.permission.BIND_REMOTEVIEWS
permission:android.permission.SET_ORIENTATION
permission:android.permission.FACTORY_TEST
permission:android.permission.BIND_DEVICE_ADMIN</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Add <tt>-f</tt> for the full description of permissions - i.e. <tt>adb shell pm list permissions -f</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
Or take a look at <tt>frameworks/base/core/res/AndroidManifest.xml</tt> in AOSP source tree
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_permission_enforcement">5.7. Permission Enforcement</h3>
<div class="paragraph"><p>There are a number of trigger points for security/permission checks:</p></div>
<div class="sect3">
<h4 id="_kernel_file_system_permission_enforcement">5.7.1. Kernel / File-system Permission Enforcement</h4>
<div class="ulist"><ul>
<li>
<p>
Access to system resources (files/drivers/unix-sockets and net/BT-sockets) is restricted via a combination of
</p>
<div class="ulist"><ul>
<li>
<p>
File-system permissions
</p>
</li>
<li>
<p>
Paranoid network security (Android-specific kernel-patches)
</p>
</li>
</ul></div>
</li>
<li>
<p>
File/driver/unix-socket ownership/permissions are set in:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/init</tt> process
</p>
</li>
<li>
<p>
<tt>/init.rc</tt> file(s)
</p>
</li>
<li>
<p>
<tt>/ueventd.rc</tt> file(s)
</p>
</li>
<li>
<p>
system ROM (via <tt>system/core/include/private/android_filesystem_config.h</tt> in AOSP)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Application's logical permissions (i.e. ones defined via <tt>&lt;uses-permission&gt;</tt> in <tt>AndroidManifest.xml</tt>) are mapped to system groups via:
</p>
<div class="listingblock">
<div class="title"><tt>frameworks/base/data/etc/platform.xml</tt> (Android source code)</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;permissions&gt;</span></span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.INTERNET"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;group</span></span> <span style="color: #009900">gid</span><span style="color: #990000">=</span><span style="color: #FF0000">"inet"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/permission&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.CAMERA"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;group</span></span> <span style="color: #009900">gid</span><span style="color: #990000">=</span><span style="color: #FF0000">"camera"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/permission&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.READ_LOGS"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;group</span></span> <span style="color: #009900">gid</span><span style="color: #990000">=</span><span style="color: #FF0000">"log"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/permission&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.WRITE_EXTERNAL_STORAGE"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;group</span></span> <span style="color: #009900">gid</span><span style="color: #990000">=</span><span style="color: #FF0000">"sdcard_rw"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/permission&gt;</span></span>
  …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/permissions&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Run <tt>adb shell cat /system/etc/permissions/platform.xml</tt> to see all the mappings</td>
</tr></table>
</div>
</li>
<li>
<p>
Permissions assigned to individual applications are stored in <tt>/data/system/packages.xml</tt>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_uid_based_permission_enforcement">5.7.2. UID-based Permission Enforcement</h4>
<div class="ulist"><ul>
<li>
<p>
Some system processes (daemons) explicitly check for the UID of the calling process (via IPC)
</p>
</li>
<li>
<p>
For example, <tt>servicemanager</tt> explicitly limits registration of new services to processes running as root, system, radio, media, nfc, and drm (with some additional restrictions)
</p>
<div class="listingblock">
<div class="title"><tt>frameworks/base/cmds/servicemanager/service_manager.c</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">unsigned</span> uid<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>name<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span> allowed<span style="color: #990000">[]</span> <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
<span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> LVMX
    <span style="color: #FF0000">{</span> AID_MEDIA<span style="color: #990000">,</span> <span style="color: #FF0000">"com.lifevibes.mx.ipc"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
    <span style="color: #FF0000">{</span> AID_MEDIA<span style="color: #990000">,</span> <span style="color: #FF0000">"media.audio_flinger"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_MEDIA<span style="color: #990000">,</span> <span style="color: #FF0000">"media.player"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_MEDIA<span style="color: #990000">,</span> <span style="color: #FF0000">"media.camera"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_MEDIA<span style="color: #990000">,</span> <span style="color: #FF0000">"media.audio_policy"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_DRM<span style="color: #990000">,</span>   <span style="color: #FF0000">"drm.drmManager"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_NFC<span style="color: #990000">,</span>   <span style="color: #FF0000">"nfc"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"radio.phone"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"radio.sms"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"radio.phonesubinfo"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"radio.simphonebook"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="font-style: italic"><span style="color: #9A1900">/* </span></span><span style="font-weight: bold"><span style="background-color: #66FFFF">TODO:</span></span><span style="font-style: italic"><span style="color: #9A1900"> remove after phone services are updated: */</span></span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"phone"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"sip"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"isms"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"iphonesubinfo"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">{</span> AID_RADIO<span style="color: #990000">,</span> <span style="color: #FF0000">"simphonebook"</span> <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>
…
<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">svc_can_register</span></span><span style="color: #990000">(</span><span style="color: #009900">unsigned</span> uid<span style="color: #990000">,</span> <span style="color: #008080">uint16_t</span> <span style="color: #990000">*</span>name<span style="color: #990000">)</span>
<span style="color: #FF0000">{</span>
    <span style="color: #009900">unsigned</span> n<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((</span>uid <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #990000">||</span> <span style="color: #990000">(</span>uid <span style="color: #990000">==</span> AID_SYSTEM<span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>n <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> n <span style="color: #990000">&lt;</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>allowed<span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="font-weight: bold"><span style="color: #0000FF">sizeof</span></span><span style="color: #990000">(</span>allowed<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]);</span> n<span style="color: #990000">++)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((</span>uid <span style="color: #990000">==</span> allowed<span style="color: #990000">[</span>n<span style="color: #990000">].</span>uid<span style="color: #990000">)</span> <span style="color: #990000">&amp;&amp;</span> <span style="font-weight: bold"><span style="color: #000000">str16eq</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> allowed<span style="color: #990000">[</span>n<span style="color: #990000">].</span>name<span style="color: #990000">))</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>
…</tt></pre></div></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_static_permission_enforcement">5.7.3. Static Permission Enforcement</h4>
<div class="ulist"><ul>
<li>
<p>
Automatically managed by <tt>ActivityManagerService</tt>
</p>
</li>
<li>
<p>
In <tt>AndroidManifest.xml</tt> an application restricts access to its components via <tt>andriod:permission</tt> attribute
</p>
<div class="ulist"><ul>
<li>
<p>
On <tt>&lt;activity&gt;</tt>, controls who can <tt>Context.startActivity()</tt> and <tt>startActivityForResult()</tt>
</p>
</li>
<li>
<p>
On <tt>&lt;service&gt;</tt>, controls who can <tt>Context.startService()</tt>, <tt>stopService()</tt>, and <tt>bindService()</tt>
</p>
</li>
<li>
<p>
On <tt>&lt;provider&gt;</tt>, controls who can access it via a <tt>ContentResolver</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>android:readPermission</tt> specifically controls who can <tt>ContentResolver.query()</tt>;
</p>
</li>
<li>
<p>
<tt>android:writePermission</tt> specifically controls who can <tt>ContentResolver.insert()</tt>, <tt>ContentResolver.update()</tt>, and <tt>ContentResolver.delete()</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
On <tt>&lt;receiver&gt;</tt>, controls who can send broadcasts to the receiver
</p>
<div class="ulist"><ul>
<li>
<p>
Receivers can also be registered programmatically, so the sender&#8217;s permission requirement can be specified via <tt>Context.registerReceiver(BroadcastReceiver receiver, IntentFilter filter, String broadcastPermission, Handler scheduler)</tt> method
</p>
</li>
<li>
<p>
Senders can also programmatically require that the receivers hold the appropriate permission via <tt>Context.sendBroadcast(Intent intent, String receiverPermission)</tt>
</p>
</li>
<li>
<p>
Some broadcasts are declared as <tt>&lt;protected-broadcast android:name="…" /&gt;</tt> in <tt>frameworks/base/core/res/AndroidManifest.xml</tt> (AOSP source tree) - these can only be sent by the system
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
For example:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".GetPasswordActivity"</span>
      <span style="color: #009900">android:permission</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.permission.GET_PASSWORD_FROM_USER"</span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;service</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".UserAuthenticatorService"</span>
      <span style="color: #009900">android:permission</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.permission.AUTHENTICATE_USER"</span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/service&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;provider</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".EnterpriseDataProvider"</span>
      <span style="color: #009900">android:readPermission</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.permission.READ_ENTERPRISE_DATA"</span>
      <span style="color: #009900">android:writePermission</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.permission.WRITE_ENTERPRISE_DATA"</span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/provider&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;receiver</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".UserAuthStatusReceiver"</span>
      <span style="color: #009900">android:permission</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.permission.SEND_USER_AUTH_STATUS"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/receiver&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_enforcing_permissions_dynamically">5.7.4. Enforcing Permissions Dynamically</h4>
<div class="imageblock">
<div class="content">
<img src="images/AndroidSecurityCallFlow.svg" alt="images/AndroidSecurityCallFlow.svg" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
Permissions can also be enforced programmatically
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>android.content.Context.checkCallingPermission(String permission)</tt>
</p>
</li>
<li>
<p>
<tt>android.content.Context.checkPermission(String permission, int pid, int uid)</tt>
</p>
</li>
<li>
<p>
<tt>android.content.Context.enforceCallingOrSelfPermission (String permission, String message)</tt>
</p>
</li>
<li>
<p>
…
</p>
</li>
<li>
<p>
<tt>android.content.pm.PackageManager.checkPermission(String permName, String pkgName)</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
All these return <tt>PackageManager.PERMISSION_GRANTED</tt> or <tt>PackageManager.PERMISSION_DENIED</tt>
</p>
</li>
<li>
<p>
This is how many of the application framework services enforce their permissions
</p>
<div class="listingblock">
<div class="title">frameworks/base/services/java/com/android/server/VibratorService.java</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>android<span style="color: #990000">.</span>server<span style="color: #990000">;</span>
…
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">VibratorService</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> IVibratorService<span style="color: #990000">.</span>Stub <span style="color: #FF0000">{</span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">vibrate</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> milliseconds<span style="color: #990000">,</span> <span style="color: #008080">IBinder</span> token<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>mContext<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkCallingOrSelfPermission</span></span><span style="color: #990000">(</span>android<span style="color: #990000">.</span>Manifest<span style="color: #990000">.</span>permission<span style="color: #990000">.</span>VIBRATE<span style="color: #990000">)</span>
      <span style="color: #990000">!=</span> PackageManager<span style="color: #990000">.</span>PERMISSION_GRANTED<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">SecurityException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Requires VIBRATE permission"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    …
  <span style="color: #FF0000">}</span>
  …
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">frameworks/base/services/java/com/android/server/LocationManagerService.java</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>android<span style="color: #990000">.</span>server<span style="color: #990000">;</span>
…
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LocationManagerService</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> ILocationManager<span style="color: #990000">.</span>Stub <span style="color: #008080">implements</span> Runnable <span style="color: #FF0000">{</span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> ACCESS_FINE_LOCATION <span style="color: #990000">=</span>
      android<span style="color: #990000">.</span>Manifest<span style="color: #990000">.</span>permission<span style="color: #990000">.</span>ACCESS_FINE_LOCATION<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> ACCESS_COARSE_LOCATION <span style="color: #990000">=</span>
      android<span style="color: #990000">.</span>Manifest<span style="color: #990000">.</span>permission<span style="color: #990000">.</span>ACCESS_COARSE_LOCATION<span style="color: #990000">;</span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">checkPermissionsSafe</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> provider<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((</span>LocationManager<span style="color: #990000">.</span>GPS_PROVIDER<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>provider<span style="color: #990000">)</span>
             <span style="color: #990000">||</span> LocationManager<span style="color: #990000">.</span>PASSIVE_PROVIDER<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>provider<span style="color: #990000">))</span>
        <span style="color: #990000">&amp;&amp;</span> <span style="color: #990000">(</span>mContext<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkCallingOrSelfPermission</span></span><span style="color: #990000">(</span>ACCESS_FINE_LOCATION<span style="color: #990000">)</span>
            <span style="color: #990000">!=</span> PackageManager<span style="color: #990000">.</span>PERMISSION_GRANTED<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">SecurityException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Provider "</span> <span style="color: #990000">+</span> provider
                <span style="color: #990000">+</span> <span style="color: #FF0000">" requires ACCESS_FINE_LOCATION permission"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>LocationManager<span style="color: #990000">.</span>NETWORK_PROVIDER<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>provider<span style="color: #990000">)</span>
        <span style="color: #990000">&amp;&amp;</span> <span style="color: #990000">(</span>mContext<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkCallingOrSelfPermission</span></span><span style="color: #990000">(</span>ACCESS_FINE_LOCATION<span style="color: #990000">)</span>
            <span style="color: #990000">!=</span> PackageManager<span style="color: #990000">.</span>PERMISSION_GRANTED<span style="color: #990000">)</span>
        <span style="color: #990000">&amp;&amp;</span> <span style="color: #990000">(</span>mContext<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkCallingOrSelfPermission</span></span><span style="color: #990000">(</span>ACCESS_COARSE_LOCATION<span style="color: #990000">)</span>
            <span style="color: #990000">!=</span> PackageManager<span style="color: #990000">.</span>PERMISSION_GRANTED<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">SecurityException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Provider "</span> <span style="color: #990000">+</span> provider
                <span style="color: #990000">+</span> <span style="color: #FF0000">" requires ACCESS_FINE_LOCATION or ACCESS_COARSE_LOCATION permission"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> Location <span style="font-weight: bold"><span style="color: #000000">_getLastKnownLocationLocked</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> provider<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">checkPermissionsSafe</span></span><span style="color: #990000">(</span>provider<span style="color: #990000">);</span>
    …
  <span style="color: #FF0000">}</span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">Location</span> <span style="font-weight: bold"><span style="color: #000000">getLastKnownLocation</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> provider<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    …
    <span style="font-weight: bold"><span style="color: #000000">_getLastKnownLocationLocked</span></span><span style="color: #990000">(</span>provider<span style="color: #990000">);</span>
    …
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Not very common in application code
</p>
<div class="ulist"><ul>
<li>
<p>
Can be used in bound services to differentiate access to specific methods (e.g. "administrative" operations)
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_declaring_custom_permissions">5.8. Declaring Custom Permissions</h3>
<div class="paragraph"><p>Before we can enforce our own permissions, we have to declare them using one or more <tt>&lt;permission&gt;</tt> in</p></div>
<div class="listingblock">
<div class="title"><tt>AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span> <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.myapp"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span>
    <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.example.app.DO_X"</span>
    <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/do_x_label"</span>
    <span style="color: #009900">android:description</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/do_x_desc"</span>
    <span style="color: #009900">android:permissionGroup</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission-group.PERSONAL_INFO"</span>
    <span style="color: #009900">android:protectionLevel</span><span style="color: #990000">=</span><span style="color: #FF0000">"dangerous"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="sect3">
<h4 id="_permission_components">5.8.1. Permission Components</h4>
<div class="ulist"><ul>
<li>
<p>
<tt>name</tt> - arbitrary but unique (name-spaced) identifier of this permission
</p>
</li>
<li>
<p>
<tt>protectionLevel</tt> - specifies if/how will Android inform the user when another app uses this permission
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>normal</tt> (0) - A low-risk permission that is automatically granted (by default), though users have an option to review these before installing (users often just ignore)
</p>
</li>
<li>
<p>
<tt>dangerous</tt> (1) - A higher-risk permission that requires explicit user approval at install time (preferred)
</p>
</li>
<li>
<p>
<tt>signature</tt> (2) - A permission that will be granted automatically if the requesting app shares the signature of the declaring app (preferred for application "suites")
</p>
</li>
<li>
<p>
<tt>signatureOrSystem</tt> (3) - A permission that will be granted only to packages in <tt>/system/app/</tt> (i.e. burned to ROM) or that are signed with the same certificates.
</p>
<div class="ulist"><ul>
<li>
<p>
This is useful in special-cases where different vendors supply apps to be built into system image, and those apps need to work together
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
<tt>label</tt> - a short description of the functionality protected by the permission (ignored when <tt>protectionLevel=signature*</tt>)
</p>
</li>
<li>
<p>
<tt>description</tt> - a longer description (warning) of what can go wrong if the permission is abused (ignored when <tt>protectionLevel=signature*</tt>)
</p>
</li>
<li>
<p>
<tt>android:icon</tt> - an drawable resource describing this permission
</p>
</li>
<li>
<p>
<tt>permissionGroup</tt> - helps organize (group) permissions by some pre-determined categories (e.g. <tt>….COST_MONEY</tt>, <tt>….PERSONAL_INFO</tt>, <tt>….SYSTEM_TOOLS</tt>, etc.)
</p>
<div class="ulist"><ul>
<li>
<p>
See <a href="http://d.android.com/reference/android/Manifest.permission_group.html">http://d.android.com/reference/android/Manifest.permission_group.html</a> for the existing Android categories
</p>
</li>
<li>
<p>
For example
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell pm list permission-groups
permission group:android.permission-group.DEVELOPMENT_TOOLS
permission group:android.permission-group.PERSONAL_INFO
permission group:android.permission-group.COST_MONEY
permission group:android.permission-group.LOCATION
permission group:android.permission-group.MESSAGES
permission group:android.permission-group.NETWORK
permission group:android.permission-group.ACCOUNTS
permission group:android.permission-group.STORAGE
permission group:android.permission-group.PHONE_CALLS
permission group:android.permission-group.HARDWARE_CONTROLS
permission group:android.permission-group.SYSTEM_TOOLS</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">We can list permissions currently defined an an Android device/emulator: <tt>$ adb shell pm list permissions -s</tt></td>
</tr></table>
</div>
</li>
</ul></div>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_fibonacci_example_custom_permissions">5.9. Fibonacci Example: Custom Permissions</h3>
<div class="ulist"><ul>
<li>
<p>
In this example, we are given two applications, <tt>FibonacciClient</tt> and <tt>FibonacciService</tt>
</p>
<div class="imageblock">
<div class="content">
<img src="images/FibonacciClientServiceArchitecture.svg" alt="images/FibonacciClientServiceArchitecture.svg" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
These two apps communicate via Binder/IPC
</p>
</li>
<li>
<p>
Common files for these applications reside in a library project called <tt>FibonacciCommon</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
The code for these applications (as Eclipse projects) is available:
</p>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/FibonacciBinderDemo/zipball/master">https://github.com/marakana/FibonacciBinderDemo/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/FibonacciBinderDemo">Git</a>: <tt>git clone <a href="https://github.com/marakana/FibonacciBinderDemo.git">https://github.com/marakana/FibonacciBinderDemo.git</a></tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_static_permission_enforcement_2">5.9.1. Static Permission Enforcement</h4>
<div class="paragraph"><p>Here, we want to restrict access to the <tt>com.marakana.android.fibonacciservice.FibonacciService</tt> to applications (i.e. clients) that hold <em>USE_FIBONACCI_SERVICE</em> custom permission</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
We start by by creating a custom permission group (making sure that we name-space it):
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/res/values/strings.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"fibonacci_permissions_group_label"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Fibonacci Permissions<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>FibonacciService/AndroidManifest.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission-group</span></span>
        <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.FIBONACCI_PERMISSIONS"</span>
        <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/fibonacci_permissions_group_label"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This permission group is optional - as we could instead use one of the already provided groups</td>
</tr></table>
</div>
</li>
<li>
<p>
Next, we create a custom permission (again, making sure that we name-space it), while taking advantage of our newly-created permission group:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/res/values/strings.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"use_fibonacci_service_permission_label"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>use fibonacci service<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"use_fibonacci_service_permission_description"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      applications with this permissions get fibonacci results for free
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>FibonacciService/AndroidManifest.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission-group</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span>
        <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.USE_FIBONACCI_SERVICE"</span>
        <span style="color: #009900">android:description</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/use_fibonacci_service_permission_description"</span>
        <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/use_fibonacci_service_permission_label"</span>
        <span style="color: #009900">android:permissionGroup</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.FIBONACCI_PERMISSIONS"</span>
        <span style="color: #009900">android:protectionLevel</span><span style="color: #990000">=</span><span style="color: #FF0000">"dangerous"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
Now we can statically require the permission on our <tt>FibonacciService</tt> service:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/AndroidManifest.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission-group</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;service</span></span>
            <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".FibonacciService"</span>
            <span style="color: #009900">android:permission</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.USE_FIBONACCI_SERVICE"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
            …
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/service&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
If we now re-run the <tt>FibonacciService</tt> and re-run the <tt>FibonacciClient</tt>, we will notice that the client will fail to launch and <tt>adb logcat</tt> will show something like:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>…
W/ActivityManager(   85): Permission Denial: Accessing service ComponentInfo{com.marakana.android.fibonacciservice/com.marakana.android.fibonacciservice.FibonacciService} from pid=540, uid=10043 requires com.marakana.android.fibonacciservice.USE_FIBONACCI_SERVICE
D/AndroidRuntime(  540): Shutting down VM
W/dalvikvm(  540): threadid=1: thread exiting with uncaught exception (group=0x409c01f8)
E/AndroidRuntime(  540): FATAL EXCEPTION: main
E/AndroidRuntime(  540): java.lang.RuntimeException: Unable to resume activity {com.marakana.android.fibonacciclient/com.marakana.android.fibonacciclient.FibonacciActivity}: java.lang.SecurityException: Not allowed to bind to service Intent { act=com.marakana.android.fibonaccicommon.IFibonacciService }
E/AndroidRuntime(  540):    at android.app.ActivityThread.performResumeActivity(ActivityThread.java:2444)
…
E/AndroidRuntime(  540):    at dalvik.system.NativeStart.main(Native Method)
E/AndroidRuntime(  540): Caused by: java.lang.SecurityException: Not allowed to bind to service Intent { act=com.marakana.android.fibonaccicommon.IFibonacciService }
E/AndroidRuntime(  540):    at android.app.ContextImpl.bindService(ContextImpl.java:1135)
E/AndroidRuntime(  540):    at android.content.ContextWrapper.bindService(ContextWrapper.java:370)
E/AndroidRuntime(  540):    at com.marakana.android.fibonacciclient.FibonacciActivity.onResume(FibonacciActivity.java:65)
…
W/ActivityManager(   85):   Force finishing activity com.marakana.android.fibonacciclient/.FibonacciActivity
…</tt></pre>
</div></div>
</li>
<li>
<p>
Finally, we can give <tt>FibonacciClient</tt> a fighting chance by allowing it to <em>use</em> the <tt>USE_FIBONACCI_SERVICE</tt> permission:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciClient/AndroidManifest.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.USE_FIBONACCI_SERVICE"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
We can now observe that our client is again able to use the service
</p>
</li>
<li>
<p>
In the Emulator, if we go to <em>Home</em> &#8594; <em>Menu</em> &#8594; <em>Manage apps</em> &#8594; <em>Fibonacci Client</em> &#8594; <em>PERMISSIONS</em>, we should see the <em>Fibonacci Permissions</em> group and under it, <em>use fibonacci service</em> permission
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_dynamic_permission_enforcement">5.9.2. Dynamic Permission Enforcement</h4>
<div class="paragraph"><p>Here, we want to restrict access to the <tt>com.marakana.android.fibonacciservice.IFibonacciServiceImpl</tt>'s recursive operations (<tt>fibJR(long n)</tt> and <tt>fibNR(long n)</tt>) for <tt>n</tt> &gt; <tt>10</tt> to applications (i.e. clients) that hold <em>USE_SLOW_FIBONACCI_SERVICE</em> custom permission</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Like before, we start off by creating a custom permission:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/res/values/strings.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"use_slow_fibonacci_service_permission_label"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        use slow fibonacci service operations
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"use_slow_fibonacci_service_permission_description"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        applications with this permissions can melt the CPU and drain the battery
        by using slow fibonacci operations
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>FibonacciService/AndroidManifest.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission-group</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span>
        <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.USE_SLOW_FIBONACCI_SERVICE"</span>
        <span style="color: #009900">android:description</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/use_slow_fibonacci_service_permission_description"</span>
        <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/use_slow_fibonacci_service_permission_label"</span>
        <span style="color: #009900">android:permissionGroup</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.FIBONACCI_PERMISSIONS"</span>
        <span style="color: #009900">android:protectionLevel</span><span style="color: #990000">=</span><span style="color: #FF0000">"dangerous"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
Next, we update our <tt>IFibonacciServiceImpl</tt> to enforce this permission dynamically - via a <tt>android.content.Context</tt> that get expect to get through the constructor:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/src/com/marakana/android/fibonacciservice/IFibonacciServiceImpl.java</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>fibonacciservice<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Context<span style="color: #990000">;</span>
…
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">IFibonacciServiceImpl</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> IFibonacciService<span style="color: #990000">.</span>Stub <span style="color: #FF0000">{</span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">Context</span> context<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #000000">IFibonacciServiceImpl</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>context <span style="color: #990000">=</span> context<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">checkN</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>n <span style="color: #990000">&gt;</span> <span style="color: #993399">10</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>context<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">enforceCallingOrSelfPermission</span></span><span style="color: #990000">(</span>
                    Manifest<span style="color: #990000">.</span>permission<span style="color: #990000">.</span>USE_SLOW_FIBONACCI_SERVICE<span style="color: #990000">,</span> <span style="color: #FF0000">"Go away!"</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> n<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        …
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibJR</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkN</span></span><span style="color: #990000">(</span>n<span style="color: #990000">));</span>
    <span style="color: #FF0000">}</span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">long</span> <span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span><span style="color: #009900">long</span> n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        …
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FibLib<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fibNR</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkN</span></span><span style="color: #990000">(</span>n<span style="color: #990000">));</span>
    <span style="color: #FF0000">}</span>
    …
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
We have to update <tt>FibonacciService</tt> to invoke the new <tt>IFibonacciServiceImpl</tt>'s constructor:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciService/src/com/marakana/android/fibonacciservice/FibonacciService.java</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">FibonacciService</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Service <span style="color: #FF0000">{</span>
    …
    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        …
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">IFibonacciServiceImpl</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getApplicationContext</span></span><span style="color: #990000">());</span>
        …
    <span style="color: #FF0000">}</span>
    …
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
If we now re-run the <tt>FibonacciService</tt> and re-run the <tt>FibonacciClient</tt> for a recursive operation with <tt>n</tt> &gt; <tt>10</tt>, we will notice that the client will fail and <tt>adb logcat</tt> will show something like:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>…
D/IFibonacciServiceImpl(  617): fib(15, RECURSIVE_NATIVE)
D/IFibonacciServiceImpl(  617): fibNR(15)
W/dalvikvm(  604): threadid=11: thread exiting with uncaught exception (group=0x409c01f8)
E/AndroidRuntime(  604): FATAL EXCEPTION: AsyncTask #1
E/AndroidRuntime(  604): java.lang.RuntimeException: An error occured while executing doInBackground()
…
E/AndroidRuntime(  604):    at java.lang.Thread.run(Thread.java:856)
E/AndroidRuntime(  604): Caused by: java.lang.SecurityException: Go away!: Neither user 10043 nor current process has com.marakana.android.fibonacciservice.USE_SLOW_FIBONACCI_SERVICE.
…</tt></pre>
</div></div>
</li>
<li>
<p>
Finally, we can allow <tt>FibonacciClient</tt> to melt our CPU and drain our battery by allowing it to <em>use</em> the <tt>USE_SLOW_FIBONACCI_SERVICE</tt> permission:
</p>
<div class="listingblock">
<div class="title"><tt>FibonacciClient/AndroidManifest.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.fibonacciservice.USE_SLOW_FIBONACCI_SERVICE"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    …
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
We can now observe that our client is again able to use recursive fibonacci operations even for <tt>n</tt> &gt; <tt>10</tt>
</p>
</li>
<li>
<p>
In the Emulator, if we go to <em>Home</em> &#8594; <em>Menu</em> &#8594; <em>Manage apps</em> &#8594; <em>Fibonacci Client</em> &#8594; <em>PERMISSIONS</em> &#8594; <em>Fibonacci Permissions</em>, we should see both <em>use fibonacci service</em> and <em>use slow fibonacci service operations</em> permissions
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="_lab_custom_permissions">5.10. Lab: Custom Permissions</h3>
<div class="ulist"><ul>
<li>
<p>
For this lab, you are given two applications, <tt>LogClient</tt> and <tt>LogService</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
These two apps communicate via Binder/IPC, where the common files reside in a library project called <tt>LogCommon</tt>:
</p>
<div class="listingblock">
<div class="title"><tt>LogCommon/src/com/marakana/android/logcommon/ILogService.aidl</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logcommon<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logcommon<span style="color: #990000">.</span>LogMessage<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">ILogService</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>in <span style="color: #008080">LogMessage</span> logMessage<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>LogCommon/src/com/marakana/android/logcommon/LogMessage.java</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logcommon<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcel<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Parcelable<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LogMessage</span> <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> Parcelable <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">int</span> priority<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> tag<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> msg<span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #000000">LogMessage</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> priority<span style="color: #990000">,</span> <span style="color: #008080">String</span> tag<span style="color: #990000">,</span> <span style="color: #008080">String</span> msg<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>priority <span style="color: #990000">=</span> priority<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>tag <span style="color: #990000">=</span> tag<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>msg <span style="color: #990000">=</span> msg<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getPriority</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> priority<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">String</span> <span style="font-weight: bold"><span style="color: #000000">getTag</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> tag<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #008080">String</span> <span style="font-weight: bold"><span style="color: #000000">getMsg</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> msg<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
    …
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
To get started:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Get <tt>LogCommon</tt>, <tt>LogService</tt>, and <tt>LogClient</tt> Eclipse projects
</p>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/LogBinderDemo/zipball/master">https://github.com/marakana/LogBinderDemo/zipball/master</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/LogBinderDemo">Git</a>: <tt>git clone <a href="https://github.com/marakana/LogBinderDemo.git">https://github.com/marakana/LogBinderDemo.git</a></tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Unzip or <tt>git clone</tt> into your workspace directory
</p>
</li>
<li>
<p>
Import <tt>LogCommon</tt>, <tt>LogClient</tt>, and <tt>LogService</tt> (as existing) projects into Eclipse
</p>
</li>
</ol></div>
</li>
<li>
<p>
In the provided Log client-service applications:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Restrict access to the <tt>com.marakana.android.logservice.LogService</tt> to applications that hold <em>USE_LOG_SERVICE</em> custom permission
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Create a custom permission group (make sure to name-space it)
</p>
</li>
<li>
<p>
Create a custom permission (make sure to name-space it)
</p>
</li>
<li>
<p>
Then require the permission on the service
</p>
</li>
<li>
<p>
Test that a client without the required permission cannot bind to the service
</p>
<div class="olist lowerroman"><ol class="lowerroman">
<li>
<p>
Look for an exception stack trace in <tt>adb logcat</tt> when you launch the client
</p>
</li>
</ol></div>
</li>
<li>
<p>
Have the client use the required permission
</p>
</li>
<li>
<p>
Test again - the client should now be able to bind to the service as before
</p>
</li>
</ol></div>
</li>
<li>
<p>
Restrict access to "long" log messages on <tt>com.marakana.android.logservice.ILogService</tt> to applications that hold <em>USE_LONG_LOG_SERVICE</em> permission (e.g. where "long" == <tt>logMessage.getTag().length() &gt; 10 || logMessage.getMsg().length() &gt; 80</tt>)
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Create another custom permission (make sure to name-space it)
</p>
</li>
<li>
<p>
Dynamically enforce your permission
</p>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">For you to do this, you&#8217;ll need access to a <tt>android.content.Context</tt> object inside the provided <tt>com.marakana.android.logservice.ILogServiceImpl</tt>. Conveniently enough, <tt>com.marakana.android.logservice.LogService</tt> extends <tt>android.app.Service</tt>, which in turn implements <tt>android.content.Context</tt> and has access to <em>application context</em> via <tt>getApplicationContext()</tt> method.</td>
</tr></table>
</div>
</li>
<li>
<p>
Test that a client without the required permission cannot log "long" messages
</p>
</li>
<li>
<p>
Have the client use the required permission
</p>
</li>
<li>
<p>
Test again - the client should now be able to use the service as before
</p>
</li>
</ol></div>
</li>
</ol></div>
</li>
<li>
<p>
Solution
</p>
<div class="ulist"><ul>
<li>
<p>
As a ZIP archive: <a href="https://github.com/marakana/LogBinderDemo/zipball/secured">https://github.com/marakana/LogBinderDemo/zipball/secured</a>
</p>
</li>
<li>
<p>
By <a href="https://github.com/marakana/LogBinderDemo/tree/secured">Git</a>: <tt>git clone <a href="https://github.com/marakana/LogBinderDemo.git">https://github.com/marakana/LogBinderDemo.git</a> -b secured</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_tt_contentprovider_tt_uri_permissions">5.11. <tt>ContentProvider</tt> URI Permissions</h3>
<div class="ulist"><ul>
<li>
<p>
Simple <tt>ContentProvider</tt> read/write permissions on are not always flexible enough
</p>
<div class="ulist"><ul>
<li>
<p>
E.g. an image viewer app wants to get access to an email attachment for viewing – it would be an overkill to give it read-permission over all of email (assuming that email is exposed via a content provider)
</p>
</li>
<li>
<p>
E.g. a contact picker (selector) activity wants to select a contact
</p>
</li>
</ul></div>
</li>
<li>
<p>
Use per-URI permissions instead
</p>
<div class="ulist"><ul>
<li>
<p>
When starting another Activity, caller sets <tt>Intent.FLAG_GRANT_READ_URI_PERMISSION</tt> or <tt>Intent.FLAG_GRANT_WRITE_URI_PERMISSION</tt>
</p>
</li>
<li>
<p>
This grants the receiving activity permission to access the specific URI regardless of whether it holds a permission over the ContentProvider managing the data behind the URI
</p>
</li>
</ul></div>
</li>
<li>
<p>
ContentProviders need to add explicit support for URI permissions via <tt>android:grantUriPermission</tt>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_public_vs_private_components">5.12. Public vs. Private Components</h3>
<div class="ulist"><ul>
<li>
<p>
Android is based on Inter-component communication (via Intents), but the components can span applications
</p>
</li>
<li>
<p>
Components can be public or private
</p>
<div class="ulist"><ul>
<li>
<p>
Private by default
</p>
</li>
<li>
<p>
Public if intent-filters are defined
</p>
</li>
<li>
<p>
Can be explicitly controlled via a simple boolean <tt>android:exported="true|false"</tt> attribute of individual components in <tt>AndroidManifest.xml</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Components may be unknowingly be leaked to other applications (assuming no permissions are used)
</p>
</li>
<li>
<p>
Unless absolutely designed for external use, explicitly set the <tt>android:exported="false"</tt>
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> …<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      …
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".GetPasswordActivity"</span> <span style="color: #009900">android:exported</span><span style="color: #990000">=</span><span style="color: #FF0000">"false"</span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
          …
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
Or use permissions and don&#8217;t trust component inputs!
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_intent_broadcast_permissions">5.13. Intent Broadcast Permissions</h3>
<div class="ulist"><ul>
<li>
<p>
Broadcast senders can specify which permission the <tt>BroadcastReceiver</tt>-s must hold to access the intent
</p>
</li>
<li>
<p>
If they don&#8217;t, the broadcast intent is leaked to all applications on the system
</p>
</li>
<li>
<p>
Always specify read permission via <tt>Context.sendBroadcast(Intent i, String receiverPermission)</tt> unless we use an explicit destination
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_pending_intents">5.14. Pending Intents</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://developer.android.com/reference/android/app/PendingIntent.html">PendingIntent</a> allows delayed triggering of an actual intent (to <a href="http://developer.android.com/reference/android/app/PendingIntent.html#getActivity%28android.content.Context,%20int,%20android.content.Intent,%20int%29">start an activity</a>, <a href="http://developer.android.com/reference/android/app/PendingIntent.html#getBroadcast%28android.content.Context,%20int,%20android.content.Intent,%20int%29">send a broadcast</a> or <a href="http://developer.android.com/reference/android/app/PendingIntent.html#getService%28android.content.Context,%20int,%20android.content.Intent,%20int%29">start a service</a>) in another application
</p>
<div class="ulist"><ul>
<li>
<p>
E.g. Notification
</p>
</li>
<li>
<p>
E.g. Alarms
</p>
</li>
</ul></div>
</li>
<li>
<p>
When the application given a pending intent triggers the actual intent, it does so with <strong>the same permissions and the identity</strong> as the application that created the pending intent
</p>
</li>
<li>
<p>
The application given the pending intent can <a href="http://developer.android.com/reference/android/app/PendingIntent.html#send%28android.content.Context,%20int,%20android.content.Intent,%20android.app.PendingIntent.OnFinished,%20android.os.Handler%29">fill-in</a> unspecified values of the actual intent (subject to the rules of <a href="http://developer.android.com/reference/android/content/Intent.html#fillIn%28android.content.Intent,%20int%29">Intent.fillIn()</a>), which may influence destination and/or integrity of the actual intent&#8217;s data
</p>
</li>
<li>
<p>
Best to only use pending intents as triggers for our own private components - i.e. explicitly specify our own component&#8217;s class in the actual Intent - so that it can go there and nowhere else
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_encryption">5.15. Encryption</h3>
<div class="sect3">
<h4 id="_data_encryption">5.15.1. Data encryption</h4>
<div class="ulist"><ul>
<li>
<p>
Privacy and integrity of data can be achieved using encryption
</p>
</li>
<li>
<p>
Data being transported off device is usually encrypted via TLS/SSL, which Android supports
</p>
<div class="ulist"><ul>
<li>
<p>
At the native level via OpenSSL
</p>
</li>
<li>
<p>
In Java using Java Cryptography Extension (JCE), which on Android is implicitly provided via BouncyCastle (<a href="http://www.bouncycastle.org/">http://www.bouncycastle.org/</a>)
</p>
</li>
<li>
<p>
The key store (of trusted root certs) is at
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/system/etc/security/cacerts.bks</tt> and can only be changed by rebuilding the ROM (&lt; ICS)
</p>
</li>
<li>
<p>
<tt>/system/etc/security/cacerts/*.0</tt> and certificates can be individually disabled via the system settings (&gt;= ICS)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
On-device data encryption is usually also done via JCE
</p>
<div class="ulist"><ul>
<li>
<p>
Use a basic infrastructure like <a href="https://raw.github.com/marakana/SecureNote/master/src/com/marakana/android/securenote/CryptUtil.java">CryptUtil</a>:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>securenote<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>EOFException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>IOException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>io<span style="color: #990000">.</span>InputStream<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>security<span style="color: #990000">.</span>InvalidAlgorithmParameterException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>security<span style="color: #990000">.</span>InvalidKeyException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>security<span style="color: #990000">.</span>Key<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>security<span style="color: #990000">.</span>NoSuchAlgorithmException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>security<span style="color: #990000">.</span>SecureRandom<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>security<span style="color: #990000">.</span>spec<span style="color: #990000">.</span>InvalidParameterSpecException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> java<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Arrays<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>crypto<span style="color: #990000">.</span>Cipher<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>crypto<span style="color: #990000">.</span>KeyGenerator<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>crypto<span style="color: #990000">.</span>NoSuchPaddingException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>crypto<span style="color: #990000">.</span>spec<span style="color: #990000">.</span>IvParameterSpec<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> javax<span style="color: #990000">.</span>crypto<span style="color: #990000">.</span>spec<span style="color: #990000">.</span>SecretKeySpec<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">CryptUtil</span> <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">int</span> IV_LENGTH <span style="color: #990000">=</span> <span style="color: #993399">16</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> ENCRYPTION_ALGORITHM <span style="color: #990000">=</span> <span style="color: #FF0000">"AES/CBC/PKCS5Padding"</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> KEY_ALGORITHM <span style="color: #990000">=</span> <span style="color: #FF0000">"AES"</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">int</span> KEY_SIZE <span style="color: #990000">=</span> <span style="color: #993399">256</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">Key</span> <span style="font-weight: bold"><span style="color: #000000">getKey</span></span><span style="color: #990000">(</span><span style="color: #009900">byte</span><span style="color: #990000">[]</span> secret<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> NoSuchAlgorithmException <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">getKey</span></span><span style="color: #990000">(</span>secret<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">Key</span> <span style="font-weight: bold"><span style="color: #000000">getKey</span></span><span style="color: #990000">(</span><span style="color: #009900">byte</span><span style="color: #990000">[]</span> secret<span style="color: #990000">,</span> <span style="color: #009900">boolean</span> wipeSecret<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> NoSuchAlgorithmException <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// generate an encryption/decryption key from random data seeded with</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// our secret (i.e. password)</span></span>
        <span style="color: #008080">SecureRandom</span> secureRandom <span style="color: #990000">=</span> SecureRandom<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getInstance</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"SHA1PRNG"</span><span style="color: #990000">);</span>
        secureRandom<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setSeed</span></span><span style="color: #990000">(</span>secret<span style="color: #990000">);</span>
        <span style="color: #008080">KeyGenerator</span> keyGenerator <span style="color: #990000">=</span> KeyGenerator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getInstance</span></span><span style="color: #990000">(</span>KEY_ALGORITHM<span style="color: #990000">);</span>
        keyGenerator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">(</span>KEY_SIZE<span style="color: #990000">,</span> secureRandom<span style="color: #990000">);</span>
        <span style="color: #008080">Key</span> key <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">SecretKeySpec</span></span><span style="color: #990000">(</span>keyGenerator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">generateKey</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getEncoded</span></span><span style="color: #990000">(),</span> KEY_ALGORITHM<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>wipeSecret<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            Arrays<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fill</span></span><span style="color: #990000">(</span>secret<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">byte</span><span style="color: #990000">)</span><span style="color: #993399">0</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> key<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">Cipher</span> <span style="font-weight: bold"><span style="color: #000000">getEncryptCipher</span></span><span style="color: #990000">(</span><span style="color: #008080">Key</span> key<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> NoSuchAlgorithmException<span style="color: #990000">,</span>
            NoSuchPaddingException<span style="color: #990000">,</span> InvalidKeyException <span style="color: #FF0000">{</span>
        <span style="color: #008080">Cipher</span> cipher <span style="color: #990000">=</span> Cipher<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getInstance</span></span><span style="color: #990000">(</span>ENCRYPTION_ALGORITHM<span style="color: #990000">);</span>
        cipher<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">(</span>Cipher<span style="color: #990000">.</span>ENCRYPT_MODE<span style="color: #990000">,</span> key<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cipher<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">Cipher</span> <span style="font-weight: bold"><span style="color: #000000">getDecryptCipher</span></span><span style="color: #990000">(</span><span style="color: #008080">Key</span> key<span style="color: #990000">,</span> <span style="color: #009900">byte</span><span style="color: #990000">[]</span> iv<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> NoSuchAlgorithmException<span style="color: #990000">,</span>
            NoSuchPaddingException<span style="color: #990000">,</span> InvalidKeyException<span style="color: #990000">,</span> InvalidAlgorithmParameterException <span style="color: #FF0000">{</span>
        <span style="color: #008080">Cipher</span> cipher <span style="color: #990000">=</span> Cipher<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getInstance</span></span><span style="color: #990000">(</span>ENCRYPTION_ALGORITHM<span style="color: #990000">);</span>
        cipher<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">(</span>Cipher<span style="color: #990000">.</span>DECRYPT_MODE<span style="color: #990000">,</span> key<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">IvParameterSpec</span></span><span style="color: #990000">(</span>iv<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cipher<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">byte</span><span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">getIv</span></span><span style="color: #990000">(</span><span style="color: #008080">Cipher</span> cipher<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> InvalidParameterSpecException <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cipher<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getParameters</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getParameterSpec</span></span><span style="color: #990000">(</span>IvParameterSpec<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">getIV</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">byte</span><span style="color: #990000">[]</span> <span style="font-weight: bold"><span style="color: #000000">getIv</span></span><span style="color: #990000">(</span><span style="color: #008080">InputStream</span> in<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> IOException <span style="color: #FF0000">{</span>
        <span style="color: #009900">byte</span><span style="color: #990000">[]</span> iv <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="color: #009900">byte</span><span style="color: #990000">[</span>IV_LENGTH<span style="color: #990000">];</span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #009900">int</span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> iv<span style="color: #990000">.</span>length<span style="color: #990000">;)</span> <span style="color: #FF0000">{</span>
            <span style="color: #009900">int</span> nRead <span style="color: #990000">=</span> in<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">(</span>iv<span style="color: #990000">,</span> i<span style="color: #990000">,</span> iv<span style="color: #990000">.</span>length <span style="color: #990000">-</span> i<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>nRead <span style="color: #990000">==</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">EOFException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Unexpected EOF"</span><span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                i <span style="color: #990000">+=</span> nRead<span style="color: #990000">;</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> iv<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
To encrypt to a byte array, we could do:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">byte</span><span style="color: #990000">[]</span> secret <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// some secret</span></span>
<span style="color: #009900">byte</span><span style="color: #990000">[]</span> plainText <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// some plain text</span></span>
<span style="color: #008080">Key</span> key <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getKey</span></span><span style="color: #990000">(</span>secret<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
<span style="color: #008080">Cipher</span> cipher <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getEncryptCipher</span></span><span style="color: #990000">(</span>key<span style="color: #990000">);</span>
<span style="color: #009900">byte</span><span style="color: #990000">[]</span> iv <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getIv</span></span><span style="color: #990000">(</span>cipher<span style="color: #990000">);</span>
<span style="color: #009900">byte</span><span style="color: #990000">[]</span> encrypted <span style="color: #990000">=</span> cipher<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doFinal</span></span><span style="color: #990000">(</span>plainText<span style="color: #990000">);</span>
<span style="font-style: italic"><span style="color: #9A1900">// store iv and encrypted</span></span></tt></pre></div></div>
</li>
<li>
<p>
To decrypt from a byte array, we could do:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">byte</span><span style="color: #990000">[]</span> secret <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// some secret</span></span>
<span style="color: #009900">byte</span><span style="color: #990000">[]</span> encrypted <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// read encrypted buffer from somewhere</span></span>
<span style="color: #009900">byte</span><span style="color: #990000">[]</span> iv <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// read iv from somewhere</span></span>
<span style="color: #008080">Key</span> key <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getKey</span></span><span style="color: #990000">(</span>secret<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
<span style="color: #008080">Cipher</span> cipher <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getDecryptCipher</span></span><span style="color: #990000">(</span>key<span style="color: #990000">,</span> iv<span style="color: #990000">);</span>
<span style="color: #009900">byte</span><span style="color: #990000">[]</span> plainText <span style="color: #990000">=</span> cipher<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doFinal</span></span><span style="color: #990000">(</span>encrypted<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
To encrypt to a file/stream, we could do:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">byte</span><span style="color: #990000">[]</span> secret <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// some secret</span></span>
<span style="color: #009900">byte</span><span style="color: #990000">[]</span> plainText <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// some plain text</span></span>
<span style="color: #008080">Key</span> key <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getKey</span></span><span style="color: #990000">(</span>secret<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
<span style="color: #008080">OutputStream</span> out <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileOutputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"some-file"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// or = socket.getOutputStream()</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">Cipher</span> cipher <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getEncryptCipher</span></span><span style="color: #990000">(</span>key<span style="color: #990000">);</span>
    <span style="color: #009900">byte</span><span style="color: #990000">[]</span> iv <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getIv</span></span><span style="color: #990000">(</span>cipher<span style="color: #990000">);</span>
    out<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span>iv<span style="color: #990000">);</span>
    out <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CipherOutputStream</span></span><span style="color: #990000">(</span>out<span style="color: #990000">,</span> cipher<span style="color: #990000">);</span>
    out<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span>plainText<span style="color: #990000">);</span>
    out<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">flush</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">finally</span></span> <span style="color: #FF0000">{</span>
    out<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">close</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
To decrypt a file/stream, we could do:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">InputStream</span> in <span style="color: #990000">=</span>  <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileInputStream</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"some-file"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// or = socket.getInputStream();</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">byte</span><span style="color: #990000">[]</span> iv <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getIv</span></span><span style="color: #990000">(</span>in<span style="color: #990000">);</span>
    <span style="color: #008080">Cipher</span> cipher <span style="color: #990000">=</span> CryptUtil<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getDecryptCipher</span></span><span style="color: #990000">(</span>key<span style="color: #990000">,</span> iv<span style="color: #990000">);</span>
    in <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">CipherInputStream</span></span><span style="color: #990000">(</span>in<span style="color: #990000">,</span> cipher<span style="color: #990000">);</span>
    in<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">read</span></span><span style="color: #990000">(</span>plainText<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// do properly</span></span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">finally</span></span> <span style="color: #FF0000">{</span>
    in<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">close</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">In May 2011, Google was caught with their pants down. They passed authentication tokens from their Android client applications to their backend services, including contacts, calendars, and photos (picassa) over a plain-text (i.e. unencrypted) channel. This enabled potential attackers to get access and modify private content of users whose auth tokens were captured.<br />
See <a href="http://money.cnn.com/2011/05/18/technology/android_security/?section=money_latest">http://money.cnn.com/2011/05/18/technology/android_security/?section=money_latest</a></td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_whole_disk_encryption">5.15.2. Whole Disk Encryption</h4>
<div class="ulist"><ul>
<li>
<p>
Android 3.0 (Honeycomb) release introduced a new feature, Settings &#8594; Location &amp; Security &#8594; Encryption &#8594; Encrypt tablet, which enables transparent encryption of the <tt>/data</tt> partition using Linux kernel&#8217;s dm-crypt functionality (<a href="http://www.saout.de/misc/dm-crypt/">http://www.saout.de/misc/dm-crypt/</a>)
</p>
</li>
<li>
<p>
dm-crypt, which presents itself as a block-device, wraps another block device such as eMMC and similar flash devices (but not raw flash chips, so no yaffs2) and offers on-the-fly encryption/decryption of the underlying data
</p>
<div class="ulist"><ul>
<li>
<p>
Note that at the moment encryption is done "in software", rather than by an optimized set of hardware instructors on the SoC
</p>
</li>
</ul></div>
</li>
<li>
<p>
To avoid issues with GPL, Android does not use dm-crypt&#8217;s <tt>cryptsetup</tt> command and <tt>libdevmapper</tt> shared library, but rather moves that functionality to the volume daemon (<tt>vold</tt>), which directly <tt>ioctl</tt>-calls on the dm-crypt&#8217;s kernel device
</p>
</li>
<li>
<p>
Additionally, Android&#8217;s <tt>init</tt> process had to be extended to support password-entry at boot
</p>
<div class="ulist"><ul>
<li>
<p>
With encryption enabled, <tt>init</tt> gets the password and then restarts into the normal boot process with <tt>/data</tt> properly initialized as a real filesystem
</p>
</li>
<li>
<p>
See <a href="http://source.android.com/tech/encryption/android_crypto_implementation.html">http://source.android.com/tech/encryption/android_crypto_implementation.html</a> for details
</p>
</li>
</ul></div>
</li>
<li>
<p>
The rest of the Android OS as well as all the apps are unaware of any encryption of the underlying <tt>/data</tt> partition
</p>
</li>
<li>
<p>
At present, the Android uses 128 AES with CBC and ESSIV:SHA256 for <tt>/data</tt>, and 128 bit AES for the master key (stored in the last 16KB of the encrypted partition)
</p>
</li>
<li>
<p>
On an unencrypted tablet:
</p>
<div class="ulist"><ul>
<li>
<p>
The <tt>/data</tt> partition is mounted as a memory block device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell mount |grep /data
/dev/block/mmcblk0p8 /data ext4 rw,nosuid,nodev,noatime,barrier=1,data=ordered 0 0</tt></pre>
</div></div>
</li>
<li>
<p>
Writing a 1GB file takes on average 103.919 seconds (10,333,296 bytes/sec)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>cd /data/local/tmp/
time dd if=/dev/zero of=out bs=4096 count=262144
262144+0 records in
262144+0 records out
1073741824 bytes transferred in 104.006 secs (10,323,845 bytes/sec)
    1m44.02s real     0m0.45s user     0m8.42s system
rm out
time dd if=/dev/zero of=out bs=4096 count=262144
…
rm out
time dd if=/dev/zero of=out bs=4096 count=262144
…</tt></pre>
</div></div>
</li>
<li>
<p>
Reading a 1GB file takes on average 45.99 seconds (23,348,197 byes/sec)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>time dd if=out of=/dev/null bs=4096 count=262144
262144+0 records in
262144+0 records out
1073741824 bytes transferred in 45.692 secs (23499558 bytes/sec)
    0m45.70s real     0m0.54s user     0m8.84s system
time dd if=out of=/dev/null bs=4096 count=262144
…
time dd if=out of=/dev/null bs=4096 count=262144
…
rm out</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
After encryption
</p>
<div class="ulist"><ul>
<li>
<p>
The <tt>/data</tt> partition is mounted as a dm-crypt device-mapper target, which wraps the original memory block device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell mount |grep /data
/dev/block/dm-0 /data ext4 rw,nosuid,nodev,noatime,barrier=1,data=ordered 0 0</tt></pre>
</div></div>
</li>
<li>
<p>
Writing a 1GB file takes on average 107.288 seconds (10,014,686 bytes/sec), a mare 3.2% degradation in performance, mostly because writing to NAND is slow
</p>
</li>
<li>
<p>
Reading a 1GB file takes on average of 70.616 seconds (15,209,002 byes/sec), a significant <strong>54% degradation</strong> in performance
</p>
<div class="ulist"><ul>
<li>
<p>
Note, that at some point dm-crypt could be optimized to take advantage of any special encryption facilities offered in the hardware (on the SoC)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Android&#8217;s whole-disk encryption is still vulnerable to various attacks:
</p>
<div class="ulist"><ul>
<li>
<p>
"Evil maid attack"
</p>
<div class="ulist"><ul>
<li>
<p>
Only the <tt>/data</tt> is encrypted, so we don&#8217;t know if we can trust the bootloader and <tt>/system</tt> not to contain any "keyloggers"
</p>
</li>
<li>
<p>
Everything along the boot path would have to be encrypted, which it is not at the moment
</p>
</li>
</ul></div>
</li>
<li>
<p>
Cold-boot attack (<a href="http://citp.princeton.edu/memory/">http://citp.princeton.edu/memory/</a>)
</p>
<div class="ulist"><ul>
<li>
<p>
Since dm-crypt stores the encryption keys in RAM, it would theoretically be possible to reboot the device with something like <tt>msramdmp</tt> (McGrew Security RAM Dumper) or <tt>ram2usb</tt> to dump the contents of RAM (containing the encryption key) to a USB drive
</p>
<div class="ulist"><ul>
<li>
<p>
The device has to be running in order for this to work
</p>
</li>
<li>
<p>
Even if the host device itself does not support booting from an alternative device (or USB), the RAM could be cooled (so that it retains its state), and then transferred to a device that would support alternative boot methods
</p>
</li>
<li>
<p>
This is a problem for almost all disk-encryption "solutions" in popular OSs, like Windows, Mac OS X, and Linux
</p>
</li>
</ul></div>
</li>
<li>
<p>
To protect against this, we would need encryption key to be stored somewhere other than RAM, like the CPU (debug) registers, which may be hardware-dependent (e.g. AES-NI on new Intel chips works well), requires changes to the Linux kernel (see <tt>TRESOR</tt> patch), and is not supported by dm-crypt/Android at the moment
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">Breaks during 3.0 to 3.1 OS upgrade. A 3.0-encrypted device had to be master-reset (i.e. all data on <tt>/data</tt> had to be wiped) on upgrading to 3.1.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">While Honeycomb&#8217;s whole-disk encryption based on dm-crypt is clearly a step in the right direction, it is far from being a NIST FIPS 140-2-certified solution, which requires two-factor encryption and is mandated for most of DOD applications.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Apple’s iOS 4 256-bit hardware encryption was cracked in May 2011 by ElcomSoft through a "simple" brute-force attack in as little as 30 mins using CPU and GPUs of modern host machines. See <a href="http://www.geek.com/articles/chips/apples-ios-4-hardware-encryption-has-been-cracked-20110525/">http://www.geek.com/articles/chips/apples-ios-4-hardware-encryption-has-been-cracked-20110525/</a> for more info.<br />
Also, according to Nguyen from Symantec, iOS encryption key is stored on the device, but itself is not encrypted by the user&#8217;s master key. This means that if a potential attackers successfully jailbreak the device, they would be able to access the data without knowing the passcode.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_vpn">5.15.3. VPN</h4>
<div class="ulist"><ul>
<li>
<p>
Pre ICS/4.0, Android supported L2TP, L2TP/IPSec PSK, L2TP/IPSec RSA, and PPTP VPNs
</p>
</li>
<li>
<p>
ICS/4.0 adds support for pure IPSec VPNs - for better compatibility with commonly deployed VPN endpoints/routers
</p>
</li>
<li>
<p>
Also new in ICS/4.0 is the new VPN API that enables SSL VPN clients to be deployed as apps
</p>
<div class="ulist"><ul>
<li>
<p>
Via <a href="http://developer.android.com/reference/android/net/VpnService.Builder.html"><tt>android.net.VpnService.Builder</tt></a>, an app can configure addresses, routing rules, DNS/search domains, and even MTUs
</p>
</li>
<li>
<p>
Via <a href="http://developer.android.com/reference/android/net/VpnService.html"><tt>android.net.VpnService</tt></a>, the app can then create a virtual network interface, which is exposed as a file descriptor
</p>
<div class="ulist"><ul>
<li>
<p>
Each read/write from/to FD retrieves/sends an IP packet from/to the interface
</p>
</li>
</ul></div>
</li>
<li>
<p>
To address security/exclusivity issues:
</p>
<div class="ulist"><ul>
<li>
<p>
User has to approve the creation of a new VPN connection
</p>
</li>
<li>
<p>
There can be only one VPN connection running at the same time (any existing one is deactivated)
</p>
</li>
<li>
<p>
A system-managed notification is shown during the lifetime of a VPN connection and provides information on the current connection as well as a way to disconnect
</p>
</li>
<li>
<p>
The network is restored automatically when the file descriptor is closed (in the event that the app process is terminated)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_keystore_and_keychain_api">5.15.4. Keystore and Keychain API</h4>
<div class="ulist"><ul>
<li>
<p>
Since Donut/1.6, Android has had a system-wide <tt>keystore</tt> for storage of VPN and (later) WiFi authentication keys
</p>
<div class="ulist"><ul>
<li>
<p>
See <a href="http://www.google.com/support/mobile/bin/answer.py?hl=en&amp;answer=168466">Working with secure certificates</a>
</p>
</li>
<li>
<p>
Pre ICS/4.0, applications were not able to access it, so those needing to authenticate via client certificates ended up maintained their own key store (hard to manage across apps)
</p>
</li>
</ul></div>
</li>
<li>
<p>
In ICS/4.0, Android adds support for <a href="http://developer.android.com/reference/android/security/KeyChain.html"><tt>android.security.KeyChain</tt></a>, which provides apps with
</p>
<div class="ulist"><ul>
<li>
<p>
Access to private keys in the system key store and their corresponding certificate chains (subject to one-time user approval)
</p>
</li>
<li>
<p>
Ability to initiate installation of credentials from X.509 certificates and PKCS#12 key stores (e.g. for installation of organization CA certs)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Also, in ICS/4.0, Android uses the screen lock password to protect the system credential storage, which works well with device administration APIs and prevents the user from disabling the password as long as they use the secured credentials
</p>
</li>
<li>
<p>
See <a href="http://android-developers.blogspot.com/2012/03/unifying-key-store-access-in-ics.html">Unifying Key Store Access in ICS</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_rooting_an_android_device">5.16. Rooting an Android device</h3>
<div class="ulist"><ul>
<li>
<p>
Why root?
</p>
<div class="ulist"><ul>
<li>
<p>
Use applications that require root (e.g. backup, tethering, overclocking, etc.)
</p>
</li>
<li>
<p>
Customize the existing ROM (e.g. remove bloatware, themes, etc.)
</p>
</li>
<li>
<p>
Install (e.g. upgrade) new custom ROMs
</p>
</li>
<li>
<p>
Understand how it works
</p>
</li>
<li>
<p>
Malware rootkits!
</p>
</li>
</ul></div>
</li>
<li>
<p>
To obtain "root" on an Android device usually involves a number of steps:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Exploit a vulnerability of the system to give us root once (see below)
</p>
</li>
<li>
<p>
Remount the <tt>/system</tt> partition read-write:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mount -o remount,rw -t ext4 /dev/block/mmcblk0p1 /system</tt></pre>
</div></div>
</li>
<li>
<p>
Create a setuid version of <tt>/system/bin/sh</tt>
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cat /system/bin/sh &gt; /system/bin/su
$ chmod 06755 /system/bin/su</tt></pre>
</div></div>
</li>
<li>
<p>
Remount the <tt>/system</tt> partition read-only
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mount -o remount,ro -t ext4 /dev/block/mmcblk0p1 /system</tt></pre>
</div></div>
</li>
<li>
<p>
Use <tt>/system/bin/su</tt> to become root at any time afterwards
</p>
</li>
</ol></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_controlling_access_to_tt_system_bin_su_tt_with_em_superuser_em">5.16.1. Controlling access to <tt>/system/bin/su</tt> with <em>Superuser</em></h4>
<div class="ulist"><ul>
<li>
<p>
In the real world, most people would not leave <tt>su</tt> wide open to anyone (or any application) - for obvious security implications
</p>
</li>
<li>
<p>
Instead they use something like <em>Superuser</em> (<a href="http://code.google.com/p/superuser/">http://code.google.com/p/superuser/</a>)
</p>
<div class="ulist"><ul>
<li>
<p>
Superuser is a combination of a custom <tt>/system/bin/su</tt> binary, as well as a <tt>Superuser.apk</tt> (application).
</p>
</li>
<li>
<p>
When a 3rd-party application wants super-user access, it runs <tt>/system/bin/su</tt> (possibly with parameters of what it wishes to execute)
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The <tt>su</tt> binary first checks whether the calling process is white-listed
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
First, it checks in the SQLite database owned by the Superuser application: <tt>/data/data/com.koushikdutta.superuser/databases/superuser.sqlite</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Its <tt>whitelist</tt> table stores three values: the calling process UID, process name (usually just the package name), and a flag (-1=not allowed, 1=temporary allowed, 10000=always allowed)
</p>
</li>
</ul></div>
</li>
<li>
<p>
If the calling process is already not-approved <tt>su</tt> exits
</p>
</li>
<li>
<p>
If the calling process is not already approved,
</p>
<div class="olist lowerroman"><ol class="lowerroman">
<li>
<p>
<tt>su</tt> launches a simple activity dialog of the Superuser application by passing the calling process' UID and PID as extra intent parameters:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="color: #009900">char</span> sysCmd<span style="color: #990000">[</span><span style="color: #993399">1024</span><span style="color: #990000">];</span>
<span style="font-weight: bold"><span style="color: #000000">sprintf</span></span><span style="color: #990000">(</span>sysCmd<span style="color: #990000">,</span> <span style="color: #FF0000">"am start -a android.intent.action.MAIN -n com.koushikdutta.superuser/com.koushikdutta.superuser.SuperuserRequestActivity --ei uid %d --ei pid %d &gt; /dev/null"</span><span style="color: #990000">,</span> g_puid<span style="color: #990000">,</span> ppid<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">system</span></span><span style="color: #990000">(</span>sysCmd<span style="color: #990000">))</span>
    …</tt></pre></div></div>
</li>
</ol></div>
</li>
<li>
<p>
Now <tt>com.koushikdutta.superuser</tt> application starts and <tt>SuperuserRequestActivity</tt> prompts the user to make their selection
</p>
<div class="olist lowerroman"><ol class="lowerroman">
<li>
<p>
The user&#8217;s selection is saved into the database and <tt>SuperuserRequestActivity</tt> terminates
</p>
</li>
<li>
<p>
<tt>su</tt> now checks the database again, and if the process is not approved, it exits
</p>
</li>
</ol></div>
</li>
<li>
<p>
<tt>su</tt> then <tt>setuid(uid)</tt>-s and <tt>setgid(gid)</tt>-s the calling process
</p>
</li>
<li>
<p>
<tt>su</tt> finally executes <tt>/system/bin/sh</tt> with the same parameters that the original <tt>su</tt> was invoked with
</p>
</li>
</ol></div>
</li>
<li>
<p>
The 3rd party application can now use <tt>sh</tt> to pass any commands that it wishes to run as <tt>root</tt>
</p>
</li>
</ol></div>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Now, let take a look at some of the past Android exploits (Getting root the first time):</p></div>
</div>
<div class="sect3">
<h4 id="_udev_exploit_cve_2009_1185">5.16.2. UDEV exploit (CVE-2009-1185)</h4>
<div class="ulist"><ul>
<li>
<p>
On a standard Linux OS, <tt>udev</tt> enables dynamic management of devices - specifically ones that can be hot-plugged while the system is running (like USB)
</p>
<div class="ulist"><ul>
<li>
<p>
When a new device is detected, Linux kernel passes a message (containing executable code) to the <tt>udev</tt> daemon, which runs as root and acts on this event
</p>
</li>
<li>
<p>
Prior to version 1.4.1, <tt>udev</tt> did not verify that the message came from the kernel, which made it possible for a rouge application to fake a device and have <tt>udev</tt> execute arbitrary code
</p>
</li>
<li>
<p>
Newer kernels sent authenticated messages, but <tt>udev</tt> needs to be smart to verify them
</p>
</li>
</ul></div>
</li>
<li>
<p>
On Android, <tt>udev</tt> functionality is rolled int Android&#8217;s <tt>init</tt> process (actually <tt>ueventd</tt>), which still runs as root
</p>
<div class="ulist"><ul>
<li>
<p>
This "exploid2" (a.k.a "Exploid") roughly works as follows:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The user <tt>copies</tt> to the device (e.g. <tt>adb push exploid2 /data/local/tmp/exploid2</tt>)
</p>
</li>
<li>
<p>
The user then runs the "exploid2" process (e.g. adb shell <tt>/data/local/tmp/exploid2</tt>)
</p>
</li>
<li>
<p>
On the first run, the "exploid2" copies itself to <tt>/sqlite_stmt_journals/exploid2</tt>
</p>
</li>
<li>
<p>
The "exploid2" then sends a <tt>NETLINK_KOBJECT_UEVENT</tt> message (via a local unix socket) to <tt>init</tt> (i.e., <tt>udev</tt> code within <tt>init</tt>) to tell it to run a copy of itself next time a device is plugged in (basically it presents itself as <tt>FIRMWARE</tt> update for this device)
</p>
</li>
<li>
<p>
The user then "hot-plugs" a device by clicking Settings &#8594; Wireless &#8594; Airplane, WiFi, etc. or plugs in a USB device (if USB host port is available)
</p>
</li>
<li>
<p>
The "exploid2" runs again, this time as <tt>root</tt> (as part of <tt>init</tt>) and it then
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Remounts the <tt>/system</tt> in read-write mode
</p>
</li>
<li>
<p>
Copies itself to <tt>/system/bin/rootshell</tt> and sets its permission as <tt>04711</tt> (i.e. setuid-bit enabled)
</p>
</li>
</ol></div>
</li>
<li>
<p>
If the user now wants root, the user simply runs <tt>/system/bin/rootshell</tt>, which then
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Switches to <tt>root</tt> via a simple <tt>setuid(0); setgid(0);</tt>
</p>
</li>
<li>
<p>
Executes <tt>/system/bin/sh</tt> (now as root) with the parameters passed to <tt>/system/bin/rootshell</tt>
</p>
</li>
</ol></div>
</li>
</ol></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_adb_setuid_exhaustion_attack_cve_2010_easy">5.16.3. ADB setuid exhaustion attack (CVE-2010-EASY)</h4>
<div class="ulist"><ul>
<li>
<p>
Android Debug Bridge Daemon (<tt>adbd</tt>) starts as root, but calls <tt>setuid(<em>shell</em>)</tt> when forking itself to execute remote requests (i.e. to run <tt>/system/bin/sh</tt>)
</p>
</li>
<li>
<p>
In this case, a program called <tt>rageagainstthecage</tt> exploits <a href="http://lwn.net/Articles/451985/">a known condition</a> where a call to <tt>setuid()</tt> fails once we reach <tt>RLIMIT_NPROC</tt>, preventing <tt>adbd</tt> from dropping its privileges, and since it does not check for this failure, it remains running as root
</p>
</li>
<li>
<p>
The program "fork-bombs" <tt>adbd</tt> by creating client requests to it (which causes it to fork) until the system reaches the maximum number of processes (RLIMIT_NPROC) - typically around 2-5K
</p>
</li>
<li>
<p>
At this point, <tt>rageagainstthecage</tt> tries to fill the last slot with its connection to <tt>adbd</tt> while it is still running as <tt>root</tt> before <tt>adbd</tt> has a chance to <tt>setuid()</tt> itself
</p>
</li>
<li>
<p>
The problem is that <tt>adbd</tt> does not check whether its call to <tt>setuid()</tt> succeeded, which leaves <tt>rageagainstthecage</tt> running with <tt>root</tt> access
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_zimperlich_attack_against_zygote">5.16.4. Zimperlich attack against Zygote</h4>
<div class="ulist"><ul>
<li>
<p>
Similar to <tt>adbd</tt>, <tt>zygote</tt> (Android app spawner, which also runs as root) did not check for setuid() failures, so it too was prone to this sort of attack
</p>
</li>
<li>
<p>
Fork self repeatedly to reach the process limit (RLIMIT_NPROC)
</p>
</li>
<li>
<p>
The call to <tt>setuid()</tt> fails
</p>
</li>
<li>
<p>
The app that was spawned runs as root
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_ashmem_memory_protection_attack_cve_2011_1149">5.16.5. Ashmem memory protection attack (CVE-2011-1149)</h4>
<div class="ulist"><ul>
<li>
<p>
"Android before 2.3 does not properly restrict access to the system property space, which allows local applications to bypass the application sandbox and gain privileges, as demonstrated by psneuter and KillingInTheNameOf, related to the use of Android shared memory (ashmem) and ASHMEM_SET_PROT_MASK."
</p>
</li>
<li>
<p>
<tt>KillingInTheNameOf</tt> exploit:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Changes protections of shared (ashmem) memory space where system properties are stored to allow writing
</p>
</li>
<li>
<p>
Sets <tt>ro.secure</tt> to <tt>0</tt>
</p>
</li>
<li>
<p>
User restarts <tt>adbd</tt>
</p>
</li>
<li>
<p>
User get root via <tt>adb shell</tt>
</p>
</li>
</ol></div>
</li>
<li>
<p>
<tt>psneuter</tt> exploit:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Disables access to shared (ashmem) memory space where system properties are stored (sets protection mask to 0)
</p>
</li>
<li>
<p>
User restarts <tt>adbd</tt>, but since <tt>adbd</tt>cannot read <tt>ro.secure</tt> it assumes <tt>ro.secure=0</tt>
</p>
</li>
<li>
<p>
User get root via <tt>adb shell</tt>
</p>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_buffer_overrun_on_tt_vold_tt_exploit_cve_2011_1823">5.16.6. Buffer Overrun on <tt>vold</tt> exploit (CVE-2011-1823)</h4>
<div class="ulist"><ul>
<li>
<p>
"The vold volume manager daemon on Android 3.0 and 2.x before 2.3.4 trusts messages that are received from a PF_NETLINK socket, which allows local users to execute arbitrary code and gain root privileges via a negative index that bypasses a maximum-only signed integer check in the DirectVolume::handlePartitionAdded method, which triggers memory corruption, as demonstrated by Gingerbreak"
</p>
</li>
<li>
<p>
On Android, <tt>vold</tt> (volume daemon running as root) is used for operations such as SD-Card mounting/unmounting, as well as encryption of <tt>/data</tt> partition
</p>
</li>
<li>
<p>
Here, an application called <a href="http://c-skills.blogspot.com/2011/04/yummy-yummy-gingerbreak.html">Gingerbreak</a> (a.k.a. <em>Softbreak</em>) is first uploaded to the device (e.g. to <tt>/data/local/tmp/softbreak</tt>)
</p>
</li>
<li>
<p>
When executed (e.g. via <tt>adb shell</tt>) it tries to exploit an out of bounds array access in <tt>vold</tt> and thus inject code to be executed by <tt>root</tt>
</p>
</li>
<li>
<p>
Because <tt>vold</tt> is configurable by the OEMs (and its memory state changes), this attack is not guaranteed to work every time - in fact, it often causes <tt>vold</tt> to segfault
</p>
</li>
<li>
<p>
A <a href="http://www.techradar.com/news/phone-and-communications/mobile-phones/android-malware-gives-itself-root-access-1062294">malicious application</a> on the device can exploit the same vulnerability to <a href="http://www.csc.ncsu.edu/faculty/jiang/RootSmart/">gain root access</a>
</p>
</li>
<li>
<p>
While this exploit initially targeted Gingerbread, it also works on Froyo and Honeycomb (&#8656; 3.1) releases
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_linux_local_privilege_escalation_via_suid_tt_proc_pid_mem_tt_write_cve_2012_0056">5.16.7. Linux Local Privilege Escalation via SUID <tt>/proc/pid/mem</tt> Write (CVE-2012-0056)</h4>
<div class="ulist"><ul>
<li>
<p>
In Linux-based systems, <tt>/proc/<em>pid</em>/mem</tt> provides an interface for reading and writing directly to a process&#8217;s virtual memory
</p>
<div class="ulist"><ul>
<li>
<p>
Seeking on <tt>/proc/<em>pid</em>/mem</tt> is the same as seeking on the memory of that process
</p>
</li>
</ul></div>
</li>
<li>
<p>
In v2.6.39, the kernel was simplified to do permission checks on <tt>/proc/<em>pid</em>/mem</tt> at the time it is opened, instead of tracking the process that&#8217;s using it
</p>
<div class="ulist"><ul>
<li>
<p>
If we hold the file descriptor to <tt>/proc/<em>pid</em>/mem</tt> open over an <a href="http://en.wikipedia.org/wiki/Exec_(operating_system)"><tt>execve()</tt> system call</a>, we&#8217;ll continue to read from the virtual memory of the original <em>old</em> process
</p>
</li>
<li>
<p>
This vulnerability can be exploited (<a href="http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2012-0056">CVE-2012-0056</a>) by local users to gain root privileges by modifying process memory (assuming no ASLR) of a setuid-enabled executable
that writes something deterministic to a file descriptor (like <tt>su</tt>), as demonstrated by <a href="http://blog.zx2c4.com/749">Mempodipper</a>
</p>
</li>
<li>
<p>
Fixed by <a href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commitdiff;h=e268337dfe26dfc7efd422a804dbb27977a3cccc">Linus on Tue, 17 Jan 2012</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Most Android devices running Android 4.0.0 - 4.0.3 (like Galaxy Nexus) are based on kernels &gt;= 2.6.39 (e.g. 3.0.8) and are <a href="https://github.com/saurik/mempodroid">vulnerable</a> (via setuid-enabled <tt>run-as</tt>) so can be easily <a href="http://forum.xda-developers.com/showpost.php?p=23290676&amp;postcount=1">rooted</a>
</p>
<div class="ulist"><ul>
<li>
<p>
Fortunately, <tt>run-as</tt> does an early check to verify that it is running as the <tt>root</tt> or <tt>shell</tt> user so this particular exploit requires ADB-based shell access
</p>
</li>
<li>
<p>
Since <tt>run-as</tt> is <a href="http://en.wikipedia.org/wiki/Static_library">statically linked</a>, the mempodroid exploit needs to be given the exact offsets to <tt>exit()</tt> and <tt>setresuid()</tt> (which happen to be <tt>0xd7f4</tt> and <tt>0xad4b</tt> on Galaxy Nexus)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb push mempodroid /data/local/tmp/.
$ adb shell chmod 755 /data/local/tmp/mempodroid
$ adb shell
shell@android:/ # id
uid=2000(shell) gid=2000(shell) groups=1003(graphics),1004(input),1007(log),1009(mount),1011(adb),1015(sdcard_rw),3001(net_bt_admin),3002(net_bt),3003(inet)
127|shell@android:/ /data/local/tmp/mempodroid 0xd7f4 0xad4b sh
shell@android:/ # id
uid=0(root) gid=0(root) groups=1003(graphics),1004(input),1007(log),1009(mount),1011(adb),1015(sdcard_rw),3001(net_bt_admin),3002(net_bt),3003(inet)</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
Patched in Android 4.0.4
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_webkit_exploit">5.16.8. WebKit exploit</h4>
<div class="ulist"><ul>
<li>
<p>
Initially discovered on iOS, which also uses WebKit
</p>
</li>
<li>
<p>
Based on buffer-overruns
</p>
</li>
<li>
<p>
Enables the browser (or any app using a WebKit via Android&#8217;s <tt>WebView</tt> or directly via <tt>libwebcore</tt>) to execute arbitrary code
</p>
</li>
<li>
<p>
A proof of concept creates a remote shell
</p>
</li>
<li>
<p>
But, not a root exploit, because the application is sandboxed
</p>
<div class="ulist"><ul>
<li>
<p>
Still, access to bookmarks, SSL sessions, stored passwords, etc.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Patched in 2.2
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_to_root_or_not_to_root">5.16.9. To Root or Not To Root?</h4>
<div class="ulist"><ul>
<li>
<p>
Dangers on already rooted devices
</p>
</li>
<li>
<p>
A malicious app can gain root access and inject a loadable kernel module into the kernel
</p>
</li>
<li>
<p>
Very hard to detect
</p>
</li>
<li>
<p>
Can open network-channels to leak information from the device
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_malware_rootkits">5.16.10. Malware Rootkits</h4>
<div class="ulist"><ul>
<li>
<p>
If we can root our own phone, so can malicious applications (e.g. trojans)
</p>
</li>
<li>
<p>
But they have to be installed first
</p>
<div class="ulist"><ul>
<li>
<p>
Easy, when they are repackaged versions of legit apps, so they look and feel "official"
</p>
</li>
<li>
<p>
Users are often confused into installing applications from Market that are not authentic, since they have no easy way to verify
</p>
</li>
<li>
<p>
Google has ability to both pull apps from Market as well as remotely uninstall them from users' devices (via C2DM) but this process is reactive - not proactive
</p>
</li>
</ul></div>
</li>
<li>
<p>
OEMs/Carriers are often too slow to patch the devices out in the field - so users remain vulnerable to these root exploits
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_security_of_memory">5.17. Security of Memory</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Address_space_layout_randomization">Address Space Layout Randomization (ASLR)</a> to randomize key locations in memory: stack, heap, libs and mmap, exec, linker (and Virtual Dynamically-linked Shared Objects, which are typically not used on Android)
</p>
<div class="ulist"><ul>
<li>
<p>
Standard in ICS (Android 4.0)
</p>
</li>
<li>
<p>
Possible, because shared libraries are no longer <a href="http://en.wikipedia.org/wiki/Prelink">pre-linked</a> in ICS
</p>
</li>
<li>
<p>
But, <a href="http://blog.duosecurity.com/2012/02/a-look-at-aslr-in-android-ice-cream-sandwich-4-0/">Android&#8217;s ALSR implementation</a> does <em>not</em> randomize:
</p>
<div class="ulist"><ul>
<li>
<p>
The heap (&#8656; 4.0.2) - as <tt>/proc/sys/kernel/randomize_va_space</tt> is set to <tt>1</tt> (enabling randomization for mmap, stack, VDSO, and executable mapping), but not the heap, which requires the setting of <tt>2</tt>
</p>
</li>
<li>
<p>
The location of the executables - as they are not compiled as <a href="http://en.wikipedia.org/wiki/Position-independent_code">position-independent code (PIC)</a>, probably due to PIC&#8217;s performance penalty on architectures with limited GPRs (like x86)
</p>
</li>
<li>
<p>
The location of Android&#8217;s custom dynamic linker
</p>
</li>
<li>
<p>
Locations of <a href="https://groups.google.com/forum/#!msg/android-security-discuss/Af71Z2QYdMo/u1miB1A9UOwJ">dynamic libraries for child processes of zygote</a> (until the next reboot)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Pre ICS, there was <a href="http://bojinov.org/professional/wisec2011-mobileaslr-paper.pdf">a proposal</a> (by Hristo Bojinov and Dan Boneh from Stanford University and Rich Cannings and Iliyan Malchev from Google) to apply ASLR statically at the time of system recovery (by <em>retouching</em> all executable code) and support undoing randomization to support future diff-based OTA updates
</p>
<div class="ulist"><ul>
<li>
<p>
Designed to help against remote exploits from network attacks and network-facing services
</p>
<div class="ulist"><ul>
<li>
<p>
A website with malicious content
</p>
</li>
<li>
<p>
Any remote network service that exploits a vulnerability of a local [network] protocol parser (e.g. DHCP, HTTP, NTP, or even app "protocols" like iCal, vCard, etc)
</p>
</li>
<li>
<p>
A rogue access point
</p>
</li>
<li>
<p>
A rogue SMS packet
</p>
</li>
<li>
<p>
A malicious audio/video file that targets a flow in a codec decoder
</p>
</li>
<li>
<p>
Does not help against local code that has access to the actual memory locations of binary code (even if randomized)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Hardware-based <a href="http://en.wikipedia.org/wiki/Executable_space_protection">executable space protection</a>, a.k.a. <a href="http://en.wikipedia.org/wiki/NX_bit">No eXecute</a> (NX)
</p>
<div class="ulist"><ul>
<li>
<p>
Known as XN on ARM, XD bit on Intel, and Enhanced Virus Protection on AMD processors
</p>
</li>
<li>
<p>
Enables us to mark certain memory pages as non-executable (i.e. data vs. instruction memory) such that an attempt to execute code in those pages will cause a hardware exception
</p>
</li>
<li>
<p>
Prevents code execution on the stack and the heap
</p>
</li>
</ul></div>
</li>
<li>
<p>
ProPolice to <a href="http://en.wikipedia.org/wiki/Buffer_overflow_protection">prevent stack buffer overruns</a> or specifically, <a href="http://en.wikipedia.org/wiki/Buffer_overflow_protection#GCC_Stack-Smashing_Protector_.28ProPolice.29">stack-smashing attacks</a> through the use of overrun detection canaries - generated by the compiler
</p>
</li>
<li>
<p>
<a href="http://code.google.com/p/safe-iop/wiki/README">safe_iop</a> to help reduce integer overflows
</p>
</li>
<li>
<p>
Extensions to OpenBSD dlmalloc to prevent double free() vulnerabilities and to prevent chunk consolidation attacks, which are a common way to exploit heap corruption.
</p>
</li>
<li>
<p>
OpenBSD calloc to prevent integer overflows during memory allocation
</p>
</li>
<li>
<p>
Linux mmap_min_addr() to mitigate null pointer dereference privilege escalation
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Valgrind">Valginrd</a> (versions &gt;= <a href="http://valgrind.org/docs/manual/dist.readme-android.html">3.7.0+ support Android</a>) to detect incorrect use of heap memory: accessing uninitialized or already freed memory, accessing memory out of bounds, memory leaks, etc.
</p>
</li>
<li>
<p>
A proposal to prevent brute-force attacks (trying to guess random offsets)
</p>
<div class="ulist"><ul>
<li>
<p>
Part of the same <a href="http://bojinov.org/professional/wisec2011-mobileaslr-paper.pdf">research paper</a> as on pre-ICS ASLR proposal
</p>
</li>
<li>
<p>
Given the millions of deployed devices, a successful exploit on one device can potentially work on a large enough subset of other devices
</p>
</li>
<li>
<p>
For example, with a 8-bit randomization offset, for any one device, there are 1 in 256 devices just like it
</p>
</li>
<li>
<p>
Use cloud-based analysis of crash reports to reliably detect attempts to bypass ASLR by guessing random offset used on each device
</p>
</li>
<li>
<p>
Attack on a single device is hard to detect, but an attack across a range of devices tends to have a well-known signature
</p>
</li>
<li>
<p>
Once detected, issue patches, or isolate vulnerable code that lead to the attack in the first place
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_tap_jacking_on_android">5.18. Tap-Jacking on Android</h3>
<div class="ulist"><ul>
<li>
<p>
Similar to "click-jacking" in web browsers
</p>
</li>
<li>
<p>
Example scenario
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
A malicious application starts a "sensitive" activity from another application (e.g. system settings)
</p>
</li>
<li>
<p>
The malicious application then overlays a customized notification dialog on top of the legitimate activity (say something that looks like a game)
</p>
</li>
<li>
<p>
User interacts with the custom notification dialog, but user touch events are passed down to the legitimate activity (say to inadvertently enable some "insecure" settings mode: like side-loading)
</p>
<div class="ulist"><ul>
<li>
<p>
Proof of concept: <a href="http://www.youtube.com/watch?v=gCLU7YUXUAY">http://www.youtube.com/watch?v=gCLU7YUXUAY</a>
</p>
</li>
</ul></div>
</li>
</ol></div>
</li>
<li>
<p>
To prevent, set <tt>android:filterTouchesWhenObscured="true"</tt> on views which are deemed "secure" (e.g. <tt>EditText</tt> used for password entry)
</p>
<div class="ulist"><ul>
<li>
<p>
When set to <tt>true</tt> the view system discards touch events that are received whenever the view&#8217;s window is obscured by another visible window
</p>
</li>
<li>
<p>
The view will not receive touches whenever a toast, dialog, or other window appears above the view&#8217;s window
</p>
</li>
<li>
<p>
For custom views, consider overriding <tt>View.onFilterTouchEventForSecurity(MotionEvent)</tt> to implement your own security policy
</p>
</li>
<li>
<p>
See <a href="http://developer.android.com/reference/android/view/View.html#Security">http://developer.android.com/reference/android/view/View.html#Security</a> for more info.
</p>
</li>
<li>
<p>
Only available as for Android API 9 (Gingerbread)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Another scenario
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
A malicious application starts a background service
</p>
</li>
<li>
<p>
User launches a legitimate "secure" application (say a banking app)
</p>
</li>
<li>
<p>
This service launches another activity, masquerading as the original
</p>
</li>
<li>
<p>
User enters password/pin/gesture to access the "secure" application
</p>
</li>
<li>
<p>
The malicious activity captures user input, records it, and simulates a failure - leading the user to re-enter the info into the legitimate activity
</p>
</li>
<li>
<p>
The secure app has no knowledge of the fact that the user taps were recorded
</p>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_android_device_administration">5.19. Android Device Administration</h3>
<div class="sect3">
<h4 id="_device_administration_overview">5.19.1. Device Administration Overview</h4>
<div class="paragraph"><p>The Android Device Administration API, introduced in Android 2.2, allows you to create security-aware applications that are useful in enterprise settings, such as:</p></div>
<div class="ulist"><ul>
<li>
<p>
Email clients
</p>
</li>
<li>
<p>
Security applications that do remote wipe
</p>
</li>
<li>
<p>
Device management services and applications
</p>
</li>
</ul></div>
<div class="paragraph"><p>You use the Device Administration API to write device admin applications that users install on their devices. The device admin application enforces desired <em>security policies</em>. Here&#8217;s how it works:</p></div>
<div class="ulist"><ul>
<li>
<p>
A system administrator writes a device admin application that enforces remote/local device security policies.
</p>
</li>
<li>
<p>
The application is installed on a user&#8217;s device.
</p>
</li>
<li>
<p>
The system prompts the user to enable the device admin application.
</p>
</li>
<li>
<p>
Once the users enable the device admin application, they are subject to its policies.
</p>
</li>
</ul></div>
<div class="paragraph"><p>When enabled, in addition to enforcing security policies, the admin application can:</p></div>
<div class="ulist"><ul>
<li>
<p>
Prompt the user to set a new password
</p>
</li>
<li>
<p>
Lock the device immediately
</p>
</li>
<li>
<p>
Perform a factory reset on the device, wiping the user data (if it has permission)
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_device_administration_overview_cont">5.19.2. Device Administration Overview (cont.)</h4>
<div class="paragraph"><p>If a device contains multiple enabled admin applications, the strictest policy is enforced.</p></div>
<div class="paragraph"><p>If users do not enable the device admin app, it remains on the device, but in an inactive state.</p></div>
<div class="ulist"><ul>
<li>
<p>
Users will not be subject to its policies, but the application may disable some or all of its functionality.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If a user fails to comply with the policies (for example, if a user sets a password that violates the guidelines), it is up to the application to decide how to handle this.</p></div>
<div class="ulist"><ul>
<li>
<p>
For example, the application may prompt the user to set a new password or disable some or all of its functionality.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To uninstall an existing device admin application, users need to first deactivate the application as a device administrator.</p></div>
<div class="ulist"><ul>
<li>
<p>
Upon deactivation, the application may disable some or all of its functionality, delete its data, and/or perform a factory reset (if it has permission).
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_security_policies">5.19.3. Security Policies</h4>
<div class="paragraph"><p>An admin application may enforce security policies regarding the device&#8217;s screen lock PIN/password, including:</p></div>
<div class="ulist"><ul>
<li>
<p>
The maximum inactivity time to trigger the screen lock
</p>
</li>
<li>
<p>
The minimum number of PIN/password characters
</p>
</li>
<li>
<p>
The maximum number of failed password attempts
</p>
</li>
<li>
<p>
The minimum number of uppercase letters, lowercase letters, digits, and/or special password characters (Android 3.0)
</p>
</li>
<li>
<p>
The password expiration period (Android 3.0)
</p>
</li>
<li>
<p>
A password history restriction, preventing users from reusing the last <em>n</em> unique passwords (Android 3.0)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Additionally, a security policy can require device storage encryption as of Android 3.0 and disabling of camera as for Android 4.0.</p></div>
</div>
<div class="sect3">
<h4 id="_the_device_administration_classes">5.19.4. The Device Administration Classes</h4>
<div class="paragraph"><p>The Device Administration API includes the following classes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>DeviceAdminReceiver</tt>
</dt>
<dd>
<p>
Base class for implementing a device administration component. This class provides a convenience for interpreting the raw intent actions that are sent by the system. Your Device Administration application must include a <tt>DeviceAdminReceiver</tt> subclass.
</p>
</dd>
<dt class="hdlist1">
<tt>DevicePolicyManager</tt>
</dt>
<dd>
<p>
A class for managing policies enforced on a device. Most clients of this class must have published a <tt>DeviceAdminReceiver</tt> that the user has currently enabled. The <tt>DevicePolicyManager</tt> manages policies for one or more <tt>DeviceAdminReceiver</tt> instances.
</p>
</dd>
<dt class="hdlist1">
<tt>DeviceAdminInfo</tt>
</dt>
<dd>
<p>
This class is used to specify metadata for a device administrator component.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_creating_the_manifest">5.19.5. Creating the Manifest</h4>
<div class="paragraph"><p>The manifest of your admin application must register your <tt>DeviceAdminReceiver</tt> as a <tt>&lt;receiver&gt;</tt>.</p></div>
<div class="paragraph"><p>The <tt>&lt;receiver&gt;</tt> should set <tt>android:permission="android.permission.BIND_DEVICE_ADMIN"</tt> to ensure that only the system is allowed to interact with the broadcast receiver.</p></div>
<div class="paragraph"><p>The <tt>&lt;receiver&gt;</tt> must have an <tt>&lt;intent-filter&gt;</tt> child element including one or more of the following <tt>&lt;action&gt;</tt>s, as defined in the <tt>DeviceAdminReceiver</tt> class:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>ACTION_DEVICE_ADMIN_ENABLED</tt>
</dt>
<dd>
<p>
<strong>(Required)</strong> This is the primary action that a device administrator must implement to be allowed to manage a device. This is sent to a device administrator when the user enables it for administration.
</p>
</dd>
<dt class="hdlist1">
<tt>ACTION_DEVICE_ADMIN_DISABLE_REQUESTED</tt>
</dt>
<dd>
<p>
Action sent to a device administrator when the user has requested to disable it, but before this has actually been done.
</p>
</dd>
<dt class="hdlist1">
<tt>ACTION_DEVICE_ADMIN_DISABLED</tt>
</dt>
<dd>
<p>
Action sent to a device administrator when the user has disabled it.
</p>
</dd>
<dt class="hdlist1">
<tt>ACTION_PASSWORD_CHANGED</tt>
</dt>
<dd>
<p>
Action sent to a device administrator when the user has changed the password of their device.
</p>
</dd>
<dt class="hdlist1">
<tt>ACTION_PASSWORD_EXPIRING</tt>
</dt>
<dd>
<p>
Action periodically sent to a device administrator when the device password is expiring.
</p>
</dd>
<dt class="hdlist1">
<tt>ACTION_PASSWORD_FAILED</tt>
</dt>
<dd>
<p>
Action sent to a device administrator when the user has failed at attempted to enter the password.
</p>
</dd>
<dt class="hdlist1">
<tt>ACTION_PASSWORD_SUCCEEDED</tt>
</dt>
<dd>
<p>
Action sent to a device administrator when the user has successfully entered their password, after failing one or more times.
</p>
</dd>
</dl></div>
<div class="openblock handout">
<div class="content">
<hr />
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;receiver</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"MyDeviceAdminReceiver"</span>
    <span style="color: #009900">android:permission</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.BIND_DEVICE_ADMIN"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.app.action.DEVICE_ADMIN_ENABLED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.app.action.ACTION_DEVICE_ADMIN_DISABLE_REQUESTED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.app.action.ACTION_DEVICE_ADMIN_DISABLED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- ... --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/receiver&gt;</span></span></tt></pre></div></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_creating_the_manifest_cont">5.19.6. Creating the Manifest (cont.)</h4>
<div class="paragraph"><p>Your <tt>&lt;receiver&gt;</tt> element must also include a <tt>&lt;meta-data&gt;</tt> child element specifying an XML resource declaring the policies used by your admin application.</p></div>
<div class="ulist"><ul>
<li>
<p>
The <tt>android:name</tt> attribute must be <tt>android.app.device_admin</tt>.
</p>
</li>
<li>
<p>
The <tt>android:resource</tt> must reference an XML resource in your application.
</p>
</li>
<li>
<p>
For example:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;meta-data</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.app.device_admin"</span>
           <span style="color: #009900">android:resource</span><span style="color: #990000">=</span><span style="color: #FF0000">"@xml/device_admin_sample"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>An example XML resource requesting all policies would be:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;device-admin</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-policies&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;limit-password</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;watch-login</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;reset-password</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;force-lock</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;wipe-data</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;expire-password</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;encrypted-storage</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;disable-camera</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/uses-policies&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/device-admin&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Your application needs to list only those policies it actually uses.</p></div>
</div>
<div class="sect3">
<h4 id="_the_tt_deviceadminreceiver_tt_class">5.19.7. The <tt>DeviceAdminReceiver</tt> Class</h4>
<div class="paragraph"><p>The <tt>DeviceAdminReceiver</tt> class defines a set of methods that you can override to handle the device administration events broadcast by the system:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>void onEnabled(Context context, Intent intent)</tt>
</dt>
<dd>
<p>
Called after the administrator is first enabled, as a result of receiving <tt>ACTION_DEVICE_ADMIN_ENABLED</tt>. At this point you can use <tt>DevicePolicyManager</tt> to set your desired policies.
</p>
</dd>
<dt class="hdlist1">
<tt>CharSequence onDisableRequested(Context context, Intent intent)</tt>
</dt>
<dd>
<p>
Called when the user has asked to disable the administrator, as a result of receiving <tt>ACTION_DEVICE_ADMIN_DISABLE_REQUESTED</tt>. You may return a warning message to display to the user before being disabled, or <tt>null</tt> for no message.
</p>
</dd>
<dt class="hdlist1">
<tt>void onDisabled(Context context, Intent intent)</tt>
</dt>
<dd>
<p>
Called prior to the administrator being disabled, as a result of receiving <tt>ACTION_DEVICE_ADMIN_DISABLED</tt>. Upon return, you can no longer use the protected parts of the <tt>DevicePolicyManager</tt> API.
</p>
</dd>
<dt class="hdlist1">
<tt>void onPasswordChanged(Context context, Intent intent)</tt>
</dt>
<dd>
<p>
Called after the user has changed their password, as a result of receiving <tt>ACTION_PASSWORD_CHANGED</tt>.
</p>
</dd>
<dt class="hdlist1">
<tt>void onPasswordExpiring(Context context, Intent intent)</tt>
</dt>
<dd>
<p>
Called periodically when the password is about to expire or has expired, as a result of receiving <tt>ACTION_PASSWORD_EXPIRING</tt>. (API 11)
</p>
</dd>
<dt class="hdlist1">
<tt>void onPasswordFailed(Context context, Intent intent)</tt>
</dt>
<dd>
<p>
Called after the user has failed at entering their current password, as a result of receiving <tt>ACTION_PASSWORD_FAILED</tt>.
</p>
</dd>
<dt class="hdlist1">
<tt>void onPasswordSucceeded(Context context, Intent intent)</tt>
</dt>
<dd>
<p>
Called after the user has succeeded at entering their current password, as a result of receiving <tt>ACTION_PASSWORD_SUCCEEDED</tt>.
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_testing_whether_the_admin_application_is_enabled">5.19.8. Testing Whether the Admin Application is Enabled</h4>
<div class="paragraph"><p>You can query the <tt>DevicePolicyManager</tt> to test if your admin application is enabled:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DevicePolicyManager devicePolicyManager
    <span style="color: #990000">=</span> <span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getSystemService</span></span><span style="color: #990000">(</span>Context<span style="color: #990000">.</span>DEVICE_POLICY_SERVICE<span style="color: #990000">);</span>
ComponentName deviceAdminComponentName
    <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ComponentName</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> MyDeviceAdminReceiver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">);</span>
<span style="color: #009900">boolean</span> isActive <span style="color: #990000">=</span> devicePolicyManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isAdminActive</span></span><span style="color: #990000">(</span>deviceAdminComponentName<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>You could then enable or disable features of your application depending on whether it is an active device administrator.</p></div>
</div>
<div class="sect3">
<h4 id="_enabling_the_application">5.19.9. Enabling the Application</h4>
<div class="paragraph"><p>Your application must explicitly request the user to enable it for device administration. To do so:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create an implicit Intent with the <tt>DevicePolicyManager.ACTION_ADD_DEVICE_ADMIN</tt> action:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">Intent</span> intent <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">.</span>ACTION_ADD_DEVICE_ADMIN<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Add an extra identifying your <tt>DeviceAdminReceiver</tt> component:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ComponentName deviceAdminComponentName
    <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ComponentName</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> MyDeviceAdminReceiver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">);</span>
intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">putExtra</span></span><span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">.</span>EXTRA_DEVICE_ADMIN<span style="color: #990000">,</span> deviceAdminComponentName<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Optionally, provide an explanation as to why the user should activate the admin application:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">putExtra</span></span><span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">.</span>EXTRA_ADD_EXPLANATION<span style="color: #990000">,</span> <span style="color: #FF0000">"Your boss told you to do this"</span><span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Use the Intent with <tt>startActivityForResult()</tt> to display the activation dialog:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">startActivityForResult</span></span><span style="color: #990000">(</span>intent<span style="color: #990000">,</span> ACTIVATION_REQUEST<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
You can test for successful activation in your Activity&#8217;s <tt>onActivityResult()</tt> method:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@Override
<span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onActivityResult</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> requestCode<span style="color: #990000">,</span> <span style="color: #009900">int</span> resultCode<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>requestCode<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ACTIVATION_REQUEST<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>resultCode <span style="color: #990000">==</span> Activity<span style="color: #990000">.</span>RESULT_OK<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">i</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"DeviceAdminSample"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Administration enabled!"</span><span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">i</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"DeviceAdminSample"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Administration enable FAILED!"</span><span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onActivityResult</span></span><span style="color: #990000">(</span>requestCode<span style="color: #990000">,</span> resultCode<span style="color: #990000">,</span> data<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_setting_password_quality_policies">5.19.10. Setting Password Quality Policies</h4>
<div class="paragraph"><p><tt>DevicePolicyManager</tt> includes APIs for setting and enforcing the device screen lock password policy.</p></div>
<div class="ulist"><ul>
<li>
<p>
The <tt>setPasswordQuality()</tt> lets you set basic password requirements for your admin application, using these constants:
</p>
<div class="openblock">
<div class="content">
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>PASSWORD_QUALITY_ALPHABETIC</tt>
</dt>
<dd>
<p>
The user must enter a password containing at least alphabetic (or other symbol) characters.
</p>
</dd>
<dt class="hdlist1">
<tt>PASSWORD_QUALITY_ALPHANUMERIC</tt>
</dt>
<dd>
<p>
The user must enter a password containing at least both numeric and alphabetic (or other symbol) characters.
</p>
</dd>
<dt class="hdlist1">
<tt>PASSWORD_QUALITY_NUMERIC</tt>
</dt>
<dd>
<p>
The user must enter a password containing at least numeric characters.
</p>
</dd>
<dt class="hdlist1">
<tt>PASSWORD_QUALITY_SOMETHING</tt>
</dt>
<dd>
<p>
The policy requires some kind of password, but doesn&#8217;t care what it is.
</p>
</dd>
<dt class="hdlist1">
<tt>PASSWORD_QUALITY_UNSPECIFIED</tt>
</dt>
<dd>
<p>
The policy has no requirements for the password.
</p>
</dd>
<dt class="hdlist1">
<tt>PASSWORD_QUALITY_COMPLEX</tt>
</dt>
<dd>
<p>
(API 11) The user must have entered a password containing at least a letter, a numerical digit and a special symbol.
</p>
</dd>
</dl></div>
</div></div>
</li>
<li>
<p>
Once you have set the password quality, you may also specify a minimum length (except with <tt>PASSWORD_QUALITY_SOMETHING</tt> and <tt>PASSWORD_QUALITY_UNSPECIFIED</tt>) using the <tt>setPasswordMinimumLength()</tt> method.
</p>
</li>
<li>
<p>
For example:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>devicePolicyManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setPasswordQuality</span></span><span style="color: #990000">(</span>deviceAdminComponentName<span style="color: #990000">,</span> PASSWORD_QUALITY_ALPHANUMERIC<span style="color: #990000">);</span>
devicePolicyManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setPasswordMinimumLength</span></span><span style="color: #990000">(</span>deviceAdminComponentName<span style="color: #990000">,</span> <span style="color: #993399">6</span><span style="color: #990000">);</span></tt></pre></div></div>
</li>
</ul></div>
<div class="openblock handout">
<div class="content">
<hr />
<div class="paragraph"><p>Your application&#8217;s policy metadata resource must request the <tt>&lt;limit-password /&gt;</tt> policy to control password quality; otherwise these methods throw a security exception.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_setting_password_quality_policies_api_11">5.19.11. Setting Password Quality Policies, API 11</h4>
<div class="paragraph"><p>Beginning with Android 3.0, the <tt>DevicePolicyManager</tt> class includes methods that give you greater control over the contents of the password. Here are the methods for fine-tuning a password&#8217;s contents:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>setPasswordMinimumLetters()</tt>
</p>
</li>
<li>
<p>
<tt>setPasswordMinimumLowerCase()</tt>
</p>
</li>
<li>
<p>
<tt>setPasswordMinimumUpperCase()</tt>
</p>
</li>
<li>
<p>
<tt>setPasswordMinimumNonLetter()</tt>
</p>
</li>
<li>
<p>
<tt>setPasswordMinimumNumeric()</tt>
</p>
</li>
<li>
<p>
<tt>setPasswordMinimumSymbols()</tt>
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can also set the password expiration timeout, and prevent users from reusing the last <em>n</em> unique passwords:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>setPasswordExpirationTimeout()</tt>
</p>
</li>
<li>
<p>
<tt>setPasswordHistoryLength()</tt>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Additionally, Android 3.0 introduced support for a policy requiring the user to encrypt the device, which you can set with:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>setStorageEncryption()</tt>
</p>
</li>
</ul></div>
<div class="openblock handout">
<div class="content">
<hr />
<div class="paragraph"><p>Your application&#8217;s policy metadata resource must request the <tt>&lt;limit-password /&gt;</tt> policy to control password quality; otherwise these methods throw a security exception.</p></div>
<div class="paragraph"><p>Similarly, it must request the <tt>&lt;expire-password /&gt;</tt> and <tt>&lt;encrypted-storage /&gt;</tt> policies to control those features without throwing a security exception.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_setting_the_device_password">5.19.12. Setting the Device Password</h4>
<div class="paragraph"><p>You can test if the current device password meets the quality requirements by calling <tt>DevicePolicyManager.isActivePasswordSufficient()</tt>, which returns a boolean result.</p></div>
<div class="paragraph"><p>If necessary, you can start an activity prompting the user to set a password as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">Intent</span> intent <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">.</span>ACTION_SET_NEW_PASSWORD<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">startActivity</span></span><span style="color: #990000">(</span>intent<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Your application can also perform a password reset on the device using <tt>DevicePolicyManager.resetPassword()</tt>. This can be useful if your application is designed to support remote administration, with a new password being provided from a central administration system.</p></div>
<div class="openblock handout">
<div class="content">
<hr />
<div class="paragraph"><p>Your application&#8217;s policy metadata resource must request the <tt>&lt;reset-password /&gt;</tt> policy to reset the password; otherwise <tt>resetPassword()</tt> throws a security exception.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_locking_and_wiping_the_device">5.19.13. Locking and Wiping the Device</h4>
<div class="paragraph"><p>Your application can lock the device programmatically using <tt>DevicePolicyManager.lockNow()</tt>.</p></div>
<div class="paragraph"><p>You can wipe the user data of the device, performing a factory reset, using <tt>DevicePolicyManager.wipeData()</tt>.</p></div>
<div class="paragraph"><p>Additionally, you can set the maximum number of allowed failed password attempts before the device is wiped automatically by calling <tt>DevicePolicyManager.setMaximumFailedPasswordsForWipe()</tt></p></div>
<div class="openblock handout">
<div class="content">
<hr />
<div class="paragraph"><p>Your application&#8217;s policy metadata resource must request the <tt>&lt;wipe-data /&gt;</tt> policy to wipe the data either explicitly or set the maximum failed passwords for wipe; otherwise a security exception is thrown. <tt>setMaximumFailedPasswordsForWipe()</tt> also requires the <tt>&lt;watch-login /&gt;</tt> policy.</p></div>
<div class="paragraph"><p>The <tt>lockNow()</tt> method requires your application to request the <tt>&lt;force-lock /&gt;</tt> policy to avoid throwing a security exception.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_device_administration_demo">5.19.14. Device Administration Demo</h4>
<div class="paragraph"><p>In this example app, you will see how to write an application that requests to device administration privileges, and once it gets them, allows user to lock or reset the device.</p></div>
<div class="paragraph"><p>We are going to look at the following files:</p></div>
<div class="ulist"><ul>
<li>
<p>
Android Manifest File
</p>
</li>
<li>
<p>
XML Resource File
</p>
</li>
<li>
<p>
Device Admin Receiver Component
</p>
</li>
<li>
<p>
Activity
</p>
</li>
</ul></div>
<div class="paragraph"><p>The source code for this project is available at
<a href="https://marakana.com/static/courseware/android/DevicePolicyDemo.zip">https://marakana.com/static/courseware/android/DevicePolicyDemo.zip</a></p></div>
</div>
<div class="sect3">
<h4 id="_android_manifest_file">5.19.15. Android Manifest File</h4>
<div class="paragraph"><p>This is where we register our device administration receiver component. It appears as another receiver declaration.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
    <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.devicepolicydemo"</span>
    <span style="color: #009900">android:versionCode</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
    <span style="color: #009900">android:versionName</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-sdk</span></span> <span style="color: #009900">android:minSdkVersion</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span>
        <span style="color: #009900">android:icon</span><span style="color: #990000">=</span><span style="color: #FF0000">"@drawable/ic_launcher"</span>
        <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span>
            <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".DevicePolicyDemoActivity"</span>
            <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.action.MAIN"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;category</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.category.LAUNCHER"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span>

        <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This is where we register our receiver --&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;receiver</span></span>
            <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".DemoDeviceAdminReceiver"</span>
            <span style="color: #009900">android:permission</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.BIND_DEVICE_ADMIN"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>

                <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This action is required --&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.app.action.DEVICE_ADMIN_ENABLED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>

            <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- This is required this receiver to become device admin component. --&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta-data</span></span>
                <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.app.device_admin"</span>
                <span style="color: #009900">android:resource</span><span style="color: #990000">=</span><span style="color: #FF0000">"@xml/device_admin_sample"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/receiver&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Notice that <tt>&lt;receiver&gt;</tt> element now includes required <tt>android:permission="android.permission.BIND_DEVICE_ADMIN"</tt> permission declaration.</p></div>
<div class="paragraph"><p>We also must include the appropriate intent action filter <tt>android.app.action.DEVICE_ADMIN_ENABLED</tt> as well as the <tt>&lt;meta-data/&gt;</tt> element that specifies that this receiver users <tt>@xml/device_admin_sample</tt> resource, which we&#8217;ll look at next.</p></div>
</div>
<div class="sect3">
<h4 id="_xml_resource_file">5.19.16. XML Resource File</h4>
<div class="paragraph"><p>This XML resource file, referenced from <tt>AndroidManifest.xml</tt> specifies what policies we are interested in.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;device-admin</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-policies&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;limit-password</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;watch-login</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;reset-password</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;force-lock</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;wipe-data</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;expire-password</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;encrypted-storage</span></span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/uses-policies&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/device-admin&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>In this example, we ask for most of the available policies merely to illustrate what is available. In a real-world example, you should only ask for policies that you really require.</p></div>
</div>
<div class="sect3">
<h4 id="_device_admin_receiver_component">5.19.17. Device Admin Receiver Component</h4>
<div class="paragraph"><p>This is the main device administration component. It is basically a specialized <tt>BroadcastReceiver</tt> class that implements some callbacks specific to device administration.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>devicepolicydemo<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>admin<span style="color: #990000">.</span>DeviceAdminReceiver<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Context<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Intent<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Toast<span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">/**</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * This is the component that is responsible for actual device administration.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * It becomes the receiver when a policy is applied. It is important that we</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * subclass DeviceAdminReceiver class here and to implement its only required</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * method onEnabled().</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">DemoDeviceAdminReceiver</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> DeviceAdminReceiver <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"DemoDeviceAdminReceiver"</span><span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">/** Called when this application is approved to be a device administrator. */</span></span>
    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onEnabled</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onEnabled</span></span><span style="color: #990000">(</span>context<span style="color: #990000">,</span> intent<span style="color: #990000">);</span>
        Toast<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">makeText</span></span><span style="color: #990000">(</span>context<span style="color: #990000">,</span> R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>device_admin_enabled<span style="color: #990000">,</span>
                Toast<span style="color: #990000">.</span>LENGTH_LONG<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">();</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onEnabled"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">/** Called when this application is no longer the device administrator. */</span></span>
    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onDisabled</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onDisabled</span></span><span style="color: #990000">(</span>context<span style="color: #990000">,</span> intent<span style="color: #990000">);</span>
        Toast<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">makeText</span></span><span style="color: #990000">(</span>context<span style="color: #990000">,</span> R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>device_admin_disabled<span style="color: #990000">,</span>
                Toast<span style="color: #990000">.</span>LENGTH_LONG<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">();</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onDisabled"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPasswordChanged</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onPasswordChanged</span></span><span style="color: #990000">(</span>context<span style="color: #990000">,</span> intent<span style="color: #990000">);</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onPasswordChanged"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPasswordFailed</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onPasswordFailed</span></span><span style="color: #990000">(</span>context<span style="color: #990000">,</span> intent<span style="color: #990000">);</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onPasswordFailed"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPasswordSucceeded</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onPasswordSucceeded</span></span><span style="color: #990000">(</span>context<span style="color: #990000">,</span> intent<span style="color: #990000">);</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onPasswordSucceeded"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Notice that we subclass <tt>DeviceAdminReceiver</tt> class. This is the required for this component to be able to receive policy notifications.</p></div>
<div class="paragraph"><p>We also must implement the required <tt>onEnabled()</tt> method that is called when the policy administration is first enabled.</p></div>
<div class="paragraph"><p>We don&#8217;t really do much here other than log what happened to visually illustrate the execution of this code.</p></div>
</div>
<div class="sect3">
<h4 id="_activity">5.19.18. Activity</h4>
<div class="paragraph"><p>The activity acts as our demo client in this case. The significant methods are <tt>onClick()</tt>, <tt>onCheckedChanged()</tt> and <tt>onActivityResult()</tt>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>devicepolicydemo<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Activity<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>admin<span style="color: #990000">.</span>DevicePolicyManager<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>ComponentName<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Context<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Intent<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Bundle<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>CompoundButton<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>CompoundButton<span style="color: #990000">.</span>OnCheckedChangeListener<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Toast<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>ToggleButton<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">DevicePolicyDemoActivity</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Activity <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span>
        OnCheckedChangeListener <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"DevicePolicyDemoActivity"</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #009900">int</span> ACTIVATION_REQUEST <span style="color: #990000">=</span> <span style="color: #993399">47</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// identifies our request id</span></span>
    <span style="color: #008080">DevicePolicyManager</span> devicePolicyManager<span style="color: #990000">;</span>
    <span style="color: #008080">ComponentName</span> demoDeviceAdmin<span style="color: #990000">;</span>
    <span style="color: #008080">ToggleButton</span> toggleButton<span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">/** Called when the activity is first created. */</span></span>
    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span><span style="color: #008080">Bundle</span> savedInstanceState<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span>savedInstanceState<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #000000">setContentView</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>layout<span style="color: #990000">.</span>main<span style="color: #990000">);</span>

        toggleButton <span style="color: #990000">=</span> <span style="color: #990000">(</span>ToggleButton<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span>
                <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>toggle_device_admin<span style="color: #990000">);</span>
        toggleButton<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setOnCheckedChangeListener</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>

        <span style="font-style: italic"><span style="color: #9A1900">// Initialize Device Policy Manager service and our receiver class</span></span>
        devicePolicyManager <span style="color: #990000">=</span> <span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getSystemService</span></span><span style="color: #990000">(</span>Context<span style="color: #990000">.</span>DEVICE_POLICY_SERVICE<span style="color: #990000">);</span>
        demoDeviceAdmin <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ComponentName</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> DemoDeviceAdminReceiver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">/**</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * Called when a button is clicked on. We have Lock Device and Reset Device</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * buttons that could invoke this method.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onClick</span></span><span style="color: #990000">(</span><span style="color: #008080">View</span> v<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>v<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getId</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>button_lock_device<span style="color: #990000">:</span>
            <span style="font-style: italic"><span style="color: #9A1900">// We lock the screen</span></span>
            Toast<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">makeText</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"Locking device..."</span><span style="color: #990000">,</span> Toast<span style="color: #990000">.</span>LENGTH_LONG<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">();</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Locking device now"</span><span style="color: #990000">);</span>
            devicePolicyManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">lockNow</span></span><span style="color: #990000">();</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>button_reset_device<span style="color: #990000">:</span>
            <span style="font-style: italic"><span style="color: #9A1900">// We reset the device - this will erase entire /data partition!</span></span>
            Toast<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">makeText</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"Locking device..."</span><span style="color: #990000">,</span> Toast<span style="color: #990000">.</span>LENGTH_LONG<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">();</span>
            Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span>
                    <span style="color: #FF0000">"RESETing device now - all user data will be ERASED to factory settings"</span><span style="color: #990000">);</span>
            devicePolicyManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">wipeData</span></span><span style="color: #990000">(</span>ACTIVATION_REQUEST<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">/**</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * Called when the state of toggle button changes. In this case, we send an</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * intent to activate the device policy administration.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCheckedChanged</span></span><span style="color: #990000">(</span><span style="color: #008080">CompoundButton</span> button<span style="color: #990000">,</span> <span style="color: #009900">boolean</span> isChecked<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>isChecked<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-style: italic"><span style="color: #9A1900">// Activate device administration</span></span>
            <span style="color: #008080">Intent</span> intent <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>
                    DevicePolicyManager<span style="color: #990000">.</span>ACTION_ADD_DEVICE_ADMIN<span style="color: #990000">);</span>
            intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">putExtra</span></span><span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">.</span>EXTRA_DEVICE_ADMIN<span style="color: #990000">,</span>
                    demoDeviceAdmin<span style="color: #990000">);</span>
            intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">putExtra</span></span><span style="color: #990000">(</span>DevicePolicyManager<span style="color: #990000">.</span>EXTRA_ADD_EXPLANATION<span style="color: #990000">,</span>
                    <span style="color: #FF0000">"Your boss told you to do this"</span><span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #000000">startActivityForResult</span></span><span style="color: #990000">(</span>intent<span style="color: #990000">,</span> ACTIVATION_REQUEST<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
        Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"onCheckedChanged to: "</span> <span style="color: #990000">+</span> isChecked<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">/**</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * Called when startActivityForResult() call is completed. The result of</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * activation could be success of failure, mostly depending on user okaying</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     * this app's request to administer the device.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
    @Override
    <span style="font-weight: bold"><span style="color: #0000FF">protected</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onActivityResult</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> requestCode<span style="color: #990000">,</span> <span style="color: #009900">int</span> resultCode<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>requestCode<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> ACTIVATION_REQUEST<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>resultCode <span style="color: #990000">==</span> Activity<span style="color: #990000">.</span>RESULT_OK<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">i</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Administration enabled!"</span><span style="color: #990000">);</span>
                toggleButton<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setChecked</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">i</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Administration enable FAILED!"</span><span style="color: #990000">);</span>
                toggleButton<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setChecked</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
            <span style="color: #FF0000">}</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onActivityResult</span></span><span style="color: #990000">(</span>requestCode<span style="color: #990000">,</span> resultCode<span style="color: #990000">,</span> data<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p><tt>onCheckedChanged()</tt> is invoked when the toggle button changes state. It sends an intent requesting that this application be granted device administration permissions on this device. User has to allow this request. The result of user&#8217;s action is then passed to <tt>onActivityResult()</tt> method.</p></div>
<div class="paragraph"><p><tt>onClick()</tt> method processes button clicks for lock and reset buttons. Note that its calls to <tt>DevicePolicyManager</tt> <strong>will</strong> lock and wipe out the device user data partition, respectively.</p></div>
</div>
<div class="sect3">
<h4 id="_lab_device_administration">5.19.19. Lab (Device Administration)</h4>
<div class="paragraph"><p>Device-admin-enable an existing Android app:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Download <a href="http://marakana.com/static/courseware/android/SecureNote.zip">http://marakana.com/static/courseware/android/SecureNote.zip</a>
</p>
</li>
<li>
<p>
Expand into your (Eclipse) workspace
</p>
</li>
<li>
<p>
Import into Eclipse
</p>
</li>
<li>
<p>
Using Device Admin APIs
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Require that the screen-lock password be set (of at least 6 characters with at least one digit)
</p>
</li>
<li>
<p>
Automatically wipe the device after 5 invalid login attempts
</p>
</li>
</ol></div>
</li>
<li>
<p>
Check against the solution available at <a href="http://marakana.com/static/courseware/android/DeviceAdministeredSecureNote.zip">http://marakana.com/static/courseware/android/DeviceAdministeredSecureNote.zip</a>
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect2">
<h3 id="_anti_malware">5.20. Anti-malware</h3>
<div class="ulist"><ul>
<li>
<p>
Use <tt>android.content.pm.PackageManager.getInstalledPackages(int flags)</tt> for the full app scan
</p>
<div class="ulist"><ul>
<li>
<p>
By package-name (e.g. check against a black/white-list):
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #008080">PackageInfo</span> packageInfo <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">getPackageManager</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getInstalledPackages</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>packageInfo<span style="color: #990000">.</span>packageName<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">startsWith</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"com.malware"</span><span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
     <span style="font-style: italic"><span style="color: #9A1900">// found malware!</span></span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
By permission (e.g. check against a black-list of inappropriate permissions):
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #008080">PackageInfo</span> packageInfo <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">getPackageManager</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getInstalledPackages</span></span><span style="color: #990000">(</span>PackageManager<span style="color: #990000">.</span>GET_PERMISSIONS<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>packageInfo<span style="color: #990000">.</span>requestedPermissions <span style="color: #990000">!=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #008080">String</span> requestedPermission <span style="color: #990000">:</span> packageInfo<span style="color: #990000">.</span>requestedPermissions<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>requestedPermission<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>android<span style="color: #990000">.</span>Manifest<span style="color: #990000">.</span>permission<span style="color: #990000">.</span>SEND_SMS<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// found malware!</span></span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
By signature (e.g., check against a black/white-list of issuers):
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">CertificateFactory</span> certificateFactory <span style="color: #990000">=</span> CertificateFactory<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getInstance</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"X509"</span><span style="color: #990000">);</span>
<span style="color: #008080">PublicKey</span> trustedIssuerPublicKey <span style="color: #990000">=</span> <span style="font-style: italic"><span style="color: #9A1900">// get some trusted key</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #008080">PackageInfo</span> packageInfo <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">getPackageManager</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getInstalledPackages</span></span><span style="color: #990000">(</span>PackageManager<span style="color: #990000">.</span>GET_SIGNATURES<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>packageInfo<span style="color: #990000">.</span>signatures <span style="color: #990000">!=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #008080">Signature</span> signature <span style="color: #990000">:</span> packageInfo<span style="color: #990000">.</span>signatures<span style="color: #990000">)</span>  <span style="color: #FF0000">{</span>
      <span style="color: #008080">InputStream</span> input <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ByteArrayInputStream</span></span><span style="color: #990000">(</span>signature<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toByteArray</span></span><span style="color: #990000">());</span>
      <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">X509Certificate</span> cert <span style="color: #990000">=</span> <span style="color: #990000">(</span>X509Certificate<span style="color: #990000">)</span> certificateFactory<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">generateCertificate</span></span><span style="color: #990000">(</span>input<span style="color: #990000">);</span>
        cert<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkValidity</span></span><span style="color: #990000">();</span>
        cert<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">verify</span></span><span style="color: #990000">(</span>trustedIssuerPublicKey<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cert<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getIssuerDN</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getName</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"CN=Some One,O=Bad,C=US"</span><span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
          <span style="font-style: italic"><span style="color: #9A1900">// found malware!</span></span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">CertificateException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// found malware!</span></span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
Listen for <tt>android.intent.action.PACKAGE_ADDED</tt> broadcasts and verify new/updated apps:
</p>
<div class="listingblock">
<div class="title"><tt>AndroidManifest.xml</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  …
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> … <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    …
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;receiver</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".ApplicationInstallReceiver"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.action.PACKAGE_ADDED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.action.PACKAGE_REPLACED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;data</span></span> <span style="color: #009900">android:scheme</span><span style="color: #990000">=</span><span style="color: #FF0000">"package"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/receiver&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>ApplicationInstallReceiver.java</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">ApplicationInstallReceiver</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> BroadcastReceiver <span style="color: #FF0000">{</span>
  @Override
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onReceive</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">Uri</span> packageUri <span style="color: #990000">=</span> intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getData</span></span><span style="color: #990000">();</span>
    <span style="color: #008080">String</span> packageName <span style="color: #990000">=</span> packageUri<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getEncodedSchemeSpecificPart</span></span><span style="color: #990000">();</span>
    <span style="color: #009900">int</span> flags <span style="color: #990000">=</span> PackageManager<span style="color: #990000">.</span>GET_PERMISSIONS <span style="color: #990000">|</span> PackageManager<span style="color: #990000">.</span>GET_SIGNATURES<span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
      <span style="color: #008080">PackageInfo</span> packageInfo <span style="color: #990000">=</span>
        context<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getPackageManager</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getPackageInfo</span></span><span style="color: #990000">(</span>packageName<span style="color: #990000">,</span> flags<span style="color: #990000">);</span>
      <span style="font-style: italic"><span style="color: #9A1900">// verify packageInfo</span></span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">NameNotFoundException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">// handle</span></span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Once a malicious app is found, offer the user a chance to delete it
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">Uri</span> packageURI <span style="color: #990000">=</span> Uri<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"package:com.malicous.app"</span><span style="color: #990000">);</span>
<span style="color: #008080">Intent</span> uninstallIntent <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>Intent<span style="color: #990000">.</span>ACTION_DELETE<span style="color: #990000">,</span> packageURI<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">startActivity</span></span><span style="color: #990000">(</span>uninstallIntent<span style="color: #990000">);</span></tt></pre></div></div>
</li>
<li>
<p>
Sample source-code available at <a href="http://marakana.com/static/courseware/android/AntiMalware.zip">http://marakana.com/static/courseware/android/AntiMalware.zip</a>
</p>
</li>
<li>
<p>
Some of the popular apps include
</p>
<div class="ulist"><ul>
<li>
<p>
Norton Mobile Security
</p>
</li>
<li>
<p>
Lookout Mobile Security
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_se_android_se_linux_on_android">5.21. SE Android (SE-Linux on Android)</h3>
<div class="ulist"><ul>
<li>
<p>
Discretionary Access Control (DAC) vs. Mandatory Access Control (MAC)
</p>
</li>
<li>
<p>
DAC on Android
</p>
<div class="ulist"><ul>
<li>
<p>
Default form of access control (also true for most Linux systems)
</p>
</li>
<li>
<p>
Access to data is controlled by the app developers
</p>
<div class="ulist"><ul>
<li>
<p>
Except for root
</p>
</li>
</ul></div>
</li>
<li>
<p>
Based on user/group identity associated with each app and its data
</p>
</li>
<li>
<p>
Coarse-grained decentralized control
</p>
<div class="ulist"><ul>
<li>
<p>
No easy way to establish a system-wide policy
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
MAC with SE-Linux
</p>
<div class="ulist"><ul>
<li>
<p>
System-wide security policy applies to all processes, data, and system operations
</p>
</li>
<li>
<p>
Based on security labels
</p>
</li>
<li>
<p>
Confines flawed/malicious apps as well as system processes (including those that run as root!)
</p>
<div class="ulist"><ul>
<li>
<p>
Prevent privilege escalation
</p>
</li>
</ul></div>
</li>
<li>
<p>
Centralized/manageable device-wide policy
</p>
</li>
</ul></div>
</li>
<li>
<p>
See <a href="http://selinuxproject.org/page/SEAndroid">SEAndroid website</a> on how to build it
</p>
</li>
<li>
<p>
From Stephen Smalley&#8217;s <a href="https://events.linuxfoundation.org/images/stories/pdf/lf_abs12_smalley.pdf">"The Case for Security Enhanced (SE) Android"</a>:
</p>
</li>
<li>
<p>
SE Android brings MAC to Android and has the following goals:
</p>
<div class="ulist"><ul>
<li>
<p>
Prevent privilege escalation by apps
</p>
</li>
<li>
<p>
Prevent data leakage by apps
</p>
</li>
<li>
<p>
Prevent bypass of security features
</p>
</li>
<li>
<p>
Enforce legal restrictions on data
</p>
</li>
<li>
<p>
Protect integrity of apps and data
</p>
</li>
<li>
<p>
Targeted at consumers, businesses, and government
</p>
</li>
</ul></div>
</li>
<li>
<p>
What SE Android <em>can</em> help with:
</p>
<div class="ulist"><ul>
<li>
<p>
Confine privileged daemons
</p>
<div class="ulist"><ul>
<li>
<p>
Protect from misuse
</p>
</li>
<li>
<p>
Limit the damage that can be done via them
</p>
</li>
</ul></div>
</li>
<li>
<p>
Sandbox and isolate apps
</p>
<div class="ulist"><ul>
<li>
<p>
Strongly separate apps from one another
</p>
</li>
<li>
<p>
Prevent privilege escalation by apps
</p>
</li>
</ul></div>
</li>
<li>
<p>
Provide centralized, analyzable policy
</p>
</li>
</ul></div>
</li>
<li>
<p>
What SE Android <em>can no</em> help with:
</p>
<div class="ulist"><ul>
<li>
<p>
Kernel vulnerabilities (in general)
</p>
<div class="ulist"><ul>
<li>
<p>
May block exploitation of specific vulnerabilities
</p>
</li>
</ul></div>
</li>
<li>
<p>
Anything allowed by security policy
</p>
<div class="ulist"><ul>
<li>
<p>
Good policy is important
</p>
</li>
<li>
<p>
Architecture of system applications matters
</p>
<div class="ulist"><ul>
<li>
<p>
Decomposition, least privilege
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Challenges
</p>
<div class="ulist"><ul>
<li>
<p>
Kernel
</p>
<div class="ulist"><ul>
<li>
<p>
No support for per-file security labeling (yaffs2)
</p>
</li>
<li>
<p>
Unique kernel subsystems lack SELinux support
</p>
</li>
</ul></div>
</li>
<li>
<p>
Userspace
</p>
<div class="ulist"><ul>
<li>
<p>
No existing SELinux support
</p>
</li>
<li>
<p>
Sharing through framework services
</p>
</li>
</ul></div>
</li>
<li>
<p>
Policy
</p>
<div class="ulist"><ul>
<li>
<p>
Existing policies unsuited to Android
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_other_security_concerns">5.22. Other Security Concerns</h3>
<div class="ulist"><ul>
<li>
<p>
Unintentional app vulnerabilities
</p>
<div class="ulist"><ul>
<li>
<p>
For example (CVE-2011-1717) "Skype for Android stored sensitive user data without encryption in sqlite3 databases that have weak permissions, which allows local applications to read user IDs, contacts, phone numbers, date of birth, instant message logs, and other private information."
</p>
</li>
</ul></div>
</li>
<li>
<p>
Push-based installation of apps from Market (based on the Google account)
</p>
<div class="ulist"><ul>
<li>
<p>
If the Google account associated with the device is compromised, malicious applications could be pushed directly to affected owner&#8217;s devices
</p>
</li>
</ul></div>
</li>
<li>
<p>
Social-engineering vectors of attack
</p>
<div class="ulist"><ul>
<li>
<p>
Lack of the developer-user trust model
</p>
</li>
<li>
<p>
Reactive vs preventative security of Market-installed apps
</p>
</li>
</ul></div>
</li>
<li>
<p>
Firewall
</p>
<div class="ulist"><ul>
<li>
<p>
Android uses all-or-nothing access to networking
</p>
<div class="ulist"><ul>
<li>
<p>
Requested via the INTERNET permission, mapped to <tt>inet</tt> group, enforced via <tt>ANDROID_PARANOID_NETWORK</tt> kernel extension
</p>
</li>
<li>
<p>
<tt>iptables</tt> is available, but not exposed to the user
</p>
</li>
<li>
<p>
No easy way to setup a firewall policy controlling/limiting access to network resources
</p>
</li>
</ul></div>
</li>
<li>
<p>
WhisperMonitor is a 3rd party custom ROM that tries to address this shortcoming, providing a full-fledged application firewall manageable by the end user
</p>
</li>
</ul></div>
</li>
<li>
<p>
Encryption of communication
</p>
<div class="ulist"><ul>
<li>
<p>
Whisper Systems' RedPhone application uses ZRTP-encrypted SMS messages to establish calls over a VOIP connection (hidden behind an alternative dialer)
</p>
<div class="ulist"><ul>
<li>
<p>
ZRTP was designed by PGP inventor Phillip Zimmerman
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Rogue applications signed using platform keys (targeting custom ROMs): jSMSHider
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://blog.mylookout.com/2011/06/security-alert-malware-found-targeting-custom-roms-jsmshider/">http://blog.mylookout.com/2011/06/security-alert-malware-found-targeting-custom-roms-jsmshider/</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
App obfuscation
</p>
<div class="ulist"><ul>
<li>
<p>
Proguard
</p>
</li>
</ul></div>
</li>
<li>
<p>
Recovery mode
</p>
<div class="ulist"><ul>
<li>
<p>
State of the device while in the recovery mode
</p>
</li>
</ul></div>
</li>
<li>
<p>
Controlling access to private content with a privacy manager
</p>
<div class="ulist"><ul>
<li>
<p>
North Carolina State University&#8217;s TISSA (Taming Information-Stealing Smartphone Applications) privacy manager controls access to user&#8217;s private data (Location, Phone Identity, Contacts, and Call Log)
</p>
<div class="ulist"><ul>
<li>
<p>
On an app-by-app basis, users decide how their data is shared: Trusted (unlimited), Bogus (false), Anonymized (filtered), or Empty (pretend that there is no data)
</p>
</li>
<li>
<p>
<a href="http://mobile.engadget.com/2011/04/19/ncsu-teases-tissa-for-android-a-security-manager-that-keeps-per/">http://mobile.engadget.com/2011/04/19/ncsu-teases-tissa-for-android-a-security-manager-that-keeps-per/</a>
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
Security issues with device skins (e.g. HTC Sense): "Security hole in HTC phones gives up e-mail addresses, location"
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://arstechnica.com/gadgets/news/2011/10/security-hole-in-htc-phones-gives-up-e-mail-addresses-location.ars">http://arstechnica.com/gadgets/news/2011/10/security-hole-in-htc-phones-gives-up-e-mail-addresses-location.ars</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Dual-mode phones (work and pleasure) - e.g. AT&amp;T Toggle (a.k.a. Enterproid Divide)
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.technologyreview.com/communications/38865/?p1=A1">http://www.technologyreview.com/communications/38865/?p1=A1</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Non-market installations
</p>
<div class="ulist"><ul>
<li>
<p>
Server-side polymorphism to generate unique variants and avoid detection by anti-malware
</p>
</li>
<li>
<p>
<a href="http://www.infoworld.com/d/security/symantec-warns-of-android-trojans-mutate-every-download-185664?source=fssr">http://www.infoworld.com/d/security/symantec-warns-of-android-trojans-mutate-every-download-185664?source=fssr</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Google Bouncer
</p>
<div class="ulist"><ul>
<li>
<p>
Upon application upload to Market, Google Bouncer scans it for known malware, spyware and trojans
</p>
</li>
<li>
<p>
Application is then run in a simulated environment (inside Google&#8217;s cloud) and tested for hidden and malicious behavior (comparing it to previously analyzed apps)
</p>
</li>
<li>
<p>
New developer accounts are checked against previously known offenders
</p>
</li>
<li>
<p>
Already-installed malicious apps can be automatically removed (remote kill-switch)
</p>
</li>
<li>
<p>
<a href="http://googlemobile.blogspot.com/2012/02/android-and-security.html">http://googlemobile.blogspot.com/2012/02/android-and-security.html</a>
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Android_Building_From_Source">6. Building Android From Source</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_why_build_android_from_source">6.1. Why Build Android From Source?</h3>
<div class="ulist"><ul>
<li>
<p>
To understand how Android works
</p>
</li>
<li>
<p>
Build custom ROMs
</p>
<div class="ulist"><ul>
<li>
<p>
Enable custom services - beyond what&#8217;s possible with APKs along
</p>
</li>
<li>
<p>
Support custom hardware
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_setting_up_the_build_environment">6.2. Setting up the Build Environment</h3>
<div class="ulist"><ul>
<li>
<p>
Before we can download and build Android from source, we need to setup our build environment
</p>
</li>
<li>
<p>
Requirements:
</p>
<div class="ulist"><ul>
<li>
<p>
Linux (specifically Ubuntu 10.04 or later) and Mac OS X are officially supported
</p>
<div class="ulist"><ul>
<li>
<p>
Windows is explicitly not supported
</p>
</li>
</ul></div>
</li>
<li>
<p>
Approximately 30GB of disk space (11GB for sources and 20GB for a complete build)
</p>
</li>
<li>
<p>
A case-sensitive file-system
</p>
<div class="ulist"><ul>
<li>
<p>
Most Unix/Linux-based file systems are already case-sensitive
</p>
</li>
<li>
<p>
Mac OS Extended (HFS+) file system is case-insensitive by default - we need to create "case sensitive, journaled" volume (e.g. via "Disk Utility")
</p>
</li>
</ul></div>
</li>
<li>
<p>
Python 2.4&#8201;&#8212;&#8201;2.7
</p>
</li>
<li>
<p>
Java Development Kit (official Sun/Oracle release is recommended)
</p>
<div class="ulist"><ul>
<li>
<p>
JDK 5 for &#8656; Froyo
</p>
</li>
<li>
<p>
JDK 6 for &gt;= Gingerbread
</p>
</li>
</ul></div>
</li>
<li>
<p>
Git 1.5.4 or newer
</p>
</li>
<li>
<p>
Build tools and libraries: flex, bison, gcc, make, zlib, libc-dev, ncurses, 32-bit dev libs, etc.
</p>
</li>
<li>
<p>
See <a href="http://source.android.com/source/initializing.html">http://source.android.com/source/initializing.html</a> for the easy copy+paste installation instructions for the required binaries and how to configure USB access (on Linux)
</p>
</li>
</ul></div>
</li>
<li>
<p>
We also need to increase our open file limits (<tt>ulimit -n</tt> on Ubuntu defaults to 1024) to 8192:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Add the following to:
</p>
<div class="listingblock">
<div class="title"><tt>/etc/security/limits.conf</tt>:</div>
<div class="content">
<pre><tt>…
*       soft    nofile  8192
*       hard    nofile  8192</tt></pre>
</div></div>
</li>
<li>
<p>
Reboot
</p>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_downloading_the_source_tree">6.3. Downloading the Source Tree</h3>
<div class="ulist"><ul>
<li>
<p>
First we need to get <tt>repo</tt>, a simple tool that makes it easier to work with Git in the context of Android
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir ~/bin
$ export PATH=~/bin:$PATH
$ curl https://dl-ssl.google.com/dl/googlesource/git-repo/repo &gt; ~/bin/repo
$ chmod a+x ~/bin/repo</tt></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
For more info on <tt>repo</tt>, see <a href="http://source.android.com/source/version-control.html">http://source.android.com/source/version-control.html</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
The next step is to set up a local working directory (on a case-sensitive file-system)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir android-src
$ cd android-src</tt></pre>
</div></div>
</li>
<li>
<p>
Next, we <tt>repo init</tt> to update repo itself as well as specify where we are going to download the sources from (including the particular version/branch)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ repo init -u https://android.googlesource.com/platform/manifest.git -b gingerbread</tt></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Here, <tt>gingerbread</tt> points to a particular branch - i.e. Android 2.3.7
</p>
</li>
<li>
<p>
For the complete list of available branches (e.g. "donut", "eclair", "froyo", "gingerbread", etc.), see "heads" under <a href="http://android.googlesource.com/?p=platform/manifest.git;a=summary">http://android.googlesource.com/?p=platform/manifest.git;a=summary</a>
</p>
</li>
<li>
<p>
For more info on codenames, tags, and build numbers see <a href="http://source.android.com/source/build-numbers.html">http://source.android.com/source/build-numbers.html</a>
</p>
</li>
<li>
<p>
To understand Android Branches and Releases (i.e. code-lines), see <a href="http://source.android.com/source/code-lines.html">http://source.android.com/source/code-lines.html</a>
</p>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Official Android repository <tt>android.googlesource.com</tt> is not the only game in town.<br />
For example, to get Android sources for TI&#8217;s SOCs, we would:<br />
<tt>repo init -u git://gitorious.org/rowboat/manifest.git -m TI-Android-FroYo-DevKit-V2.2.xml</tt> for OMAP3 and<br />
<tt>repo init -u git://gitorious.org/rowboat/manifest.git -m TI-Android-FroYo-DSP-DevKit-V2.xml</tt> for DM37x EVM<br />
(the <tt>.xml</tt> files come from TI) to check out Froyo build optimized for their hardware.</td>
</tr></table>
</div>
</li>
</ul></div>
</li>
<li>
<p>
The final step is to pull the actual files from the repository (11.7GB download for ICS)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ repo sync</tt></pre>
</div></div>
</li>
<li>
<p>
See <a href="http://source.android.com/source/downloading.html">http://source.android.com/source/downloading.html</a> for more details on getting Android sources
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="Android_Source_Code_Structure">6.4. Android Source Code Structure</h3>
<div class="ulist"><ul>
<li>
<p>
<tt>bionic/</tt> - the home of the Bionic (libc) library
</p>
</li>
<li>
<p>
<tt>bootable/</tt> - the home of Android&#8217;s bootloader, diskinstaller, and recovery image support
</p>
</li>
<li>
<p>
<tt>build/</tt> - the home of the Android build system
</p>
</li>
<li>
<p>
<tt>cts/</tt> - Android&#8217;s Compatibility Test Suite
</p>
<div class="ulist"><ul>
<li>
<p>
See <a href="http://source.android.com/compatibility/cts-intro.html">http://source.android.com/compatibility/cts-intro.html</a> for more info.
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>dalvik/</tt> - the home of the Dalvik VM
</p>
</li>
<li>
<p>
<tt>development/</tt> - development tools, configuration files and sample apps
</p>
</li>
<li>
<p>
<tt>device/</tt> - device-specific binaries (like kernel and device drivers) and source
</p>
<div class="ulist"><ul>
<li>
<p>
Gingerbread tree supports HTC Nexus One and Samsung Nexus S
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>external/</tt> - 3rd party libraries (mostly native, but also Java), which are synced from their own repositories
</p>
</li>
<li>
<p>
<tt>frameworks/</tt> - Android-specific native utilities (e.g. <tt>app_process</tt>, <tt>bootanimation</tt>, etc.), daemons (e.g. <tt>installd</tt>, <tt>servicemanager</tt>, <tt>system_server</tt>), and libraries (including JNI wrappers and HAL support), as well as Java APIs (i.e. all of <tt>android.*</tt>) and services (all all Application Framework support)
</p>
</li>
<li>
<p>
<tt>hardware/</tt> - hardware-abstraction-layer (HAL) definitions (<tt>libhardware</tt> and <tt>libhardware_legacy</tt>) and some device-specific implementations (e.g. msm7k&#8217;s <tt>libaudio.so</tt> and TI OMAP3&#8217;s <tt>libstagefrighthw.so</tt>) both in source code and binaries
</p>
</li>
<li>
<p>
<tt>libcore/</tt> - Apache Harmony (see <tt>libcore/luni/src/main/java/</tt>) as well as test/support libraries
</p>
</li>
<li>
<p>
<tt>ndk/</tt> - the home of NDK
</p>
</li>
<li>
<p>
<tt>out/</tt> - the location where binaries built by <tt>make</tt> go
</p>
</li>
<li>
<p>
<tt>packages/</tt> - the home of the built-in applications (e.g. Phone, Browser, Gallery, etc), content providers (e.g. Contact Provider, Media Provider, etc.), wall papers (including live wall papers), input methods (e.g. LatinIME), etc.
</p>
</li>
<li>
<p>
<tt>prebuilt/</tt> - pre-built kernels (mostly for QEMU) as well as other binaries (mostly 3rd party development tools)
</p>
</li>
<li>
<p>
<tt>sdk/</tt> - the home of Android SDK tools (<tt>ddms</tt>, <tt>traceview</tt>, <tt>ninepatch</tt>, etc.)
</p>
</li>
<li>
<p>
<tt>system/</tt> - the home of the Android root file system, configuration files, <tt>init</tt> and <tt>init.rc</tt>, as well as some of the native daemons
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="Android_Build_System">6.5. Android Build System</h3>
<div class="ulist"><ul>
<li>
<p>
Android&#8217;s build system is based on <em>make</em>
</p>
</li>
<li>
<p>
Android OS is a collection of modules (executables, libraries, applications, etc.) - each with its own unique makefile (<tt>Android.mk</tt>)
</p>
</li>
<li>
<p>
The build system was designed around some specific objectives:
</p>
<div class="ulist"><ul>
<li>
<p>
Allows building for multiple targets (emulator, various devices) and on multiple hosts (Linux and MacOS X)
</p>
</li>
<li>
<p>
Uses make non-recursively - helps avoid slow/unpredictable build times
</p>
<div class="ulist"><ul>
<li>
<p>
The build system still allows makefiles from sub-directories (one level) to be included via <tt>include $(call all-subdir-makefiles)</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Allows selective (individual component) builds - to speed up compile-test cycles
</p>
</li>
<li>
<p>
Enables configuration via environment settings as well as configuration files - makes the build system more flexible
</p>
</li>
<li>
<p>
Separates built binaries from the source files - enables fast cleans
</p>
</li>
<li>
<p>
Enables automatic dependency resolution - so no need for explicit dependancies in makefiles
</p>
</li>
<li>
<p>
Enables hiding of command lines - so the output of the build is not too verbose
</p>
</li>
<li>
<p>
Enables multiple targets in one directory - allows for modules to be more compact
</p>
</li>
</ul></div>
</li>
<li>
<p>
Porting existing autoconf-based (libtool-ized) projects to Android&#8217;s build system can be simplified by <a href="http://cgit.collabora.com/git/user/derek/androgenizer.git">http://cgit.collabora.com/git/user/derek/androgenizer.git</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_initializing_the_build_environment">6.6. Initializing the Build Environment</h3>
<div class="ulist"><ul>
<li>
<p>
Before we can run the actual build, we need to initialize the build environment by sourcing <tt>build/envsetup.sh</tt> into our shell
</p>
</li>
<li>
<p>
Running this command adds special functions to our shell: <tt>help</tt>, <tt>croot</tt>, <tt>m</tt>, <tt>mm</tt>, <tt>mmm</tt>, <tt>cgrep</tt>, <tt>jgrep</tt>, <tt>resgrep</tt>, <tt>godir</tt>, <tt>lunch</tt>, etc. - as these are used later for the actual build
</p>
</li>
<li>
<p>
Finally, this script also includes vendor/device-specific functions as well (which are used to register targets to build)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ source build/envsetup.sh
$ help
Invoke ". build/envsetup.sh" from your shell to add the following functions to your environment:
- croot:   Changes directory to the top of the tree.
- m:       Makes from the top of the tree.
- mm:      Builds all of the modules in the current directory.
- mmm:     Builds all of the modules in the supplied directories.
- cgrep:   Greps on all local C/C++ files.
- jgrep:   Greps on all local Java files.
- resgrep: Greps on all local res/*.xml files.
- godir:   Go to the directory containing a file.

Look at the source to view more functions. The complete list is:
add_lunch_combo cgrep check_product check_variant choosecombo chooseproduct choosetype choosevariant cproj croot
findmakefile gdbclient get_abs_build_var get_build_var getbugreports getprebuilt gettop godir help isviewserverstarted
jgrep lunch m mm mmm pid print_lunch_menu printconfig resgrep runhat runtest set_java_home set_sequence_number
set_stuff_for_environment setpaths settitle smoketest startviewserver stopviewserver systemstack tapas tracedmdump</tt></pre>
</div></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_choosing_the_build_target">6.7. Choosing the Build Target</h3>
<div class="ulist"><ul>
<li>
<p>
Next, we choose our <em>target</em> using the <tt>lunch</tt> command (actually, it&#8217;s one of the functions added by <tt>build/envsetup.sh</tt> to our shell)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ lunch

You're building on linux

Lunch menu... pick a combo:
     1. generic-eng
     2. full_passion-userdebug
     3. full_crespo-userdebug
     4. full_crespo4g-userdebug

Which would you like? [generic-eng]

============================================
PLATFORM_VERSION_CODENAME=REL
PLATFORM_VERSION=2.3.4
TARGET_PRODUCT=generic
TARGET_BUILD_VARIANT=eng
TARGET_SIMULATOR=false
TARGET_BUILD_TYPE=release
TARGET_BUILD_APPS=
TARGET_ARCH=arm
HOST_ARCH=x86
HOST_OS=linux
HOST_BUILD_TYPE=release
BUILD_ID=GINGERBREAD
============================================</tt></pre>
</div></div>
</li>
<li>
<p>
We could also run <tt>lunch 1</tt> to choose the first target or we can explicitly specify a particular target as <tt>lunch generic-eng</tt>
</p>
</li>
<li>
<p>
We could also use <tt>choosecombo</tt> command, which internally uses <tt>chooseproduct</tt>, <tt>choosetype</tt>, and, <tt>choosevariant</tt> to prompt us for product, type, and variant separately
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ choosecombo
Only device builds are supported for linux
     Forcing TARGET_SIMULATOR=false

Press enter:



Build type choices are:
     1. release
     2. debug

Which would you like? [1]

Which product would you like? [generic]


Variant choices are:
     1. user
     2. userdebug
     3. eng
Which would you like? [eng]

============================================
PLATFORM_VERSION_CODENAME=REL
PLATFORM_VERSION=2.3.4
TARGET_PRODUCT=generic
TARGET_BUILD_VARIANT=eng
TARGET_SIMULATOR=false
TARGET_BUILD_TYPE=release
TARGET_BUILD_APPS=
TARGET_ARCH=arm
HOST_ARCH=x86
HOST_OS=linux
HOST_BUILD_TYPE=release
BUILD_ID=GINGERBREAD
============================================</tt></pre>
</div></div>
</li>
<li>
<p>
Either way, the result of <tt>lunch</tt> or <tt>choosecombo</tt> sets up the environmental variables which the build system reads to know what to build
</p>
<div class="ulist"><ul>
<li>
<p>
These environmental variables can also be printed using <tt>printconfig</tt> command
</p>
</li>
</ul></div>
</li>
<li>
<p>
Targets take the form of <em>CodeName</em>-<em>BuildType</em>
</p>
<div class="ulist"><ul>
<li>
<p>
<em>CodeName</em> is mapped to a specific device as follows
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>passion</tt> - HTC Nexus One
</p>
</li>
<li>
<p>
<tt>crespo</tt> - Samsung Nexus S
</p>
</li>
<li>
<p>
<tt>crespo4g</tt> - Samsung Nexus S 4G
</p>
</li>
<li>
<p>
<tt>generic</tt> - QEMU Emulator
</p>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Building AOSP on Linux-x86 also supported a <tt>simulator</tt> target, which was a partial build of Android, compiled as a single Linux x86 binary, meant to run as a stand-alone process. It would enable testing Dalvik, OpenCORE/Stagefright, or WebKit under Valgrind (instrumentation/debugging framework). But <tt>simulator</tt> has been dropped as a valid lunch target since it&#8217;s no longer actively maintained by the AOSP team.</td>
</tr></table>
</div>
</li>
</ul></div>
</li>
<li>
<p>
<em>BuildType</em> specifies the intended use (security restrictions)
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>user</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Intended to be the final release
</p>
</li>
<li>
<p>
Installs modules tagged as <tt>user</tt>
</p>
</li>
<li>
<p>
Installs non-APK modules that have no tags specified
</p>
</li>
<li>
<p>
Installs APKs according to the product definition files (tags are ignored for APK modules)
</p>
</li>
<li>
<p>
Sets <tt>ro.secure=1</tt>
</p>
</li>
<li>
<p>
Sets <tt>ro.debuggable=0</tt>
</p>
</li>
<li>
<p>
<tt>adbd</tt> is disabled by default (i.e. has to be enabled via Settings &#8594; Applications &#8594; Development &#8594; USB Debugging)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>userdebug</tt> - the same as <tt>user</tt>, except:
</p>
<div class="ulist"><ul>
<li>
<p>
Intended for limited debugging
</p>
</li>
<li>
<p>
Installs modules tagged with <tt>debug</tt>
</p>
</li>
<li>
<p>
Sets <tt>ro.debuggable=1</tt>
</p>
</li>
<li>
<p>
<tt>adbd</tt> is enabled by default
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>eng</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
Intended for platform-level debugging
</p>
</li>
<li>
<p>
Installs modules tagged with: <tt>eng</tt>, <tt>debug</tt>, <tt>user</tt>, and/or <tt>development</tt>
</p>
</li>
<li>
<p>
Installs non-APK modules that have no tags specified
</p>
</li>
<li>
<p>
Installs APKs according to the product definition files, in addition to tagged APKs
</p>
</li>
<li>
<p>
Sets <tt>ro.secure=0</tt>
</p>
</li>
<li>
<p>
Sets <tt>ro.debuggable=1</tt>
</p>
</li>
<li>
<p>
Sets <tt>ro.kernel.android.checkjni=1</tt>
</p>
</li>
<li>
<p>
<tt>adbd</tt> is enabled by default
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Additional <em>CodeName</em>-<em>BuildType</em> combinations may be available based on what <tt>build/envsetup.sh</tt> finds (usually in the <tt>device/</tt> folder)</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Building for real hardware usually requires that we get proprietary binaries (mostly user-space HAL). For Nexus and other Google-supported devices, we can go to <a href="http://code.google.com/android/nexus/drivers.html">http://code.google.com/android/nexus/drivers.html</a>, which allows us to download scripts, which in turn extract binaries from the connected devices (via <tt>adb pull</tt>) into <tt>vendor/</tt> directory tree structure.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_compiling_android">6.8. Compiling Android</h3>
<div class="ulist"><ul>
<li>
<p>
Before the actual compile, it is useful to setup ccache - a compiler cache that can be used to speed-up rebuilds
</p>
<div class="ulist"><ul>
<li>
<p>
Add the following to your shell&#8217;s startup-script (e.g. <tt>.bashrc</tt>) and/or run from the command line:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ export USE_CCACHE=1</tt></pre>
</div></div>
</li>
<li>
<p>
The max-disk usage for ccache defaults to about 1GB, so to change it (assuming you have enough space) run the following from command line (assuming <tt>linux-x86</tt> as your host):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ prebuilt/linux-x86/ccache/ccache -M 50G</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
We can build the entire code-base with GNU&#8217;s <tt>make</tt> command (note that this can take 20-120 mins)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j4</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">GNU Make supports <tt>-jN</tt> argument, which allows us to parallelize compilation across multiple hardware threads. Typically, <tt>N</tt> should be set to the number of hardware threads available on the host machine plus two. For example, use <tt>make -j10</tt> to build on a quad-core i7 with two hardware threads per core (i.e. hyperthreaded).</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">Use <tt>-jN</tt> with caution, because you may run into memory, disk I/O, or max open-file limits.</td>
</tr></table>
</div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_makefile_targets">6.8.1. Makefile targets</h4>
<div class="ulist"><ul>
<li>
<p>
In addition to the default <tt>all</tt> target, Android&#8217;s <tt>Makefile</tt> (actually <tt>build/core/main.mk</tt>) supports additional targets
</p>
</li>
<li>
<p>
<tt>make sdk</tt> - build the tools that are part of Android SDK (<tt>adb</tt>, <tt>fastboot</tt>, etc.)
</p>
</li>
<li>
<p>
<tt>make snod</tt> - build the system image from the current software binaries
</p>
</li>
<li>
<p>
<tt>make services</tt>
</p>
</li>
<li>
<p>
<tt>make runtime</tt>
</p>
</li>
<li>
<p>
<tt>make droid</tt> - make droid is the normal build
</p>
</li>
<li>
<p>
<tt>make all</tt> - make everything, whether it is included in the product definition or not
</p>
</li>
<li>
<p>
<tt>make clean</tt> - remove all built files (prepare for a new build). Same as rm -rf out/&lt;configuration&gt;/
</p>
</li>
<li>
<p>
<tt>make clobber</tt>
</p>
</li>
<li>
<p>
<tt>make dataclean</tt>
</p>
</li>
<li>
<p>
<tt>make installclean</tt>
</p>
</li>
<li>
<p>
<tt>make modules</tt> - shows a list of submodules that can be built (List of all LOCAL_MODULE definitions)
</p>
</li>
<li>
<p>
<tt>make &lt;local_module&gt;</tt> - make a specific module (note that this is not the same as directory name. It is the LOCAL_MODULE * definition in the Android.mk file)
</p>
</li>
<li>
<p>
<tt>make clean-&lt;local_module&gt;</tt> - clean a specific module
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_examining_the_built_images">6.9. Examining the Built Images</h3>
<div class="ulist"><ul>
<li>
<p>
Upon successful <tt>generic</tt> (emulator) build, the <tt>make</tt> command will create the following images
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>out/target/product/generic/ramdisk.img</tt> - the temporary root file system used during the booting process to setup our mount points and support the <tt>init</tt> process
</p>
</li>
<li>
<p>
<tt>out/target/product/generic/system.img</tt> - this <tt>/system</tt> image with
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/system/bin</tt> - system binaries (including various daemons started by <tt>init</tt> via <tt>init.rc</tt>)
</p>
</li>
<li>
<p>
<tt>/system/xbin</tt> - debugging/profiling binaries
</p>
</li>
<li>
<p>
<tt>/system/usr</tt> - mostly configuration/mapping files (e.g. keylayouts)
</p>
</li>
<li>
<p>
<tt>/system//etc</tt> - configuration files (e.g. permissions, library mappings, networking/DHCP, etc.)
</p>
</li>
<li>
<p>
<tt>/system/lib</tt> - system/framework native libraries (including support for user-space HAL)
</p>
</li>
<li>
<p>
<tt>/system/framework</tt> - system/framework Dalvik libraries (in dex bytecode format but in <tt>.jar</tt> files)
</p>
</li>
<li>
<p>
<tt>/system/app</tt> - built-in system apps (including content providers, input providers, etc.)
</p>
</li>
<li>
<p>
<tt>/system/fonts</tt> - built-in system fonts
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>out/target/product/generic/userdata.img</tt> - the contents of the <tt>/data</tt> partition (empty)
</p>
</li>
<li>
<p>
Since the emulator is based on QEMU, it uses its own built-in <tt>/boot</tt> partition with a pre-compiled kernel on it
</p>
</li>
</ul></div>
</li>
<li>
<p>
Upon successful <tt>full_crespo-userdebug</tt> build (i.e. device-specific), the <tt>make</tt> command will create the following images
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>out/target/product/crespo/boot.img</tt> - a custom Android "filesystem" consisting of a 2KB header, followed by a gzipped kernel, followed by a ramdisk, followed by an optional second stage loader (not typically used)
</p>
<div class="ulist"><ul>
<li>
<p>
This image (as well as <tt>recovery.img</tt>) is created using Android&#8217;s <tt>out/host/&lt;arch&gt;/bin/mkbootimg</tt> command, and produces a file of the following structure:
</p>
<div class="listingblock">
<div class="title"><a href="http://android.git.kernel.org/?p=platform/system/core.git;a=blob;f=mkbootimg/bootimg.h">http://android.git.kernel.org/?p=platform/system/core.git;a=blob;f=mkbootimg/bootimg.h</a></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">52</span> <span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<span style="font-style: italic"><span style="color: #9A1900">53 ** +-----------------+</span></span>
<span style="font-style: italic"><span style="color: #9A1900">54 ** | boot header     | 1 page</span></span>
<span style="font-style: italic"><span style="color: #9A1900">55 ** +-----------------+</span></span>
<span style="font-style: italic"><span style="color: #9A1900">56 ** | kernel          | n pages</span></span>
<span style="font-style: italic"><span style="color: #9A1900">57 ** +-----------------+</span></span>
<span style="font-style: italic"><span style="color: #9A1900">58 ** | ramdisk         | m pages</span></span>
<span style="font-style: italic"><span style="color: #9A1900">59 ** +-----------------+</span></span>
<span style="font-style: italic"><span style="color: #9A1900">60 ** | second stage    | o pages</span></span>
<span style="font-style: italic"><span style="color: #9A1900">61 ** +-----------------+</span></span>
<span style="font-style: italic"><span style="color: #9A1900">62 **</span></span>
<span style="font-style: italic"><span style="color: #9A1900">63 ** n = (kernel_size + page_size - 1) / page_size</span></span>
<span style="font-style: italic"><span style="color: #9A1900">64 ** m = (ramdisk_size + page_size - 1) / page_size</span></span>
<span style="font-style: italic"><span style="color: #9A1900">65 ** o = (second_size + page_size - 1) / page_size</span></span>
<span style="font-style: italic"><span style="color: #9A1900">66 **</span></span>
<span style="font-style: italic"><span style="color: #9A1900">67 ** 0. all entities are page_size aligned in flash</span></span>
<span style="font-style: italic"><span style="color: #9A1900">68 ** 1. kernel and ramdisk are required (size != 0)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">69 ** 2. second is optional (second_size == 0 -&gt; no second)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">70 ** 3. load each element (kernel, ramdisk, second) at</span></span>
<span style="font-style: italic"><span style="color: #9A1900">71 **    the specified physical address (kernel_addr, etc)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">72 ** 4. prepare tags at tag_addr.  kernel_args[] is</span></span>
<span style="font-style: italic"><span style="color: #9A1900">73 **    appended to the kernel commandline in the tags.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">74 ** 5. r0 = 0, r1 = MACHINE_TYPE, r2 = tags_addr</span></span>
<span style="font-style: italic"><span style="color: #9A1900">75 ** 6. if second_size != 0: jump to second_addr</span></span>
<span style="font-style: italic"><span style="color: #9A1900">76 **    else: jump to kernel_addr</span></span>
<span style="font-style: italic"><span style="color: #9A1900">77 */</span></span></tt></pre></div></div>
</li>
</ul></div>
</li>
<li>
<p>
<tt>out/target/product/crespo/ramdisk.img</tt> - see above (included in <tt>boot.img</tt>)
</p>
<div class="ulist"><ul>
<li>
<p>
For more info on ramdisk, see <a href="http://android.git.kernel.org/?p=kernel/common.git;a=blob;f=Documentation/filesystems/ramfs-rootfs-initramfs.txt">http://android.git.kernel.org/?p=kernel/common.git;a=blob;f=Documentation/filesystems/ramfs-rootfs-initramfs.txt</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>out/target/product/crespo/system.img</tt> - similar to <tt>generic</tt> system.img, but with additional content
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/system/modules</tt> - custom kernel modules (i.e. mostly drivers)
</p>
</li>
<li>
<p>
<tt>/system/media/audio</tt> - custom audio ringtones, notifications, etc.
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>out/target/product/crespo/userdata.img</tt> - the initial contents of the <tt>/data</tt> partition
</p>
</li>
<li>
<p>
<tt>out/target/product/crespo/recovery.img</tt> - like <tt>boot.img</tt>, it has its own boot header, kernel, and ramdisk, but it also includes a custom <tt>/sbin/recovery</tt> program used during system recovery
</p>
<div class="ulist"><ul>
<li>
<p>
While Android system can reboot itself into recovery mode, we can usually also boot into recovery through special key combination - usually by holding down volume up or home key on power-up
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>out/target/product/crespo/ramdisk-recovery.img</tt> - see above (included in <tt>recovery.img</tt>)
</p>
</li>
</ul></div>
</li>
<li>
<p>
See <a href="http://source.android.com/source/building.html">http://source.android.com/source/building.html</a> for more info on building Android
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_running_custom_android_build_on_emulator">6.10. Running Custom Android Build on Emulator</h3>
<div class="ulist"><ul>
<li>
<p>
Run <tt>emulator</tt> right from the source directory (requires <tt>lunch</tt> to be run first)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ source build/envsetup.sh
$ lunch …
$ make …
$ out/host/linux-x86/bin/emulator &amp;</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Replace <tt>linux-x86</tt> with <tt>darwin-x86</tt> for Mac OS X.</td>
</tr></table>
</div>
</li>
<li>
<p>
Alternatively, we can run our image in one of our Android Virtual Devices (AVD)
</p>
<div class="ulist"><ul>
<li>
<p>
Create an AVD - unless we already have one from before
</p>
<div class="ulist"><ul>
<li>
<p>
We could use "Android SDK and AVD Manager" GUI to create an AVD (based on the same "target" as the image we compiled)
</p>
</li>
<li>
<p>
Or, we could create an AVD from the command line (assuming we are in the source directory and SDK&#8217;s <tt>android</tt> is in our <tt>PATH</tt>):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ android create avd --sdcard 16M --target android-10 --name custom-avd --path custom-avd
Android 2.3.3 is a basic Android platform.
Do you wish to create a custom hardware profile [no]
Created AVD 'custom-avd' based on Android 2.3.3,
with the following hardware config:
hw.lcd.density=240
vm.heapSize=24
hw.ramSize=256</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
We are now ready to run it (assuming we are in the source directory and SDK&#8217;s <tt>emulator</tt> is in our <tt>PATH</tt>):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ emulator -avd custom-avd -system out/target/product/generic/system.img -ramdisk out/target/product/generic/ramdisk.img &amp;</tt></pre>
</div></div>
</li>
</ul></div>
</li>
<li>
<p>
And the result is
</p>
<div class="imageblock">
<div class="content">
<img src="screens/EmulatorAboutCustomROM.png" alt="screens/EmulatorAboutCustomROM.png" />
</div>
</div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_running_custom_android_build_on_real_hardware">6.11. Running Custom Android Build on Real Hardware</h3>
<div class="ulist"><ul>
<li>
<p>
First we reboot our device into fastboot mode (assuming SDK&#8217;s <tt>adb</tt> is in our <tt>PATH</tt>)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb reboot bootloader</tt></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
We could also reboot using the special key combination on power-up, but that&#8217;s often device-specific (as mentioned above)
</p>
<div class="ulist"><ul>
<li>
<p>
Nexus S and Nexus S 4G: Press and hold Volume Up, then press and hold Power
</p>
</li>
<li>
<p>
Nexus One: Press and hold the trackball, then press Power
</p>
</li>
<li>
<p>
G1 and MyTouch 3G: Press and hold Back, then press Power
</p>
</li>
</ul></div>
</li>
<li>
<p>
Android requires that every device support "fastboot" protocol - a mechanism for communicating with bootloaders over USB
</p>
</li>
<li>
<p>
For more info on Fastboot, see <tt>bootable/bootloader/legacy/fastboot_protocol.txt</tt> (relative to the source directory)
</p>
</li>
</ul></div>
</li>
<li>
<p>
We may need to unlock our bootloader (which may not be permitted on many devices)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ out/host/linux-x86/bin/fastboot oem unlock</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Nexus One (passion) does not allow the bootloader to be locked again with <tt>fastboot oem lock</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
We are now ready to flash our device
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ out/host/linux-x86/bin/fastboot flashall -w</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">Running this command will <strong>wipe</strong> our device! The <tt>-w</tt> switch is used to also wipe the <tt>/data</tt> partition, which is sometimes necessary (on first-flash, or on major updates), but is otherwise not required.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Nexus One (passion) does not support the <tt>-w</tt> switch, so instead we can <tt>fastboot erase cache</tt> and <tt>fastboot erase userdata</tt> before flashing.</td>
</tr></table>
</div>
</li>
<li>
<p>
Finally, we reboot the device to run our custom build
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_building_the_linux_kernel">6.12. Building the Linux Kernel</h3>
<div class="ulist" id="Android_Building_Linux_Kernel"><ul>
<li>
<p>
As of 2009, Linux kernel is no longer cloned as part of the standard <tt>repo sync</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
The kernel&#8217;s build system is separate from the one Android uses for the rest of the platform
</p>
</li>
<li>
<p>
Most system integrators get the pre-built kernel from their SoC provider
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">It is easiest to build the Linux kernel on a Linux OS. While other host OSs can also be used, they are not trivial to setup.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_getting_the_kernel">6.13. Getting the Kernel</h3>
<div class="listingblock">
<div class="content">
<pre><tt>$ git clone https://android.googlesource.com/kernel/common.git
$ git clone https://android.googlesource.com/kernel/goldfish.git
$ git clone https://android.googlesource.com/kernel/msm.git
$ git clone https://android.googlesource.com/kernel/omap.git
$ git clone https://android.googlesource.com/kernel/samsung.git
$ git clone https://android.googlesource.com/kernel/tegra.git</tt></pre>
</div></div>
<div class="sect3">
<h4 id="_building_kernel_for_the_emulator_goldfish">6.13.1. Building Kernel for the Emulator (Goldfish)</h4>
<div class="olist arabic" id="Android_Building_Linux_Kernel_for_Emulator"><ol class="arabic">
<li>
<p>
Start the emulator
</p>
</li>
<li>
<p>
Get the existing kernel version from <tt>/proc/version</tt> (since <tt>uname</tt> does not exist on Android)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell cat /proc/version
Linux version 2.6.29-g46b05b2 (vchtchetkine@vc-irv.irv.corp.google.com) (gcc version 4.4.3 (GCC) ) #28 Thu Nov 17 06:39:36 PST 2011</tt></pre>
</div></div>
</li>
<li>
<p>
Get the corresponding kernel version (here, we are getting the kernel for goldfish, the emulator)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git clone https://android.googlesource.com/kernel/goldfish.git
$ cd goldfish/
$ git branch -a
$ git checkout -t remotes/origin/android-goldfish-2.6.29</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Alternatively, we could directly clone the goldfish 2.6.29 branch <br />
<tt>$ git clone https://android.googlesource.com/kernel/goldfish.git -b android-goldfish-2.6.29</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
Specify the target architecture and cross compiler
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ export ARCH=arm
$ export CROSS_COMPILE=/path/to/android-src/prebuilt/linux-x86/toolchain/arm-eabi-4.4.3/bin/arm-eabi-</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">Android&#8217;s own build system uses <tt>ARCH</tt> and <tt>CROSS_COMPILE</tt> env vars, so these need to be cleared before building AOSP.<br />
As an alternative, these can be also passed directly to the make commands: <tt>$ make … ARCH=… CROSS_COMPILE=…</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
Get the existing kernel configuration file (with all of the Android/emulator specific options) by pulling it from the running emulator:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb pull /proc/config.gz .
$ gunzip config.gz
$ mv config .config</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">As an alternative, we could generate the Goldfish <tt>.config</tt> file (even without the emulator) by running:<br />
<tt>$ make goldfish_armv7_defconfig ARCH=arm</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
You can optionally take a look at the existing configuration options and make changes as desired
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make menuconfig ARCH=arm</tt></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
For example, you could set your <em>General setup</em> &#8594; <em>Local version - append to kernel release</em> to something like <tt>-marakana-example</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Now we are ready to compile
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make</tt></pre>
</div></div>
</li>
<li>
<p>
The resulting kernel will be compressed to <tt>arch/arm/boot/zImage</tt>
</p>
</li>
<li>
<p>
Run the emulator with our new kernel
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ out/host/linux-x86/bin/emulator -kernel /path/to/common/arch/arm/boot/zImage</tt></pre>
</div></div>
</li>
<li>
<p>
And the result is
</p>
<div class="imageblock">
<div class="content">
<img src="screens/CustomKernel.png" alt="screens/CustomKernel.png" />
</div>
</div>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Android_Startup">7. Android Startup</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/AndroidProcessSnapshot.svg" alt="images/AndroidProcessSnapshot.svg" />
</div>
</div>
<div class="sect2">
<h3 id="_bootloading_the_kernel">7.1. Bootloading the Kernel</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
On power-up, CPU is uninitialized - wait for stable power
</p>
</li>
<li>
<p>
Execute Boot ROM (hardwired into CPU)
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Locate the first-stage boot loader
</p>
</li>
<li>
<p>
Load the first-stage boot loader into internal RAM
</p>
</li>
<li>
<p>
Jump to first-stage boot loader&#8217;s memory location to execute it
</p>
</li>
</ol></div>
</li>
<li>
<p>
First-stage boot loader runs
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Detect and initialize external RAM
</p>
</li>
<li>
<p>
Locate the second-stage boot loader
</p>
</li>
<li>
<p>
Load the second-stage boot loader into external RAM
</p>
</li>
<li>
<p>
Jump to the second-stage boot loader&#8217;s memory location to execute it
</p>
</li>
</ol></div>
</li>
<li>
<p>
Second-stage boot loader runs
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Setup file systems (typically on Flash media)
</p>
</li>
<li>
<p>
Optionally setup display, network, additional memory, and other devices
</p>
</li>
<li>
<p>
Enable additional CPU features
</p>
</li>
<li>
<p>
Enable low-level memory protection
</p>
</li>
<li>
<p>
Optionally load security protections (e.g. ROM validation code)
</p>
</li>
<li>
<p>
Locate Linux Kernel
</p>
</li>
<li>
<p>
Load Linux Kernel into RAM
</p>
</li>
<li>
<p>
Place Linux Kernel boot parameters into memory so that kernel knows what to run upon startup
</p>
</li>
<li>
<p>
Jump to Linux Kernel memory address to run it
</p>
</li>
</ol></div>
</li>
<li>
<p>
Linux Kernel runs
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Build a table in RAM describing the layout of the physical memory
</p>
</li>
<li>
<p>
Initialize and setup input devices
</p>
</li>
<li>
<p>
Initialize and setup disk (typically MTD) controllers and map available block devices in RAM
</p>
</li>
<li>
<p>
Initialize Advanced Power Management (APM) support
</p>
</li>
<li>
<p>
Initialize interrupt handlers: Interrupt Descriptor Table (IDT), Global Descriptor Table (GDT), and Programmable Interrupt Controllers (PIC)
</p>
</li>
<li>
<p>
Reset the floating-point unit (FPU)
</p>
</li>
<li>
<p>
Switch from real to protected mode (i.e. enable memory protection)
</p>
</li>
<li>
<p>
Initialize segmentation registers and a provisional stack
</p>
</li>
<li>
<p>
Zero uninitialized memory
</p>
</li>
<li>
<p>
Decompress the kernel image
</p>
</li>
<li>
<p>
Initialize provisional kernel page tables and enable paging
</p>
</li>
<li>
<p>
Setup kernel mode stack for process <tt>0</tt>
</p>
</li>
<li>
<p>
Fill the IDT with null interrupt handlers
</p>
</li>
<li>
<p>
Initialize the first page frame with system parameters
</p>
</li>
<li>
<p>
Identify the CPU model
</p>
</li>
<li>
<p>
Initialize registers with the addresses of the GDT and IDT
</p>
</li>
<li>
<p>
Initialize and start the kernel
</p>
<div class="olist lowerroman"><ol class="lowerroman">
<li>
<p>
Scheduler
</p>
</li>
<li>
<p>
Memory zones
</p>
</li>
<li>
<p>
Buddy system allocator
</p>
</li>
<li>
<p>
IDT
</p>
</li>
<li>
<p>
SoftIRQs
</p>
</li>
<li>
<p>
Date and Time
</p>
</li>
<li>
<p>
Slab allocator
</p>
</li>
<li>
<p>
&#8230;
</p>
</li>
</ol></div>
</li>
<li>
<p>
Create process <tt>1</tt> (<tt>/init</tt>) and run it
</p>
</li>
</ol></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="Android_Init_Startup">7.2. Android&#8217;s <tt>init</tt> Startup</h3>
<div class="imageblock">
<div class="content">
<img src="images/StartupWalkthru.svg" alt="images/StartupWalkthru.svg" />
</div>
</div>
<div class="ulist"><ul>
<li>
<p>
The granddaddy of all other processes on the system (PID=1)
</p>
</li>
<li>
<p>
Custom initialization script (with its own language)
</p>
<div class="ulist"><ul>
<li>
<p>
Different than more traditional <tt>/etc/inittab</tt> and SysV-init-levels initialization options
</p>
</li>
</ul></div>
</li>
<li>
<p>
When started by the kernel, <tt>init</tt> parses and executes commands from two files:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/init.rc</tt> - provides generic initialization instructions (see <tt>system/core/rootdir/init.rc</tt>)
</p>
</li>
<li>
<p>
<tt>/init.&lt;board-name&gt;.rc</tt> - provides machine-specific initialization instructions - sometimes overriding <tt>/init.rc</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>/init.goldfish.rc</tt> for the emulator
</p>
</li>
<li>
<p>
<tt>/init.trout.rc</tt> for HTC&#8217;s ADP1
</p>
</li>
<li>
<p>
<tt>/init.herring.rc</tt> for Samsung&#8217;s Nexus S (see <tt>device/samsung/crespo/init.herring.rc</tt>)
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
The <tt>init</tt> program never exists (if it were, the kernel would panic), so it continues to monitor started services
</p>
</li>
<li>
<p>
The init's language consists of four broad classes of statements (see <tt>system/core/init/readme.txt</tt>)
</p>
<div class="ulist"><ul>
<li>
<p>
Actions - named sequences of commands queued to be executed on a unique trigger
</p>
<div class="listingblock">
<div class="content">
<pre><tt>on &lt;trigger&gt;
   &lt;command&gt;
   &lt;command&gt;
   &lt;command&gt;</tt></pre>
</div></div>
</li>
<li>
<p>
Triggers - named events that trigger actions
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>early-init</tt>, <tt>init</tt>, <tt>early-fs</tt>, <tt>fs</tt>, <tt>post-fs</tt>, <tt>early-boot</tt>, <tt>boot</tt> - built-in stages of init
</p>
</li>
<li>
<p>
<tt>&lt;name&gt;=&lt;value&gt;</tt> - fires when a system property is set to <tt>&lt;name&gt;=&lt;value&gt;</tt>
</p>
</li>
<li>
<p>
<tt>device-added-&lt;path&gt;</tt> - fires when a device node at <tt>&lt;path&gt;</tt> is added
</p>
</li>
<li>
<p>
<tt>device-removed-&lt;path&gt;</tt> - fires when a device node at <tt>&lt;path&gt;</tt> is removed
</p>
</li>
<li>
<p>
<tt>service-exited-&lt;name&gt;</tt> - fires when a service by <tt>&lt;name&gt;</tt> exists
</p>
</li>
</ul></div>
</li>
<li>
<p>
Commands - a command to be queued and run
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>chdir &lt;directory&gt;</tt> - change working directory
</p>
</li>
<li>
<p>
<tt>chmod &lt;octal-mode&gt; &lt;path&gt;</tt> - change file access permissions
</p>
</li>
<li>
<p>
<tt>chown &lt;owner&gt; &lt;group&gt; &lt;path&gt;</tt> - change file user and group ownership
</p>
</li>
<li>
<p>
<tt>chroot &lt;directory&gt;</tt> - change process root directory
</p>
</li>
<li>
<p>
<tt>class_start &lt;serviceclass&gt;</tt> - start all non-running services of the specified class
</p>
</li>
<li>
<p>
<tt>class_stop &lt;serviceclass&gt;</tt> - stop all running services of the specified class
</p>
</li>
<li>
<p>
<tt>domainname &lt;name&gt;</tt> - set the domain name.
</p>
</li>
<li>
<p>
<tt>exec &lt;path&gt; [ &lt;argument&gt; ]*</tt> - fork and execute <tt>&lt;path&gt; &lt;argument&gt; ...</tt> (blocks <tt>init</tt> until exec returns)
</p>
</li>
<li>
<p>
<tt>export &lt;name&gt; &lt;value&gt;</tt> - set globally visible environment variable <tt>&lt;name&gt; =&lt;value&gt;</tt>
</p>
</li>
<li>
<p>
<tt>hostname &lt;name&gt;</tt> - set the host name
</p>
</li>
<li>
<p>
<tt>ifup &lt;interface&gt;</tt> - bring the network interface &lt;interface&gt; online
</p>
</li>
<li>
<p>
<tt>import &lt;filename&gt;</tt> - parse and process <tt>&lt;filename&gt;</tt> init configuration file (extends the current script)
</p>
</li>
<li>
<p>
<tt>insmod &lt;path&gt;</tt> - install the kernel module at <tt>&lt;path&gt;</tt>
</p>
</li>
<li>
<p>
<tt>loglevel &lt;level&gt;</tt> - initialize the logger to <tt>&lt;level&gt;</tt>
</p>
</li>
<li>
<p>
<tt>mkdir &lt;path&gt; [mode] [owner] [group]</tt> - create a directory at <tt>&lt;path&gt;</tt> and optionally change its default permissions (<tt>755</tt>) and user (<tt>root</tt>) / group (<tt>root</tt>) ownership
</p>
</li>
<li>
<p>
<tt>mount &lt;type&gt; &lt;device&gt; &lt;dir&gt; [ &lt;mountoption&gt; ]*</tt> - attempt to mount named <tt>&lt;device&gt;</tt> at <tt>&lt;dir&gt;</tt> with the optional `&lt;mountoption&gt;`s
</p>
</li>
<li>
<p>
<tt>setprop &lt;name&gt; &lt;value&gt;</tt> - set system property <tt>&lt;name&gt;=&lt;value&gt;</tt>
</p>
</li>
<li>
<p>
<tt>setrlimit &lt;resource&gt; &lt;cur&gt; &lt;max&gt;</tt> - set the rlimit for a <tt>&lt;resource&gt;</tt>
</p>
</li>
<li>
<p>
<tt>start &lt;service&gt;</tt> - start named <tt>&lt;service&gt;</tt> if it is not already running
</p>
</li>
<li>
<p>
<tt>stop &lt;service&gt;</tt> - stop name <tt>&lt;service&gt;</tt> if it is currently running
</p>
</li>
<li>
<p>
<tt>symlink &lt;target&gt; &lt;path&gt;</tt> - symbolically link <tt>&lt;path&gt;</tt> to <tt>&lt;target&gt;</tt>
</p>
</li>
<li>
<p>
<tt>sysclktz &lt;mins_west_of_gmt&gt;</tt> - set the system clock base (0 for GMT)
</p>
</li>
<li>
<p>
<tt>trigger &lt;event&gt;</tt> - trigger an event - i.e. call one action from another
</p>
</li>
<li>
<p>
<tt>write &lt;path&gt; &lt;string&gt; [ &lt;string&gt; ]*</tt> - write arbitrary <tt>&lt;string&gt;`s to file by specified `&lt;path&gt;</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
Services - persistent daemon programs to be launched (optionally) restarted if they exit
</p>
<div class="listingblock">
<div class="content">
<pre><tt>service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*
   &lt;option&gt;
   &lt;option&gt;
   ...</tt></pre>
</div></div>
</li>
<li>
<p>
Options - modifiers to services, modifying how/when they are run re/launched
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>critical</tt> - a device-critical service - devices goes into recovery if the service exits more than 4 times in 4 minutes
</p>
</li>
<li>
<p>
<tt>disabled</tt> - not started by default - i.e. it has to be started explicitly by name
</p>
</li>
<li>
<p>
<tt>setenv &lt;name&gt; &lt;value&gt;</tt> - set the environment variable <tt>&lt;name&gt;=&lt;value&gt;</tt> in the service
</p>
</li>
<li>
<p>
<tt>socket &lt;name&gt; &lt;dgram|stream|seqpacket&gt; &lt;perm&gt; [ &lt;user&gt; [ &lt;group&gt; ] ]</tt> - create a unix domain socket named /dev/socket/&lt;name&gt; and pass its fd to the service
</p>
</li>
<li>
<p>
<tt>user &lt;username&gt;</tt> - change service&#8217;s effective user ID to <tt>&lt;username&gt;</tt>
</p>
</li>
<li>
<p>
<tt>group &lt;groupname&gt; [ &lt;groupname&gt; ]*</tt> - change service&#8217;s effective group ID to <tt>&lt;groupname&gt;</tt> (additional groups are supplemented via <tt>setgroups()</tt>)
</p>
</li>
<li>
<p>
<tt>oneshot</tt> - ignore service exist (default is to auto-restart)
</p>
</li>
<li>
<p>
<tt>class &lt;name&gt;</tt> - set the class name of the service (defaults to <tt>default</tt>) so that all services of a particular class can be started/stopped together
</p>
</li>
<li>
<p>
<tt>onrestart</tt> - execute a command on restart
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
The default <tt>init.rc</tt> script
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Starts <tt>ueventd</tt>
</p>
</li>
<li>
<p>
Initializes the system clock and logger
</p>
</li>
<li>
<p>
Sets up global environment
</p>
</li>
<li>
<p>
Sets up the file system (mount points and symbolic links)
</p>
</li>
<li>
<p>
Configures kernel timeouts and scheduler
</p>
</li>
<li>
<p>
Configures process groups
</p>
</li>
<li>
<p>
Mounts the file systems
</p>
</li>
<li>
<p>
Creates a basic directory structure on <tt>/data</tt> and applies permissions
</p>
</li>
<li>
<p>
Applies permissions on <tt>/cache</tt>
</p>
</li>
<li>
<p>
Applies permissions on certain <tt>/proc</tt> points
</p>
</li>
<li>
<p>
Initializes local network (i.e. localhost)
</p>
</li>
<li>
<p>
Configures the parameters for the low memory killer <a href="#Android_Linux_Kernel_Low_Memory_Killer">[Android_Linux_Kernel_Low_Memory_Killer]</a>
</p>
</li>
<li>
<p>
Applies permissions for <tt>systemserver</tt> and daemons
</p>
</li>
<li>
<p>
Defines TCP buffer sizes for various networks
</p>
</li>
<li>
<p>
Configures and (optionally) loads various daemons (i.e. services): <tt>ueventd</tt>, <tt>console</tt>, <tt>adbd</tt>, <tt>servicemanager</tt>, <tt>vold</tt>, <tt>netd</tt>, <tt>debuggerd</tt>, <tt>rild</tt>, <tt>zygote</tt> (which in turn starts <tt>system_server</tt>), <tt>mediaserver</tt>, <tt>bootanimation</tt> (one time), and various Bluetooth daemons (like <tt>dbus-daemon</tt>, <tt>bluetoothd</tt>, etc.), <tt>installd</tt>, <tt>racoon</tt>, <tt>mtpd</tt>, <tt>keystore</tt>
</p>
</li>
</ol></div>
</li>
<li>
<p>
Nexus S' <tt>init.herring.rc</tt> additionally
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Sets up product info
</p>
</li>
<li>
<p>
Initializes device-driver-specific info, file system structures, and permissions: battery, wifi, phone, uart_switch, GPS, radio, bluetooth, NFC, lights
</p>
</li>
<li>
<p>
Initializes and (re)mounts file systems
</p>
</li>
<li>
<p>
Loads additional device-specific daemons
</p>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_zygote_startup">7.3. Zygote Startup</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Zygote starts from <tt>/init.rc</tt>
</p>
<div class="listingblock">
<div class="content">
<pre><tt>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
    socket zygote stream 666
    onrestart write /sys/android_power/request_state wake
    onrestart write /sys/power/state on
    onrestart restart media
    onrestart restart netd</tt></pre>
</div></div>
</li>
<li>
<p>
This translates to <tt>frameworks/base/cmds/app_process/app_main.cpp:main()</tt>
</p>
</li>
<li>
<p>
The command <tt>app_process</tt> then launches <tt>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:main()</tt> in a Dalvik VM via <tt>frameworks/base/core/jni/AndroidRuntime.cpp:start()</tt>
</p>
</li>
<li>
<p>
<tt>ZygoteInit.main()</tt> then
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Registers for zygote socket
</p>
</li>
<li>
<p>
Pre-loads classes defined in <tt>frameworks/base/preloaded-classes</tt> (1800+)
</p>
</li>
<li>
<p>
Pre-loads resources <tt>preloaded_drawables</tt> and <tt>preloaded_color_state_lists</tt> from <tt>frameworks/base/core/res/res/values/arrays.xml</tt>
</p>
</li>
<li>
<p>
Runs garbage collector (to clean the memory as much as possible)
</p>
</li>
<li>
<p>
Forks itself to start <tt>systemserver</tt>
</p>
</li>
<li>
<p>
Starts listening for requests to fork itself for other apps
</p>
</li>
</ol></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_system_server_startup">7.4. System Server Startup</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
When Zygote forks itself to launch the <tt>systemserver</tt> process (in <tt>ZygoteInit.java:startSystemServer()</tt>), it executes <tt>frameworks/base/services/java/com/android/server/SystemServer:java.main()</tt>
</p>
</li>
<li>
<p>
The <tt>SystemServer:java.main()</tt> method loads <tt>android_servers</tt> JNI lib from <tt>frameworks/base/services/jni</tt> and invokes <tt>init1()</tt> native method
</p>
</li>
<li>
<p>
Before <tt>init1()</tt> runs, the JNI loader first runs <tt>frameworks/base/services/jni/onload.cpp:JNI_OnLoad()</tt>, which registers native services - to be used as JNI counterparts to Java-based service manager loaded later
</p>
</li>
<li>
<p>
Now <tt>frameworks/base/services/jni/com_android_server_SystemServer.cpp:init1()</tt> is invoked, which simply wraps a call to  <tt>frameworks/base/cmds/system_server/library/system_init.cpp:system_init()</tt>
</p>
</li>
<li>
<p>
The <tt>system_init.cpp:system_init()</tt> function
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
First starts native services (some optionally):
</p>
<div class="olist lowerroman"><ol class="lowerroman">
<li>
<p>
<tt>frameworks/base/services/surfaceflinger/SurfaceFlinger.cpp</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/sensorservice/SensorService.cpp</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/audioflinger/AudioFlinger.cpp</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/media/libmediaplayerservice/MediaPlayerService.cpp</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/camera/libcameraservice/CameraService.cpp</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/audioflinger/AudioPolicyService.cpp</tt>
</p>
</li>
</ol></div>
</li>
<li>
<p>
Then goes back to <tt>frameworks/base/services/java/com/android/server/SystemServer.java:init2()</tt>, again via <tt>frameworks/base/core/jni/AndroidRuntime.cpp:start()</tt> JNI call
</p>
</li>
</ol></div>
</li>
<li>
<p>
The <tt>SystemServer.java:init2()</tt> method then starts Java service managers in a separate thread (<tt>ServerThread</tt>), readies them, and registers each one with <tt>frameworks/base/core/java/android/os/ServiceManager:addService()</tt> (which in turn delegates to to ServiceManagerNative.java, which effectively talks to <tt>servicemanager</tt> daemon previously started by <tt>init</tt>)
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
<tt>frameworks/base/services/java/com/android/server/PowerManagerService.java</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/java/com/android/server/am/ActivityManagerService.java</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/java/com/android/server/TelephonyRegistry.java</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/java/com/android/server/PackageManagerService.java</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/java/com/android/server/BatteryService.java</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/services/java/com/android/server/VibratorService.java</tt>
</p>
</li>
<li>
<p>
etc
</p>
</li>
</ol></div>
</li>
<li>
<p>
Finally <tt>frameworks/base/services/java/com/android/server/am/ActivityManagerService.java:finishBooting()</tt> sets <tt>sys.boot_completed=1</tt> and sends out
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
a broadcast intent with <tt>android.intent.action.PRE_BOOT_COMPLETED</tt> action (to give apps a chance to reach to boot upgrades)
</p>
</li>
<li>
<p>
an activity intent with <tt>android.intent.category.HOME</tt> category to launch the <em>Home</em> (or <em>Launcher</em>) application
</p>
</li>
<li>
<p>
a broadcast intent with <tt>android.intent.action.BOOT_COMPLETED</tt> action, which launches applications subscribed to this intent (while using <tt>android.permission.RECEIVE_BOOT_COMPLETED</tt>)
</p>
</li>
</ol></div>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Android_Services">8. Android Services</h2>
<div class="sectionbody">
<div class="paragraph"><p>The objective of this module is to explain the inter-workings of various Android services. There are close to sixty various services in ICS release. In this module, we&#8217;ve hand-picked some of the more common ones. By the end of the module, you should start to understand some common traits of Android service architecture, such as use of the Binder for inter-process communication, and use of JNI for Java-C interaction.</p></div>
<div class="paragraph"><p>Android services are the key to exposing lower level functionality of the hardware and the Linux kernel to the high level Android apps. Understanding how they work creates the opportunity to customize and extend their behavior, or add another service altogether.</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell service list
Found 56 services:
0   phone: [com.android.internal.telephony.ITelephony]
1   iphonesubinfo: [com.android.internal.telephony.IPhoneSubInfo]
2   simphonebook: [com.android.internal.telephony.IIccPhoneBook]
3   isms: [com.android.internal.telephony.ISms]
4   samplingprofiler: []
5   diskstats: []
6   appwidget: [com.android.internal.appwidget.IAppWidgetService]
7   backup: [android.app.backup.IBackupManager]
8   uimode: [android.app.IUiModeManager]
9   usb: [android.hardware.usb.IUsbManager]
10  audio: [android.media.IAudioService]
11  wallpaper: [android.app.IWallpaperManager]
12  dropbox: [com.android.internal.os.IDropBoxManagerService]
13  search: [android.app.ISearchManager]
14  country_detector: [android.location.ICountryDetector]
15  location: [android.location.ILocationManager]
16  devicestoragemonitor: []
17  notification: [android.app.INotificationManager]
18  mount: [IMountService]
19  throttle: [android.net.IThrottleManager]
20  connectivity: [android.net.IConnectivityManager]
21  wifi: [android.net.wifi.IWifiManager]
22  wifip2p: [android.net.wifi.p2p.IWifiP2pManager]
23  netpolicy: [android.net.INetworkPolicyManager]
24  netstats: [android.net.INetworkStatsService]
25  textservices: [com.android.internal.textservice.ITextServicesManager]
26  network_management: [android.os.INetworkManagementService]
27  clipboard: [android.content.IClipboard]
28  statusbar: [com.android.internal.statusbar.IStatusBarService]
29  device_policy: [android.app.admin.IDevicePolicyManager]
30  accessibility: [android.view.accessibility.IAccessibilityManager]
31  input_method: [com.android.internal.view.IInputMethodManager]
32  window: [android.view.IWindowManager]
33  alarm: [android.app.IAlarmManager]
34  vibrator: [android.os.IVibratorService]
35  battery: []
36  hardware: [android.os.IHardwareService]
37  content: [android.content.IContentService]
38  account: [android.accounts.IAccountManager]
39  permission: [android.os.IPermissionController]
40  cpuinfo: []
41  gfxinfo: []
42  meminfo: []
43  activity: [android.app.IActivityManager]
44  package: [android.content.pm.IPackageManager]
45  telephony.registry: [com.android.internal.telephony.ITelephonyRegistry]
46  usagestats: [com.android.internal.app.IUsageStats]
47  batteryinfo: [com.android.internal.app.IBatteryStats]
48  power: [android.os.IPowerManager]
49  entropy: []
50  sensorservice: [android.gui.SensorServer]
51  media.audio_policy: [android.media.IAudioPolicyService]
52  media.camera: [android.hardware.IAudioPolicyServiceService]
53  media.player: [android.media.IMediaPlayerService]
54  media.audio_flinger: [android.media.IAudioFlinger]
55  SurfaceFlinger: [android.ui.ISurfaceComposer]</tt></pre>
</div></div>
<div class="sect2">
<h3 id="_vibrator">8.1. Vibrator</h3>
<div class="imageblock">
<div class="content">
<img src="images/VibratorArchitecture.svg" alt="images/VibratorArchitecture.svg" />
</div>
<div class="title">Figure 5. Vibrator Service Architecture</div>
</div>
<div class="ulist"><ul>
<li>
<p>
<tt>/system/framework/framework.jar</tt> is built by <tt>frameworks/base/Android.mk</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>android.os.Vibrator</tt> is defined by <tt>frameworks/base/core/java/android/os/Vibrator.java</tt>
</p>
</li>
<li>
<p>
<tt>android.os.IVibratorService</tt> is defined by <tt>frameworks/base/core/java/android/os/IVibratorService.aidl</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/bin/servicemanager</tt> is built by <tt>frameworks/base/cmds/servicemanager.Android.mk</tt> and started from <tt>system/core/rootdir/init.rc</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>service_manager.c</tt> comes from <tt>frameworks/base/cmds/servicemanager/service_manager.c</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>system_server</tt> is forked from <tt>zygote</tt> via <tt>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:startSystemServer()</tt>, which in turn calls <tt>libcore/dalvik/src/main/java/dalvik/system/Zygote.java:forkSystemServer(…)</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>zygote</tt> is a daemon started by <tt>frameworks/base/cmds/app_process/app_main.cpp</tt> from <tt>system/core/rootdir/init.rc</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/framework/services.jar</tt> is built by <tt>frameworks/base/services/java/Android.mk</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>com.android.server.SystemServer</tt> is defined by <tt>frameworks/base/services/java/com/android/server/SystemServer.java</tt>
</p>
</li>
<li>
<p>
<tt>com.android.server.VibratorService</tt> is defined by <tt>frameworks/base/services/java/com/android/server/VibratorService.java</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/lib/libandroid_servers.so</tt> is built by <tt>frameworks/base/services/jni/Android.mk</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>com_android_server_VibratorService.cpp</tt> comes from <tt>frameworks/base/services/jni/com_android_server_VibratorService.cpp</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>/system/lib/libhardware_legacy.so</tt> is built by <tt>hardware/libhardware_legacy/Android.mk</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>vibrator.c</tt> comes from <tt>hardware/libhardware_legacy/vibrator/vibrator.c</tt>
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_power_service">8.2. Power Service</h3>
<div class="imageblock">
<div class="content">
<img src="images/PowerManagerServiceArchitecture.svg" alt="images/PowerManagerServiceArchitecture.svg" />
</div>
<div class="title">Figure 6. Power Service Architecture</div>
</div>
<div class="sect3">
<h4 id="_links">8.2.1. Links</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="https://gitorious.org/android/powertop">https://gitorious.org/android/powertop</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_alarm_service">8.3. Alarm Service</h3>
<div class="imageblock">
<div class="content">
<img src="images/AlarmManagerServiceArchitecture.svg" alt="images/AlarmManagerServiceArchitecture.svg" />
</div>
<div class="title">Figure 7. Alarm Service Architecture</div>
</div>
</div>
<div class="sect2">
<h3 id="_package_service">8.4. Package Service</h3>
<div class="imageblock">
<div class="content">
<img src="images/PackageManagerServiceArchitecture.svg" alt="images/PackageManagerServiceArchitecture.svg" />
</div>
<div class="title">Figure 8. Package Service Architecture</div>
</div>
</div>
<div class="sect2">
<h3 id="_wifi_service">8.5. WiFi Service</h3>
<div class="paragraph"><p>Wifi Service exposes wifi functionality of the underlying system to the application layer via <tt>WifiManager</tt> class. The key differentiation between wifi stack and some other ones is that the wifi stack primarily uses the <tt>wpa_supplicant</tt> to manage the Wifi driver.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/WifiArchitecture.svg" alt="images/WifiArchitecture.svg" />
</div>
<div class="title">Figure 9. Wifi Service Architecture</div>
</div>
<div class="sect3">
<h4 id="_links_2">8.5.1. Links</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://developer.android.com/reference/android/net/wifi/package-summary.html">http://developer.android.com/reference/android/net/wifi/package-summary.html</a>
</p>
</li>
<li>
<p>
<a href="http://linuxwireless.org/">http://linuxwireless.org/</a>
</p>
</li>
<li>
<p>
<a href="http://www.youtube.com/playlist?p=PLA12950D8456F1818">http://www.youtube.com/playlist?p=PLA12950D8456F1818</a>
</p>
</li>
<li>
<p>
<a href="http://www.au-kbc.org/comm/Docs/papers/Vipin_Analysis_of_open_source_WLAN_driver_paper.pdf">http://www.au-kbc.org/comm/Docs/papers/Vipin_Analysis_of_open_source_WLAN_driver_paper.pdf</a>
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Wpa_supplicant">http://en.wikipedia.org/wiki/Wpa_supplicant</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_location_service">8.6. Location Service</h3>
<div class="imageblock">
<div class="content">
<img src="images/LocationManagerServiceArchitecture.svg" alt="images/LocationManagerServiceArchitecture.svg" />
</div>
<div class="title">Figure 10. Location Service Architecture</div>
</div>
</div>
<div class="sect2">
<h3 id="_audio_service">8.7. Audio Service</h3>
<div class="imageblock">
<div class="content">
<img src="images/AudioPlaybackServiceArchitecture.svg" alt="images/AudioPlaybackServiceArchitecture.svg" />
</div>
<div class="title">Figure 11. Audio Architecture (playing audio)</div>
</div>
<div class="paragraph"><div class="title">Audio Manager-Service Architecture (setting volume)</div><p><span class="image">
<img src="images/AudioManagerServiceArchitecture.svg" alt="images/AudioManagerServiceArchitecture.svg" />
</span></p></div>
<div class="ulist"><ul>
<li>
<p>
AudioFlinger - Android native audio system
</p>
</li>
<li>
<p>
Hosted in <tt>/system/bin/mediaserver</tt> daemon (started from <tt>/init</tt>)
</p>
<div class="ulist"><ul>
<li>
<p>
Written from scratch for Android
</p>
</li>
<li>
<p>
Similar to PulseAudio,
</p>
<div class="ulist"><ul>
<li>
<p>
A Linux standard sound system (POSIX-compliant)
</p>
</li>
<li>
<p>
Licensed under LGPL
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
AudioFlinger provides:
</p>
<div class="ulist"><ul>
<li>
<p>
APIs for PCM media playback and recording
</p>
<div class="ulist"><ul>
<li>
<p>
Applications generally play/record audio via higher-level APIs
</p>
</li>
<li>
<p>
Even OpenSL ES goes to AudioFlinger
</p>
</li>
</ul></div>
</li>
<li>
<p>
Control mechanism for implementing audio policy
</p>
</li>
<li>
<p>
Effects
</p>
</li>
</ul></div>
</li>
<li>
<p>
Playing audio usually involves
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Parsing and decoding of audio data by <a href="#Android_Media_Framework">[Android_Media_Framework]</a> (Stagefright) via the mediaplayer service
</p>
</li>
<li>
<p>
Writing decoded (PCM) data to an AudioTrack (AudioSink)
</p>
</li>
<li>
<p>
Mixing AudioTracks in AudioFlinger&#8217;s mixer thread (<tt>AudioFlinger::MixerThread::threadLoop()</tt>)
</p>
</li>
<li>
<p>
Applying effects
</p>
</li>
<li>
<p>
Buffering stream data
</p>
</li>
<li>
<p>
Writing buffers to a PCM output device (e.g. ALSA driver) via <tt>android_audio_legacy.AudioHardware</tt> (audio legacy HAL) or "audio" hardware module HAL
</p>
</li>
</ol></div>
</li>
<li>
<p>
For example, on Galaxy Nexus:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
/system/lib/audioflinger.so
</p>
</li>
<li>
<p>
/system/lib/libhardware.so
</p>
</li>
<li>
<p>
/system/lib/hw/audio.primary.tuna.so
</p>
</li>
<li>
<p>
/system/lib/libtinyalsa.so
</p>
</li>
<li>
<p>
/dev/snd/pcmC0D0p
</p>
</li>
</ol></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_links_3">8.7.1. Links</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.alsa-project.org/main/index.php/Main_Page">http://www.alsa-project.org/main/index.php/Main_Page</a> (ALSA Project)
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.alsa-project.org/~tiwai/writing-an-alsa-driver/">http://www.alsa-project.org/~tiwai/writing-an-alsa-driver/</a> (ALSA Driver Documentation)
</p>
</li>
<li>
<p>
<a href="http://www.alsa-project.org/~tiwai/writing-an-alsa-driver.pdf">http://www.alsa-project.org/~tiwai/writing-an-alsa-driver.pdf</a> (ALSA Driver Documentation, PDF)
</p>
</li>
<li>
<p>
<a href="http://www.alsa-project.org/~tiwai/alsa-driver-api/">http://www.alsa-project.org/~tiwai/alsa-driver-api/</a> (ALSA Driver API Reference)
</p>
</li>
<li>
<p>
<a href="http://www.alsa-project.org/~tiwai/alsa-driver-api.pdf">http://www.alsa-project.org/~tiwai/alsa-driver-api.pdf</a> (ALSA Driver API Reference, PDF)
</p>
</li>
<li>
<p>
<a href="http://www.alsa-project.org/main/index.php/Matrix:Vendor-Intel">http://www.alsa-project.org/main/index.php/Matrix:Vendor-Intel</a> (Intel ICH southbridge AC97 audio support)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<a href="https://github.com/tinyalsa">https://github.com/tinyalsa</a> (Tiny library to interface with ALSA in the Linux kernel)
</p>
</li>
<li>
<p>
<a href="http://www.alsa-project.org/main/index.php/SALSA-Library">http://www.alsa-project.org/main/index.php/SALSA-Library</a> (Small ALSA Library)
</p>
</li>
<li>
<p>
<a href="http://www.kandroid.org/online-pdk/guide/audio.html">http://www.kandroid.org/online-pdk/guide/audio.html</a> (Outdated architecture of the audio stack in Android)
</p>
</li>
<li>
<p>
<a href="http://code.google.com/p/andraudio/wiki/GingerbreadMP3Diagrams">http://code.google.com/p/andraudio/wiki/GingerbreadMP3Diagrams</a> (Gingerbread-specific sequence diagrams)
</p>
</li>
<li>
<p>
<a href="http://www.pulseaudio.org/">http://www.pulseaudio.org/</a> (PulseAudio, an alternative to AudioFlinger)
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://arunraghavan.net/2012/01/pulseaudio-vs-audioflinger-fight/">http://arunraghavan.net/2012/01/pulseaudio-vs-audioflinger-fight/</a> (PulseAudio vs. AudioFlinger comparison)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<a href="http://code.google.com/p/android/issues/detail?id=3434">http://code.google.com/p/android/issues/detail?id=3434</a> (AudioFlinger latency issues)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="Android_Media_Framework">8.8. Android Media Framework</h3>
<div class="sect3">
<h4 id="_introduction">8.8.1. Introduction</h4>
<div class="paragraph"><p>The media framework are the APIs and libraries used for controlling playback and recording of video/audio. Since everything involving video and audio require a lot of computing power, mobile devices usually use a lot of special-purpose hardware for this, compared to desktop computers where there normally is enough raw power to run most/everything in software. Full-software solutions normally are more flexible and portable, but obviously require more processor power (which also might give a higher power consumption).</p></div>
<div class="paragraph"><p>Normally only the highest level APIs are public, to allow for flexibility in the implementation internally.</p></div>
</div>
<div class="sect3">
<h4 id="_typical_stack_of_function_calls">8.8.2. Typical stack of function calls</h4>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
java: <tt>android.media.MediaPlayer</tt><br />
  <tt>frameworks/base/media/java/android/media/MediaPlayer.java</tt>
</p>
</li>
<li>
<p>
JNI: <tt>frameworks/base/media/jni/android_media_MediaPlayer.cpp</tt><br />
  Quite straight mapping of java native functions to the C++ <tt>MediaPlayer</tt> class
</p>
</li>
<li>
<p>
C++: MediaPlayer<br />
  <tt>frameworks/base/media/libmedia/mediaplayer.cpp</tt>
</p>
</li>
<li>
<p>
<tt>IMediaPlayer</tt>, <tt>IMediaPlayerService</tt><br />
  <tt>frameworks/base/include/media/IMediaPlayer.h</tt><br />
  <tt>frameworks/base/include/media/IMediaPlayerService.h</tt>
</p>
</li>
<li>
<p>
<tt>BpMediaPlayer</tt>: Binder client/proxy interface<br />
  <tt>frameworks/base/media/libmedia/IMediaPlayer.cpp</tt>
</p>
</li>
<li>
<p>
<tt>BnMediaPlayer</tt>: Binder implementation interface (running in the media server)
</p>
</li>
<li>
<p>
<tt>BnMediaPlayer</tt> implemented by <tt>MediaPlayerService::Client</tt><br />
  <tt>frameworks/base/libmediaplayservice/MediaPlayerService.cpp</tt>
</p>
</li>
<li>
<p>
<tt>MediaPlayerService</tt> backed by different implementations:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>PVPlayer</tt> (old OpenCORE based player, phased out in gingerbread, removed later)
</p>
</li>
<li>
<p>
<tt>StagefrightPlayer</tt><br />
  <tt>frameworks/base/media/libmediaplayerservice/StagefrightPlayer.cpp</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>AwesomePlayer</tt><br />
    <tt>frameworks/base/media/libstagefright/AwesomePlayer.cpp</tt>
</p>
</li>
<li>
<p>
<tt>OMXCodec</tt><br />
    <tt>frameworks/base/media/libstagefright/OMXCodec.cpp</tt><br />
    Pull based stagefright element, wrapping IOMX
</p>
</li>
<li>
<p>
<tt>AudioPlayer</tt><br />
    <tt>frameworks/base/media/libstagefright/AudioPlayer.cpp</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>NuPlayer</tt> (new in ICS/Honeycomb only for HTTP Live Streaming)<br />
  <tt>frameworks/base/media/libmediaplayerservice/nuplayer/NuPlayerDriver.cpp</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>ACodec</tt><br />
  <tt>frameworks/base/media/libstagefright/ACodec.cpp</tt> message passing based frontend on top of IOMX
</p>
</li>
</ul></div>
</li>
</ul></div>
</li>
<li>
<p>
<tt>MediaPlayerService::AudioOutput</tt><br />
  <tt>frameworks/base/libmediaplayservice/MediaPlayerService.cpp</tt>
</p>
</li>
<li>
<p>
<tt>AudioTrack</tt><br />
  <tt>frameworks/base/media/libmedia/AudioTrack.cpp</tt>
</p>
</li>
<li>
<p>
<tt>IAudioTrack</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>BpAudioTrack</tt>, <tt>BnAudioTrack</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>AudioFlinger::TrackHandle</tt><br />
  <tt>frameworks/base/services/audioflinger/AudioFlinger.cpp</tt>
</p>
</li>
</ol></div>
<div class="paragraph"><p>The actual decoding/encoding in the OMXCodec and ACodec class is implemented via the IOMX interface:</p></div>
<div class="ulist"><ul>
<li>
<p>
IOMX
</p>
<div class="ulist"><ul>
<li>
<p>
BpOMX, BnOMX
</p>
</li>
<li>
<p>
OMX <tt>frameworks/base/media/libstagefright/omx/OMX.cpp</tt>
</p>
</li>
<li>
<p>
OMXMaster <tt>frameworks/base/media/libstagefright/omx/OMXMaster.cpp</tt>
</p>
</li>
<li>
<p>
OMXNodeInstance <tt>frameworks/base/media/libstagefright/omx/OMXNodeInstance.cpp</tt>
</p>
</li>
<li>
<p>
Normal OpenMAX IL
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>The applications may also use OpenSL ES for playing back audio this internally uses <tt>OMXCodec</tt> from stagefright for decoding of the audio. (Code for this is in <tt>system/media/opensles/libopensles/android SfPlayer.cpp</tt> in gingerbread, in <tt>system/media/wilhelm/src/android/android AudioSfDecoder.cpp</tt> in ICS.) In ICS, there’s also a an OpenMAX AL API that can play back video, using the <tt>IMediaPlayerService</tt> interface.</p></div>
</div>
<div class="sect3">
<h4 id="_the_media_server_process">8.8.3. The media server process</h4>
<div class="ulist"><ul>
<li>
<p>
restricting direct access to hardware devices to this single process normal processes cannot access the hardware directly.
</p>
<div class="ulist"><ul>
<li>
<p>
a number of different entry points at both high and low API levels – BnMediaPlayer, BnOMX, BnAudioTrack
</p>
</li>
<li>
<p>
encapsulating most of the media handling – calling process only provides the input url/file descriptor, the surface to render into and calls start/stop
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Most of the APIs above in section 2 can either run in the calling application processes, or in the media server. Each of the Binder APIs (<tt>IAPI/BpAPI/BnAPI</tt>, such as <tt>IOMX</tt>, <tt>BpOMX</tt>, <tt>BnOMX</tt>) can proxy calls into the media server. The caller only gets an instance of the generic interface, e.g. <tt>IMediaPlayerm</tt> and does not know whether this is a proxy for calling the same interface in another process (<tt>BpOMX</tt>) or the actual implementation running within the same process (<tt>BnOMX</tt>).</p></div>
<div class="paragraph"><p>Thanks to this, the whole concept of some parts of the API running within a separate process is mostly transparent when working with the APIs.</p></div>
</div>
<div class="sect3">
<h4 id="_stagefright">8.8.4. Stagefright</h4>
<div class="sect4">
<h5 id="_intro">Intro</h5>
<div class="paragraph"><p>Stagefright is the library containing most of the implementation of the media framework.</p></div>
<div class="paragraph"><p>Stagefright is a relatively recent development within android, replacing OpenCORE. It first appeared in Eclair, was made default player for all video (except for RTSP streaming which was still handled by OpenCORE) in Froyo, and in Gingerbread it had gained RTSP streaming support and was mature enough to be used for video recording, too, so OpenCORE was removed in Gingerbread. Since then, it has still evolved a bit.</p></div>
<div class="paragraph"><p>Stagefright is mainly a generic pipeline kind of framework, similar to GStreamer, but much smaller and simpler. (It is purpose-written from scratch to fill the exact needs of Android, while OpenCORE was an already existing framework that PacketVideo provided at the time. Stagefright is a few orders of magnitude smaller than OpenCORE while still fulfilling all the needs Android has.)</p></div>
</div>
<div class="sect4">
<h5 id="_example">Example</h5>
<div class="paragraph"><p>Being a pipeline framework means that it consists of individual elements that form a pipeline, where each element either can produce data itself, or take input data from another element. By chaining such elements together, one can produce a pipeline that does the intended thing. E.g., for playing back video from a mp4 file on the phone, the following elements are hooked up together:</p></div>
<div class="ulist"><ul>
<li>
<p>
`FileSource `
</p>
</li>
<li>
<p>
<tt>MPEG4Extractor</tt><br />
  One <tt>MPEG4Source</tt> for each track (audio/video) in the file
</p>
</li>
<li>
<p>
<tt>OMXCodec</tt> (one for each track, connected to the <tt>MPEG4Source</tt>)
</p>
</li>
<li>
<p>
<tt>AudioPlayer</tt>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <tt>AwesomePlayer</tt> creates the right <tt>MediaExtractor</tt> in <tt>finishSetDataSource_1</tt>, setting up the tracks in <tt>setDataSource l</tt>, and later creates the <tt>OMXCodec</tt> object for each of the tracks. The audio <tt>OMXCodec</tt> object is given as source object to <tt>AudioPlayer</tt>, which then reads data from it.</p></div>
<div class="paragraph"><p>GStreamer has the same element/pipeline design, but is much more flexible supporting a number of modes of operation and a lot more elements, while Stagefright is simpler and smaller, since it only does exactly what is needed in Android.</p></div>
</div>
<div class="sect4">
<h5 id="_pipeline">Pipeline</h5>
<div class="paragraph"><p>The pipeline in Stagefright is pull-based, meaning that each element deriving from the base class <tt>MediaSource</tt> implements a method <tt>read()</tt>, which when called will block until the <tt>MediaSource</tt> element has produced one <tt>MediaBuffer</tt> which is returned. When the <tt>MediaSource</tt> subclass object is created, it is normally given an upstream <tt>MediaSource</tt> object to read from, e.g. for <tt>OMXCodec</tt>, the <tt>MediaSource</tt> is given as parameter to <tt>OMXCodec::Create()</tt>.</p></div>
<div class="paragraph"><p>For <tt>OMXCodec</tt>, the <tt>read()</tt> method internally reads a packet of compressed data from the source (which might e.g. be <tt>MPEG4Source</tt> within <tt>MPEG4Extractor</tt> in the case above), passes the packet to the actual OpenMAX codec for decoding, and when the decoded raw audio data is available, it is returned by the read() method.</p></div>
<div class="paragraph"><p>Similarly, the <tt>MPEG4Source</tt> object will block in the <tt>read()</tt> method until it has read one packet from the source file, which is then returned to the caller.
With this design, elements can be more or less arbitrarily connected, as long as one element can handle the data type that the input element produces.</p></div>
<div class="paragraph"><p>For pipelines, Stagefright contains these kinds of element implementations:</p></div>
<div class="ulist"><ul>
<li>
<p>
Sources for reading data from a file, or reading raw data from capture devices (e.g. <tt>CameraSource</tt>)
</p>
</li>
<li>
<p>
Extractors, for interpreting different file formats (e.g. <tt>AACExtractor, AMRExtractor, AVIExtractor, MP3Extractor, MPEG4Extractor, OggExtractor, WAVExtractor</tt>)
</p>
</li>
<li>
<p>
<tt>OMXCodec</tt>, for decoding/encoding data • Writers, for producing files of different formats (e.g. <tt>AACWriter, AMR-Writer, MPEG2TSWriter, MPEG4Writer</tt>)
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_other_components">Other components</h5>
<div class="paragraph"><p>In Honeycomb/Ice Cream Sandwich, Stagefright has evolved further, with a second mode of operation in addition to the plain pipeline based system. Now, the <tt>ACodec</tt> class encapsulates an OpenMAX codec with a different kind of abstraction. This class isn’t to be used as a strict pipeline element, thus, it doesn’t implement the <tt>MediaSource</tt> interface. Instead, messages are passed to ACodec (which implements AHandler, for receiving messages) with buffers to pass to the OpenMAX codec. This is more similar to the behavior model of the actual OpenMAX codecs themselves.</p></div>
<div class="paragraph"><p>In addition to the elements, Stagefright contains higher level classes such as AwesomePlayer that coordinates playback of a video file, other utility classes such as color converters, wrapping of OpenMAX codecs (providing a Binder C++ interface around OpenMAX, giving it the possibility to use the codecs from a different process even if the codecs themselves run within the media server), and a number of software implementations of codecs.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/MediaFrameworkComponents.svg" alt="images/MediaFrameworkComponents.svg" />
</div>
<div class="title">Figure 12. An illustration of the general pipeline structure.</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content"><tt>FileSource</tt>, <tt>MPEG4Source</tt> and <tt>OMXCodec</tt> all implement the <tt>MediaSource</tt> interface. <tt>MPEG4Extractor</tt>, <tt>OMXCodec</tt>, <tt>AudioPlayer</tt>, <tt>MediaWriter</tt> all use the <tt>MediaSource</tt> interface for reading their input from the preceding element, of which they don’t need to know anything else than what’s in MediaSource.</td>
</tr></table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/MediaFrameworkPipeline.svg" alt="images/MediaFrameworkPipeline.svg" />
</div>
<div class="title">Figure 13. An example of a pipeline decoding audio and video from an MP4 file.</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/MediaFrameworkArchitecture.svg" alt="images/MediaFrameworkArchitecture.svg" />
</div>
<div class="title">Figure 14. A rough visualization of the split between the application process and media server.</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/MediaFrameworkIOMX.svg" alt="images/MediaFrameworkIOMX.svg" />
</div>
<div class="title">Figure 15. Details of the IOMX interface.</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_openmax_il_5_1_overview">8.8.5. OpenMAX IL 5.1 Overview</h4>
<div class="ulist"><ul>
<li>
<p>
OpenMAX IL is a Khronos specified vendor-independent API for, among other things, providing access to codecs, both audio and video.
</p>
</li>
<li>
<p>
An OpenMAX IL implementation consists of two separate parts a core and a number of components. The core acts as a registry for querying and instantiating the components.
</p>
</li>
<li>
<p>
The component names are usually vendor specific, but each component implements one or more roles that are common among different implementations, e.g. "audio decoder.aac".
</p>
</li>
<li>
<p>
OpenMAX IL components are state machines with a few different states (loaded, idle, executing). The input and output from the component happens via asynchronous buffer passing filled buffers with input data and empty data to fill with decoded/encoded data are passed to the component, and the component asynchronous calls back when an input buffer can be reused, or when an output buffer is filled and can be consumed.
</p>
</li>
<li>
<p>
In general, each vendor provides a core of their own with different library name (e.g. libOMX Core.so, libOmxCore.so, libomxil-bellagio.so) that export the OMX core functions (OMX Init, OMX Deinit, OMX GetHandle and so on)
</p>
</li>
</ul></div>
<div class="sect4">
<h5 id="_openmax_il_in_stagefright">OpenMAX IL in Stagefright</h5>
<div class="paragraph"><p>Stagefright provides wrapping around OMX core implementations. The main client api is called IOMX (<tt>frameworks/base/include/media/IOMX.h</tt>), which is a Binder interface with a proxy (<tt>BpOMX</tt>) and backend (<tt>BnOMX</tt>), allowing the caller and implementation to reside in separate processes. BnOMX is implemented by the <tt>OMX</tt> class in <tt>frameworks/base/media/libstagefright/omx/OMX.cpp</tt>, which uses the <tt>OMXMaster</tt> class in <tt>frameworks/base/media/libstagefright/omx/OMXMaster.cpp</tt> for querying and instantiating components from a number of different implementation sources. <tt>OMXMaster</tt> loads one or more plugins (<tt>OMXPluginBase</tt>, defined in <tt>frameworks/base/include/media/libstagefright/OMXPluginBase.h</tt>) that are analogous to normal OMX IL cores.</p></div>
<div class="paragraph"><p><tt>OMXMaster</tt> loads a shared library named <tt>libstagefrighthw.so</tt>, which should have a function named <tt>ZN7android15createOMXPluginEv(android::createOMXPlugin())</tt> or <tt>createOMXPlugin</tt> (since ICS, both are tried, earlier, only the former was tried), that returns an <tt>OMXPluginBase</tt> pointer when called.</p></div>
<div class="paragraph"><p>This library, <tt>libstagefrighthw.so</tt>, is vendor specific. Examples of implementations of this library, wrapping a normal OMX IL core, are available in:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>hardware/qcom/media/libstagefrighthw/QComOMXPlugin.cpp</tt>
</p>
</li>
<li>
<p>
<tt>hardware/ti/omap3/libstagefrighthw/TIOMXPlugin.cpp</tt>
</p>
</li>
<li>
<p>
<tt>hardware/ti/omap4xxx/libstagefrighthw/TIOMXPlugin.cpp</tt> (ICS only)
</p>
</li>
</ul></div>
<div class="paragraph"><p>All of these are very similar they simply load an OMX core from a shared library, load the OMX core function pointers from the library, and map the <tt>OMXPluginBase</tt> methods to the OMX core.</p></div>
<div class="paragraph"><p>For software codecs, there’s no full proper OMX IL core in ICS, all decoders are mapped straight from the <tt>OMXPluginBase,</tt> implemented in <tt>frameworks/base/media/libstagefright/omx/SoftOMXPlugin.cpp</tt>. All software encoders (and in gingerbread, all software decoders too) are hooked up directly from the <tt>OMXCodec</tt> class, where the direct constructors of the software encoder classes are called, without any indirection via OMX like interfaces these software codecs implement the <tt>MediaSource</tt> interface directly. Due to this, these codecs cannot be accessed via the IOMX layer.</p></div>
<div class="paragraph"><p>The development seems to be moving towards the OMX interfaces namely, in ICS, the software decoders have been converted to use OMX. The new ACodec class in ICS only uses codecs via the OMX interfaces.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_a_custom_openmax_il_plugin">8.8.6. Adding a custom OpenMAX IL plugin</h4>
<div class="sect4">
<h5 id="_implement_an_omx_core_for_the_codecs">Implement an OMX core for the codecs</h5>
<div class="paragraph"><p>Examples:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>hardware/qcom/media/mm-core/omxcore</tt>
</p>
</li>
<li>
<p>
<tt>hardware/ti/omap3/omx/system/src/openmax_il</tt>
</p>
</li>
<li>
<p>
<tt>hardware/ti/omap4xxx/domx/omx_core</tt> (ICS only)
</p>
</li>
<li>
<p>
<tt>device/samsung/crespo/sec_mm/sec_omx/sec_omx_core</tt> (Gingerbread only)
</p>
</li>
</ul></div>
<div class="paragraph"><p>The OMX core acts as a registry for the available codecs. If the build configuration already contains a vendor specific OMX core, the new OMX components can either be added to this OMX core, or a new separate OMX core can be added.</p></div>
</div>
<div class="sect4">
<h5 id="_build_tt_libstagefrighthw_tt">Build <tt>libstagefrighthw</tt></h5>
<div class="paragraph"><p>Build <tt>libstagefright</tt>, containing an <tt>OMXPluginBase</tt> implementation that loads the OMX core.
Examples:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>hardware/qcom/media/libstagefrighthw/QComOMXPlugin.cpp</tt>
</p>
</li>
<li>
<p>
<tt>hardware/ti/omap3/libstagefrighthw/TIOMXPlugin.cpp</tt>
</p>
</li>
<li>
<p>
<tt>hardware/ti/omap4xxx/libstagefrighthw/TIOMXPlugin.cpp</tt> (ICS only)
</p>
</li>
<li>
<p>
<tt>device/samsung/crespo/libstagefrighthw/SEC OMX Plugin.cpp</tt> (Gingerbread only)
</p>
</li>
</ul></div>
<div class="paragraph"><p>If one chooses to add a second OMX core, a second <tt>libstagefrighthw</tt> (with a slightly different name) has to be created, and this also requires modifications to <tt>frameworks/base/media/libstagefright/omx/OMXMaster.cpp</tt>, in order to be able to handle two different vendor libraries at the same time. Therefore, it’s probably best to integrate new components within the current vendor OMX core if one already exists.</p></div>
</div>
<div class="sect4">
<h5 id="_implement_omx_components_for_the_codecs">Implement OMX components for the codecs</h5>
<div class="paragraph"><p>This is the actual wrapping of the codecs. Simple examples (which don’t use the proper real OMX API but only stagefright’s own internal API) are available in</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>frameworks/base/media/libstagefright/omx/SoftOMXComponent.cpp</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/media/libstagefright/omx/SimpleSoftOMXComponent.cpp</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/media/libstagefright/codecs/aacdec/SoftAAC.cpp</tt>
</p>
</li>
</ol></div>
<div class="paragraph"><p>These contain all the logic any OMX component needs to have, but the external API isn’t the proper public OMX version, but only stagefright-internal ones. Real implementations with the proper public OMX API are available in e.g.:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>hardware/ti/omap3/omx/audio/src/openmax il/aac_dec</tt>
</p>
</li>
<li>
<p>
<tt>hardware/qcom/media/mm-video/vidc/vdec</tt>
</p>
</li>
<li>
<p>
<tt>device/samsung/crespo/sec_mm/sec_omx/sec_omx-component/video/dec/h264dec</tt> (Gingerbread only)
</p>
</li>
<li>
<p>
<a href="http://omxil.sourceforge.net/">http://omxil.sourceforge.net/</a> a full software OMX IL implementation
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_register_the_new_omx_components">Register the new OMX components</h5>
<div class="paragraph"><p>Register the new OMX components in <tt>frameworks/base/media/libstagefright/OMXCodec.cpp</tt>. Simply add the component names and the mime types it handles in the <tt>kDecoderInfo/kEncoderInfo</tt> tables. (OMXCodec in stagefright doesn’t query for which components implement certain roles, but blindly checks for all the components listed to support a certain mime type, and uses the first one that actually exists.)</p></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_telephony">8.9. Telephony</h3>
<div class="paragraph"><p>In this section, we&#8217;ll explore the inter-workings of the telephony stack. We&#8217;ll start with the standard Android Phone app, and trace the execution of placing a call all the way down to RIL daemon.</p></div>
<div class="sect3">
<h4 id="_telephony_manager">8.9.1. Telephony Manager</h4>
<div class="paragraph"><p>Android Framework provides the Telephony Manager class in <tt>android.telephony</tt> package. The Telephony Manager allows you to monitor the state of the mobile network connection. However, Telephony Manager does not allow you to place or manage any calls. Only the Phone app can initiate and answer phone calls.</p></div>
</div>
<div class="sect3">
<h4 id="_phone_app">8.9.2. Phone App</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Some of this content comes from the actual AOSP source code, licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2 License</a>.</td>
</tr></table>
</div>
<div class="imageblock" id="Telephony_Architecture">
<div class="content">
<img src="images/TelephonyArchitecture.svg" alt="images/TelephonyArchitecture.svg" />
</div>
<div class="title">Figure 16. Android Telephony Architecture Diagram</div>
</div>
<div class="sect4">
<h5 id="_overview_5">Overview</h5>
<div class="paragraph"><p>Phone app does come with some UI components, such as the dialer, but the most significant part is its handling of <tt>CALL</tt> and <tt>CALL_PRIVILEGED</tt> intents to do the actual dialing of a number.</p></div>
</div>
<div class="sect4">
<h5 id="_outgoingcallbroadcaster">OutgoingCallBroadcaster</h5>
<div class="paragraph"><p><tt>OutgoingCallBroadcaster</tt> activity receives <tt>CALL</tt> and <tt>CALL_PRIVILEGED</tt> Intents, and broadcasts the <tt>ACTION_NEW_OUTGOING_CALL</tt> intent which allows other applications to monitor, redirect, or prevent the outgoing call. After the other applications have had a chance to see the <tt>ACTION_NEW_OUTGOING_CALL</tt> intent, it finally reaches the <tt>OutgoingCallReceiver</tt>, which passes the (possibly modified) intent on to the  <tt>SipCallOptionHandler</tt>, which will ultimately start the call using the <tt>CallController.placeCall()</tt> API.</p></div>
</div>
<div class="sect4">
<h5 id="_callcontroller">CallController</h5>
<div class="paragraph"><p><tt>CallController</tt> handler is the phone app module in charge of <em>call control</em>.
This is a singleton object which acts as the interface to the telephony layer (and other parts of the Android framework) for all user-initiated telephony functionality, like making outgoing calls.</p></div>
<div class="paragraph"><p>This functionality includes things like:</p></div>
<div class="ulist"><ul>
<li>
<p>
actually running the placeCall() method and handling errors or retries
</p>
</li>
<li>
<p>
running the whole "emergency call in airplane mode" sequence
</p>
</li>
<li>
<p>
running the state machine of MMI sequences
</p>
</li>
<li>
<p>
restoring/resetting mute and speaker state when a new call starts
</p>
</li>
<li>
<p>
updating the proximity sensor wake lock state
</p>
</li>
<li>
<p>
resolving what the voicemail: intent should mean (and making the call)
</p>
</li>
</ul></div>
<div class="paragraph"><p>The single CallController instance stays around forever; it&#8217;s not tied to the lifecycle of any particular Activity (like the InCallScreen). There&#8217;s also no implementation of onscreen UI here (that&#8217;s all in InCallScreen).</p></div>
<div class="paragraph"><p>Note that this class does not handle asynchronous events from the telephony layer, like reacting to an incoming call; see CallNotifier for that.  This class purely handles actions initiated by the user, like outgoing calls.</p></div>
<div class="paragraph"><p><tt>placeCall(Intent intent)</tt> initiates an outgoing call.</p></div>
<div class="paragraph"><p>Here&#8217;s the most typical outgoing call sequence:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
OutgoingCallBroadcaster receives a <tt>CALL</tt> intent and sends the <tt>NEW_OUTGOING_CALL</tt> broadcast.
</p>
</li>
<li>
<p>
The broadcast finally reaches <tt>OutgoingCallReceiver</tt>, which stashes away a copy of the original <tt>CALL</tt> intent and launches <tt>SipCallOptionHandler</tt>.
</p>
</li>
<li>
<p>
SipCallOptionHandler decides whether this is a PSTN or SIP call (and in some cases brings up a dialog to let the user choose), and ultimately calls CallController.placeCall() (from the setResultAndFinish() method) with the stashed-away intent from step (2) as the "intent" parameter.
</p>
</li>
<li>
<p>
Here in <tt>CallController.placeCall()</tt> we read the phone number or SIP address out of the intent and actually initiate the call, and simultaneously launch the <tt>InCallScreen</tt> to display the in-call UI.
</p>
</li>
<li>
<p>
We handle various errors by directing the <tt>InCallScreen</tt> to display error messages or dialogs (via the <tt>InCallUiState</tt> "pending call status code" flag), and in some cases we also sometimes continue working in the background to resolve the problem (like in the case of an emergency call while in airplane mode).  Any time that some onscreen indication to the user needs to change, we update the "status dialog" info in the <tt>inCallUiState</tt> and (re)launch the <tt>InCallScreen</tt> to make sure it&#8217;s visible.
</p>
</li>
</ol></div>
</div>
<div class="sect4">
<h5 id="_phoneutils">PhoneUtils</h5>
<div class="paragraph"><p><tt>PhoneUtils.placeCall(Context context, Phone phone, String number, Uri contactRef, boolean isEmergencyCall, Uri gatewayUri)</tt> dials the number using the <tt>phone</tt> passed in.</p></div>
</div>
<div class="sect4">
<h5 id="_callmanager">CallManager</h5>
<div class="paragraph"><p><tt>CallManager</tt>, defined in <tt>PhoneApp</tt> class.</p></div>
<div class="paragraph"><p><tt>CallManager</tt> class provides an abstract layer for <tt>PhoneApp</tt> to access and control calls. It implements <tt>Phone</tt> interface.</p></div>
<div class="paragraph"><p><tt>CallManager</tt> provides call and connection control as well as channel capability.</p></div>
<div class="paragraph"><p>There are three categories of APIs <tt>CallManager</tt> provided</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Call control and operation, such as <tt>dial()</tt> and <tt>hangup()</tt>
</p>
</li>
<li>
<p>
Channel capabilities, such as <tt>CanConference()</tt>
</p>
</li>
<li>
<p>
Register notification
</p>
</li>
</ol></div>
<div class="paragraph"><p><tt>public Connection dial(Phone phone, String dialString)</tt> in CallManager initiate a new voice connection. This happens asynchronously, so you cannot assume the audio path is connected (or a call index has been assigned) until PhoneStateChanged notification has occurred.</p></div>
<div class="paragraph"><p><tt>dial()</tt> uses <tt>PhoneProxy</tt> to implement <tt>Phone</tt> interface to make the call.</p></div>
</div>
<div class="sect4">
<h5 id="_phone_interface">Phone Interface</h5>
<div class="paragraph"><p><tt>Phone</tt> interface specifies the capabilities of the underlying phone system, weather GSM, CDMA, or SIP. We&#8217;ll assume GMS from here on.</p></div>
</div>
<div class="sect4">
<h5 id="_gsmphone">GSMPhone</h5>
<div class="paragraph"><p><tt>GSMPhone</tt> extends <tt>PhoneBase</tt> which in turn implements the <tt>Phone</tt> interface.</p></div>
<div class="paragraph"><p>It uses <tt>GSMCallTracker</tt> to dial via <tt>CommandsInterface</tt>. This interface is implemented by <tt>RIL</tt> class.</p></div>
<div class="paragraph"><p><tt>RIL</tt> in turn uses <tt>RILRequest</tt> to send the requests to <tt>rild</tt> daemon.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">You can use <tt>adb logcat -b radio</tt> to see the radio-specific log messages.</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_ril_java">RIL (Java)</h5>
<div class="paragraph"><p><tt>RIL</tt> class is the implementation of the <tt>CommandsInterface</tt> that <tt>GSMPhone</tt> uses to dial out. This Java implementation writes out the commands to RIL daemon, the native code.</p></div>
<div class="paragraph"><p><tt>RIL</tt> uses <tt>RILSender</tt> and <tt>RILReceiver</tt> to send and receive messages from <tt>rild</tt> - the RIL Daemon. Unlike most of the other Android system services, RIL uses sockets for this inter-process communication, and not the Binder.</p></div>
</div>
<div class="sect4">
<h5 id="_ril_daemon">RIL Daemon</h5>
<div class="paragraph"><p>The RIL consists of two primary components:</p></div>
<div class="ulist"><ul>
<li>
<p>
RIL Daemon: The RIL daemon initializes the Vendor RIL, processes all communication from Android telephony services, and dispatches calls to the Vendor RIL as solicited commands.
</p>
</li>
<li>
<p>
Vendor RIL: The radio-specific Vendor RIL of ril.h that processes all communication with radio hardware and dispatches calls to the RIL Daemon (rild) through unsolicited commands.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Some of the following documentation comes from once available <em>Android Platform Development Kit: Radio Layer Interface</em> documentation. This documentation is no longer readily available from Google (deemed outdated) but is licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 license</a>. We&#8217;ve updated the references as originally provided.</td>
</tr></table>
</div>
</div>
<div class="sect4">
<h5 id="_ril_initialization">RIL Initialization</h5>
<div class="paragraph"><p>Android initializes the telephony stack and the Vendor RIL at startup as described in the sequence below:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
RIL daemon reads <tt>rild.lib</tt> path and <tt>rild.libargs</tt> system properties to determine the Vendor RIL library to use and any initialization arguments to provide to the Vendor RIL.
</p>
</li>
<li>
<p>
RIL daemon loads the Vendor RIL library and calls <tt>RIL_Init</tt> to initialize the RIL and obtain a reference to RIL functions.
</p>
</li>
<li>
<p>
RIL daemon calls <tt>RIL_register</tt> on the Android telephony stack, providing a reference to the Vendor RIL functions
</p>
</li>
</ol></div>
<div class="paragraph"><p>Details of this implementation are available in <tt>AOSP/hardware/ril/rild/rild.c</tt>.</p></div>
</div>
<div class="sect4">
<h5 id="_ril_interaction">RIL Interaction</h5>
<div class="paragraph"><p>There are two forms of communication that the RIL handles:</p></div>
<div class="ulist"><ul>
<li>
<p>
Solicited commands: Solicited commands originated by RIL lib, such as <tt>DIAL</tt> and <tt>HANGUP</tt>.
</p>
</li>
<li>
<p>
Unsolicited responses: Unsolicited responses that originate from the baseband, such as <tt>CALL_STATE_CHANGED</tt> and <tt>NEW_SMS</tt>.
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_solicited_ril_commands">Solicited RIL Commands</h5>
<div class="paragraph"><p>The following snippet illustrates the interface for solicited commands:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>void OnRequest (int request_id, void *data, size_t datalen, RIL_Token t);</tt>
</p>
</li>
<li>
<p>
<tt>void OnRequestComplete (RIL_Token t, RIL_Error e, void *response, size_t responselen);</tt>
</p>
</li>
</ul></div>
<div class="imageblock">
<div class="content">
<img src="images/RIL-solicited-commands.png" alt="images/RIL-solicited-commands.png" />
</div>
<div class="title">Figure 17. Example of solicited RIL commands</div>
</div>
<div class="paragraph"><p>There are over sixty solicited commands grouped by the following families:</p></div>
<div class="ulist"><ul>
<li>
<p>
SIM PIN, IO, and IMSI/IMEI (11)
</p>
</li>
<li>
<p>
Call status and handling (dial, answer, mute…) (16)
</p>
</li>
<li>
<p>
Network status query (4)
</p>
</li>
<li>
<p>
Network setting (barring, forwarding, selection…) (12)
</p>
</li>
<li>
<p>
SMS (3)
</p>
</li>
<li>
<p>
PDP connection (4)
</p>
</li>
<li>
<p>
Power and reset (2)
</p>
</li>
<li>
<p>
Supplementary Services (5)
</p>
</li>
<li>
<p>
Vendor defined and support (4)
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_unsolicited_ril_commands">Unsolicited RIL Commands</h5>
<div class="paragraph"><p>The following snippet illustrates the interface for unsolicited commands:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>void OnUnsolicitedResponse (int unsolResponse, void *data, size_t datalen);</tt>
</p>
</li>
</ul></div>
<div class="imageblock">
<div class="content">
<img src="images/RIL-unsolicited-commands.png" alt="images/RIL-unsolicited-commands.png" />
</div>
<div class="title">Figure 18. Example of unsolicited RIL commands</div>
</div>
<div class="paragraph"><p>There are over ten unsolicited commands grouped by the following families:</p></div>
<div class="ulist"><ul>
<li>
<p>
Network status changed (4)
</p>
</li>
<li>
<p>
New SMS notify (3)
</p>
</li>
<li>
<p>
New USSD notify (2)
</p>
</li>
<li>
<p>
Signal strength or time changed (2)
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_implementing_the_ril">Implementing the RIL</h5>
<div class="paragraph"><p>To implement a radio-specific RIL, create a shared library that implements a set of functions required by Android to process radio requests. The required functions are defined in the RIL header (<tt>AOSP/hardware/ril/include/telephony/ril.h</tt>).</p></div>
<div class="paragraph"><p>The Android radio interface is radio-agnostic and the Vendor RIL can use any protocol to communicate with the radio. Android provides a reference Vendor RIL, using the Hayes AT command set, that you can use as a quick start for telephony testing and a guide for commercial vendor RILs. The source code for the reference RIL is found at <tt>AOSP/hardware/ril/reference-ril</tt>.</p></div>
<div class="paragraph"><p>Compile your Vendor RIL as a shared library using the convention <tt>libril-&lt;companyname&gt;-&lt;RIL version&gt;.so</tt>, for example, <tt>libril-acme-124.so</tt>, where:</p></div>
<div class="ulist"><ul>
<li>
<p>
libril: all vendor RIL implementations start with <tt>libril</tt>
</p>
</li>
<li>
<p>
<tt>&lt;companyname&gt;</tt>: a company-specific abbreviation
</p>
</li>
<li>
<p>
<tt>&lt;RIL version&gt;</tt>: RIL version number
</p>
</li>
<li>
<p>
so: standard file extension for shared objects in Linux
</p>
</li>
</ul></div>
<div class="paragraph"><p>For reference implementation of RIL, see <tt>AOSP/hardware/ril/libril</tt>.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_links_4">8.9.3. Links</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.linuxjournal.com/magazine/java-api-androids-telephony-stack">Linux Journal: The Java API to Android&#8217;s Telephony Stack</a>
</p>
</li>
<li>
<p>
<a href="http://androidapps.org.ua/i_sect18_d1e18369.html">Android Application Development, by Rick Rogers and John Lombardo</a>
</p>
</li>
<li>
<p>
<a href="http://www.netmite.com/android/mydroid/development/pdk/docs/telephony.html">The old official documentation of RIL no longer officially available</a>
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/Hayes_command_set">Hayes command set</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_device_policy_service">8.10. Device Policy Service</h3>
<div class="imageblock">
<div class="content">
<img src="images/DevicePolicyServiceArchitecture.svg" alt="images/DevicePolicyServiceArchitecture.svg" />
</div>
<div class="title">Figure 19. Device Policy Service Architecture</div>
</div>
</div>
<div class="sect2">
<h3 id="_surface_flinger">8.11. Surface Flinger</h3>
<div class="imageblock">
<div class="content">
<img src="images/SurfaceFlingerArchitecture.svg" alt="images/SurfaceFlingerArchitecture.svg" />
</div>
<div class="title">Figure 20. SurfaceFlinger Architecture</div>
</div>
<div class="ulist"><ul>
<li>
<p>
SurfaceFlinger - Android low-level graphics compositor
</p>
<div class="ulist"><ul>
<li>
<p>
Started from <tt>frameworks/base/cmds/surfaceflinger/main_surfaceflinger.cpp</tt>
</p>
</li>
<li>
<p>
Registers with Binder as <tt>android.ui.ISurfaceComposer</tt> under "SurfaceFlinger" name
</p>
</li>
<li>
<p>
Provides direct write access to framebuffer (<tt>/dev/graphics/fb0</tt>) memory
</p>
</li>
<li>
<p>
Surfaces are Z-Ordered into layers, and alpha blended via OpenGL ES
</p>
</li>
</ul></div>
</li>
<li>
<p>
3D via EGL/OpenGL ES 1.0/2.0
</p>
<div class="ulist"><ul>
<li>
<p>
1.0 is can be rendered by the CPU by a software renderer though it can be accelerated by <em>Copybit</em>
</p>
</li>
<li>
<p>
2.0 is GPU-only
</p>
</li>
<li>
<p>
OpenGL from Java is provided by JSR 239 plus a JNI wrapper to the native OpenGL
</p>
</li>
</ul></div>
</li>
<li>
<p>
Gralloc module - used by SurfaceFlinger to allocate and map graphics memory to processes (for 2D and 3D rendering)
</p>
<div class="ulist"><ul>
<li>
<p>
Memory is allocated from the Unified Memory Provider (UMP) device driver and accessed through a secure ID
</p>
</li>
<li>
<p>
Memory can be shared  (via Binder) across applications, drivers, and hardware components to enable zero-copy operations
</p>
</li>
<li>
<p>
Gralloc provides physical address info required to set up MMU/MPU table
</p>
</li>
<li>
<p>
Gralloc enables mapping of UMP memory into CPU address space to fascinate reading and writing
</p>
</li>
<li>
<p>
Definition at <tt>hardware/libhardware/include/hardware/gralloc.h</tt>
</p>
</li>
<li>
<p>
Implementation is typically proprietary (co-owned by SoC/GPU vendors)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Refresh rate depends on VSYNC
</p>
<div class="ulist"><ul>
<li>
<p>
Missing a VSYNC halves the refresh rate
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_initialization">8.11.1. Initialization</h4>
<div class="listingblock">
<div class="content">
<pre><tt>frameworks/base/cmds/surfaceflinger/main_surfaceflinger.cpp:
  SurfaceFlinger::publishAndJoinThreadPool();</tt></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_getting_something_to_draw_on">8.11.2. Getting something to draw on</h4>
<div class="listingblock">
<div class="content">
<pre><tt>Surface()
  native Surface.init() ==&gt; android_view_Surface.c Surface_init()
    SurfaceComposerClient::onFirstRef()
      ComposerService::getComposerService() -- singleton


    SurfaceComposerClient::createSurface()
      ISurfaceComposerClient::createSurface() -&gt; SurfaceControl

Surface.lockCanvas()
  native Surface.lockCanvasNative ==&gt; android_view_Surface.c Surface_lockCanvas() -&gt; Canvas (SkCanvas)</tt></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_drawing">8.11.3. Drawing</h4>
<div class="listingblock">
<div class="content">
<pre><tt>Canvas.drawLine()
  native Canvas.native_drawLine() ==&gt; Canvas.cpp SkCanvasGlue::drawLine__FFFFPaint()
    SkCanvas::drawLine
      SkCanvas::drawPoints
        SkDevice::drawPoints
          SkDraw::drawPoints</tt></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_displaying_what_we_drew_on">8.11.4. Displaying what we drew on</h4>
<div class="listingblock">
<div class="content">
<pre><tt>native Surface.unlockCanvasAndPost() ==&gt; android_view_Surface.c Surface_unlockCanvasAndPost()
  Surface::unlockAndPost
    SurfaceTextureClient::unlockAndPost
      SurfaceTextureClient::queueBuffer
        SurfaceTexture::queueBuffer
          FrameAvailableListener::onFrameAvailable (interface)
            Layer::onFrameQueued
              SurfaceFlinger::signalEvent
                MessageQueue::invalidate
                …
                SurfaceFlinger::waitForEvent returns
              SurfaceFlinger::threadLoop unblocks
                SurfaceFlinger::handlePageFlip
                SurfaceFlinger::handleRepaint
                DisplayHardware::compositionComplete
                  FramebufferNativeWindow::compositionComplete

                SurfaceFlinger::postFramebuffer
                  DisplayHardware::flip</tt></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_other">8.11.5. Other</h4>
<div class="listingblock">
<div class="content">
<pre><tt>ANativeWindow (core/include/system/window.h) can be either:
  FramebufferNativeWindow
  SurfaceTextureClient
    Surface

FramebufferNativeWindow::queueBuffer
  framebuffer_device_t::post</tt></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_links_5">8.11.6. Links</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://people.debian.org.tw/~olv/surfaceflinger/surfaceflinger.pdf">http://people.debian.org.tw/~olv/surfaceflinger/surfaceflinger.pdf</a> (outdated)
</p>
</li>
<li>
<p>
<a href="http://www.khronos.org/opengles/">http://www.khronos.org/opengles/</a> (OpenGL ES)
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/OpenGL">http://en.wikipedia.org/wiki/OpenGL</a>
</p>
</li>
<li>
<p>
<a href="http://en.wikipedia.org/wiki/EGL_(EGL">http://en.wikipedia.org/wiki/EGL_(EGL</a>)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<a href="http://www.vivantecorp.com/Khronos.pdf">http://www.vivantecorp.com/Khronos.pdf</a> ("High Performance Graphics on Android")
</p>
</li>
<li>
<p>
<a href="http://jcp.org/en/jsr/detail?id=239">http://jcp.org/en/jsr/detail?id=239</a> (JSR 239)
</p>
</li>
<li>
<p>
<a href="http://jsharkey.org/blog/2010/07/01/android-surfaceflinger-tricks-for-fun-and-profit/">http://jsharkey.org/blog/2010/07/01/android-surfaceflinger-tricks-for-fun-and-profit/</a>
</p>
</li>
<li>
<p>
<a href="http://www.malideveloper.com/developer-resources/drivers/open-source-mali-gpus-android-gralloc-module.php">http://www.malideveloper.com/developer-resources/drivers/open-source-mali-gpus-android-gralloc-module.php</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_camera_service">8.12. Camera Service</h3>
<div class="paragraph"><p>See <a href="http://marakana.com/static/courseware/android/Aptina-Android-Camera-Internals.pdf">http://marakana.com/static/courseware/android/Aptina-Android-Camera-Internals.pdf</a></p></div>
<div class="sect3">
<h4 id="_links_6">8.12.1. Links</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.kandroid.org/online-pdk/guide/camera.html">http://www.kandroid.org/online-pdk/guide/camera.html</a> (outdated)
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Android_Customization">9. Customizing Android</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
In this section, we will create:
</p>
<div class="ulist"><ul>
<li>
<p>
a custom Android device (ROM), we&#8217;ll call it <em>Marakana Alpha</em>
</p>
</li>
<li>
<p>
and a custom Android SDK add-on, that will enable 3rd party developers to develop for our custom device
</p>
</li>
</ul></div>
</li>
<li>
<p>
The following diagrams includes some of the custom components we&#8217;ll be creating for <em>Marakana Alpha</em>:
</p>
<div class="imageblock">
<div class="content">
<img src="images/MarakanaAlphaDeviceCustomComponents.svg" alt="images/MarakanaAlphaDeviceCustomComponents.svg" />
</div>
</div>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The following steps assume building Android ICS 4.0.3/4 for ARMv7 on Ubuntu 10.04 x86_64 and that the Android sources are available under <tt>~/ics/</tt> directory (for the current user).</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The complete code (which we&#8217;ll develop in this section) for Marakana Alpha is available at <a href="https://github.com/marakana/alpha">https://github.com/marakana/alpha</a><br />
The code for Marakana Alpha SDK add-on is available <a href="https://github.com/marakana/alpha_sdk_addon">https://github.com/marakana/alpha_sdk_addon</a></td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_setting_up_custom_device_directory_structure">9.1. Setting up Custom Device Directory Structure</h3>
<div class="paragraph"><p>While we could overlay our device&#8217;s custom components over the existing AOSP source tree, that makes it harder to deal with future OS upgrades.
Instead, we will create a <strong>self-contained</strong> directory structure to host our device.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create our vendor (e.g. <em>mararkana</em>) directory
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/</tt></pre>
</div></div>
</li>
<li>
<p>
Now create our device (e.g. <em>alpha</em>) sub-directory:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha</tt></pre>
</div></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_registering_our_device_with_android_8217_s_build_system">9.2. Registering our Device with Android&#8217;s Build System</h3>
<div class="paragraph"><p>We now want to add our device to the Android&#8217;s <em>lunch</em> list</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Remember that <tt>$ source build/envsetup.sh</tt> registers lunch combos that we can later build</td>
</tr></table>
</div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create <tt>vendorsetup.sh</tt> file for our device (the name of this file is fixed):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/vendorsetup.sh</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>add_lunch_combo full_marakana_alpha-eng</tt></pre></div></div>
</li>
<li>
<p>
Re-build the lunch list:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ source build/envsetup.sh
including device/marakana/alpha/vendorsetup.sh
including device/moto/stingray/vendorsetup.sh
including device/moto/wingray/vendorsetup.sh
including device/samsung/crespo4g/vendorsetup.sh
including device/samsung/crespo/vendorsetup.sh
including device/samsung/maguro/vendorsetup.sh
including device/samsung/torospr/vendorsetup.sh
including device/samsung/toro/vendorsetup.sh
including device/samsung/tuna/vendorsetup.sh
including device/ti/panda/vendorsetup.sh
including sdk/bash_completion/adb.bash</tt></pre>
</div></div>
</li>
<li>
<p>
Finally, we can check to see that our device now appear in the lunch menu:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ lunch

You're building on Linux

Lunch menu... pick a combo:
     1. full-eng
     2. full_x86-eng
     3. vbox_x86-eng
     4. full_marakana_alpha-eng
     5. full_stingray-userdebug
     6. full_wingray-userdebug
     7. full_crespo4g-userdebug
     8. full_crespo-userdebug
     9. full_maguro-userdebug
     10. full_torospr-userdebug
     11. full_toro-userdebug
     12. full_tuna-userdebug
     13. full_panda-eng

Which would you like? [full-eng]</tt></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
We are <strong>not yet ready</strong> to select it here, because we have not yet provided the necessary makefiles for <tt>full_marakana_alpha</tt>. If we do, we&#8217;ll get:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ lunch 3
build/core/product_config.mk:203: *** No matches for product "full_marakana_alpha".  Stop.

** Don't have a product spec for: 'full_marakana_alpha'
** Do you have the right repo manifest?</tt></pre>
</div></div>
</li>
</ul></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_adding_the_makefile_plumbing_for_our_device">9.3. Adding the Makefile Plumbing for our Device</h3>
<div class="paragraph"><p>We now need to add basic support for building our device.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Start by creating a our own <tt>AndroidProducts.mk</tt> file, which simply defines the actual makefiles to be used when building our device:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/AndroidProducts.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">PRODUCT_MAKEFILES :=</span> <span style="color: #009900">$(LOCAL_DIR)</span>/full_alpha.mk</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The only purpose of <tt>AndroidProducts.mk</tt> file (whose name is fixed) is to set <tt>PRODUCT_MAKEFILES</tt> to a list of product makefiles to expose to the build system.  The only external variable it can use is <tt>LOCAL_DIR</tt>, whose value will be automatically set to the directory containing this file.</td>
</tr></table>
</div>
</li>
<li>
<p>
Create the main build-file for our device (we call it <tt>full_alpha</tt> following the example from <tt>device/samsung/crespo/full_crespo.mk</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/full_alpha.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Defines a list of languages to be supported by our device</span></span>
<span style="color: #009900">$(</span>call inherit-product<span style="color: #990000">,</span> <span style="color: #009900">$(SRC_TARGET_DIR)/product/languages_small.mk)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Defines the rules for building the base Android platform,</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># but itself is not specialized for any particular device</span></span>
<span style="color: #009900">$(</span>call inherit-product<span style="color: #990000">,</span> <span style="color: #009900">$(SRC_TARGET_DIR)/product/generic.mk)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Discard inherited values and use our own instead.</span></span>
<span style="color: #990000">PRODUCT_NAME :=</span> full_marakana_alpha
<span style="color: #990000">PRODUCT_DEVICE :=</span> alpha
<span style="color: #990000">PRODUCT_MODEL :=</span> Full Marakana Alpha Image <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> Emulator
</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note inheriting from an existing product</div>
<div class="paragraph"><p>Our device inherits from the <tt>generic</tt> product:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$(call inherit-product, $(SRC_TARGET_DIR)/product/generic.mk)</tt></pre>
</div></div>
<div class="paragraph"><p>which resolves to <tt>build/target/product/generic.mk</tt> file.</p></div>
<div class="paragraph"><p>This <em>generic</em> product (file) in turn inherits from:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>build/target/product/generic_no_telephony.mk</tt>
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>frameworks/base/data/fonts/fonts.mk</tt>
</p>
</li>
<li>
<p>
<tt>external/lohit-fonts/fonts.mk</tt>
</p>
</li>
<li>
<p>
<tt>frameworks/base/data/keyboards/keyboards.mk</tt>
</p>
</li>
<li>
<p>
<tt>build/target/product/core.mk</tt>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<tt>build/target/product/telephony.mk</tt>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The combination of these files set up compilation rules that define what gets included in the final product.</p></div>
</td>
</tr></table>
</div>
</li>
<li>
<p>
Next, we&#8217;ll import some boiler-plate make/support files from the "generic" board - since our device will run on the emulator:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cp build/target/board/generic/BoardConfig.mk device/marakana/alpha/.
$ cp build/target/board/generic/AndroidBoard.mk device/marakana/alpha/.
$ cp build/target/board/generic/device.mk device/marakana/alpha/.
$ cp build/target/board/generic/system.prop device/marakana/alpha/.</tt></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<tt>AndroidBoard.mk</tt> - is essentially empty
</p>
</li>
<li>
<p>
<tt>device.mk</tt> - sets up basic emulator-specific configuration files
</p>
</li>
<li>
<p>
<tt>system.prop</tt> - used to set system-wide properties (here, just RIL settings for the emulator)
</p>
</li>
<li>
<p>
<tt>BoardConfig.mk</tt> - defines our device board&#8217;s kernel/hardware capabilities:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/BoardConfig.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># config.mk</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Product-specific compile-time definitions.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># The generic product target doesn't have any hardware-specific pieces.</span></span>
<span style="color: #990000">TARGET_NO_BOOTLOADER :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #990000">TARGET_NO_KERNEL :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Note: we build the platform images for ARMv7-A _without_ NEON.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Technically, the emulator supports ARMv7-A _and_ NEON instructions, but</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># emulated NEON code paths typically ends up 2x slower than the normal C code</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># it is supposed to replace (unlike on real devices where it is 2x to 3x</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># faster).</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># What this means is that the platform image will not use NEON code paths</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># that are slower to emulate. On the other hand, it is possible to emulate</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># application code generated with the NDK that uses NEON in the emulator.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="color: #990000">TARGET_ARCH_VARIANT :=</span> armv7-a
<span style="color: #990000">TARGET_CPU_ABI :=</span> armeabi-v7a
<span style="color: #990000">TARGET_CPU_ABI2 :=</span> armeabi

<span style="color: #990000">HAVE_HTC_AUDIO_DRIVER :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
<span style="color: #990000">BOARD_USES_GENERIC_AUDIO :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># no hardware camera</span></span>
<span style="color: #990000">USE_CAMERA_STUB :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Set /system/bin/sh to ash, not mksh, to make sure we can switch back.</span></span>
<span style="color: #990000">TARGET_SHELL :=</span> ash

<span style="font-style: italic"><span style="color: #9A1900"># Enable dex-preoptimization to speed up the first boot sequence</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># of an SDK AVD. Note that this operation only works on Linux for now</span></span>
ifeq <span style="color: #990000">(</span><span style="color: #009900">$(HOST_OS),linux)</span>
<span style="color: #990000">WITH_DEXPREOPT :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
endif

<span style="font-style: italic"><span style="color: #9A1900"># Build OpenGLES emulation guest and host libraries</span></span>
<span style="color: #990000">BUILD_EMULATOR_OPENGL :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># Build and enable the OpenGL ES View renderer. When running on the emulator,</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the GLES renderer disables itself if host GL acceleration isn't available.</span></span>
<span style="color: #990000">USE_OPENGL_RENDERER :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about CPU Architecture</div>
<div class="paragraph"><p>Because we copied <tt>build/target/board/generic/BoardConfig.mk</tt> we inherited the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>TARGET_ARCH_VARIANT := armv7-a
TARGET_CPU_ABI := armeabi-v7a
TARGET_CPU_ABI2 := armeabi</tt></pre>
</div></div>
<div class="paragraph"><p>Alternatively, we could have built our image for x86, either by copying <tt>build/target/board/generic_x86/BoardConfig.mk</tt> or by changing our own <tt>device/marakana/alpha/BoardConfig.mk</tt> to say the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>TARGET_ARCH := x86
TARGET_ARCH_VARIANT := x86-atom
TARGET_CPU_ABI := x86</tt></pre>
</div></div>
</td>
</tr></table>
</div>
</li>
</ul></div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_generating_our_own_platform_signing_keys_optional">9.4. Generating Our Own Platform Signing Keys (Optional)</h3>
<div class="paragraph"><p>Before we compile our device, we <em>should</em> generate our own platform signing keys <a href="#Platform_Keys">[Platform_Keys]</a>, otherwise our device will not pass CTS.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Define our subject/issuer info:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ SIGNER="/C=US/ST=California/L=San Francisco/O=Marakana Inc./OU=Android/CN=Android Platform Signer/emailAddress=android@marakana.com"</tt></pre>
</div></div>
</li>
<li>
<p>
Remove the existing keys (it does not hurt to back them up first!):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ rm build/target/product/security/*.p*</tt></pre>
</div></div>
</li>
<li>
<p>
Generate the platform key:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ echo | development/tools/make_key build/target/product/security/platform "$SIGNER"
creating build/target/product/security/platform.pk8 with no password
Generating RSA private key, 2048 bit long modulus
....................+++
..........................................................+++
e is 3 (0x3)</tt></pre>
</div></div>
</li>
<li>
<p>
Generate the shared key:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ echo | development/tools/make_key build/target/product/security/shared "$SIGNER"
creating build/target/product/security/shared.pk8 with no password
Generating RSA private key, 2048 bit long modulus
..................................................................................................+++
............+++
e is 3 (0x3)</tt></pre>
</div></div>
</li>
<li>
<p>
Generate the media key:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ echo | development/tools/make_key build/target/product/security/media "$SIGNER"
creating build/target/product/security/media.pk8 with no password
Generating RSA private key, 2048 bit long modulus
...................+++
....................+++
e is 3 (0x3)</tt></pre>
</div></div>
</li>
<li>
<p>
Generate the testkey key:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ echo | development/tools/make_key build/target/product/security/testkey "$SIGNER"
creating build/target/product/security/testkey.pk8 with no password
Generating RSA private key, 2048 bit long modulus
....................+++
................................................+++
e is 3 (0x3)</tt></pre>
</div></div>
</li>
<li>
<p>
Verify that our keys have been created:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ ls -1 build/target/product/security/*.p*
build/target/product/security/media.pk8
build/target/product/security/media.x509.pem
build/target/product/security/platform.pk8
build/target/product/security/platform.x509.pem
build/target/product/security/shared.pk8
build/target/product/security/shared.x509.pem
build/target/product/security/testkey.pk8
build/target/product/security/testkey.x509.pem</tt></pre>
</div></div>
</li>
<li>
<p>
Check that our specific subject/issuer has been used:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ openssl x509 -noout -subject -issuer -in  build/target/product/security/platform.x509.pem
subject= /C=US/ST=California/L=San Francisco/O=Marakana Inc./OU=Android/CN=Android Platform Signer/emailAddress=android@marakana.com
issuer= /C=US/ST=California/L=San Francisco/O=Marakana Inc./OU=Android/CN=Android Platform Signer/emailAddress=android@marakana.com</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/caution.png" alt="Caution" />
</td>
<td class="content">The <tt>build/target/product/security/.pk8</tt> files are the private keys (<tt>.x509.pem</tt> are the certificates), and we need to make sure to keep them safe and secure - especially since we did not encrypt them!</td>
</tr></table>
</div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_building_our_device_for_the_first_time">9.5. Building our Device For The First Time</h3>
<div class="paragraph"><p>We are now ready to try out our "custom" device - though there is nothing truly custom yet, except for the <tt>PRODUCT_*</tt> settings and our own product keys.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
For good measure, re-register our device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ source build/envsetup.sh
including device/marakana/alpha/vendorsetup.sh
…</tt></pre>
</div></div>
</li>
<li>
<p>
Now we can <tt>lunch</tt> of our device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ lunch full_marakana_alpha-eng

============================================
PLATFORM_VERSION_CODENAME=REL
PLATFORM_VERSION=4.0.3
TARGET_PRODUCT=full_marakana_alpha
TARGET_BUILD_VARIANT=eng
TARGET_BUILD_TYPE=release
TARGET_BUILD_APPS=
TARGET_ARCH=arm
TARGET_ARCH_VARIANT=armv7-a
HOST_ARCH=x86
HOST_OS=linux
HOST_BUILD_TYPE=release
BUILD_ID=IML74K
============================================</tt></pre>
</div></div>
</li>
<li>
<p>
We can now compile our device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ export USE_CCACHE=1
$ make -j10
…
Installed file list: out/target/product/alpha/installed-files.txt
Target system fs image: out/target/product/alpha/obj/PACKAGING/systemimage_intermediates/system.img
Install system fs image: out/target/product/alpha/system.img</tt></pre>
</div></div>
</li>
<li>
<p>
Finally, we can run it
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ out/host/linux-x86/bin/emulator &amp;</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Replace <tt>linux</tt> with <tt>darwin</tt> for Mac OS X</td>
</tr></table>
</div>
</li>
<li>
<p>
And we should see
</p>
<div class="imageblock">
<div class="content">
<img src="screens/MarakanaAlpha-AboutPhone-v1.png" alt="screens/MarakanaAlpha-AboutPhone-v1.png" />
</div>
</div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_adding_a_custom_kernel_to_our_device">9.6. Adding a Custom Kernel to our Device</h3>
<div class="paragraph"><p>Our device would work fine with the provided QEMU-based (i.e. emulator-specific) kernel:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>prebuilt/android-arm/kernel/kernel-qemu-armv7</tt> for ARMv7
</p>
</li>
<li>
<p>
<tt>prebuilt/android-arm/kernel/kernel-qemu</tt> for ARMv5
</p>
</li>
<li>
<p>
<tt>prebuilt/android-x86/kernel/kernel-qemu</tt> for x86)
</p>
</li>
</ul></div>
<div class="paragraph"><p>In this section, we will configure a custom kernel (<a href="#Android_Building_Linux_Kernel">[Android_Building_Linux_Kernel]</a>) so that we can:</p></div>
<div class="ulist"><ul>
<li>
<p>
Change the <em>Hardware</em> name of our device from <em>Goldfish</em> to <em>Alpha Marakana Board</em> - allowing us to have custom system (init/ueventd) configuration files
</p>
</li>
<li>
<p>
To enable loadable module support - in case we decide to add new drivers as modules later on
</p>
</li>
</ul></div>
<div class="paragraph"><p>The steps outlined here are similar to <a href="#Android_Building_Linux_Kernel_for_Emulator">[Android_Building_Linux_Kernel_for_Emulator]</a>:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a directory to host our kernel sources:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir ~/kernel/
$ cd ~/kernel/</tt></pre>
</div></div>
</li>
<li>
<p>
Clone the Goldfish kernel sources:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git clone https://android.googlesource.com/kernel/goldfish.git
$ cd goldfish/</tt></pre>
</div></div>
</li>
<li>
<p>
Check out <tt>android-goldfish-2.6.29</tt> branch of the kernel we wish to build:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git checkout -t remotes/origin/android-goldfish-2.6.29</tt></pre>
</div></div>
</li>
<li>
<p>
Create the default kernel configuration file (<tt>.config</tt>):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make goldfish_armv7_defconfig ARCH=arm</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Depending on <tt>TARGET_ARCH_VARIANT</tt> that we specified in <tt>device/marakana/alpha/BoardConfig.mk</tt>:<br />
to compile for ARMv5, we would run <tt>make goldfish_defconfig ARCH=arm</tt> instead.<br />
to compile for x86, we would run <tt>make goldfish_defconfig ARCH=x86</tt> instead.</td>
</tr></table>
</div>
</li>
<li>
<p>
Change the <em>Hardware</em> name from <tt>"Goldfish"</tt> to <tt>"Marakana Alpha Board"</tt>:
</p>
<div class="listingblock">
<div class="title"><tt>arch/arm/mach-goldfish/board-goldfish.c</tt>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="font-weight: bold"><span style="color: #000000">MACHINE_START</span></span><span style="color: #990000">(</span>GOLDFISH<span style="color: #990000">,</span> <span style="color: #FF0000">"Marakana Alpha Board"</span><span style="color: #990000">)</span>
…</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about the hardware (board) name</div>
<div class="paragraph"><p>As we already know, when the Android kernel loads, it runs <tt>init</tt>, which configures itself from <tt>init.rc</tt> and <tt>init.<em>hardware</em>.rc</tt> configuration files.</p></div>
<div class="paragraph"><p>The <em>hardware</em> name is extracted from <tt>/proc/cpuinfo</tt>:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell cat /proc/cpuinfo |grep Hardware
Hardware    : Goldfish</tt></pre>
</div></div>
<div class="paragraph"><p>Basically, <tt>system/core/init/init.c:main()</tt> uses <tt>system/core/init/util.c:get_hardware_name(…)</tt> to parse  <tt>/proc/cpuinfo</tt> and extract the hardware name. This name is converted to lower-case and all the space
characters are trimmed.</p></div>
<div class="paragraph"><p>Android&#8217;s <tt>ueventd</tt> process (started by <tt>init</tt>) also configures itself in a similar way, by loading <tt>ueventd.rc</tt> and <tt>ueventd.<em>hardware</em>.rc</tt> configuration files.</p></div>
<div class="paragraph"><p>Since in our case we changed the name of our hardware to "Marakana Alpha Board", we will also need to create the corresponding: <tt>init.marakanaalphaboard.rc</tt> and <tt>ueventd.marakanaalphaboard.rc</tt> files.</p></div>
</td>
</tr></table>
</div>
</li>
<li>
<p>
Configure the kernel
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make menuconfig ARCH=arm</tt></pre>
</div></div>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Set <em>General setup</em> &#8594; <em>Local version</em> to <tt>-marakana-alpha-release</tt>
</p>
</li>
<li>
<p>
Select <em>Enable loadable module support</em> and within it also select <em>Module unloading</em> and within that <em>Forced module unloading</em>
</p>
</li>
<li>
<p>
Customize the rest as desired
</p>
</li>
</ol></div>
</li>
<li>
<p>
Compile the kernel
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10 ARCH=arm CROSS_COMPILE=~/ics/prebuilt/linux-x86/toolchain/arm-eabi-4.4.3/bin/arm-eabi-</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">For x86, run <tt>make -j10 ARCH=x86 CROSS_COMPILE=~/ics/prebuilt/linux-x86/toolchain/i686-android-linux-4.4.3/bin/i686-android-linux-</tt> instead.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/warning.png" alt="Warning" />
</td>
<td class="content">We ran into issues (clobbered PIC register) last time we tried compiling for x86 (January 2012).</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Remember that <tt>~/ics/</tt> is the root of the Android Open Source Project (AOSP) source tree</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">AOSP comes with a convenient script to compile the Linux kernel for QEMU-based emulator: <tt>~/ics/external/qemu/distrib/build-kernel.sh</tt>.</td>
</tr></table>
</div>
</li>
<li>
<p>
Copy the compiled kernel to our device&#8217;s <tt>alpha/</tt> directory:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cp arch/arm/boot/zImage ~/ics/device/marakana/alpha/kernel</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">For x86, copy <tt>arch/x86/boot/zImage</tt> instead.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">In case you were not able to compile the kernel, you could also download a pre-built one from <a href="https://github.com/marakana/alpha/raw/master/kernel">https://github.com/marakana/alpha/raw/master/kernel</a></td>
</tr></table>
</div>
</li>
<li>
<p>
Now we can go back to the AOSP source
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cd ~/ics/</tt></pre>
</div></div>
</li>
<li>
<p>
Enable our custom kernel in <tt>BoardConfig.mk</tt> (double-negation, nice!):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/BoardConfig.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="color: #990000">TARGET_NO_KERNEL :=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>
…</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This will cause the build system to rebuild the <tt>boot.img</tt> file, but because we are still working with the emulator, we&#8217;ll have to explicitly reference our kernel on startup.</td>
</tr></table>
</div>
</li>
<li>
<p>
Now we are ready to create <em>our own</em> <tt>init</tt> and <tt>ueventd</tt> configuration files by copying the ones from Goldfish:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cp system/core/rootdir/etc/init.goldfish.rc device/marakana/alpha/init.marakanaalphaboard.rc
$ cp system/core/rootdir/etc/ueventd.goldfish.rc device/marakana/alpha/ueventd.marakanaalphaboard.rc</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Remember, <tt>marakanaalphaboard</tt> is our device&#8217;s new hardware name (lowercased and stripped of spaces).</td>
</tr></table>
</div>
</li>
<li>
<p>
Create a <tt>common.mk</tt> makefile for our common components, where we&#8217;ll configure our kernel and copy the <tt>init</tt> and <tt>ueventd</tt> configuration files:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/common.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Since this file can also be referenced by alpha-sdk_addon</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># we cannot assume LOCAL_PATH points to the directory where</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># this file is located. Instead, we create another variable</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># to capture this directory.</span></span>
<span style="color: #990000">MY_PATH :=</span> <span style="color: #009900">$(LOCAL_PATH)</span><span style="color: #990000">/..</span>/alpha

<span style="font-style: italic"><span style="color: #9A1900"># Include all makefiles in sub-directories (one level deep)</span></span>
include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Enable our custom kernel</span></span>
<span style="color: #990000">LOCAL_KERNEL :=</span> <span style="color: #009900">$(MY_PATH)</span>/kernel
PRODUCT_COPY_FILES <span style="color: #990000">+=</span> <span style="color: #009900">$(LOCAL_KERNEL)</span><span style="color: #990000">:</span>kernel

<span style="font-style: italic"><span style="color: #9A1900"># Copy our init and ueventd configuration files to the root</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># file system (ramdisk.img -&gt; boot.img)</span></span>
PRODUCT_COPY_FILES <span style="color: #990000">+=</span> <span style="color: #009900">$(MY_PATH)</span>/init.marakanaalphaboard.rc<span style="color: #990000">:</span>root/init.marakanaalphaboard.rc
PRODUCT_COPY_FILES <span style="color: #990000">+=</span> <span style="color: #009900">$(MY_PATH)</span>/ueventd.marakanaalphaboard.rc<span style="color: #990000">:</span>root/ueventd.marakanaalphaboard.rc
</tt></pre></div></div>
</li>
<li>
<p>
Now, we need to include our common <tt>common.mk</tt> file in our device&#8217;s main makefile (<tt>full_alpha.mk</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/full_alpha.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
<span style="font-style: italic"><span style="color: #9A1900"># Include the common definitions and packages</span></span>
include <span style="color: #009900">$(LOCAL_PATH)</span>/common.mk</tt></pre></div></div>
</li>
<li>
<p>
Re-build our ROM, which, in this case just creates a new <tt>out/target/product/alpha/boot.img</tt> (that we won&#8217;t actually use):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10
…</tt></pre>
</div></div>
</li>
<li>
<p>
Restart the emulator (with our new kernel)
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ out/host/linux-x86/bin/emulator -kernel out/target/product/alpha/kernel &amp;</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">We have to run our emulator with <tt>-kernel</tt>, because otherwise it would ignore the kernel in our newly built <tt>boot.img</tt> and instead use the default one (<tt>prebuilt/android-arm/kernel/kernel-qemu-armv7</tt>). This applies just to the emulator.</td>
</tr></table>
</div>
</li>
<li>
<p>
Test
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell cat /proc/version
Linux version 2.6.29-marakana-alpha-release-g46b05b2 (sasa@thermal) (gcc version 4.4.3 (GCC) ) #3 Tue Jan 3 13:25:44 PST 2012</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The path to <tt>adb</tt> was added to our <tt>PATH</tt> when we <tt>$ source build/envsetup.sh</tt> (on a Linux host, it comes from <tt>out/host/linux-x86/bin/adb</tt>)</td>
</tr></table>
</div>
</li>
<li>
<p>
We could also take a look at the updated <em>About</em> screen:
</p>
<div class="imageblock">
<div class="content">
<img src="screens/MarakanaAlpha-AboutPhone-v2.png" alt="screens/MarakanaAlpha-AboutPhone-v2.png" />
</div>
</div>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_adding_a_custom_native_library_and_executable_to_our_device">9.7. Adding a Custom Native Library and Executable to our Device</h3>
<div class="ulist"><ul>
<li>
<p>
In this section, we&#8217;ll create a simple native shared library (like a HAL), which will directly interact with a kernel driver (the Android logger driver at <tt>/dev/log/main</tt>) and allow us to
</p>
<div class="ulist"><ul>
<li>
<p>
Flush the log buffer
</p>
</li>
<li>
<p>
Get the max size of the log buffer
</p>
</li>
<li>
<p>
Get the used size of the log buffer
</p>
</li>
</ul></div>
</li>
<li>
<p>
We&#8217;ll also create a simple executable that will use our shared library
</p>
</li>
<li>
<p>
Let&#8217;s get started:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
We start by creating a home for our shared libraries:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/lib/</tt></pre>
</div></div>
</li>
<li>
<p>
Since our actual libraries will be in their own sub-directories, we need to include them in our build system, via a simple makefile:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/lib/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span></tt></pre></div></div>
</li>
<li>
<p>
Now we can create an actual directory for our <tt>libmrknlog</tt> library:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/lib/libmrknlog</tt></pre>
</div></div>
</li>
<li>
<p>
Now we can create a simple header file (<tt>libmrknlog.h</tt>) for our library:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/lib/libmrknlog/libmrknlog.h</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#ifndef</span></span> _MRKNLOG_H_
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> _MRKNLOG_H_

<span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> __cplusplus
<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #FF0000">"C"</span> <span style="color: #FF0000">{</span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_flush_log</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_total_log_size</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_used_log_size</span></span><span style="color: #990000">();</span>

<span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> __cplusplus
<span style="color: #FF0000">}</span>  <span style="font-style: italic"><span style="color: #9A1900">/* End of the 'extern "C"' block */</span></span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<span style="font-weight: bold"><span style="color: #000080">#endif</span></span> <span style="font-style: italic"><span style="color: #9A1900">/* End of the _MRKNLOG_H_ block */</span></span></tt></pre></div></div>
</li>
<li>
<p>
Next, we implement our shared library (<tt>libmrknlog.c</tt>) - using <tt>ioctl()</tt> to talk to the kernel driver:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/lib/libmrknlog/libmrknlog.c</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#define</span></span> LOG_FILE <span style="color: #FF0000">"/dev/log/main"</span>
<span style="font-weight: bold"><span style="color: #000080">#define</span></span> LOG_TAG <span style="color: #FF0000">"MrknLog"</span>

<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;cutils/logger.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;cutils/log.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;string.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;fcntl.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;errno.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;sys/ioctl.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;sys/stat.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;sys/types.h&gt;</span>

<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"libmrknlog.h"</span>

<span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">ioctl_log</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span> mode<span style="color: #990000">,</span> <span style="color: #009900">int</span> request<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">int</span> logfd <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span>LOG_FILE<span style="color: #990000">,</span> mode<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>logfd <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">LOGE</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Failed to open %s: %s"</span><span style="color: #990000">,</span> LOG_FILE<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">strerror</span></span><span style="color: #990000">(</span>errno<span style="color: #990000">));</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        <span style="color: #009900">int</span> ret <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ioctl</span></span><span style="color: #990000">(</span>logfd<span style="color: #990000">,</span> request<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #000000">close</span></span><span style="color: #990000">(</span>logfd<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> ret<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_flush_log</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">ioctl_log</span></span><span style="color: #990000">(</span>O_WRONLY<span style="color: #990000">,</span> LOGGER_FLUSH_LOG<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_total_log_size</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">ioctl_log</span></span><span style="color: #990000">(</span>O_RDONLY<span style="color: #990000">,</span> LOGGER_GET_LOG_BUF_SIZE<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_used_log_size</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">ioctl_log</span></span><span style="color: #990000">(</span>O_RDONLY<span style="color: #990000">,</span> LOGGER_GET_LOG_LEN<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
</li>
<li>
<p>
We are now ready for the makefile (<tt>Android.mk</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/lib/libmrknlog/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_SRC_FILES :=</span> libmrknlog.c
<span style="color: #990000">LOCAL_SHARED_LIBRARIES :=</span> libcutils
<span style="color: #990000">LOCAL_MODULE :=</span> libmrknlog
include <span style="color: #009900">$(BUILD_SHARED_LIBRARY)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Here, we need <tt>LOCAL_SHARED_LIBRARIES := libcutils</tt> in order to link to <tt>__android_log_print</tt> (used by the <tt>LOGE</tt> macro)</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">In previous versions of Android (pre 4.0), we would&#8217;ve also needed to add <tt>LOCAL_PRELINK_MODULE := false</tt> in order to prevent pre-linking of our library. Pre-linked libraries were registered to be loaded at fixed memory addresses in order to speed up linking and allow for faster booting (at the expense of ASLR). If we did not disable it, we would&#8217;ve had to register our library <tt>build/core/prelink-linux-arm.map</tt> (now deprecated).</td>
</tr></table>
</div>
</li>
<li>
<p>
Optionally, we can compile our library to test that it builds:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make libmrknlog
…
target thumb C: libmrknlog &lt;= device/marakana/alpha/lib/libmrknlog/libmrknlog.c
target SharedLib: libmrknlog (out/target/product/alpha/obj/SHARED_LIBRARIES/libmrknlog_intermediates/LINKED/libmrknlog.so)
target Symbolic: libmrknlog (out/target/product/alpha/symbols/system/lib/libmrknlog.so)
target Strip: libmrknlog (out/target/product/alpha/obj/lib/libmrknlog.so)
Install: out/target/product/alpha/system/lib/libmrknlog.so</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about compiling individual modules</div>
<div class="paragraph"><p>Android&#8217;s build system allows us to compile individual modules via a simple <tt>$ make &lt;module-name&gt;</tt> where <tt>&lt;module-name&gt;</tt> is defined by <tt>LOCAL_MODULE</tt> (or <tt>LOCAL_PACKAGE_NAME</tt> for apps) in the module&#8217;s <tt>Android.mk</tt> file. To clean just this one module, we can do <tt>$ make clean-&lt;module-name&gt;</tt>.</p></div>
<div class="paragraph"><p>This works, but it still takes a long time (about 21.2s on 3.4GHz i7 with SSD) because the build system has to scan the entire source tree to find our module.</p></div>
<div class="paragraph"><p>Alternatively, we can use the <tt>mm</tt> function right from the module&#8217;s directory (takes about 1.6s):</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ godir libmrknlog
device/marakana/alpha/lib/libmrknlog$ mm
…
make: Entering directory ++/flash/ics-4.0.3'
target thumb C: libmrknlog &lt;= device/marakana/alpha/lib/libmrknlog/libmrknlog.c
target SharedLib: libmrknlog (out/target/product/alpha/obj/SHARED_LIBRARIES/libmrknlog_intermediates/LINKED/libmrknlog.so)
target Symbolic: libmrknlog (out/target/product/alpha/symbols/system/lib/libmrknlog.so)
target Strip: libmrknlog (out/target/product/alpha/obj/lib/libmrknlog.so)
Install: out/target/product/alpha/system/lib/libmrknlog.so
make: Leaving directory ++/flash/ics-4.0.3'
device/marakana/alpha/lib/libmrknlog$ cd -
$</tt></pre>
</div></div>
<div class="paragraph"><p>The function <tt>godir</tt> builds a <tt>filelist</tt> index of all of the source-files, searches for the file that matches the argument name in that list, and then jumps to the directory containing that file. In this case, it&#8217;s equivalent to <tt>cd device/marakana/alpha/lib/libmrknlog</tt> command.</p></div>
<div class="paragraph"><p>Both <tt>godir</tt> and <tt>mm</tt> are defined by <tt>build/envsetup.sh</tt>, which we sourced into our shell.</p></div>
</td>
</tr></table>
</div>
</li>
<li>
<p>
Since our library&#8217;s <tt>Android.mk</tt> states <tt>LOCAL_MODULE_TAGS := optional</tt>, we need to register it with Alpha&#8217;s <tt>PRODUCT_PACKAGES</tt>, otherwise it will not be included in the final ROM:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/common.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> libmrknlog</tt></pre></div></div>
</li>
<li>
<p>
Before we can create our executable to test our library, let&#8217;s create a directory for all binaries:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/bin</tt></pre>
</div></div>
</li>
<li>
<p>
Like with our libraries, we need to "recursively" include makefiles in sub-directories of <tt>…/bin/</tt>, which is where our executables will live:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/bin/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span></tt></pre></div></div>
</li>
<li>
<p>
Now we can create a directory for our <tt>mrknlog</tt> executable:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/bin/mrknlog</tt></pre>
</div></div>
</li>
<li>
<p>
Next we provide the implementation (<tt>mrknlog.c</tt>), which will use our shared library (<tt>libmrknlog</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/bin/mrknlog/mrknlog.c</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;string.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;errno.h&gt;</span>

<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;libmrknlog.h&gt;</span>

<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span> <span style="color: #990000">(</span><span style="color: #009900">int</span> argc<span style="color: #990000">,</span> <span style="color: #009900">char</span><span style="color: #990000">*</span> argv<span style="color: #990000">[])</span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">int</span> usedSize <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_used_log_size</span></span><span style="color: #990000">();</span>
    <span style="color: #009900">int</span> totalSize <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_total_log_size</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>totalSize <span style="color: #990000">&gt;=</span> <span style="color: #993399">0</span> <span style="color: #990000">&amp;&amp;</span> usedSize <span style="color: #990000">&gt;=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">mrkn_flush_log</span></span><span style="color: #990000">()</span> <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Flushed log. Previously it was consuming %d of %d bytes</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span>
                usedSize<span style="color: #990000">,</span> totalSize<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span><span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to flush log: %s"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">strerror</span></span><span style="color: #990000">(</span>errno<span style="color: #990000">));</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span><span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to get log size: %s"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">strerror</span></span><span style="color: #990000">(</span>errno<span style="color: #990000">));</span>
    <span style="color: #FF0000">}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
As with everything else, we need a makefile (<tt>Android.mk</tt>) to build our executable:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/bin/mrknlog/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>

include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_SRC_FILES :=</span> mrknlog.c
<span style="color: #990000">LOCAL_C_INCLUDES :=</span> <span style="color: #009900">$(LOCAL_PATH)</span><span style="color: #990000">/../..</span>/lib/libmrknlog<span style="color: #990000">/</span>
<span style="color: #990000">LOCAL_SHARED_LIBRARIES :=</span> libmrknlog
<span style="color: #990000">LOCAL_MODULE :=</span> mrknlog
include <span style="color: #009900">$(BUILD_EXECUTABLE)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Here, we need to tell the compiler where to find our library&#8217;s header file:<br />
<tt>LOCAL_C_INCLUDES := $(LOCAL_PATH)/../../lib/libmrknlog/</tt><br />
and tell the linker to link against our library:<br />
<tt>LOCAL_SHARED_LIBRARIES := libmrknlog</tt><br />
Finally, unlike last time when we <tt>include $(BUILD_SHARED_LIBRARY)</tt>, this time we:<br />
<tt>include $(BUILD_EXECUTABLE)</tt><br />
which will produce <tt>system/bin/mrknlog</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
We can compile our executable to test that it builds:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ rm filelist
$ godir mrknlog.c
   [1] ./device/marakana/alpha/bin/mrknlog
   [2] ./device/marakana/alpha/lib/libmrknlog

Select one: 1
device/marakana/alpha/bin/mrknlog$ mm
…
target thumb C: mrknlog &lt;= device/marakana/alpha/bin/mrknlog/mrknlog.c
target Executable: mrknlog (out/target/product/alpha/obj/EXECUTABLES/mrknlog_intermediates/LINKED/mrknlog)
target Symbolic: mrknlog (out/target/product/alpha/symbols/system/bin/mrknlog)
target Strip: mrknlog (out/target/product/alpha/obj/EXECUTABLES/mrknlog_intermediates/mrknlog)
Install: out/target/product/alpha/system/bin/mrknlog
…
device/marakana/alpha/bin/mrknlog$ croot
$</tt></pre>
</div></div>
</li>
<li>
<p>
Just like with our library, since our executable&#8217;s <tt>Android.mk</tt> states <tt>LOCAL_MODULE_TAGS := optional</tt>, we need to register it with Alpha&#8217;s <tt>PRODUCT_PACKAGES</tt>, or otherwise it will not be included in the final ROM:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/common.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> mrknlog</tt></pre></div></div>
</li>
<li>
<p>
Now we can rebuild our entire device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10
…
Install system fs image: out/target/product/alpha/system.img</tt></pre>
</div></div>
</li>
<li>
<p>
Finally, we are ready to test our library/executable:
</p>
<div class="listingblock">
<div class="content">
<pre><tt># (re)start the emulator
$ out/host/linux-x86/bin/emulator -kernel out/target/product/alpha/kernel &amp;
# wait for the emulator to finish
# check out our library
$ adb shell ls -l /system/lib/libmrknlog.so
-rw-r--r-- root     root         5468 2012-01-04 10:02 libmrknlog.so
# check out our utility
$ adb shell ls -l /system/bin/mrknlog
-rwxr-xr-x root     shell        5612 2012-01-04 10:20 mrknlog
# check if our utility is doing what it is supposed to
$ adb logcat -g
/dev/log/main: ring buffer is 64Kb (54Kb consumed), max entry is 4096b, max payload is 4076b
$ adb shell /system/bin/mrknlog
Flushed log. Previously it was consuming 55981 of 65536 bytes
$ adb logcat -g
/dev/log/main: ring buffer is 64Kb (0Kb consumed), max entry is 4096b, max payload is 4076b
# check again
$ adb shell /system/bin/mrknlog
Flushed log. Previously it was consuming 0 of 65536 bytes
# good :-)</tt></pre>
</div></div>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_using_our_native_library_via_a_custom_daemon">9.8. Using our Native Library via a Custom Daemon</h3>
<div class="ulist"><ul>
<li>
<p>
Having a custom utility <tt>mrknlog</tt> is fine, but what if we wanted to have it run periodically, to flush the log buffers at a regular interval - we&#8217;d need a daemon
</p>
</li>
<li>
<p>
As we discussed before, daemons are executables (e.g. <tt>mrknlogd</tt>) generally started by <tt>init</tt> (from <tt>init.rc</tt>) as <tt>service</tt>-es
</p>
</li>
<li>
<p>
Let&#8217;s get started:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
As before, we need to create a home for our daemon source:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/bin/mrknlogd</tt></pre>
</div></div>
</li>
<li>
<p>
Next, we create or daemon source (<tt>mrknlogd.c</tt>), by utilizing our <tt>libmrknlog</tt> library:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/bin/mrknlogd/mrknlogd.c</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#define</span></span> LOG_TAG <span style="color: #FF0000">"MRKN Log Daemon"</span>

<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdio.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;stdlib.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;unistd.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;utils/Log.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;libmrknlog.h&gt;</span>

<span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span> <span style="color: #990000">(</span><span style="color: #009900">int</span> argc<span style="color: #990000">,</span> <span style="color: #009900">char</span><span style="color: #990000">*</span> argv<span style="color: #990000">[])</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>argc <span style="color: #990000">!=</span> <span style="color: #993399">2</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span><span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"Usage: %s &lt;flush-frequency-in-seconds&gt;</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span> argv<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]);</span>
    <span style="font-weight: bold"><span style="color: #000000">exit</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="color: #009900">int</span> frequency <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">atoi</span></span><span style="color: #990000">(</span>argv<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]);</span>
    <span style="color: #009900">int</span> totalSize <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_total_log_size</span></span><span style="color: #990000">();</span>
    <span style="color: #009900">int</span> usedSize<span style="color: #990000">;</span>
    <span style="color: #009900">int</span> count <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      usedSize <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_used_log_size</span></span><span style="color: #990000">();</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">mrkn_flush_log</span></span><span style="color: #990000">()</span> <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">LOGI</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Flushed log (%d, %d of %d bytes). Waiting %d seconds before the next flush."</span><span style="color: #990000">,</span>
          count<span style="color: #990000">,</span> usedSize<span style="color: #990000">,</span> totalSize<span style="color: #990000">,</span> frequency<span style="color: #990000">);</span>
        count<span style="color: #990000">++;</span>
      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">LOGE</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Failed to flush log. Waiting %d seconds before the next attempt"</span><span style="color: #990000">,</span>
          frequency<span style="color: #990000">);</span>
      <span style="color: #FF0000">}</span>
      <span style="font-weight: bold"><span style="color: #000000">sleep</span></span><span style="color: #990000">(</span>frequency<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This program is designed to run as a "daemon" simply by running infinitely in a <tt>while(1) {…}</tt> block.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">We can use <tt>LOGI()</tt>, <tt>LOGE()</tt>, and other such macros, which simplify logging:<br />
<tt>#define  LOGI(&#8230;)  <em>android_log_print(ANDROID_LOG_INFO,LOG_TAG,</em>VA_ARGS<em>)</tt><br />
<tt>#define  LOGE(&#8230;)  </em>android_log_print(ANDROID_LOG_ERROR,LOG_TAG,<em>VA_ARGS</em>)</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
Next, we create our makefile (<tt>Android.mk</tt>), which defines links from our source to our library:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/bin/mrknlogd/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>

include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_SRC_FILES :=</span> mrknlogd.c
<span style="color: #990000">LOCAL_C_INCLUDES :=</span> <span style="color: #009900">$(LOCAL_PATH)</span><span style="color: #990000">/../..</span>/lib/libmrknlog<span style="color: #990000">/</span>
<span style="color: #990000">LOCAL_SHARED_LIBRARIES :=</span> libmrknlog libcutils
<span style="color: #990000">LOCAL_MODULE :=</span> mrknlogd
include <span style="color: #009900">$(BUILD_EXECUTABLE)</span></tt></pre></div></div>
</li>
<li>
<p>
Now we can compile our daemon to test that it builds:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10 mrknlogd
…
target Executable: mrknlogd (out/target/product/alpha/obj/EXECUTABLES/mrknlogd_intermediates/LINKED/mrknlogd)
target Non-prelinked: mrknlogd (out/target/product/alpha/symbols/system/bin/mrknlogd)
target Strip: mrknlogd (out/target/product/alpha/obj/EXECUTABLES/mrknlogd_intermediates/mrknlogd)
Install: out/target/product/alpha/system/bin/mrknlogd</tt></pre>
</div></div>
</li>
<li>
<p>
Just like with our previous executable/library, we need to register our daemon with Alpha&#8217;s <tt>PRODUCT_PACKAGES</tt>, or otherwise it will not be included in the final ROM:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/common.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> mrknlogd</tt></pre></div></div>
</li>
<li>
<p>
Before we can rebuild our ROM, we need to configure <tt>init</tt> to start our <tt>mrknlogd</tt> daemon as a <tt>service</tt>, and to do that, we need to register this in our <tt>init.marakanaalphaboard.rc</tt> file:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/init.marakanaalphaboard.rc</tt>:</div>
<div class="content">
<pre><tt>…
on boot
    …
    start mrknlogd
…
# Marakana's custom log-flushing daemon
service mrknlogd /system/bin/mrknlogd 60
    user system
    group log
    oneshot</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="title">A note about security</div>
<div class="paragraph"><p>In order to get the size of the log buffer <tt>/dev/log/main</tt>, we need to be able to read from this "file", and for that, we need to be either <tt>root</tt> or belong to group <tt>log</tt> (we chose the latter):</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ adb shell ls -l /dev/log/main
crw-rw--w- root     log       10,  57 2012-01-05 00:02 main</tt></pre>
</div></div>
</td>
</tr></table>
</div>
</li>
<li>
<p>
Now we can rebuild our entire device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10
…
build/core/Makefile:25: warning: overriding commands for target ++out/target/product/alpha/root/init.goldfish.rc'
system/core/rootdir/Android.mk:58: warning: ignoring old commands for target ++out/target/product/alpha/root/init.goldfish.rc'
…
Install system fs image: out/target/product/alpha/system.img
Installed file list: out/target/product/alpha/installed-files.txt</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">There warnings are (unfortunately) expected because our rule to copy <tt>init.goldfish.rc</tt> (implemented by <tt>build/core/Makefile</tt>) conflicts with what Android wants to do already (in <tt>system/core/rootdir/Android.mk</tt>).</td>
</tr></table>
</div>
</li>
<li>
<p>
Finally, we are ready to test our daemon:
</p>
<div class="listingblock">
<div class="content">
<pre><tt># (re)start the emulator
$ out/host/linux-x86/bin/emulator -kernel out/target/product/alpha/kernel &amp;
# wait for the emulator to finish
# check out our daemon
$ adb shell ls -l /system/bin/mrknlogd
-rwxr-xr-x root     shell        5636 2012-01-04 20:52 mrknlogd
# check that it runs
$ adb shell ps | grep mrknlogd
system    44    1     772    300   c0051854 40012c74 S /system/bin/mrknlogd
$ adb logcat | grep MRKN
I/MRKN Log Daemon(   37): Flushed log (1, 60 of 65536 bytes). Waiting 60 seconds before the next flush.
I/MRKN Log Daemon(   37): Flushed log (2, 34406 of 65536 bytes). Waiting 60 seconds before the next flush.
I/MRKN Log Daemon(   37): Flushed log (3, 232 of 65536 bytes). Waiting 60 seconds before the next flush.
^C
$ adb logcat -g
/dev/log/main: ring buffer is 64Kb (0Kb consumed), max entry is 4096b, max payload is 4076b
# good :-)</tt></pre>
</div></div>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_exposing_our_native_library_via_java_i_e_jni">9.9. Exposing our Native Library via Java (i.e. JNI)</h3>
<div class="ulist"><ul>
<li>
<p>
Our shared native library (<tt>libmrknlog.so</tt>) is fine if we just develop in C/C++, but to utilize its functionality in the Java layers, we need to wrap it with some JNI love
</p>
</li>
<li>
<p>
As we discussed in <a href="#Android_NDK">[Android_NDK]</a> section, here we will:
</p>
<div class="ulist"><ul>
<li>
<p>
Create a Java "library" (<tt>com.marakana.android.lib.log.LibLog</tt>)
</p>
</li>
<li>
<p>
Declare some of its methods as <tt>native</tt> (e.g. <tt>public static native void flushLog();</tt>)
</p>
</li>
<li>
<p>
Extract the C header file (<tt>com_marakana_android_lib_log_LibLog.h</tt>) using <tt>javah -jni ….LibLog</tt>
</p>
</li>
<li>
<p>
Provide the implementation (<tt>com_marakana_android_lib_log_LibLog.c</tt>) - where we will finally get to utilize our shared library (<tt>libmrknlog.so</tt>)
</p>
</li>
<li>
<p>
Compile our Java/JNI library as <tt>/system/frameworks/com.marakana.android.lib.log.jar</tt> and <tt>/system/lib/libmrknlog_jni.so</tt>
</p>
</li>
<li>
<p>
Create a simple Java program and test that our library works
</p>
</li>
</ul></div>
</li>
<li>
<p>
Let&#8217;s get started:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Since our Java/JNI library will primarily service the <em>Application Framework</em> layer, let&#8217;s create a home for our framework components:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/framework</tt></pre>
</div></div>
</li>
<li>
<p>
Like with our libraries and executables, we need to "recursively" include makefiles in sub-directories of <tt>…/framework/</tt>, which is where our Java/JNI library will live:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span></tt></pre></div></div>
</li>
<li>
<p>
Now, let&#8217;s create the home for our Java/JNI library and two sub-directories for its Java and JNI parts:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/framework/libmrknlog_jni
$ mkdir device/marakana/alpha/framework/libmrknlog_jni/java
$ mkdir device/marakana/alpha/framework/libmrknlog_jni/jni</tt></pre>
</div></div>
</li>
<li>
<p>
To include these sub-directories in the compilation (<tt>java/</tt> and <tt>jni/</tt>), we again need one of those "recursive" makefiles:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span></tt></pre></div></div>
</li>
<li>
<p>
Now, let&#8217;s create the directory structure that reflects our Java library&#8217;s package name (<tt>com.marakana.android.lib.log</tt>):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir -p device/marakana/alpha/framework/libmrknlog_jni/java/com/marakana/android/lib/log</tt></pre>
</div></div>
</li>
<li>
<p>
Now let&#8217;s create our Java "library" class (<tt>LibLog.java</tt>) and its accompanying exception (<tt>LibLogException.java</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/java/com/marakana/android/lib/log/LibLog.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LibLog</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> LibLogException<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> LibLogException<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">native</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> LibLogException<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #FF0000">{</span>
     System<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">loadLibrary</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mrknlog_jni"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/java/com/marakana/android/lib/log/LibLogException.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LibLogException</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> RuntimeException <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #000000">LibLogException</span></span><span style="color: #990000">(</span><span style="color: #008080">String</span> msg<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">(</span>msg<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
While we are at it, we might as well create a simple <tt>Main.java</tt> class to test our Java/JNI library:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/java/com/marakana/android/lib/log/Main.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log<span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">/** </span></span><span style="color: #009900">@hide</span><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">Main</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">main</span></span> <span style="color: #990000">(</span>String<span style="color: #990000">[]</span> args<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
      <span style="color: #009900">int</span> usedSize <span style="color: #990000">=</span> LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">();</span>
      <span style="color: #009900">int</span> totalSize <span style="color: #990000">=</span> LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">();</span>
      LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">();</span>
      System<span style="color: #990000">.</span>out<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">printf</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Flushed log. Previously it was consuming %d of %d bytes</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000">"</span><span style="color: #990000">,</span>
          usedSize<span style="color: #990000">,</span> totalSize<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">LibLogException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      System<span style="color: #990000">.</span>err<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">println</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Failed to flush the log"</span><span style="color: #990000">);</span>
      e<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">printStackTrace</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
For our Java/JNI library (deployed as <tt>/system/framework/com.marakana.android.lib.log.jar</tt>) to be accessible to the running applications, we need to explicitly expose its logical name (<tt>com.marakana.android.lib.log</tt>) via a simple XML mapping file (<tt>com.marakana.android.lib.log.xml</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/java/com.marakana.android.lib.log.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;permissions&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;library</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.lib.log"</span>
    <span style="color: #009900">file</span><span style="color: #990000">=</span><span style="color: #FF0000">"/system/framework/com.marakana.android.lib.log.jar"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/permissions&gt;</span></span>
</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This file will be deployed as <tt>/system/etc/permissions/com.marakana.android.lib.log.xml</tt> in the target image and applications that wish to use our library will have to reference it in their via <tt>AndroidManifest.xml</tt> with:<br />
<tt>&lt;uses-library android:name="com.marakana.android.lib.log" android:required="true"/&gt;</tt></td>
</tr></table>
</div>
</li>
<li>
<p>
Now we are ready for the makefile (<tt>Android.mk</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/java/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>LOCAL_PATH <span style="color: #990000">:=</span> $<span style="color: #990000">(</span><span style="color: #008080">call</span> my<span style="color: #990000">-</span>dir<span style="color: #990000">)</span>

# Build the library
include $<span style="color: #990000">(</span>CLEAR_VARS<span style="color: #990000">)</span>
LOCAL_MODULE_TAGS <span style="color: #990000">:=</span> optional
LOCAL_MODULE <span style="color: #990000">:=</span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log
LOCAL_SRC_FILES <span style="color: #990000">:=</span> $<span style="color: #990000">(</span><span style="color: #008080">call</span> all<span style="color: #990000">-</span>java<span style="color: #990000">-</span>files<span style="color: #990000">-</span>under<span style="color: #990000">,.)</span>
include $<span style="color: #990000">(</span>BUILD_JAVA_LIBRARY<span style="color: #990000">)</span>

# Build the documentation
include $<span style="color: #990000">(</span>CLEAR_VARS<span style="color: #990000">)</span>
LOCAL_SRC_FILES <span style="color: #990000">:=</span> $<span style="color: #990000">(</span><span style="color: #008080">call</span> all<span style="color: #990000">-</span>subdir<span style="color: #990000">-</span>java<span style="color: #990000">-</span>files<span style="color: #990000">)</span> $<span style="color: #990000">(</span><span style="color: #008080">call</span> all<span style="color: #990000">-</span>subdir<span style="color: #990000">-</span>html<span style="color: #990000">-</span>files<span style="color: #990000">)</span>
LOCAL_MODULE<span style="color: #990000">:=</span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log_doc
LOCAL_DROIDDOC_OPTIONS <span style="color: #990000">:=</span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log
LOCAL_MODULE_CLASS <span style="color: #990000">:=</span> JAVA_LIBRARIES
LOCAL_DROIDDOC_USE_STANDARD_DOCLET <span style="color: #990000">:=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
include $<span style="color: #990000">(</span>BUILD_DROIDDOC<span style="color: #990000">)</span>

# <span style="color: #008080">Copy</span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log<span style="color: #990000">.</span><span style="color: #008080">xml</span> to <span style="color: #990000">/</span>system<span style="color: #990000">/</span>etc<span style="color: #990000">/</span>permissions<span style="color: #990000">/</span>
include $<span style="color: #990000">(</span>CLEAR_VARS<span style="color: #990000">)</span>
LOCAL_MODULE_TAGS <span style="color: #990000">:=</span> optional
LOCAL_MODULE <span style="color: #990000">:=</span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log<span style="color: #990000">.</span>xml
LOCAL_MODULE_CLASS <span style="color: #990000">:=</span> ETC
LOCAL_MODULE_PATH <span style="color: #990000">:=</span> $<span style="color: #990000">(</span>TARGET_OUT_ETC<span style="color: #990000">)/</span>permissions
LOCAL_SRC_FILES <span style="color: #990000">:=</span> $<span style="color: #990000">(</span>LOCAL_MODULE<span style="color: #990000">)</span>
include $<span style="color: #990000">(</span>BUILD_PREBUILT<span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">In this one file, we have three separate targets: to compile the code, to build the documentation (used by the SDK addon), and to copy the <tt>com.marakana.android.lib.log.xml</tt> file to <tt>/system/etc/permissions/</tt> (though this last one seems a too fancy for a simple copy command). Notice that we separate these three targets using the <tt>include $(CLEAR_VARS)</tt> macro.</td>
</tr></table>
</div>
</li>
<li>
<p>
Compile:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cd device/marakana/alpha/framework/libmrknlog_jni/java
device/marakana/alpha/framework/libmrknlog_jni/java$ mm com.marakana.android.lib.log com.marakana.android.lib.log.xml
…
target Java: com.marakana.android.lib.log
…
Copying: out/target/common/obj/JAVA_LIBRARIES/com.marakana.android.lib.log_intermediates/classes.jar
…
Install: out/target/product/alpha/system/framework/com.marakana.android.lib.log.jar
target Prebuilt: com.marakana.android.lib.log.xml (out/target/product/alpha/obj/ETC/com.marakana.android.lib.log.xml_intermediates/com.marakana.android.lib.log.xml)
Install: out/target/product/alpha/system/etc/permissions/com.marakana.android.lib.log.xml
…
device/marakana/alpha/framework/libmrknlog_jni/java$ croot
$</tt></pre>
</div></div>
</li>
<li>
<p>
Next, we need create the C header file for our library (using the <tt>javah -jni</tt> command), and fortunately we can re-use the compiled classes left for us in the <tt>out/</tt> directory by the previous step:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ javah -jni \
    -d device/marakana/alpha/framework/libmrknlog_jni/jni/ \
    -classpath out/target/common/obj/JAVA_LIBRARIES/com.marakana.android.lib.log_intermediates/classes.jar \
    com.marakana.android.lib.log.LibLog</tt></pre>
</div></div>
</li>
<li>
<p>
To check that it worked, we can take a look at the generated C header file (<tt>…_LibLog.h</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/jni/com_marakana_android_lib_log_LibLog.h</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> Java_com_marakana_android_lib_log_LibLog_flushLog
  <span style="color: #990000">(</span>JNIEnv <span style="color: #990000">*,</span> jclass<span style="color: #990000">);</span>
…
JNIEXPORT jint <span style="color: #008080">JNICALL</span> Java_com_marakana_android_lib_log_LibLog_getTotalLogSize
  <span style="color: #990000">(</span>JNIEnv <span style="color: #990000">*,</span> jclass<span style="color: #990000">);</span>
…
JNIEXPORT jint <span style="color: #008080">JNICALL</span> Java_com_marakana_android_lib_log_LibLog_getUsedLogSize
  <span style="color: #990000">(</span>JNIEnv <span style="color: #990000">*,</span> jclass<span style="color: #990000">);</span>
…</tt></pre></div></div>
</li>
<li>
<p>
Now we can provide our implementation (<tt>….LibLog.c</tt>), which simply wraps calls to functions from <tt>libmrknlog</tt> and provides some basic error handling:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/jni/com_marakana_android_lib_log_LibLog.c</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">&lt;libmrknlog.h&gt;</span>
<span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"com_marakana_android_lib_log_LibLog.h"</span>

<span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">ThrowLibLogException</span></span><span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span>message<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #008080">jclass</span> class <span style="color: #990000">=</span> <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">FindClass</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"com/marakana/android/lib/log/LibLogException"</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>class<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">ThrowNew</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> class<span style="color: #990000">,</span> message<span style="color: #990000">);</span>
    <span style="color: #990000">(*</span>env<span style="color: #990000">)-&gt;</span><span style="font-weight: bold"><span style="color: #000000">DeleteLocalRef</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> class<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

JNIEXPORT <span style="color: #009900">void</span> <span style="color: #008080">JNICALL</span> Java_com_marakana_android_lib_log_LibLog_flushLog
  <span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">mrkn_flush_log</span></span><span style="color: #990000">()</span> <span style="color: #990000">!=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">ThrowLibLogException</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to flush log"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

JNIEXPORT jint <span style="color: #008080">JNICALL</span> Java_com_marakana_android_lib_log_LibLog_getTotalLogSize
  <span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #008080">jint</span> result <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_total_log_size</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>result <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">ThrowLibLogException</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to get total log size"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

JNIEXPORT jint <span style="color: #008080">JNICALL</span> Java_com_marakana_android_lib_log_LibLog_getUsedLogSize
  <span style="color: #990000">(</span><span style="color: #008080">JNIEnv</span> <span style="color: #990000">*</span>env<span style="color: #990000">,</span> <span style="color: #008080">jclass</span> clazz<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="color: #008080">jint</span> result <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">mrkn_get_used_log_size</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>result <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">ThrowLibLogException</span></span><span style="color: #990000">(</span>env<span style="color: #990000">,</span> <span style="color: #FF0000">"Failed to get used log size"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Next, we create a makefile (<tt>Android.mk</tt>) to compile our JNI code into a shared library (<tt>libmrknlog_jni.so</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/libmrknlog_jni/jni/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_SRC_FILES :=</span> com_marakana_android_lib_log_LibLog.c
LOCAL_C_INCLUDES <span style="color: #990000">+=</span> <span style="color: #009900">$(JNI_H_INCLUDE)</span> <span style="color: #009900">$(LOCAL_PATH)</span><span style="color: #990000">/../../..</span>/lib/libmrknlog
<span style="color: #990000">LOCAL_SHARED_LIBRARIES :=</span> libmrknlog
<span style="color: #990000">LOCAL_MODULE :=</span> libmrknlog_jni
include <span style="color: #009900">$(BUILD_SHARED_LIBRARY)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">As with <tt>libmrknlog.so</tt>, in previous versions of Android (pre-4.0) we would have had to also specify <tt>LOCAL_PRELINK_MODULE := false</tt> to disable pre-linking of our shared library.</td>
</tr></table>
</div>
</li>
<li>
<p>
Now we have all the pieces to compile our JNI library (into <tt>/system/lib/libmrknlog_jni.so</tt>):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cd device/marakana/alpha/framework/libmrknlog_jni/jni
device/marakana/alpha/framework/libmrknlog_jni/jni$ mm
…
Install: out/target/product/alpha/system/lib/libmrknlog_jni.so
device/marakana/alpha/framework/libmrknlog_jni/jni$ croot
$</tt></pre>
</div></div>
</li>
<li>
<p>
As before, since our Java/JNI library&#8217;s components are marked as <tt>LOCAL_MODULE_TAGS := optional</tt>, in order to get them into the final ROM, we need to register them with Alpha&#8217;s <tt>PRODUCT_PACKAGES</tt>:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/common.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> <span style="color: #990000">\</span>
    com.marakana.android.lib.log <span style="color: #990000">\</span>
    com.marakana.android.lib.log.xml <span style="color: #990000">\</span>
    libmrknlog_jni</tt></pre></div></div>
</li>
<li>
<p>
Now we can rebuild our entire device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10
…
Install system fs image: out/target/product/alpha/system.img</tt></pre>
</div></div>
</li>
<li>
<p>
Finally, we are ready to test our Java/JNI library via the <tt>Main.main()</tt> method:
</p>
<div class="listingblock">
<div class="content">
<pre><tt># (re)start the emulator
$ out/host/linux-x86/bin/emulator -kernel out/target/product/alpha/kernel &amp;
# wait for the emulator to finish
# check out our Java library
$ adb shell ls -l /system/framework/com.marakana.android.lib.log.jar
-rw-r--r-- root     root          313 2012-01-05 00:47 com.marakana.android.lib.log.jar
# check out our Java library registry file
$ adb shell ls -l /system/etc/permissions/com.marakana.android.lib.log.xml
-rw-r--r-- root     root          180 2012-01-05 00:47 com.marakana.android.lib.log.xml
# check out our JNI shared library
$ adb shell ls -l /system/lib/libmrknlog_jni.so
-rw-r--r-- root     root         5452 2012-01-05 00:54 libmrknlog_jni.so
# check if our utility is doing what it is supposed to
$ adb logcat -g
/dev/log/main: ring buffer is 64Kb (33Kb consumed), max entry is 4096b, max payload is 4076b
# now run our Java library's Main.main() by directly invoking the Dalvik VM
$ adb shell dalvikvm -cp /system/framework/com.marakana.android.lib.log.jar com.marakana.android.lib.log.Main
Flushed log. Previously it was consuming 34346 of 65536 bytes
# check again
$ adb logcat -g
/dev/log/main: ring buffer is 64Kb (0Kb consumed), max entry is 4096b, max payload is 4076b
$ adb shell dalvikvm -cp /system/framework/com.marakana.android.lib.log.jar com.marakana.android.lib.log.Main
Flushed log. Previously it was consuming 318 of 65536 bytes
# good :-)</tt></pre>
</div></div>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_consuming_our_a_custom_java_jni_8594_native_library_via_a_custom_app_optional">9.10. Consuming our a Custom Java/JNI&#8594;Native Library via a Custom App (Optional)</h3>
<div class="ulist"><ul>
<li>
<p>
Now that we have a native library, and a JNI wrapper around it, we could create a custom application to take advantage of its services
</p>
</li>
<li>
<p>
Note that we will later wrap the JNI library with a client-service Binder library/solution, so the app we are creating now is just for demonstration purposes - not the final "solution"
</p>
</li>
<li>
<p>
Let&#8217;s get started:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a home directory for our Alpha apps:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir -p device/marakana/alpha/app/</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This app will not be shared with the SDK add-on.</td>
</tr></table>
</div>
</li>
<li>
<p>
As we should know by now, we need a makefile (<tt>Android.mk</tt>) to include <tt>app/</tt>'s the sub-directories:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span></tt></pre></div></div>
</li>
<li>
<p>
Now we can create a sub-directory for our app (<tt>MrknLogLibClient</tt>), its basic directory structure (<tt>res/</tt>, and <tt>src/</tt>), and the source package (<tt>com.marakana.android.loglibclient</tt>) directory structure:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir -p device/marakana/alpha/app/MrknLogLibClient/res/values
$ mkdir -p device/marakana/alpha/app/MrknLogLibClient/res/layout
$ mkdir -p device/marakana/alpha/app/MrknLogLibClient/src/com/marakana/android/loglibclient</tt></pre>
</div></div>
</li>
<li>
<p>
We need some basic string resources (used in the UI):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogLibClient/res/values/strings.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Marakana Log Lib Client<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"log_utilization_message"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Using %1$d of %2$d bytes of the log buffer<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"flush_log_button"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Flush Log Buffer<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
And we also need a simple layout (<tt>log.xml</tt>), with a text view, to show the current log utilization, and a button, to allow us to clear the log:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogLibClient/res/layout/log.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;LinearLayout</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
  <span style="color: #009900">android:orientation</span><span style="color: #990000">=</span><span style="color: #FF0000">"vertical"</span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span>
  <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;TextView</span></span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
    <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"center"</span> <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/output"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;Button</span></span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
    <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/button"</span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/flush_log_button"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/LinearLayout&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
Now, we are ready to write our one-and only activity (<tt>LogActivity</tt>) utilizing <tt>com.marakana.android.lib.log</tt> Java/JNI library:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogLibClient/src/com/marakana/android/loglibclient/LogActivity.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>loglibclient<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Activity<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Bundle<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Handler<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Button<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>TextView<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log<span style="color: #990000">.</span>LibLog<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LogActivity</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Activity
  <span style="font-weight: bold"><span style="color: #0000FF">implements</span></span> View<span style="color: #990000">.</span>OnClickListener<span style="color: #990000">,</span> Runnable <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">TextView</span> output<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">Handler</span> handler<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span><span style="color: #008080">Bundle</span> savedInstanceState<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span>savedInstanceState<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setContentView</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>layout<span style="color: #990000">.</span>log<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output <span style="color: #990000">=</span> <span style="color: #990000">(</span>TextView<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>output<span style="color: #990000">);</span>
    <span style="color: #008080">Button</span> button <span style="color: #990000">=</span> <span style="color: #990000">(</span>Button<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>button<span style="color: #990000">);</span>
    button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setOnClickListener</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Handler</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">updateOutput</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setText</span></span><span style="color: #990000">(</span>
      <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getString</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>log_utilization_message<span style="color: #990000">,</span>
      LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">(),</span> LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">()));</span>
  <span style="color: #FF0000">}</span>

  @Override
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onResume</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onResume</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

  @Override
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPause</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onPause</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">removeCallbacks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onClick</span></span><span style="color: #990000">(</span><span style="color: #008080">View</span> view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">updateOutput</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">updateOutput</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">postDelayed</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">1000</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Our activity uses a handler in order to request periodic (1 Hz) call-backs to the <tt>run()</tt> method, via which we simply update our UI with the log utilization data.</td>
</tr></table>
</div>
</li>
<li>
<p>
And, like any other app, we need to provide our own <tt>AndroidManifest.xml</tt> configuration file:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogLibClient/AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
  <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.loglibclient"</span>
  <span style="color: #009900">android:versionCode</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
  <span style="color: #009900">android:versionName</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-sdk</span></span> <span style="color: #009900">android:minSdkVersion</span><span style="color: #990000">=</span><span style="color: #FF0000">"8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.READ_LOGS"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-library</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.lib.log"</span> <span style="color: #009900">android:required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".LogActivity"</span> <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.action.MAIN"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;category</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.category.LAUNCHER"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">We need <tt>&lt;uses-permission android:name="android.permission.READ_LOGS"/&gt;</tt> so that our app&#8217;s user ID gets added to the <tt>log</tt> group membership, or otherwise we won&#8217;t be able to read from <tt>/dev/log/main</tt> (as discussed earlier).<br />
Additionally, we added <tt>&lt;uses-library android:name="com.marakana.android.lib.log" android:required="true"/&gt;</tt> so that we get run-time access to the <tt>com.marakana.android.lib.log</tt> library.</td>
</tr></table>
</div>
</li>
<li>
<p>
And, like any other component, our app also needs its own makefile (<tt>Android.mk</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogLibClient/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_SRC_FILES :=</span> <span style="color: #009900">$(</span>call all-java-files-under<span style="color: #990000">,</span>src<span style="color: #990000">)</span>
<span style="color: #990000">LOCAL_JAVA_LIBRARIES :=</span> com.marakana.android.lib.log
<span style="color: #990000">LOCAL_PACKAGE_NAME :=</span> MrknLogLibClient
<span style="color: #990000">LOCAL_SDK_VERSION :=</span> current
<span style="color: #990000">LOCAL_PROGUARD_ENABLED :=</span> disabled
include <span style="color: #009900">$(BUILD_PACKAGE)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">We are referencing our <tt>com.marakana.android.lib.log</tt> library here as well, for the sake of the compiler. Also, notice that we are using <tt>include $(BUILD_PACKAGE)</tt> in order to build our code as an app.</td>
</tr></table>
</div>
</li>
<li>
<p>
And, also like any other component that we wish to include in our ROM, we need to register <tt>MrknLogLibClient</tt> with the device&#8217;s main makefile (<tt>full_alpha.xml</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/full_alpha.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> MrknLogLibClient</tt></pre></div></div>
</li>
<li>
<p>
Now we can compile it:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10
…
Install: out/target/product/alpha/system/app/MrknLogLibClient.apk
…
Install system fs image: out/target/product/alpha/system.img</tt></pre>
</div></div>
</li>
<li>
<p>
And finally, we can test everything:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Restart the emulator
</p>
</li>
<li>
<p>
Launch the <tt>Marakana Log Lib Client</tt> app
</p>
</li>
<li>
<p>
Test that you can flush the log buffer
</p>
<div class="imageblock">
<div class="content">
<img src="screens/MrknLogLibClient.png" alt="screens/MrknLogLibClient.png" />
</div>
</div>
</li>
</ol></div>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_exposing_our_custom_library_via_a_custom_ipc_binder_service">9.11. Exposing our Custom Library via a Custom IPC/Binder Service</h3>
<div class="ulist"><ul>
<li>
<p>
Let&#8217;s suppose that we were able to control access to our "driver" (even though it is not really ours), such that:
</p>
<div class="ulist"><ul>
<li>
<p>
The "read" operations (getting the used/total sizes of the log buffer) are implicitly permitted
</p>
</li>
<li>
<p>
The "write" operation (flushing the log buffer) requires an explicit permission check
</p>
</li>
</ul></div>
</li>
<li>
<p>
We can do this by wrapping "our driver" (and the custom library that enables these operations) with:
</p>
<div class="ulist"><ul>
<li>
<p>
A custom Binder-based service where we control access to the driver
</p>
</li>
<li>
<p>
A custom Java-based manager (library) where we enable transparent access to our service
</p>
</li>
</ul></div>
</li>
<li>
<p>
Let&#8217;s get started:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
We&#8217;ll start off by creating a directory structure for the custom manager library, since that&#8217;s where our service descriptor (<tt>ILogService.aidl</tt>) is going to live:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha/framework/mrknlogservice
$ mkdir -p device/marakana/alpha/framework/mrknlogservice/com/marakana/android/service/log</tt></pre>
</div></div>
</li>
<li>
<p>
Let&#8217;s create a simple AIDL description of our service (<tt>LibLogService.aidl</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/mrknlogservice/com/marakana/android/service/log/ILogService.aidl</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>service<span style="color: #990000">.</span>log<span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">/**</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * System-private API for talking to the LogService.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> * {</span></span><span style="color: #009900">@hide</span><span style="font-style: italic"><span style="color: #9A1900">}</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">ILogService</span> <span style="color: #FF0000">{</span>
  <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">();</span>
  <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">();</span>
  <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Notice that the methods described by <tt>ILogService.aidl</tt> closely match what our <tt>LibLog</tt> JNI-bridge provides. Also, we are using <tt>{@hide}</tt> to <em>hide</em> our AIDL interface from the documentation we&#8217;ll be producing later for our SDK addon. Why hide it? Because the clients will use our service via a manager proxy that we&#8217;ll be creating next.</td>
</tr></table>
</div>
</li>
<li>
<p>
We don&#8217;t want to force the "complexity" of Binder upon our clients, so we provide them with a convenience <tt>LogManager</tt> proxy to our (yet-to-be-created) service:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/mrknlogservice/com/marakana/android/service/log/LogManager.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>service<span style="color: #990000">.</span>log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>IBinder<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>ServiceManager<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LogManager</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"LogManager"</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> REMOTE_SERVICE_NAME <span style="color: #990000">=</span> ILogService<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getName</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">ILogService</span> service<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #008080">LogManager</span> <span style="font-weight: bold"><span style="color: #000000">getInstance</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">LogManager</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #000000">LogManager</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Connecting to ILogService by name ["</span> <span style="color: #990000">+</span> REMOTE_SERVICE_NAME <span style="color: #990000">+</span> <span style="color: #FF0000">"]"</span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">=</span> ILogService<span style="color: #990000">.</span>Stub<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">asInterface</span></span><span style="color: #990000">(</span>ServiceManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getService</span></span><span style="color: #990000">(</span>REMOTE_SERVICE_NAME<span style="color: #990000">));</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service <span style="color: #990000">==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">IllegalStateException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Failed to find ILogService by name ["</span> <span style="color: #990000">+</span> REMOTE_SERVICE_NAME <span style="color: #990000">+</span> <span style="color: #FF0000">"]"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
      Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Flushing logs. If it works, you won't see this message."</span><span style="color: #990000">);</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">RemoteException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">RuntimeException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Failed to flush log"</span><span style="color: #990000">,</span> e<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">RemoteException</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">RuntimeException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Failed to get total log size"</span><span style="color: #990000">,</span> e<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>service<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">catch</span></span> <span style="color: #990000">(</span><span style="color: #008080">Exception</span> e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">RuntimeException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Failed to get used log size"</span><span style="color: #990000">,</span> e<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">We are using <tt>android.os.ServiceManager</tt> to lookup an object providing <tt>ILogService</tt> implementation. This is going to be our service, which we yet have to create and register with the service-manager.</td>
</tr></table>
</div>
</li>
<li>
<p>
For our clients to access <tt>LogManager</tt>, we need to expose it as a Java library - so we create an XML descriptor for it:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/mrknlogservice/com.marakana.android.service.log.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;permissions&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;library</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.service.log"</span>
    <span style="color: #009900">file</span><span style="color: #990000">=</span><span style="color: #FF0000">"/system/framework/com.marakana.android.service.log.jar"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/permissions&gt;</span></span>
</tt></pre></div></div>
</li>
<li>
<p>
Now we are ready ready to create a makefile (<tt>Android.mk</tt>) with rules to compile our library, build its documentation, and copy its <tt>com.marakana.android.service.log.xml</tt> descriptor to <tt>/system/etc/permissions/</tt>:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/framework/mrknlogservice/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH :=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Build the library</span></span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_MODULE :=</span> com.marakana.android.service.log
<span style="color: #990000">LOCAL_SRC_FILES :=</span> <span style="color: #009900">$(</span>call all-java-files-under<span style="color: #990000">,.)</span>
LOCAL_SRC_FILES <span style="color: #990000">+=</span> com/marakana/android/service/log/ILogService.aidl
include <span style="color: #009900">$(BUILD_JAVA_LIBRARY)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Build the documentation</span></span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_SRC_FILES :=</span> <span style="color: #009900">$(</span>call all-subdir-java-files<span style="color: #990000">)</span> <span style="color: #009900">$(</span>call all-subdir-html-files<span style="color: #990000">)</span>
<span style="color: #990000">LOCAL_MODULE:=</span> com.marakana.android.service.log_doc
<span style="color: #990000">LOCAL_DROIDDOC_OPTIONS :=</span> com.marakana.android.service.log
<span style="color: #990000">LOCAL_MODULE_CLASS :=</span> JAVA_LIBRARIES
<span style="color: #990000">LOCAL_DROIDDOC_USE_STANDARD_DOCLET :=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
include <span style="color: #009900">$(BUILD_DROIDDOC)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Copy com.marakana.android.service.log.xml to /system/etc/permissions/</span></span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_MODULE :=</span> com.marakana.android.service.log.xml
<span style="color: #990000">LOCAL_MODULE_CLASS :=</span> ETC
<span style="color: #990000">LOCAL_MODULE_PATH :=</span> <span style="color: #009900">$(TARGET_OUT_ETC)</span>/permissions
<span style="color: #990000">LOCAL_SRC_FILES :=</span> <span style="color: #009900">$(LOCAL_MODULE)</span>
include <span style="color: #009900">$(BUILD_PREBUILT)</span></tt></pre></div></div>
</li>
<li>
<p>
To test that we did everything correctly, we can compile our library:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cd device/marakana/alpha/framework/mrknlogservice
device/marakana/alpha/framework/mrknlogservice$ mm -j10 com.marakana.android.service.log com.marakana.android.service.log.xml
…
Aidl: com.marakana.android.service.log &lt;= device/marakana/alpha/framework/mrknlogservice/com/marakana/android/service/log/ILogService.aidl
…
Install: out/target/product/alpha/system/framework/com.marakana.android.service.log.jar
…
Install: out/target/product/alpha/system/etc/permissions/com.marakana.android.service.log.xml
…
device/marakana/alpha/framework/mrknlogservice$ croot
$</tt></pre>
</div></div>
</li>
<li>
<p>
For our <tt>com.marakana.android.service.log</tt> library to be included in the final ROM, we need to add it to the <tt>common.mk</tt> makefile:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/common.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> <span style="color: #990000">\</span>
    com.marakana.android.service.log <span style="color: #990000">\</span>
    com.marakana.android.service.log.xml</tt></pre></div></div>
</li>
<li>
<p>
Now we can create our <tt>MrknLogService</tt>, which will implement <tt>ILogService</tt>, but since we&#8217;ll define our service as an <em>application</em>, we need first to create a directory for <tt>alpha</tt> apps:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir -p device/marakana/alpha/app/</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This directory may already exist if we created <tt>MrknLogLibClient</tt> app before (this was optional).</td>
</tr></table>
</div>
</li>
<li>
<p>
And, as we know by now, we need a makefile to include <tt>app/</tt>'s sub-directories into the build:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This file may already exist if we created <tt>MrknLogLibClient</tt> app before (this was optional).</td>
</tr></table>
</div>
</li>
<li>
<p>
Next, we create a directory for our service (<tt>MrknLogService</tt>), its basic directory structure (<tt>res/</tt>, and <tt>src/</tt>), and the source package (<tt>com.marakana.android.loglibclient</tt>) directory structure:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir -p device/marakana/alpha/app/MrknLogService/res/values
$ mkdir -p device/marakana/alpha/app/MrknLogService/src/com/marakana/android/logservice</tt></pre>
</div></div>
</li>
<li>
<p>
We need some basic string resources:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogService/res/values/strings.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"flush_log_permission_label"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Flush Log<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"flush_log_permission_description"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Applications with this permission will be able
    to clear the logs, potentially covering their own tracks of malicious behavior.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">These strings are used for our custom permission that we&#8217;ll be creating next.</td>
</tr></table>
</div>
</li>
<li>
<p>
Next, let&#8217;s define our app&#8217;s <tt>AndroidManifest.xml</tt> file:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogService/AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
  <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.logservice"</span>
  <span style="color: #009900">android:versionCode</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span>
  <span style="color: #009900">android:versionName</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span>
  <span style="color: #009900">android:sharedUserId</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.uid.system"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-sdk</span></span> <span style="color: #009900">android:minSdkVersion</span><span style="color: #990000">=</span><span style="color: #FF0000">"8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission.READ_LOGS"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".LogServiceApp"</span> <span style="color: #009900">android:persistent</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-library</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.service.log"</span> <span style="color: #009900">android:required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-library</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.lib.log"</span> <span style="color: #009900">android:required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.logservice.FLUSH_LOG"</span>
    <span style="color: #009900">android:protectionLevel</span><span style="color: #990000">=</span><span style="color: #FF0000">"dangerous"</span>
    <span style="color: #009900">android:permissionGroup</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.permission-group.SYSTEM_TOOLS"</span>
    <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/flush_log_permission_label"</span>
    <span style="color: #009900">android:description</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/flush_log_permission_description"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>In this manifest file, there are a few items of interest:</p></div>
<div class="paragraph"><p>We required that our app run with the <tt>system</tt> user (so that we can access the <tt>ServiceManager</tt> &#8658; <tt>/system/bin/servicemanager</tt>) by adding <tt>android:sharedUserId="android.uid.system"</tt> attribute to the manifest. This is enforced by <tt>frameworks/base/cmds/servicemanager/service_manager.c:svc_can_register(…)</tt>.</p></div>
<div class="paragraph"><p>We gave ourselves access to the <tt>log</tt> group (so that we can read from <tt>/dev/log/main</tt>) with the <tt>&lt;uses-permission android:name="android.permission.READ_LOGS"/&gt;</tt> entry.</p></div>
<div class="paragraph"><p>We defined a custom <tt>LogServiceApp</tt> application class, which once loaded, will in turn load our service (<tt>ILogServiceImpl</tt>) and register it with the <tt>ServiceManager</tt>. We defined our application as <tt>android:persistent="true"</tt>, which means that the <tt>ActivityManager</tt> will automatically launch it on boot, and it will never demote its importance (<tt>/proc/&lt;our-service-app-pid&gt;/oom_adj</tt>=<tt>-12</tt>), so <tt>ActivityManagerService</tt> and the low memory killer will never kill it. Additionally, gave our application access to <tt>com.marakana.android.service.log</tt> library to get access to <tt>ILogService</tt> interface and <tt>com.marakana.android.lib.log</tt> library to get access to <tt>LibLog</tt> JNI bridge.</p></div>
<div class="paragraph"><p>Finally, we defined our custom permission (<tt>….FLUSH_LOG</tt>), which we&#8217;ll later enforce in our service class implementation (<tt>ILogServiceImpl</tt>).</p></div>
</td>
</tr></table>
</div>
</li>
<li>
<p>
Now we can provide the implementation <tt>ILogServiceImpl</tt> for our AIDL-defined interface (<tt>ILogService</tt>) we created earlier:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogService/src/com/marakana/android/logservice/ILogServiceImpl.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logservice<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>Context<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>content<span style="color: #990000">.</span>pm<span style="color: #990000">.</span>PackageManager<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>RemoteException<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>service<span style="color: #990000">.</span>log<span style="color: #990000">.</span>ILogService<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>log<span style="color: #990000">.</span>LibLog<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">ILogServiceImpl</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> ILogService<span style="color: #990000">.</span>Stub <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"ILogServiceImpl"</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">Context</span> context<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #000000">ILogServiceImpl</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>context <span style="color: #990000">=</span> context<span style="color: #990000">;</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> RemoteException <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>context<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">checkCallingOrSelfPermission</span></span><span style="color: #990000">(</span>Manifest<span style="color: #990000">.</span>permission<span style="color: #990000">.</span>FLUSH_LOG<span style="color: #990000">)</span> <span style="color: #990000">!=</span>
        PackageManager<span style="color: #990000">.</span>PERMISSION_GRANTED<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">throw</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">SecurityException</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Requires FLUSH_LOG permission"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Flushing logs. If it works, you won't see this message."</span><span style="color: #990000">);</span>
    LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> RemoteException <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">int</span> <span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">throws</span></span> RemoteException <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> LibLog<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">For the most part, our service simply wraps our JNI library, except that it requires that the caller be granted our custom <tt>Manifest.permission.FLUSH_LOG</tt> permission before calling the <tt>LibLog.flushLog()</tt> method.</td>
</tr></table>
</div>
</li>
<li>
<p>
For our <tt>ILogServiceImpl</tt> to be accessible to our <tt>LogManager</tt>, we need to instantiate it and register it with the <tt>ServiceManager</tt> - we do this in our custom <tt>LogServiceApp</tt> application class loaded from the manifest file:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogService/src/com/marakana/android/logservice/LogServiceApp.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logservice<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Application<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>ServiceManager<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>util<span style="color: #990000">.</span>Log<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>service<span style="color: #990000">.</span>log<span style="color: #990000">.</span>ILogService<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LogServiceApp</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Application <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> TAG <span style="color: #990000">=</span> <span style="color: #FF0000">"LogServiceApp"</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> REMOTE_SERVICE_NAME <span style="color: #990000">=</span> ILogService<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getName</span></span><span style="color: #990000">();</span>
  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">ILogServiceImpl</span> serviceImpl<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>serviceImpl <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">ILogServiceImpl</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    ServiceManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addService</span></span><span style="color: #990000">(</span>REMOTE_SERVICE_NAME<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>serviceImpl<span style="color: #990000">);</span>
    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Registered ["</span> <span style="color: #990000">+</span> serviceImpl<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getClass</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">getName</span></span><span style="color: #990000">()</span> <span style="color: #990000">+</span> <span style="color: #FF0000">"] as ["</span> <span style="color: #990000">+</span> REMOTE_SERVICE_NAME <span style="color: #990000">+</span> <span style="color: #FF0000">"]"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onTerminate</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onTerminate</span></span><span style="color: #990000">();</span>
    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"Terminated"</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Normally, regular applications cannot get access to <tt>ServiceManager</tt> class (because it is hidden) nor to the <tt>servicemanager</tt> daemon (because it enforces UID-based restrictions). To work around these limitations, we&#8217;ll compile our app with the framework classes (where <tt>ServiceManager</tt> is <em>not</em> hidden), and run it with the <tt>system</tt> user (which <em>does</em> have access to <tt>servicemanager</tt> daemon).</td>
</tr></table>
</div>
</li>
<li>
<p>
We are now ready for our makefile (<tt>Android.mk</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogService/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_SRC_FILES :=</span> <span style="color: #009900">$(</span>call all-java-files-under<span style="color: #990000">,</span>src<span style="color: #990000">)</span>
<span style="color: #990000">LOCAL_REQUIRED_MODULES :=</span> <span style="color: #990000">\</span>
    com.marakana.android.service.log <span style="color: #990000">\</span>
    com.marakana.android.lib.log
<span style="color: #990000">LOCAL_JAVA_LIBRARIES :=</span> <span style="color: #990000">\</span>
    com.marakana.android.service.log <span style="color: #990000">\</span>
    com.marakana.android.lib.log <span style="color: #990000">\</span>
    core <span style="color: #990000">\</span>
    framework
<span style="color: #990000">LOCAL_PACKAGE_NAME :=</span> MrknLogService
<span style="color: #990000">LOCAL_SDK_VERSION :=</span> current
<span style="color: #990000">LOCAL_PROGUARD_ENABLED :=</span> disabled
<span style="color: #990000">LOCAL_CERTIFICATE :=</span> platform
include <span style="color: #009900">$(BUILD_PACKAGE)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">The setting <tt>LOCAL_JAVA_LIBRARIES := … framework</tt> allows us to reference <tt>ServiceManager</tt> and<br />
<tt>LOCAL_CERTIFICATE := platform</tt> makes it possible for us to run with the <tt>system</tt> user and thereby access the <tt>servicemanager</tt> daemon.</td>
</tr></table>
</div>
</li>
<li>
<p>
Let&#8217;s compile our code:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ cd device/marakana/alpha/app/MrknLogService
device/marakana/alpha/app/MrknLogService$ mm
…
Install: out/target/product/alpha/system/app/MrknLogService.apk
device/marakana/alpha/app/MrknLogService$ croot
$</tt></pre>
</div></div>
</li>
<li>
<p>
We want our <tt>MrknLogService</tt> to be included in the final ROM, so we add it to <tt>common.mk</tt>:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/common.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> MrknLogService</tt></pre></div></div>
</li>
<li>
<p>
Compile the entire device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10
…
Install system fs image: out/target/product/alpha/system.img</tt></pre>
</div></div>
</li>
<li>
<p>
It&#8217;s best to test our new manager&#8594;service&#8594;library&#8594;driver proxy via a real application, so that&#8217;s what we&#8217;ll be creating next.
</p>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_building_a_custom_app_using_a_custom_service_manager">9.12. Building a Custom App Using a Custom Service Manager</h3>
<div class="ulist"><ul>
<li>
<p>
Similar to how we implemented <tt>MrknLogLibClient</tt> app, we are now going to create a new app (<tt>MrknLogServiceClient</tt>), that will take advantage of our IPC/Binder-based APIs
</p>
</li>
<li>
<p>
Since most of the steps are going to be very similar, we&#8217;ll focus only on the parts that are different:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a new directory for our new app (<tt>MrknLogServiceClient</tt>), its basic directory structure (<tt>res/</tt>, and <tt>src/</tt>), and the source package (<tt>com.marakana.android.logserviceclient</tt>) directory structure:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir -p device/marakana/alpha/app/MrknLogServiceClient/res/values
$ mkdir -p device/marakana/alpha/app/MrknLogServiceClient/res/layout
$ mkdir -p device/marakana/alpha/app/MrknLogServiceClient/src/com/marakana/android/logserviceclient</tt></pre>
</div></div>
</li>
<li>
<p>
Just like before, we need some basic string resources (used in the UI):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogServiceClient/res/values/strings.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Marakana Log Service Client<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"log_utilization_message"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Using %1$d of %2$d bytes of the log buffer<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;string</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"flush_log_button"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Flush Log Buffer<span style="font-weight: bold"><span style="color: #0000FF">&lt;/string&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
And we also need a simple layout (<tt>log.xml</tt>), which is exactly the same as the one we created for <tt>MrknLogLibClient</tt> before:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogServiceClient/res/layout/log.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;LinearLayout</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
  <span style="color: #009900">android:orientation</span><span style="color: #990000">=</span><span style="color: #FF0000">"vertical"</span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span>
  <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;TextView</span></span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
    <span style="color: #009900">android:gravity</span><span style="color: #990000">=</span><span style="color: #FF0000">"center"</span> <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/output"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;Button</span></span> <span style="color: #009900">android:layout_width</span><span style="color: #990000">=</span><span style="color: #FF0000">"fill_parent"</span> <span style="color: #009900">android:layout_height</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrap_content"</span>
    <span style="color: #009900">android:id</span><span style="color: #990000">=</span><span style="color: #FF0000">"@+id/button"</span> <span style="color: #009900">android:text</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/flush_log_button"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/LinearLayout&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
Our activity (<tt>LogActivity</tt>) will be similar to the one we wrote before, except that in this case will be using  <tt>com.marakana.android.service.log</tt> Java (Binder) library and its <tt>LogManager</tt> APIs:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogServiceClient/src/com/marakana/android/logserviceclient/LogActivity.java</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>logserviceclient<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>app<span style="color: #990000">.</span>Activity<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Bundle<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>os<span style="color: #990000">.</span>Handler<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>view<span style="color: #990000">.</span>View<span style="color: #990000">.</span>OnClickListener<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>Button<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> android<span style="color: #990000">.</span>widget<span style="color: #990000">.</span>TextView<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #000080">import</span></span> com<span style="color: #990000">.</span>marakana<span style="color: #990000">.</span>android<span style="color: #990000">.</span>service<span style="color: #990000">.</span>log<span style="color: #990000">.</span>LogManager<span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="color: #008080">LogActivity</span> <span style="font-weight: bold"><span style="color: #0000FF">extends</span></span> Activity <span style="color: #008080">implements</span> Runnable<span style="color: #990000">,</span> OnClickListener <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">TextView</span> output<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">Handler</span> handler<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #008080">LogManager</span> logManager<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span><span style="color: #008080">Bundle</span> savedInstanceState<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>logManager <span style="color: #990000">=</span> LogManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getInstance</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onCreate</span></span><span style="color: #990000">(</span>savedInstanceState<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setContentView</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>layout<span style="color: #990000">.</span>log<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output <span style="color: #990000">=</span> <span style="color: #990000">(</span>TextView<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>output<span style="color: #990000">);</span>
    <span style="color: #008080">Button</span> button <span style="color: #990000">=</span> <span style="color: #990000">(</span>Button<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">findViewById</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>id<span style="color: #990000">.</span>button<span style="color: #990000">);</span>
    button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setOnClickListener</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Handler</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">updateOutput</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>output<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setText</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getString</span></span><span style="color: #990000">(</span>R<span style="color: #990000">.</span>string<span style="color: #990000">.</span>log_utilization_message<span style="color: #990000">,</span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>logManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getUsedLogSize</span></span><span style="color: #990000">(),</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>logManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getTotalLogSize</span></span><span style="color: #990000">()));</span>
  <span style="color: #FF0000">}</span>

  @Override
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onResume</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onResume</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

  @Override
  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onPause</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">super</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">onPause</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">removeCallbacks</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onClick</span></span><span style="color: #990000">(</span><span style="color: #008080">View</span> view<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>logManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">flushLog</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">updateOutput</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">run</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">updateOutput</span></span><span style="color: #990000">();</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>handler<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">postDelayed</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">1000</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</li>
<li>
<p>
Like before, we need a <tt>AndroidManifest.xml</tt> file, but this time around we are using the <tt>….FLUSH_LOG</tt> permission, and <tt>com.marakana.android.service.log</tt> library:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogServiceClient/AndroidManifest.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;manifest</span></span> <span style="color: #009900">xmlns:android</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/apk/res/android"</span>
  <span style="color: #009900">package</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.logserviceclient"</span>
  <span style="color: #009900">android:versionCode</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span> <span style="color: #009900">android:versionName</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-sdk</span></span> <span style="color: #009900">android:minSdkVersion</span><span style="color: #990000">=</span><span style="color: #FF0000">"8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-permission</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.logservice.FLUSH_LOG"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;application</span></span> <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;uses-library</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.marakana.android.service.log"</span>
      <span style="color: #009900">android:required</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">".LogActivity"</span>
      <span style="color: #009900">android:label</span><span style="color: #990000">=</span><span style="color: #FF0000">"@string/app_name"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.action.MAIN"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;category</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.intent.category.LAUNCHER"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/application&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/manifest&gt;</span></span></tt></pre></div></div>
</li>
<li>
<p>
And, also like before, our app needs its own makefile (<tt>Android.mk</tt>):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/app/MrknLogServiceClient/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">LOCAL_PATH:=</span> <span style="color: #009900">$(</span>call my-dir<span style="color: #990000">)</span>
include <span style="color: #009900">$(CLEAR_VARS)</span>
<span style="color: #990000">LOCAL_MODULE_TAGS :=</span> optional
<span style="color: #990000">LOCAL_SRC_FILES :=</span> <span style="color: #009900">$(</span>call all-java-files-under<span style="color: #990000">,</span>src<span style="color: #990000">)</span>
<span style="color: #990000">LOCAL_JAVA_LIBRARIES :=</span> com.marakana.android.service.log
<span style="color: #990000">LOCAL_PACKAGE_NAME :=</span> MrknLogServiceClient
<span style="color: #990000">LOCAL_SDK_VERSION :=</span> current
<span style="color: #990000">LOCAL_PROGUARD_ENABLED :=</span> disabled
include <span style="color: #009900">$(BUILD_PACKAGE)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">We are referencing our <tt>com.marakana.android.service.log</tt> library here as well, for the sake of the compiler.</td>
</tr></table>
</div>
</li>
<li>
<p>
And, as before, we need to register <tt>MrknLogServiceClient</tt> with the device&#8217;s main makefile (<tt>full_alpha.xml</tt>) in order to get it included in the ROM:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha/full_alpha.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>…
PRODUCT_PACKAGES <span style="color: #990000">+=</span> MrknLogServiceClient</tt></pre></div></div>
</li>
<li>
<p>
Now we can compile our entire device:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10
…
Install: out/target/product/alpha/system/app/MrknLogServiceClient.apk
…
Install system fs image: out/target/product/alpha/system.img</tt></pre>
</div></div>
</li>
<li>
<p>
And finally, we can test everything:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Restart the emulator
</p>
</li>
<li>
<p>
Launch the <tt>Marakana Log Service Client</tt> app
</p>
</li>
<li>
<p>
Test that you can flush the log buffer
</p>
<div class="imageblock">
<div class="content">
<img src="screens/MrknLogServiceClient.png" alt="screens/MrknLogServiceClient.png" />
</div>
</div>
</li>
</ol></div>
</li>
</ol></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_creating_a_custom_sdk_add_on_optional">9.13. Creating a Custom SDK Add-on (Optional)</h3>
<div class="ulist"><ul>
<li>
<p>
We can create apps for our own custom device (utilizing our custom libraries), but what if we wanted to expose those APIs to 3rd part developers? We&#8217;d need an SDK Addon
</p>
</li>
<li>
<p>
Android SDK addons allow 3rd party developers to get access to our custom system images (including our custom libraries), compile their apps against our APIs, and test them on an emulator
</p>
</li>
<li>
<p>
Note that custom hardware would have to be simulated (e.g. the way GPS is simulated on the emulator)
</p>
</li>
<li>
<p>
Fortunately, our SDK addon will be able to utilize most of what we provided in <tt>alpha/</tt> so we&#8217;ll focus only on the differences
</p>
</li>
<li>
<p>
Let&#8217;s get started:
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a directory for our addon:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha_sdk_addon</tt></pre>
</div></div>
</li>
<li>
<p>
Though this is purely optional, let&#8217;s create a custom emulator skin for our add-on, by copying an existing one:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha_sdk_addon/skins
$ cp -r sdk/emulator/skins/HVGA device/marakana/alpha_sdk_addon/skins/MrknHvgaMdpi</tt></pre>
</div></div>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
We could now customize the portrait background of our skin (<tt>device/marakana/alpha_sdk_addon/skins/MrknHvgaMdpi/background_port.png</tt>) - say by adding our custom logo to it
</p>
<div class="imageblock">
<div class="content">
<img src="device/marakana/alpha_sdk_addon/skins/MrknHvgaMdpi/background_port.png" alt="device/marakana/alpha_sdk_addon/skins/MrknHvgaMdpi/background_port.png" />
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">For example, we could use this one: <a href="https://github.com/marakana/alpha_sdk_addon/raw/master/skins/MrknHvgaMdpi/background_land.png">https://github.com/marakana/alpha_sdk_addon/raw/master/skins/MrknHvgaMdpi/background_land.png</a></td>
</tr></table>
</div>
</li>
<li>
<p>
We could also customize the landscape background of our skin (<tt>device/marakana/alpha_sdk_addon/skins/MrknHvgaMdpi/background_land.png</tt>) - also by adding our custom logo to it
</p>
<div class="imageblock">
<div class="content">
<img src="device/marakana/alpha_sdk_addon/skins/MrknHvgaMdpi/background_land.png" alt="device/marakana/alpha_sdk_addon/skins/MrknHvgaMdpi/background_land.png" />
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">For example, we could use this one: <a href="https://github.com/marakana/alpha_sdk_addon/raw/master/skins/MrknHvgaMdpi/background_port.png">https://github.com/marakana/alpha_sdk_addon/raw/master/skins/MrknHvgaMdpi/background_port.png</a></td>
</tr></table>
</div>
</li>
<li>
<p>
We could also customize other images, layout controls (<tt>layout</tt>), and hardware-specific values (<tt>hardware.ini</tt>)
</p>
</li>
</ol></div>
</li>
<li>
<p>
To simulate that our devices supports NFC, we would:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Create a directory (<tt>nxp</tt>):
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ mkdir device/marakana/alpha_sdk_addon/nxp</tt></pre>
</div></div>
</li>
<li>
<p>
Add a configuration file (<tt>com.nxp.mifare.xml</tt>) declaring NFC-feature support:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha_sdk_addon/nxp/com.nxp.mifare.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- Devices that support MIFARE need to declare NXP's feature constant --&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;permissions&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;feature</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"com.nxp.mifare"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/permissions&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">NFC-support is not really required for our particular product (<em>Alpha</em>), but this is an example of how some hardware-specific features are defined.</td>
</tr></table>
</div>
</li>
</ol></div>
</li>
<li>
<p>
While on the subject of hardware, let&#8217;s define skin-independent set of hardware properties (<tt>hardware.ini</tt>) for our emulated device:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha_sdk_addon/hardware.ini</tt></div>
<div class="content">
<pre><tt># Custom hardware options for the add-on.
# Properties defined here impact all AVD targeting this add-on.
# Each skin can also override those values with its own hardware.ini file.
vm.heapSize = 24</tt></pre>
</div></div>
</li>
<li>
<p>
Next, we define the properties of our SDK addon (<tt>manifest.ini</tt>) - name, description, API version, revision, libraries, and skin - as these properties are required by development tools (such as SDK Manager and Eclipse) using our addon:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha_sdk_addon/manifest.ini</tt></div>
<div class="content">
<pre><tt>name=Alpha Add-On
vendor=Marakana
description=Marakana Alpha Add-on
api=15
revision=1
libraries=com.marakana.android.lib.log;com.marakana.android.service.log
com.marakana.android.lib.log=com.marakana.android.lib.log.jar;Marakana Log Library
com.marakana.android.service.log=com.marakana.android.service.log.jar;Marakana Log Service
skin=MrknHvgaMdpi</tt></pre>
</div></div>
</li>
<li>
<p>
Next, we define a list of classes to be included (<tt>+&lt;package-name&gt;.(<strong>|&lt;class-name&gt;)</tt>) or excluded (<tt>-&lt;package-name&gt;.(</strong>|&lt;class-name&gt;)</tt>) from the generated SDK addon&#8217;s libraries:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha_sdk_addon/alpha_sdk_addon_stub_defs.txt</tt></div>
<div class="content">
<pre><tt>+com.marakana.android.lib.log.*
-com.marakana.android.lib.log.Main
+com.marakana.android.service.log.*</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">These classes are known as SDK Addon Stub Definitions, and this file is processed by <tt>development/tools/mkstubs</tt> during the build time. The Java tool <tt>mkstubs</tt> loads this file via <tt>PRODUCT_SDK_ADDON_STUB_DEFS</tt> makefile property.</td>
</tr></table>
</div>
</li>
<li>
<p>
Now we are ready for our addon&#8217;s main makefile (<tt>alpha_sdk_addon.mk</tt>), which will be loaded later by <tt>AndroidProducts.mk</tt>:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha_sdk_addon/alpha_sdk_addon.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Include the common stuff</span></span>
include <span style="color: #009900">$(LOCAL_PATH)</span><span style="color: #990000">/..</span>/alpha/common.mk

<span style="font-style: italic"><span style="color: #9A1900"># List of modules to include in the the add-on system image</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#PRODUCT_PACKAGES +=</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># The name of this add-on (for the SDK)</span></span>
<span style="color: #990000">PRODUCT_SDK_ADDON_NAME :=</span> marakana_alpha_addon

<span style="font-style: italic"><span style="color: #9A1900"># Copy the following files for this add-on's SDK</span></span>
<span style="color: #990000">PRODUCT_SDK_ADDON_COPY_FILES :=</span> <span style="color: #990000">\</span>
    <span style="color: #009900">$(LOCAL_PATH)</span>/manifest.ini<span style="color: #990000">:</span>manifest.ini <span style="color: #990000">\</span>
    <span style="color: #009900">$(LOCAL_PATH)</span>/hardware.ini<span style="color: #990000">:</span>hardware.ini <span style="color: #990000">\</span>
    <span style="color: #009900">$(</span>call find-copy-subdir-files<span style="color: #990000">,*,</span><span style="color: #009900">$(LOCAL_PATH)/skins/MrknHvgaMdpi,skins/MrknHvgaMdpi)</span>


<span style="font-style: italic"><span style="color: #9A1900"># Copy the jar files for the libraries (APIs) exposed in this add-on's SDK</span></span>
<span style="color: #990000">PRODUCT_SDK_ADDON_COPY_MODULES :=</span> <span style="color: #990000">\</span>
<span style="color: #990000">    com.marakana.android.lib.log:</span>libs/com.marakana.android.lib.log.jar <span style="color: #990000">\</span>
<span style="color: #990000">    com.marakana.android.service.log:</span>libs/com.marakana.android.service.log.jar

<span style="color: #990000">PRODUCT_SDK_ADDON_STUB_DEFS :=</span> <span style="color: #009900">$(LOCAL_PATH)</span>/alpha_sdk_addon_stub_defs.txt

<span style="font-style: italic"><span style="color: #9A1900"># Define the name of the documentation to generate for this add-on's SDK</span></span>
<span style="color: #990000">PRODUCT_SDK_ADDON_DOC_MODULES :=</span> <span style="color: #990000">\</span>
    com.marakana.android.service.log_doc

<span style="font-style: italic"><span style="color: #9A1900"># Since the add-on is an emulator, we also need to explicitly copy the kernel to images</span></span>
PRODUCT_SDK_ADDON_COPY_FILES <span style="color: #990000">+=</span> <span style="color: #009900">$(LOCAL_KERNEL)</span><span style="color: #990000">:</span>images/armeabi-v7a/kernel-qemu

<span style="font-style: italic"><span style="color: #9A1900"># This add-on extends the default sdk product.</span></span>
<span style="color: #009900">$(</span>call inherit-product<span style="color: #990000">,</span> <span style="color: #009900">$(SRC_TARGET_DIR)/product/sdk.mk)</span>

<span style="font-style: italic"><span style="color: #9A1900"># The name of this add-on (for the build system)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Use 'make PRODUCT-&lt;PRODUCT_NAME&gt;-sdk_addon' to build the an add-on,</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># so in this case, we would run 'make PRODUCT-marakana_alpha_addon-sdk_addon'</span></span>
<span style="color: #990000">PRODUCT_NAME :=</span> marakana_alpha_addon
<span style="color: #990000">PRODUCT_DEVICE :=</span> alpha
<span style="color: #990000">PRODUCT_MODEL :=</span> Marakana Alpha SDK Addon Image <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> Emulator</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">As we can see from the comments, this file extends from <tt>build/target/product/sdk.mk</tt>, includes everything from <tt>alpha-commmon</tt>, adds support for library documentation, defines the addon&#8217;s name (<tt>PRODUCT_SDK_ADDON_NAME</tt>), specifies the files/modules to be copied (<tt>manifest.ini</tt>, <tt>hardware.ini</tt>, skin, libraries, and kernel) into the addon (<tt>PRODUCT_SDK_ADDON_COPY_FILES</tt>), loads stub defs, and defines the addon&#8217;s product info (like <tt>PRODUCT_NAME</tt>).</td>
</tr></table>
</div>
</li>
<li>
<p>
Just like with our <tt>alpha</tt> product, we need to create <tt>AndroidProducts.mk</tt> file, which the build system looks for to get a list of the actual make files (in this just <tt>alpha_sdk_addon.mk</tt>) to process for this "product" (i.e. SDK addon):
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha_sdk_addon/AndroidProducts.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">PRODUCT_MAKEFILES :=</span> <span style="color: #009900">$(LOCAL_DIR)</span>/alpha_sdk_addon.mk</tt></pre></div></div>
</li>
<li>
<p>
Just to be on the safe side, let&#8217;s make sure that make files from all sub-directories also get included:
</p>
<div class="listingblock">
<div class="title"><tt>device/marakana/alpha_sdk_addon/Android.mk</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>include <span style="color: #009900">$(</span>call all-subdir-makefiles<span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">This file is unnecessary in this particular case, but it does not hurt to have it in case we add more addon-specific components down the road, which will most likely be stored in their own sub-directories.</td>
</tr></table>
</div>
</li>
<li>
<p>
Now we are ready to compile our addon:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ make -j10 PRODUCT-marakana_alpha_addon-sdk_addon
…
Copy: out/host/linux-x86/obj/SDK_ADDON/marakana_alpha_addon_intermediates/marakana_alpha_addon-eng.sasa-linux-x86/images/armeabi-v7a/system.img
Packaging SDK Addon: out/host/linux-x86/sdk_addon/marakana_alpha_addon-eng.sasa-linux-x86.zip</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Notice that the directory/file-name encodes the name of the user who built this addon (in this case "sasa"). Adjust the following steps as necessary.</td>
</tr></table>
</div>
</li>
<li>
<p>
Next, to test that it works, we first install our SDK to our Android SDK&#8217;s <tt>add-ons/</tt> directory:
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ unzip out/host/linux-x86/sdk_addon/marakana_alpha_addon-eng.sasa-linux-x86.zip -d /home/sasa/android/sdk/add-ons/
Archive:  out/host/linux-x86/sdk_addon/marakana_alpha_addon-eng.sasa-linux-x86.zip
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/select.png
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/arrow_left.png
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/background_land.png
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/arrow_right.png
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/layout
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/background_port.png
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/hardware.ini
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/spacebar.png
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/controls.png
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/key.png
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/keyboard.png
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/button.png
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/arrow_down.png
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/skins/MrknHvgaMdpi/arrow_up.png
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/package-list
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/help-doc.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/com/marakana/android/service/log/package-summary.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/com/marakana/android/service/log/package-frame.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/com/marakana/android/service/log/package-tree.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/com/marakana/android/service/log/LogManager.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/allclasses-noframe.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/constant-values.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/stylesheet.css
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/deprecated-list.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/index.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/allclasses-frame.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/index-all.html
 extracting: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/resources/inherit.gif
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/docs/com.marakana.android.service.log_doc/overview-tree.html
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/images/armeabi-v7a/build.prop
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/images/armeabi-v7a/ramdisk.img
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/images/armeabi-v7a/kernel-qemu
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/images/armeabi-v7a/NOTICE.txt
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/images/armeabi-v7a/userdata.img
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/images/armeabi-v7a/system.img
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/hardware.ini
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/manifest.ini
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/libs/com.marakana.android.lib.log.jar
  inflating: /home/sasa/android/sdk/add-ons/marakana_alpha_addon-eng.sasa-linux-x86/libs/com.marakana.android.service.log.jar</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/tip.png" alt="Tip" />
</td>
<td class="content">Adjust the path to Android SDK directory as necessary.</td>
</tr></table>
</div>
</li>
<li>
<p>
Let&#8217;s test that it shows up in our <em>Android SDK and ADV Manager</em>:
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Run
</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ /path/to/android/sdk/tools/android $</tt></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Adjust the path to Android SDK directory as necessary.</td>
</tr></table>
</div>
</li>
<li>
<p>
And we should now see "Alpha Add-On by Marakana, Android API 15, revision 1, Installed" show up under <em>Packages</em>:
</p>
<div class="imageblock">
<div class="content">
<img src="screens/Android_SDK_and_AVD_Manager-with-MarakanaAlphaSDKAddon.png" alt="screens/Android_SDK_and_AVD_Manager-with-MarakanaAlphaSDKAddon.png" />
</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">For this to work, we need to have our addon&#8217;s <tt>api</tt> setting (in <tt>manifest.ini</tt> file) match an available <em>SDK Platform Android</em> of the same API version.</td>
</tr></table>
</div>
</li>
</ol></div>
</li>
<li>
<p>
Now we can create a new emulator image (AVD) based on our add-on (from the <em>Android SDK and AVD Manager</em>):
</p>
<div class="imageblock">
<div class="content">
<img src="screens/Android_SDK_and_AVD_Manager-Create-MarakanaAlphaSDKAddon-AVD.png" alt="screens/Android_SDK_and_AVD_Manager-Create-MarakanaAlphaSDKAddon-AVD.png" />
</div>
</div>
</li>
<li>
<p>
To see that it works, we can now launch our newly created "marakana-alpha" AVD:
</p>
<div class="imageblock">
<div class="content">
<img src="screens/MarakanaAlphaSDKAddon.png" alt="screens/MarakanaAlphaSDKAddon.png" />
</div>
</div>
</li>
<li>
<p>
Our <tt>marakana-alpha</tt> AVD will not have any of the <em>Mrkn*ClientApp</em> apps we previously created for the "Marakana Alpha" device , but since our APIs are available to us via the libraries, we can re-create these applications in Eclipse and deploy them to our AVD - this is left as an exercise for the reader :-)
</p>
</li>
</ol></div>
</li>
</ul></div>
<div class="sect3">
<h4 id="_distributing_our_custom_sdk_add_on_optional">9.13.1. Distributing our Custom SDK Add-on (Optional)</h4>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
First, we need to create a <tt>repository.xml</tt> file to describe our add-on and publish it to our server:
</p>
<div class="listingblock">
<div class="title"><tt>https://marakana.com/external/android/sdk-addon/repository.xml</tt></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"UTF-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:sdk-addon</span></span>
    <span style="color: #009900">xmlns:xsi</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span style="color: #009900">xmlns:sdk</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://schemas.android.com/sdk/android/addon/1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:add-on&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:name&gt;</span></span>Alpha Add-On<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:name&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:api-level&gt;</span></span>15<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:api-level&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:vendor&gt;</span></span>Marakana<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:vendor&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:revision&gt;</span></span>1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:revision&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:description&gt;</span></span>Android + Marakana Alpha Add-on, API 15, revision 1 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:description&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:desc-url&gt;</span></span>http://marakana.com/external/android/sdk-addon/<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:desc-url&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:uses-license</span></span> <span style="color: #009900">ref</span><span style="color: #990000">=</span><span style="color: #FF0000">"marakana-android-addon-license"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:archives&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:archive</span></span> <span style="color: #009900">os</span><span style="color: #990000">=</span><span style="color: #FF0000">"any"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:size&gt;</span></span>96382546<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:size&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:checksum</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"sha1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>5cec8cc3f3064441cb96a50e2b8aa528681ffc78<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:checksum&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:url&gt;</span></span>marakana_alpha_sdk_addon_api-15_r1.zip<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:url&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:archive&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:archives&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:libs&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:libs&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:add-on&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;sdk:license</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"marakana-android-addon-license"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this SDK addon except in compliance with the License.
You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:license&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/sdk:sdk-addon&gt;</span></span>
</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">We have to make sure that we adjust the info as necessary to reflect our particular site/addon.</td>
</tr></table>
</div>
</li>
<li>
<p>
Next, we need to upload our addon to our site, relative to <tt>&lt;sdk:sdk-addon&gt;</tt> &#8594; <tt>&lt;sdk:add-on&gt;</tt> &#8594; <tt>&lt;sdk:desc-url&gt;</tt> URL (e.g. <tt>https://marakana.com/external/android/sdk-addon/marakana_alpha_sdk_addon_api-15_r1.zip</tt>)
</p>
</li>
<li>
<p>
We are now ready to test it out in our <em>Android SDK Manager</em>
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
Go to <em>Tools</em> &#8594; <em>Manage Add-on Sites&#8230;</em> in the menu bar
</p>
</li>
<li>
<p>
Click on <em>New&#8230;</em>
</p>
</li>
<li>
<p>
Enter the base URL in the URL field (e.g. <tt>https://marakana.com/external/android/sdk-addon/</tt>) and click on <em>OK</em>
</p>
</li>
<li>
<p>
Click on <em>Close</em> to dismiss the <em>Add-on Sites</em> window
</p>
</li>
<li>
<p>
Under <em>Packages</em> we should now see <em>Alpha Add-On by Marakana</em>, with a status <em>Not installed</em>
</p>
</li>
<li>
<p>
Click on the checkbox next to our package
</p>
</li>
<li>
<p>
Click on <em>Install 1 package&#8230;</em> button
</p>
</li>
<li>
<p>
Accept the license terms and click on <em>Install</em>
</p>
</li>
</ol></div>
</li>
<li>
<p>
Test that it works by creating an AVD based on our add-on and/or using it in Eclipse
</p>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_android_usb_support_appendix">10. Android USB Support (Appendix)</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview_of_android_usb_support">10.1. Overview of Android USB Support</h3>
<div class="sect3">
<h4 id="_android_usb_host_and_accessory_modes">10.1.1. Android USB Host and Accessory Modes</h4>
<div class="paragraph"><p>Android supports a variety of USB peripherals and Android USB <em>accessories</em> (hardware that implements the Android accessory protocol) through two modes: <em>USB host</em> and <em>USB accessory</em>.</p></div>
<div class="paragraph"><p>In USB host mode, the Android-powered device acts as the host.</p></div>
<div class="ulist"><ul>
<li>
<p>
When the Android-powered device is in host mode, it acts as the USB host, powers the bus, and enumerates connected USB devices.
</p>
</li>
<li>
<p>
Most existing USB peripherals are designed to connected to a USB host.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In USB accessory mode, the external USB hardware act as the USB hosts.</p></div>
<div class="ulist"><ul>
<li>
<p>
When the Android-powered device is in USB accessory mode, the connected USB hardware (an Android USB accessory in this case) acts as the host and powers the bus.
</p>
</li>
<li>
<p>
This design gives Android-powered devices that do not have host capabilities the ability to interact with USB hardware.
</p>
</li>
<li>
<p>
Android USB accessories must be designed to work with Android-powered devices and adhere to the Android accessory protocol outlined in the <em>Android Accessory Development Kit</em> documentation.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_android_usb_support">10.1.2. Android USB Support</h4>
<div class="paragraph"><p>USB accessory and host modes are directly supported in Android 3.1 (API level 12) or newer platforms.</p></div>
<div class="ulist"><ul>
<li>
<p>
USB accessory mode is also backported to Android 2.3.4 (API level 10) as an add-on library to support a broader range of devices.
</p>
</li>
<li>
<p>
Device manufacturers can choose whether or not to include the add-on library on the device&#8217;s system image.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Support for USB host and accessory modes are ultimately dependent on the device&#8217;s hardware, regardless of platform level. You can filter for devices that support USB host and accessory through a <tt>&lt;uses-feature&gt;</tt> element, as discussed later.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_android_usb_host_mode">10.2. Android USB Host Mode</h3>
<div class="ulist"><ul>
<li>
<p>
API Overview
</p>
</li>
<li>
<p>
Android Manifest Requirements
</p>
</li>
<li>
<p>
Working with devices
</p>
</li>
<li>
<p>
Discovering a device
</p>
</li>
<li>
<p>
Obtaining permission to communicate with a device
</p>
</li>
<li>
<p>
Communicating with a device
</p>
</li>
<li>
<p>
Terminating communication with a device
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_api_overview">10.2.1. API Overview</h4>
<div class="paragraph"><p>The <tt>android.hardware.usb</tt> package contains the following classes supporting USB host mode:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>UsbManager</tt>
</dt>
<dd>
<p>
Allows you to enumerate and communicate with connected USB devices.
</p>
</dd>
<dt class="hdlist1">
<tt>UsbDevice</tt>
</dt>
<dd>
<p>
Represents a connected USB device and contains methods to access its identifying information, interfaces, and endpoints.
</p>
</dd>
<dt class="hdlist1">
<tt>UsbInterface</tt>
</dt>
<dd>
<p>
Represents an interface of a USB device, which defines a set of functionality for the device. A device can have one or more interfaces on which to communicate on.
</p>
</dd>
<dt class="hdlist1">
<tt>UsbEndpoint</tt>
</dt>
<dd>
<p>
Represents an interface endpoint, which is a communication channel for this interface. An interface can have one or more endpoints, and usually has input and output endpoints for two-way communication with the device.
</p>
</dd>
<dt class="hdlist1">
<tt>UsbDeviceConnection</tt>
</dt>
<dd>
<p>
Represents a connection to the device, which transfers data on endpoints. This class allows you to send data back and forth sychronously or asynchronously.
</p>
</dd>
<dt class="hdlist1">
<tt>UsbRequest</tt>
</dt>
<dd>
<p>
Represents an asynchronous request to communicate with a device through a UsbDeviceConnection.
</p>
</dd>
<dt class="hdlist1">
<tt>UsbConstants</tt>
</dt>
<dd>
<p>
Defines USB constants that correspond to definitions in <tt>linux/usb/ch9.h</tt> of the Linux kernel.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In general, you:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Obtain a <tt>UsbManager</tt> to retrieve the desired <tt>UsbDevice</tt>
</p>
</li>
<li>
<p>
Find the appropriate <tt>UsbInterface</tt> and the <tt>UsbEndpoint</tt> of that interface to communicate on
</p>
</li>
<li>
<p>
Open a <tt>UsbDeviceConnection</tt> to communicate with the USB device
</p>
</li>
</ol></div>
<div class="openblock handout">
<div class="content">
<hr />
<div class="paragraph"><p>In most situations, you need to use all of these classes (<tt>UsbRequest</tt> is only required if you are doing asynchronous communication) when communicating with a USB device.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_using_the_manifest_to_require_usb_support">10.2.2. Using the Manifest to Require USB Support</h4>
<div class="paragraph"><p>Not all Android-powered devices are guaranteed to support the USB host APIs.</p></div>
<div class="paragraph"><p>To indicate that your application requires USB host support, add the following elements to your application&#8217;s manifest:</p></div>
<div class="ulist"><ul>
<li>
<p>
Include a <tt>&lt;uses-feature&gt;</tt> element that declares that your application uses the <tt>android.hardware.usb.host</tt> feature:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;uses-feature android:name="android.hardware.usb.host" /&gt;</tt></pre>
</div></div>
</li>
<li>
<p>
Set the minimum SDK of the application to API Level 12 or higher. The USB host APIs are not present on earlier API levels.
</p>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;uses-sdk android:minSdkVersion="12" /&gt;</tt></pre>
</div></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_working_with_devices">10.2.3. Working with Devices</h4>
<div class="paragraph"><p>When users connect USB devices to an Android-powered device, the Android system can determine whether your application is interested in the connected device. If so, you can set up communication with the device if desired.</p></div>
<div class="paragraph"><p>To do this, your application has to:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Discover connected USB devices either by:
</p>
<div class="ulist"><ul>
<li>
<p>
Using an intent filter to be notified when the user connects a USB device, or
</p>
</li>
<li>
<p>
Enumerating USB devices that are already connected.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Ask the user for permission to connect to the USB device, if not already obtained.
</p>
</li>
<li>
<p>
Communicate with the USB device by reading and writing data on the appropriate interface endpoints.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_discovering_a_device_using_an_intent_filter_the_manifest">10.2.4. Discovering a Device Using an Intent Filter, The Manifest</h4>
<div class="paragraph"><p>To have your application discover a particular USB device, you can specify an intent filter to filter for the <tt>android.hardware.usb.action.USB_DEVICE_ATTACHED</tt> intent.</p></div>
<div class="ulist"><ul>
<li>
<p>
Along with this intent filter, you need to specify a resource file that specifies properties of the USB device, such as product and vendor ID.
</p>
</li>
<li>
<p>
When users connect a device that matches your device filter, the system presents them with a dialog that asks if they want to start your application.
</p>
</li>
<li>
<p>
If users accept, your application automatically has permission to access the device until the device is disconnected.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In your activity, you can obtain the <tt>UsbDevice</tt> that represents the attached device from the intent like this:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>UsbDevice device = (UsbDevice) intent.getParcelableExtra(UsbManager.EXTRA_DEVICE);</tt></pre>
</div></div>
<div class="paragraph"><p>The following example shows how to declare the intent filter in your application&#8217;s manifest:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span> ...<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    ...
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.hardware.usb.action.USB_DEVICE_ATTACHED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta-data</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.hardware.usb.action.USB_DEVICE_ATTACHED"</span>
        <span style="color: #009900">android:resource</span><span style="color: #990000">=</span><span style="color: #FF0000">"@xml/device_filter"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>&lt;meta-data&gt;</tt> element points to an external XML resource file that declares identifying information about the device that you want to detect.</p></div>
</div>
<div class="sect3">
<h4 id="_discovering_a_device_using_an_intent_filter_the_resource_file">10.2.5. Discovering a Device Using an Intent Filter, The Resource File</h4>
<div class="paragraph"><p>In the XML resource file, declare <tt>&lt;usb-device&gt;</tt> elements for the USB devices that you want to filter.</p></div>
<div class="ulist"><ul>
<li>
<p>
The <tt>&lt;usb-device&gt;</tt> element supports the following optional attributes:
</p>
<div class="ulist"><ul>
<li>
<p>
<tt>vendor-id</tt>
</p>
</li>
<li>
<p>
<tt>product-id</tt>
</p>
</li>
<li>
<p>
<tt>class</tt>
</p>
</li>
<li>
<p>
<tt>subclass</tt>
</p>
</li>
<li>
<p>
<tt>protocol</tt> (device or interface)
</p>
</li>
</ul></div>
</li>
<li>
<p>
In general, use vendor and product ID if you want to filter for a specific device; use class, subclass, and protocol if you want to filter for a group of USB devices, such as mass storage devices or digital cameras.
</p>
</li>
<li>
<p>
For example, the following resource file specifies that any USB device with the corresponding vendor ID and product ID should be filtered. These IDs are specific to the device and are specified by the device&#8217;s manufacturer:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;usb-device</span></span> <span style="color: #009900">vendor-id</span><span style="color: #990000">=</span><span style="color: #FF0000">"1234"</span> <span style="color: #009900">product-id</span><span style="color: #990000">=</span><span style="color: #FF0000">"5678"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
</li>
</ul></div>
<div class="paragraph"><p>Save the resource file in your application&#8217;s <tt>res/xml/</tt> directory.</p></div>
<div class="ulist"><ul>
<li>
<p>
The resource file name (without the <tt>.xml</tt> extension) must be the same as the one you specified in the <tt>&lt;meta-data&gt;</tt> element.
</p>
</li>
<li>
<p>
For example, the resource file for the manifest shown previously should be saved in <tt>res/xml/device_filter.xml</tt>.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_enumerating_usb_devices">10.2.6. Enumerating USB Devices</h4>
<div class="paragraph"><p>If your application is interested in inspecting all of the USB devices currently connected while your application is running, it can enumerate devices on the bus.</p></div>
<div class="ulist"><ul>
<li>
<p>
Use the <tt>UsbManager.getDeviceList()</tt> method to get a hash map of all the USB devices that are connected.
</p>
</li>
<li>
<p>
The hash map is keyed by the USB device&#8217;s name if you want to obtain a device from the map.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">UsbManager</span> manager <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbManager<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getSystemService</span></span><span style="color: #990000">(</span>Context<span style="color: #990000">.</span>USB_SERVICE<span style="color: #990000">);</span>
<span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #008080">HashMap&lt;String, UsbDevice&gt;</span> deviceList <span style="color: #990000">=</span> manager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getDeviceList</span></span><span style="color: #990000">();</span>
<span style="color: #008080">UsbDevice</span> device <span style="color: #990000">=</span> deviceList<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"deviceName"</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If desired, you can also just obtain an iterator from the hash map and process each device one by one:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">UsbManager</span> manager <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbManager<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getSystemService</span></span><span style="color: #990000">(</span>Context<span style="color: #990000">.</span>USB_SERVICE<span style="color: #990000">);</span>
<span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #008080">HashMap&lt;String, UsbDevice&gt;</span> deviceList <span style="color: #990000">=</span> manager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getDeviceList</span></span><span style="color: #990000">();</span>
<span style="color: #008080">Iterator&lt;UsbDevice&gt;</span> deviceIterator <span style="color: #990000">=</span> deviceList<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">values</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">iterator</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>deviceIterator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">hasNext</span></span><span style="color: #990000">())</span> <span style="color: #FF0000">{</span>
    <span style="color: #008080">UsbDevice</span> device <span style="color: #990000">=</span> deviceIterator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">next</span></span><span style="color: #990000">()</span>
    <span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_obtaining_permission_to_communicate_with_a_device">10.2.7. Obtaining Permission to Communicate With a Device</h4>
<div class="paragraph"><p>Before communicating with the USB device, your application must have permission from your users.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">If your application uses an intent filter to discover USB devices as they&#8217;re connected, it automatically receives permission if the user allows your application to handle the intent. If not, you must request permission explicitly in your application before connecting to the device.</td>
</tr></table>
</div>
<div class="paragraph"><p>Explicitly asking for permission might be necessary in some situations such as when your application enumerates USB devices that are already connected and then wants to communicate with one.</p></div>
<div class="ulist"><ul>
<li>
<p>
You must check for permission to access a device before trying to communicate with it.
</p>
</li>
<li>
<p>
If not, you will receive a runtime error if the user denied permission to access the device.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To explicitly obtain permission:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Call <tt>UsbManager.requestPermission()</tt>.
</p>
</li>
<li>
<p>
The call to <tt>requestPermission()</tt> displays a dialog to the user asking for permission to connect to the device.
</p>
</li>
<li>
<p>
The system generates a broadcast intent with a boolean <tt>EXTRA_PERMISSION_GRANTED</tt> extra indicating the user&#8217;s response.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The following sample code shows how to create a broadcast receiver to process the response:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> ACTION_USB_PERMISSION <span style="color: #990000">=</span> <span style="color: #FF0000">"com.android.example.USB_PERMISSION"</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">BroadcastReceiver</span> mUsbReceiver <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">BroadcastReceiver</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onReceive</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">String</span> action <span style="color: #990000">=</span> intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getAction</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ACTION_USB_PERMISSION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>action<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">synchronized</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="color: #008080">UsbDevice</span> device <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbDevice<span style="color: #990000">)</span>intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getParcelableExtra</span></span><span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>EXTRA_DEVICE<span style="color: #990000">);</span>

                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getBooleanExtra</span></span><span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>EXTRA_PERMISSION_GRANTED<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>device <span style="color: #990000">!=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                      <span style="font-style: italic"><span style="color: #9A1900">// Call method to set up device communication</span></span>
                   <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
                <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"permission denied for device "</span> <span style="color: #990000">+</span> device<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>To register the broadcast receiver, add this in your <tt>onCreate()</tt> method in your activity:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">IntentFilter</span> filter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">IntentFilter</span></span><span style="color: #990000">(</span>ACTION_USB_PERMISSION<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">registerReceiver</span></span><span style="color: #990000">(</span>mUsbReceiver<span style="color: #990000">,</span> filter<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>To display the dialog that asks users for permission to connect to the device, call the <tt>UsbManager.requestPermission()</tt> method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">UsbManager</span> mUsbManager <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbManager<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getSystemService</span></span><span style="color: #990000">(</span>Context<span style="color: #990000">.</span>USB_SERVICE<span style="color: #990000">);</span>
<span style="color: #008080">UsbDevice</span> device<span style="color: #990000">;</span>
<span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
mPermissionIntent <span style="color: #990000">=</span> PendingIntent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getBroadcast</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>ACTION_USB_PERMISSION<span style="color: #990000">),</span> <span style="color: #993399">0</span><span style="color: #990000">);</span>
mUsbManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">requestPermission</span></span><span style="color: #990000">(</span>device<span style="color: #990000">,</span> mPermissionIntent<span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_communicating_with_a_device">10.2.8. Communicating With a Device</h4>
<div class="paragraph"><p>Communication with a USB device can be either synchronous or asynchronous.</p></div>
<div class="ulist"><ul>
<li>
<p>
In either case, you should create a new thread on which to carry out all data transmissions, so you don&#8217;t block the UI thread.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To properly set up communication with a device, you need to obtain the appropriate <tt>UsbInterface</tt> and <tt>UsbEndpoint</tt> of the device that you want to communicate on and send requests on this endpoint with a <tt>UsbDeviceConnection</tt>. In general, your code should:</p></div>
<div class="ulist"><ul>
<li>
<p>
Check a <tt>UsbDevice</tt> object&#8217;s attributes, such as product ID, vendor ID, or device class to figure out whether or not you want to communicate with the device.
</p>
</li>
<li>
<p>
When you are certain that you want to communicate with the device, find the appropriate <tt>UsbInterface</tt> that you want to use to communicate along with the appropriate <tt>UsbEndpoint</tt> of that interface.
</p>
<div class="ulist"><ul>
<li>
<p>
Interfaces can have one or more endpoints, and commonly will have an input and output endpoint for two-way communication.
</p>
</li>
</ul></div>
</li>
<li>
<p>
When you find the correct endpoint, open a <tt>UsbDeviceConnection</tt> on that endpoint.
</p>
</li>
<li>
<p>
Supply the data that you want to transmit on the endpoint with the <tt>bulkTransfer()</tt> or <tt>controlTransfer()</tt> method.
</p>
<div class="ulist"><ul>
<li>
<p>
You should carry out this step in another thread to prevent blocking the main UI thread.
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>The following code snippet is a trivial way to do a synchronous data transfer. Your code should have more logic to correctly find the correct interface and endpoints to communicate on and also should do any transferring of data in a different thread than the main UI thread:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">byte</span><span style="color: #990000">[]</span> bytes <span style="color: #990000">=</span> <span style="color: #FF0000">"hello usb"</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getBytes</span></span><span style="color: #990000">();</span>
<span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="color: #009900">int</span> TIMEOUT <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">boolean</span> forceClaim <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>

<span style="color: #990000">...</span>

<span style="color: #008080">UsbInterface</span> intf <span style="color: #990000">=</span> device<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getInterface</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">);</span>
<span style="color: #008080">UsbEndpoint</span> endpoint <span style="color: #990000">=</span> intf<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getEndpoint</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">);</span>
<span style="color: #008080">UsbDeviceConnection</span> connection <span style="color: #990000">=</span> mUsbManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">openDevice</span></span><span style="color: #990000">(</span>device<span style="color: #990000">);</span>
connection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">claimInterface</span></span><span style="color: #990000">(</span>intf<span style="color: #990000">,</span> forceClaim<span style="color: #990000">);</span>
connection<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bulkTransfer</span></span><span style="color: #990000">(</span>endpoint<span style="color: #990000">,</span> bytes<span style="color: #990000">,</span> bytes<span style="color: #990000">.</span>length<span style="color: #990000">,</span> TIMEOUT<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// Do in another thread</span></span></tt></pre></div></div>
<div class="paragraph"><p>To send data asynchronously, use the <tt>UsbRequest</tt> class to initialize and queue an asynchronous request, then wait for the result with <tt>requestWait()</tt>.</p></div>
</div>
<div class="sect3">
<h4 id="_terminating_communication_with_a_device">10.2.9. Terminating Communication With a Device</h4>
<div class="paragraph"><p>When you are done communicating with a device or if the device was detached, close the <tt>UsbInterface</tt> and <tt>UsbDeviceConnection</tt> by calling <tt>releaseInterface()</tt> and <tt>close()</tt>.</p></div>
<div class="paragraph"><p>To listen for detached events, create a broadcast receiver like below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">BroadcastReceiver</span> mUsbReceiver <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">BroadcastReceiver</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onReceive</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">String</span> action <span style="color: #990000">=</span> intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getAction</span></span><span style="color: #990000">();</span>

      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>ACTION_USB_DEVICE_DETACHED<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>action<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            <span style="color: #008080">UsbDevice</span> device <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbDevice<span style="color: #990000">)</span>intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getParcelableExtra</span></span><span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>EXTRA_DEVICE<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>device <span style="color: #990000">!=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">// call your method that cleans up and closes communication with the device</span></span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Creating the broadcast receiver within the application, and not the manifest, allows your application to handle detached events only while it is running.</p></div>
<div class="ulist"><ul>
<li>
<p>
This way, detached events are sent only to the application that is currently running and not broadcast to all applications.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_android_usb_accessory_mode">10.3. Android USB Accessory Mode</h3>
<div class="ulist"><ul>
<li>
<p>
Choosing the Right USB Accessory APIs
</p>
</li>
<li>
<p>
Installing the Google APIs add-on library
</p>
</li>
<li>
<p>
API Overview
</p>
</li>
<li>
<p>
Usage differences between the add-on library and the platform APIs
</p>
</li>
<li>
<p>
Android Manifest Requirements
</p>
</li>
<li>
<p>
Working with accessories
</p>
</li>
<li>
<p>
Discovering an accessory
</p>
</li>
<li>
<p>
Obtaining permission to communicate with an accessory
</p>
</li>
<li>
<p>
Communicating with an accessory
</p>
</li>
<li>
<p>
Terminating communication with an accessory
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_choosing_the_right_usb_accessory_apis">10.3.1. Choosing the Right USB Accessory APIs</h4>
<div class="paragraph"><p>The USB accessory APIs were introduced to the platform in Android 3.1. They are also available in Android 2.3.4 using the Google APIs add-on library.</p></div>
<div class="ulist"><ul>
<li>
<p>
Because these APIs were backported using an external library, there are two packages that you can import to support USB accessory mode.
</p>
</li>
<li>
<p>
Depending on what Android-powered devices you want to support, you might have to use one over the other.
</p>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>com.android.future.usb</tt>
</dt>
<dd>
<p>
To support USB accessory mode in Android 2.3.4, the Google APIs add-on library includes the backported USB accessory APIs and they are contained in this namespace.
</p>
<div class="ulist"><ul>
<li>
<p>
Android 3.1 also supports importing and calling the classes within this namespace to support applications written with the add-on library.
</p>
</li>
<li>
<p>
This add-on library is a thin wrapper around the android.hardware.usb accessory APIs and does not support USB host mode.
</p>
</li>
<li>
<p>
If you want to support the widest range of devices that support USB accessory mode, use the add-on library and import this package.
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<tt>android.hardware.usb</tt>
</dt>
<dd>
<p>
This namespace contains the classes that support USB accessory mode in Android 3.1.
</p>
<div class="ulist"><ul>
<li>
<p>
This package is included as part of the framework APIs, so Android 3.1 supports USB accessory mode without the use of an add-on library.
</p>
</li>
<li>
<p>
Use this package if you only care about Android 3.1 or newer devices that have hardware support for USB accessory mode, which you can declare in your manifest file.
</p>
</li>
</ul></div>
</dd>
</dl></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_api_overview_2">10.3.2. API Overview</h4>
<div class="paragraph"><p>The following classes support the USB accessory APIs:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<tt>UsbManager</tt>
</dt>
<dd>
<p>
Allows you to enumerate and communicate with connected USB accessories.
</p>
<div class="ulist"><ul>
<li>
<p>
If you are using the add-on library, you must obtain the <tt>UsbManager</tt> object in the following manner:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>UsbManager manager = UsbManager.getInstance(this);</tt></pre>
</div></div>
</li>
<li>
<p>
If you are not using the add-on library, you must obtain the <tt>UsbManager</tt> object in the following manner:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>UsbManager manager = (UsbManager) getSystemService(Context.USB_SERVICE);</tt></pre>
</div></div>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<tt>UsbAccessory</tt>
</dt>
<dd>
<p>
Represents a USB accessory and contains methods to access its identifying information.
</p>
<div class="ulist"><ul>
<li>
<p>
When you filter for a connected accessory with an intent filter, the <tt>UsbAccessory</tt> object is contained inside the intent that is passed to your application. If you are using the add-on library, you must obtain the <tt>UsbAccessory</tt> object in the following manner:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>UsbAccessory accessory = UsbManager.getAccessory(intent);</tt></pre>
</div></div>
</li>
<li>
<p>
If you are not using the add-on library, you must obtain the <tt>UsbAccessory</tt> object in the following manner:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>UsbAccessory accessory = (UsbAccessory) intent.getParcelableExtra(UsbManager.EXTRA_ACCESSORY);</tt></pre>
</div></div>
</li>
</ul></div>
</dd>
</dl></div>
<div class="openblock handout">
<div class="content">
<hr />
<div class="paragraph"><p>Because the add-on library is a wrapper for the framework APIs, the classes that support the USB accessory feature are similar. You can use the reference documentation for the <tt>android.hardware.usb</tt> even if you are using the add-on library.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_android_manifest_requirements">10.3.3. Android Manifest Requirements</h4>
<div class="paragraph"><p>Not all Android-powered devices are guaranteed to support the USB accessory APIs.</p></div>
<div class="paragraph"><p>To indicate that your application requires USB accessory support, add the following elements to your application&#8217;s manifest:</p></div>
<div class="ulist"><ul>
<li>
<p>
Include a <tt>&lt;uses-feature&gt;</tt> element that declares that your application uses the <tt>android.hardware.usb.accessory</tt> feature:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;uses-feature android:name="android.hardware.usb.accessory" /&gt;</tt></pre>
</div></div>
</li>
<li>
<p>
Set the minimum SDK of the application to API Level 10 if you are using the add-on library or 12 if you are using the <tt>android.hardware.usb</tt> package.
</p>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;uses-sdk android:minSdkVersion="12" /&gt;</tt></pre>
</div></div>
</li>
<li>
<p>
If you are using the add-on library, add the <tt>&lt;uses-library&gt;</tt> element specifying <tt>com.android.future.usb.accessory</tt> for the library.
</p>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;uses-library android:name="com.android.future.usb.accessory" /&gt;</tt></pre>
</div></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_working_with_accessories">10.3.4. Working with Accessories</h4>
<div class="paragraph"><p>When users connect USB accessories to an Android-powered device, the Android system can determine whether your application is interested in the connected accessory. If so, you can set up communication with the accessory if desired.</p></div>
<div class="paragraph"><p>To do this, your application has to:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Discover connected accessories by using an intent filter that filters for accessory attached events or by enumerating connected accessories and finding the appropriate one.
</p>
</li>
<li>
<p>
Ask the user for permission to communicate with the accessory, if not already obtained.
</p>
</li>
<li>
<p>
Communicate with the accessory by reading and writing data on the appropriate interface endpoints.
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_discovering_a_device_using_an_intent_filter_the_manifest_2">10.3.5. Discovering a Device Using an Intent Filter, The Manifest</h4>
<div class="paragraph"><p>To have your application discover a particular USB device, you can specify an intent filter to filter for the <tt>android.hardware.usb.action.USB_ACCESSORY_ATTACHED</tt> intent.</p></div>
<div class="ulist"><ul>
<li>
<p>
Along with this intent filter, you need to specify a resource file that specifies properties of the USB accessory, such as manufacturer, model, and version.
</p>
</li>
<li>
<p>
When users connect a device that matches your device filter, the system presents them with a dialog that asks if they want to start your application.
</p>
</li>
<li>
<p>
If users accept, your application automatically has permission to access the device until the device is disconnected.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In your activity, you can obtain the <tt>UsbAccessory</tt> that represents the attached device from the intent.</p></div>
<div class="ulist"><ul>
<li>
<p>
If you are using the add-on library, obtain the <tt>UsbAccessory</tt> object in the following manner:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>UsbAccessory accessory = UsbManager.getAccessory(intent);</tt></pre>
</div></div>
</li>
<li>
<p>
If you are not using the add-on library, obtain the <tt>UsbAccessory</tt> object in the following manner:
</p>
<div class="literalblock">
<div class="content">
<pre><tt>UsbAccessory accessory = (UsbAccessory) intent.getParcelableExtra(UsbManager.EXTRA_ACCESSORY);</tt></pre>
</div></div>
</li>
</ul></div>
<div class="paragraph"><p>The following example shows how to declare the intent filter in your application&#8217;s manifest:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;activity</span></span> ...<span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    ...
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;intent-filter&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.hardware.usb.action.USB_ACCESSORY_ATTACHED"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/intent-filter&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta-data</span></span> <span style="color: #009900">android:name</span><span style="color: #990000">=</span><span style="color: #FF0000">"android.hardware.usb.action.USB_ACCESSORY_ATTACHED"</span>
        <span style="color: #009900">android:resource</span><span style="color: #990000">=</span><span style="color: #FF0000">"@xml/accessory_filter"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/activity&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <tt>&lt;meta-data&gt;</tt> element points to an external XML resource file that declares identifying information about the device that you want to detect.</p></div>
</div>
<div class="sect3">
<h4 id="_discovering_a_device_using_an_intent_filter_the_resource_file_2">10.3.6. Discovering a Device Using an Intent Filter, The Resource File</h4>
<div class="paragraph"><p>In the XML resource file, declare <tt>&lt;usb-accessory&gt;</tt> elements for the accessories that you want to filter.</p></div>
<div class="ulist"><ul>
<li>
<p>
Each <tt>&lt;usb-accessory&gt;</tt> can have the following attributes:
</p>
<div class="ulist"><ul>
<li>
<p>
manufacturer
</p>
</li>
<li>
<p>
model
</p>
</li>
<li>
<p>
version
</p>
</li>
</ul></div>
</li>
<li>
<p>
For example, the following resource file specifies that any USB accessory that has the corresponding model, manufacturer, and version should be filtered. These IDs are specific to the device and are specified by the device&#8217;s manufacturer:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span> <span style="color: #009900">encoding</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resources&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;usb-accessory</span></span> <span style="color: #009900">model</span><span style="color: #990000">=</span><span style="color: #FF0000">"DemoKit"</span> <span style="color: #009900">manufacturer</span><span style="color: #990000">=</span><span style="color: #FF0000">"Google"</span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resources&gt;</span></span></tt></pre></div></div>
</li>
</ul></div>
<div class="paragraph"><p>Save the resource file in your application&#8217;s <tt>res/xml/</tt> directory.</p></div>
<div class="ulist"><ul>
<li>
<p>
The resource file name (without the <tt>.xml</tt> extension) must be the same as the one you specified in the <tt>&lt;meta-data&gt;</tt> element.
</p>
</li>
<li>
<p>
For example, the resource file for the manifest shown previously should be saved in <tt>res/xml/accessory_filter.xml</tt>.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_enumerating_accessories">10.3.7. Enumerating Accessories</h4>
<div class="paragraph"><p>You can have your application enumerate accessories that have identified themselves while your application is running.</p></div>
<div class="paragraph"><p>Use the <tt>UsbManager.getAccessoryList()</tt> method to get an array all the USB accessories that are connected:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">UsbManager</span> manager <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbManager<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getSystemService</span></span><span style="color: #990000">(</span>Context<span style="color: #990000">.</span>USB_SERVICE<span style="color: #990000">);</span>
UsbAccessory<span style="color: #990000">[]</span> accessoryList <span style="color: #990000">=</span> manager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getAcccessoryList</span></span><span style="color: #990000">();</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">Currently, only one connected accessory is supported at one time, but the API is designed to support multiple accessories in the future.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_obtaining_permission_to_communicate_with_an_accessory">10.3.8. Obtaining Permission to Communicate With an Accessory</h4>
<div class="paragraph"><p>Before communicating with the USB accessory, your application must have permission from your users.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">If your application uses an intent filter to discover USB devices as they&#8217;re connected, it automatically receives permission if the user allows your application to handle the intent. If not, you must request permission explicitly in your application before connecting to the device.</td>
</tr></table>
</div>
<div class="paragraph"><p>Explicitly asking for permission might be necessary in some situations such as when your application enumerates USB devices that are already connected and then wants to communicate with one.</p></div>
<div class="ulist"><ul>
<li>
<p>
You must check for permission to access a device before trying to communicate with it.
</p>
</li>
<li>
<p>
If not, you will receive a runtime error if the user denied permission to access the device.
</p>
</li>
</ul></div>
<div class="paragraph"><p>To explicitly obtain permission:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Call <tt>UsbManager.requestPermission()</tt>.
</p>
</li>
<li>
<p>
The call to <tt>requestPermission()</tt> displays a dialog to the user asking for permission to connect to the accessory.
</p>
</li>
<li>
<p>
The system generates a broadcast intent with a boolean <tt>EXTRA_PERMISSION_GRANTED</tt> extra indicating the user&#8217;s response.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The following sample code shows how to create a broadcast receiver to process the response:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">String</span> ACTION_USB_PERMISSION <span style="color: #990000">=</span> <span style="color: #FF0000">"com.android.example.USB_PERMISSION"</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="font-weight: bold"><span style="color: #0000FF">final</span></span> <span style="color: #008080">BroadcastReceiver</span> mUsbReceiver <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">BroadcastReceiver</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onReceive</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">String</span> action <span style="color: #990000">=</span> intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getAction</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ACTION_USB_PERMISSION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>action<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">synchronized</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="color: #008080">UsbAccessory</span> accessory <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbAccessory<span style="color: #990000">)</span> intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getParcelableExtra</span></span><span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>EXTRA_ACCESSORY<span style="color: #990000">);</span>

                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getBooleanExtra</span></span><span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>EXTRA_PERMISSION_GRANTED<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>accessory <span style="color: #990000">!=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                      <span style="font-style: italic"><span style="color: #9A1900">// Call method to set up accessory communication</span></span>
                   <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
                <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"permission denied for accessory "</span> <span style="color: #990000">+</span> accessory<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>To register the broadcast receiver, add this in your <tt>onCreate()</tt> method in your activity:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">IntentFilter</span> filter <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">IntentFilter</span></span><span style="color: #990000">(</span>ACTION_USB_PERMISSION<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">registerReceiver</span></span><span style="color: #990000">(</span>mUsbReceiver<span style="color: #990000">,</span> filter<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>To display the dialog that asks users for permission to connect to the device, call the <tt>UsbManager.requestPermission()</tt> method:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">UsbManager</span> mUsbManager <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbManager<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">getSystemService</span></span><span style="color: #990000">(</span>Context<span style="color: #990000">.</span>USB_SERVICE<span style="color: #990000">);</span>
<span style="color: #008080">UsbAccessory</span> accessory<span style="color: #990000">;</span>
<span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>
mPermissionIntent <span style="color: #990000">=</span> PendingIntent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getBroadcast</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Intent</span></span><span style="color: #990000">(</span>ACTION_USB_PERMISSION<span style="color: #990000">),</span> <span style="color: #993399">0</span><span style="color: #990000">);</span>
mUsbManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">requestPermission</span></span><span style="color: #990000">(</span>accessory<span style="color: #990000">,</span> mPermissionIntent<span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_communicating_with_an_accessory">10.3.9. Communicating With an Accessory</h4>
<div class="paragraph"><p>You can communicate with the accessory by using the <tt>UsbManager</tt> to obtain a file descriptor that you can set up input and output streams to read and write data to descriptor.</p></div>
<div class="ulist"><ul>
<li>
<p>
The streams represent the accessory&#8217;s input and output bulk endpoints.
</p>
</li>
<li>
<p>
You should set up the communication between the device and accessory in another thread, so you don&#8217;t lock the main UI thread.
</p>
</li>
<li>
<p>
The following example shows how to open an accessory to communicate with:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">UsbAccessory</span> mAccessory<span style="color: #990000">;</span>
<span style="color: #008080">ParcelFileDescriptor</span> mFileDescriptor<span style="color: #990000">;</span>
<span style="color: #008080">FileInputStream</span> mInputStream<span style="color: #990000">;</span>
<span style="color: #008080">FileOutputStream</span> mOutputStream<span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// ...</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">private</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">openAccessory</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    Log<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">d</span></span><span style="color: #990000">(</span>TAG<span style="color: #990000">,</span> <span style="color: #FF0000">"openAccessory: "</span> <span style="color: #990000">+</span> accessory<span style="color: #990000">);</span>
    mFileDescriptor <span style="color: #990000">=</span> mUsbManager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">openAccessory</span></span><span style="color: #990000">(</span>mAccessory<span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>mFileDescriptor <span style="color: #990000">!=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">FileDescriptor</span> fd <span style="color: #990000">=</span> mFileDescriptor<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getFileDescriptor</span></span><span style="color: #990000">();</span>
        mInputStream <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileInputStream</span></span><span style="color: #990000">(</span>fd<span style="color: #990000">);</span>
        mOutputStream <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">FileOutputStream</span></span><span style="color: #990000">(</span>fd<span style="color: #990000">);</span>
        <span style="color: #008080">Thread</span> thread <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Thread</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> <span style="color: #FF0000">"AccessoryThread"</span><span style="color: #990000">);</span>
        thread<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">start</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>In the thread&#8217;s <tt>run()</tt> method, you can read and write to the accessory by using the <tt>FileInputStream</tt> or <tt>FileOutputStream</tt> objects.</p></div>
<div class="paragraph"><p>When reading data from an accessory with a <tt>FileInputStream</tt> object, ensure that the buffer that you use is big enough to store the USB packet data.</p></div>
<div class="ulist"><ul>
<li>
<p>
The Android accessory protocol supports packet buffers up to 16384 bytes, so you can choose to always declare your buffer to be of this size for simplicity.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note" />
</td>
<td class="content">At a lower level, the packets are 64 bytes for USB full-speed accessories and 512 bytes for USB high-speed accessories. The Android accessory protocol bundles the packets together for both speeds into one logical packet for simplicity.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_terminating_communication_with_an_accessory">10.3.10. Terminating Communication With an Accessory</h4>
<div class="paragraph"><p>When you are done communicating with an accessory or if the accessory was detached, close the file descriptor that you opened by calling <tt>close()</tt>.</p></div>
<div class="paragraph"><p>To listen for detached events, create a broadcast receiver like below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #008080">BroadcastReceiver</span> mUsbReceiver <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">BroadcastReceiver</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">public</span></span> <span style="color: #009900">void</span> <span style="font-weight: bold"><span style="color: #000000">onReceive</span></span><span style="color: #990000">(</span><span style="color: #008080">Context</span> context<span style="color: #990000">,</span> <span style="color: #008080">Intent</span> intent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="color: #008080">String</span> action <span style="color: #990000">=</span> intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getAction</span></span><span style="color: #990000">();</span>

        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>ACTION_USB_ACCESSORY_DETACHED<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">equals</span></span><span style="color: #990000">(</span>action<span style="color: #990000">))</span> <span style="color: #FF0000">{</span>
            <span style="color: #008080">UsbAccessory</span> accessory <span style="color: #990000">=</span> <span style="color: #990000">(</span>UsbAccessory<span style="color: #990000">)</span>intent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getParcelableExtra</span></span><span style="color: #990000">(</span>UsbManager<span style="color: #990000">.</span>EXTRA_ACCESSORY<span style="color: #990000">);</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>accessory <span style="color: #990000">!=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">// call your method that cleans up and closes communication with the accessory</span></span>
            <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Creating the broadcast receiver within the application, and not the manifest, allows your application to handle detached events only while it is running.</p></div>
<div class="ulist"><ul>
<li>
<p>
This way, detached events are sent only to the application that is currently running and not broadcast to all applications.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_the_android_open_accessory_development_kit">10.3.11. The Android Open Accessory Development Kit</h4>
<div class="paragraph"><p>The Android Open Accessory Development Kit (ADK) provides an implementation of an Android USB accessory that is based on the Arduino open source electronics prototyping platform.</p></div>
<div class="paragraph"><p>The main hardware and software components of the ADK include:</p></div>
<div class="ulist"><ul>
<li>
<p>
A USB micro-controller board that is based on the Arduino Mega2560 and <a href="mailto:Circuits@Home">Circuits@Home</a> USB Host Shield designs ("the ADK board").
</p>
<div class="ulist"><ul>
<li>
<p>
The ADK board provides input and output pins that you can implement through the use of attachments called "shields."
</p>
</li>
<li>
<p>
Custom firmware, written in C++, is installed on the board to define the board&#8217;s functionality and interaction with the attached shield and Android-powered device.
</p>
</li>
</ul></div>
</li>
<li>
<p>
An Android Demo Shield (ADK shield) that affixes atop the ADK board implements the input and output points on the board.
</p>
<div class="ulist"><ul>
<li>
<p>
These implementations include a joystick, LED outputs, and temperature and light sensors.
</p>
</li>
<li>
<p>
You can create or buy your own shields or wire your own features to the ADK board to implement custom functionality.
</p>
</li>
</ul></div>
</li>
<li>
<p>
A library based on the Arduino USB Host Shield library provides the logic for the USB micro-controller board to act as a USB Host.
</p>
<div class="ulist"><ul>
<li>
<p>
This allows the board to initiate transactions with USB devices.
</p>
</li>
</ul></div>
</li>
<li>
<p>
An Arduino sketch defines the firmware that runs on the ADK board and is written in C++.
</p>
<div class="ulist"><ul>
<li>
<p>
The sketch calls the Android accessory protocol library to interact with the Android-powered device.
</p>
</li>
<li>
<p>
It also sends data from the ADK board and shield to the Android application and receives data from the Android application and outputs it to the ADK board and shield.
</p>
</li>
</ul></div>
</li>
<li>
<p>
The Android accessory protocol library.
</p>
<div class="ulist"><ul>
<li>
<p>
This library defines how to enumerate the bus, find a connected Android-powered device that supports accessory mode, and how to setup communication with the device.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Other third party libraries to support the ADK board&#8217;s functionality:
</p>
<div class="ulist"><ul>
<li>
<p>
CapSense library
</p>
</li>
<li>
<p>
I2C / TWI (Two-Wire Interface) library
</p>
</li>
<li>
<p>
Servo library
</p>
</li>
<li>
<p>
Spi library
</p>
</li>
<li>
<p>
Wire library
</p>
</li>
</ul></div>
</li>
<li>
<p>
An Android application, DemoKit, that communicates with the ADK board and shield.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_legal_disclaimer">11. Legal Disclaimer</h2>
<div class="sectionbody">
<div class="paragraph"><p>INFORMATION IN THIS DOCUMENT IS PROVIDED “AS IS”. NO LICENSE, EXPRESS OR IMPLIED, BY ESTOPPEL OR OTHERWISE, TO ANY INTELLECTUAL PROPERTY RIGHTS IS GRANTED BY THIS DOCUMENT. MARAKANA ASSUMES NO LIABILITY WHATSOEVER AND MARAKANA DISCLAIMS ANY EXPRESS OR IMPLIED WARRANTY, RELATING TO THIS INFORMATION INCLUDING LIABILITY OR WARRANTIES RELATING TO FITNESS FOR A PARTICULAR PURPOSE, MERCHANTABILITY, OR INFRINGEMENT OF ANY PATENT, COPYRIGHT OR OTHER INTELLECTUAL PROPERTY RIGHT.</p></div>
<div class="paragraph"><p>Other names and brands may be claimed as the property of others.</p></div>
<div class="paragraph"><p>Copyright © 2012 Marakana Inc.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2012-05-07 17:52:33 PDT
</div>
</div>
</body>
</html>
